# Онлайн-уроки в Brainify

## Описание функциональности

Реализована полная система онлайн-уроков с интеграцией Jitsi Meet для видеозвонков и Excalidraw для интерактивной доски.

## Основные компоненты

### 1. Страница онлайн-урока (`/online-lesson`)
- **URL**: `/online-lesson?lessonId={id}`
- **Доступ**: Преподаватели и ученики
- **Функции**:
  - Проверка оборудования (камера, микрофон, интернет)
  - Видеозвонок через Jitsi Meet
  - Интерактивная доска через Excalidraw
  - Настройки качества видео
  - Сохранение содержимого доски

### 2. Проверка оборудования
- **Камера**: Автоматическое обнаружение и тестирование
- **Микрофон**: Проверка активности с анализом звука
- **Интернет**: Тест скорости соединения
- **Браузер**: Проверка совместимости

### 3. Видеозвонок (Jitsi Meet)
- **Комнаты**: Уникальные комнаты для каждого урока
- **Управление**: Включение/выключение камеры и микрофона
- **Демонстрация экрана**: Возможность поделиться экраном
- **Чат**: Встроенный чат для общения

### 4. Интерактивная доска (Excalidraw)
- **Совместная работа**: Реальное время редактирования
- **Инструменты**: Рисование, текст, фигуры, стикеры
- **Сохранение**: Автоматическое сохранение содержимого
- **Экспорт**: Сохранение в формате изображения

## Техническая реализация

### Модели данных

#### OnlineLessonSession
```java
@Entity
@Table(name = "online_lesson_sessions")
public class OnlineLessonSession {
    private Long id;
    private Lesson lesson;
    private String jitsiRoomName;
    private String excalidrawRoomId;
    private String excalidrawRoomKey;
    private LocalDateTime teacherJoinedAt;
    private LocalDateTime studentJoinedAt;
    private LocalDateTime sessionStartedAt;
    private LocalDateTime sessionEndedAt;
    private SessionStatus status;
    private String boardContent;
    private String lessonNotes;
}
```

### API Endpoints

#### Получение данных урока
```
GET /api/lessons/{lessonId}/online-data
```
Возвращает данные урока и сессии для онлайн-урока.

#### Завершение урока
```
POST /api/lessons/{lessonId}/end
```
Завершает онлайн-урок и сохраняет данные.

#### Статус урока
```
GET /api/lessons/{lessonId}/online-status
```
Возвращает текущий статус онлайн-урока.

### Сервисы

#### OnlineLessonService
- Создание и управление сессиями
- Проверка прав доступа
- Завершение уроков
- Очистка старых сессий

## Инструкция по использованию

### Для преподавателей

1. **Вход в урок**:
   - В личном кабинете найдите нужный урок
   - Нажмите кнопку "Войти в урок" (доступна за 15 минут до начала)
   - Система перенаправит на страницу проверки оборудования

2. **Проверка оборудования**:
   - Разрешите доступ к камере и микрофону
   - Проверьте работу всех компонентов
   - Нажмите "Подключиться к уроку"

3. **Проведение урока**:
   - Используйте видеозвонок для общения с учеником
   - Рисуйте на интерактивной доске
   - Демонстрируйте экран при необходимости

4. **Завершение урока**:
   - Нажмите кнопку завершения
   - Выберите, сохранять ли содержимое доски
   - Система автоматически завершит урок

### Для учеников

1. **Присоединение к уроку**:
   - В личном кабинете найдите урок
   - Нажмите кнопку "Присоединиться к уроку"
   - Пройдите проверку оборудования

2. **Участие в уроке**:
   - Общайтесь с преподавателем через видеозвонок
   - Работайте на интерактивной доске
   - Задавайте вопросы в чате

## Настройка и развертывание

### Требования
- Java 17+
- Spring Boot 3.x
- MySQL 8.0+
- Современный браузер с поддержкой WebRTC

### Зависимости
- Jitsi Meet External API
- Excalidraw (загружается из CDN)

### Миграция базы данных
```sql
-- Выполните миграцию для создания таблицы сессий
source online-lesson-sessions-migration.sql;
```

### Конфигурация
В `application.properties` добавьте:
```properties
# Настройки для онлайн-уроков
online.lesson.session.timeout=24
online.lesson.cleanup.enabled=true
```

## Безопасность

### Проверки доступа
- Только участники урока могут присоединиться
- Проверка времени урока (за 15 минут до начала)
- Автоматическое завершение через час после начала

### Защита данных
- Уникальные комнаты для каждого урока
- Шифрование видеозвонков (Jitsi)
- Безопасное хранение содержимого доски

## Мониторинг и логирование

### Логирование
- Создание сессий
- Присоединение участников
- Завершение уроков
- Ошибки подключения

### Метрики
- Количество активных сессий
- Время проведения уроков
- Использование ресурсов

## Устранение неполадок

### Проблемы с камерой/микрофоном
1. Проверьте разрешения браузера
2. Убедитесь, что устройства не заняты другими приложениями
3. Попробуйте другой браузер

### Проблемы с подключением
1. Проверьте интернет-соединение
2. Убедитесь, что порты не заблокированы
3. Попробуйте снизить качество видео

### Проблемы с доской
1. Обновите страницу
2. Проверьте JavaScript в браузере
3. Убедитесь, что Excalidraw загрузился

## Будущие улучшения

### Планируемые функции
- Запись уроков
- Автоматические заметки
- Интеграция с календарем
- Мобильное приложение
- Аналитика уроков

### Оптимизации
- Улучшение качества видео
- Снижение задержек
- Оптимизация использования ресурсов
- Кэширование данных доски
