# Синхронизация онлайн доски - Brainify

## Описание

Система синхронизации онлайн доски позволяет пользователям рисовать на общей доске в реальном времени. Все операции рисования сохраняются в базе данных и синхронизируются между всеми участниками урока.

## Архитектура

### Компоненты

1. **BoardOperation** - модель для хранения операций рисования
2. **BoardController** - REST API для работы с доской
3. **BoardWebSocketController** - WebSocket контроллер для реального времени
4. **BoardService** - сервис для бизнес-логики
5. **online-lesson.js** - клиентский JavaScript

### База данных

Таблица `board_operations` содержит:
- `id` - уникальный идентификатор
- `lesson_id` - ID урока
- `operation_type` - тип операции (start, draw, end)
- `x_coordinate`, `y_coordinate` - координаты точки
- `color` - цвет линии
- `brush_size` - размер кисти
- `user_id` - ID пользователя
- `user_name` - имя пользователя
- `sequence_number` - порядковый номер операции
- `timestamp` - время создания

## Функциональность

### 1. Сохранение операций рисования

Каждая точка рисования сохраняется в БД:
- **start** - начало рисования
- **draw** - продолжение рисования
- **end** - завершение рисования

### 2. Синхронизация в реальном времени

- WebSocket соединение для мгновенной синхронизации
- Операции отправляются всем участникам урока
- Поддержка sequence_number для правильного порядка

### 3. Восстановление состояния доски

При загрузке страницы:
1. Запрос состояния через WebSocket
2. Fallback на REST API если WebSocket недоступен
3. Восстановление всех операций в правильном порядке

## API Endpoints

### REST API

```
GET /api/board/state/{lessonId} - получить состояние доски
GET /api/board/operations/{lessonId} - получить операции
POST /api/board/test-save-operation/{lessonId} - тест сохранения
DELETE /api/board/operations/{lessonId} - очистить операции
GET /api/board/test-db - тест подключения к БД
```

### WebSocket

```
/app/board/{lessonId}/draw - отправка операции рисования
/app/board/{lessonId}/request-state - запрос состояния
/app/board/{lessonId}/join - присоединение к уроку
/app/board/{lessonId}/leave - выход с урока
```

## Использование

### 1. Запуск приложения

```bash
mvn spring-boot:run
```

### 2. Тестирование

Откройте `http://localhost:8082/test-board-api.html` для тестирования API.

### 3. Онлайн урок

Перейдите на страницу онлайн урока с параметром `lessonId`:
```
http://localhost:8082/online-lesson?lessonId=1
```

## Отладка

### Логирование

Включено подробное логирование:
- Сохранение операций в БД
- WebSocket сообщения
- Восстановление состояния доски

### Тестовые функции

В консоли браузера доступны функции:
```javascript
// Принудительная синхронизация
forceBoardSync()

// Восстановление состояния
restoreBoardState()

// Тест восстановления
testBoardRestore()
```

## Проблемы и решения

### 1. Точки не отрисовываются после перезагрузки

**Причина**: Неправильная обработка состояния доски
**Решение**: Исправлена функция `handleBoardState()` с сортировкой по `sequenceNumber`

### 2. Синхронизация не работает в реальном времени

**Причина**: Проблемы с WebSocket подключением
**Решение**: Добавлен fallback на REST API и улучшена обработка ошибок

### 3. Координаты некорректные

**Причина**: Неправильное преобразование координат
**Решение**: Добавлена валидация координат и логирование

## Производительность

### Оптимизации

1. **Сортировка операций** - по sequenceNumber для правильного порядка
2. **Валидация координат** - пропуск некорректных точек
3. **Fallback механизм** - REST API при недоступности WebSocket
4. **Логирование** - для отладки проблем

### Ограничения

- Размер canvas: 10000x10000 пикселей
- Максимальный размер кисти: 20 пикселей
- Поддерживаемые типы операций: start, draw, end

## Безопасность

- Валидация входных данных
- Проверка прав доступа к уроку
- Санитизация координат
- Ограничение размера операций

## Мониторинг

### Метрики

- Количество операций на урок
- Время отклика WebSocket
- Успешность восстановления состояния
- Ошибки синхронизации

### Логи

Все операции логируются с подробной информацией:
- Время выполнения
- Параметры операции
- Результат выполнения
- Ошибки и исключения
