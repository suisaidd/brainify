// Professional Board Brush Optimizer - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–∏—Å—Ç–∏ –≤—ã—Å–æ–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è
// –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ, throttling, –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–æ—á–µ–∫ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ —Ä–∏—Å–æ–≤–∞–Ω–∏—è

class BrushOptimizer {
    constructor(board) {
        this.board = board;
        this.isEnabled = true;
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
        this.smoothing = {
            enabled: true,
            strength: 0.7, // –°–∏–ª–∞ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è (0-1)
            velocityThreshold: 10, // –ü–æ—Ä–æ–≥ —Å–∫–æ—Ä–æ—Å—Ç–∏ –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
            maxPoints: 500, // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ –≤ —à—Ç—Ä–∏—Ö–µ
            minDistance: 2, // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
            adaptiveSmoothing: true
        };
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ throttling
        this.throttling = {
            enabled: true,
            interval: 8, // –ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ –º—Å (125 FPS –º–∞–∫—Å)
            adaptiveInterval: true,
            performanceThreshold: 30 // FPS –Ω–∏–∂–µ –∫–æ—Ç–æ—Ä–æ–≥–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª
        };
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
        this.drawingState = {
            isDrawing: false,
            currentStroke: null,
            lastPoint: null,
            lastTime: 0,
            velocity: 0,
            pressure: 1,
            smoothedPoints: [],
            throttleTimer: null
        };
        
        // –ë—É—Ñ–µ—Ä —Ç–æ—á–µ–∫ –¥–ª—è —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
        this.pointBuffer = [];
        this.maxBufferSize = 5;
        
        console.log('üñåÔ∏è BrushOptimizer –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    }
    
    // –ù–∞—á–∞–ª–æ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
    startDrawing(point, options = {}) {
        if (!this.isEnabled) return false;
        
        console.log('üé® –ù–∞—á–∞–ª–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∏—Å–æ–≤–∞–Ω–∏—è');
        
        this.drawingState.isDrawing = true;
        this.drawingState.lastPoint = point;
        this.drawingState.lastTime = performance.now();
        this.drawingState.velocity = 0;
        this.drawingState.pressure = options.pressure || 1;
        
        // –û—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–æ–≤
        this.pointBuffer = [point];
        this.drawingState.smoothedPoints = [point];
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —à—Ç—Ä–∏—Ö–∞
        this.drawingState.currentStroke = {
            id: Date.now() + '_' + Math.random(),
            points: [point],
            color: options.color || '#000000',
            brushSize: options.brushSize || 3,
            opacity: options.opacity || 1,
            tool: options.tool || 'brush',
            timestamp: Date.now()
        };
        
        return true;
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—á–∫–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
    addPoint(point, options = {}) {
        if (!this.isEnabled || !this.drawingState.isDrawing) return false;
        
        const currentTime = performance.now();
        const deltaTime = currentTime - this.drawingState.lastTime;
        
        // Throttling - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ç–æ—á–∫–∏ –µ—Å–ª–∏ –æ–Ω–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ
        if (this.throttling.enabled && deltaTime < this.getAdaptiveInterval()) {
            return false;
        }
        
        // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
        const distance = this.calculateDistance(this.drawingState.lastPoint, point);
        this.drawingState.velocity = distance / Math.max(deltaTime, 1);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è
        if (distance < this.smoothing.minDistance) {
            return false;
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä
        this.pointBuffer.push(point);
        if (this.pointBuffer.length > this.maxBufferSize) {
            this.pointBuffer.shift();
        }
        
        // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏
        const smoothedPoint = this.smoothing.enabled ? 
            this.smoothPoint(point) : point;
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è
        smoothedPoint.pressure = this.calculateAdaptivePressure(options.pressure);
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ —à—Ç—Ä–∏—Ö
        this.drawingState.currentStroke.points.push(smoothedPoint);
        this.drawingState.smoothedPoints.push(smoothedPoint);
        
        // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ—á–µ–∫
        if (this.drawingState.currentStroke.points.length > this.smoothing.maxPoints) {
            this.optimizeStrokePoints();
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        this.drawingState.lastPoint = point;
        this.drawingState.lastTime = currentTime;
        
        return smoothedPoint;
    }
    
    // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
    finishDrawing() {
        if (!this.isEnabled || !this.drawingState.isDrawing) return null;
        
        console.log('‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∏—Å–æ–≤–∞–Ω–∏—è');
        
        // –§–∏–Ω–∞–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —à—Ç—Ä–∏—Ö–∞
        const finalStroke = this.finalizeStroke();
        
        // –û—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        this.drawingState.isDrawing = false;
        this.drawingState.currentStroke = null;
        this.pointBuffer = [];
        this.drawingState.smoothedPoints = [];
        
        return finalStroke;
    }
    
    // –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏
    smoothPoint(point) {
        if (!this.smoothing.enabled || this.pointBuffer.length < 2) {
            return point;
        }
        
        const smoothingStrength = this.getAdaptiveSmoothingStrength();
        
        // –ü—Ä–æ—Å—Ç–æ–µ —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ —Ç–æ—á–∫–∞–º–∏
        let avgX = point.x;
        let avgY = point.y;
        let weight = 1;
        
        for (let i = this.pointBuffer.length - 2; i >= 0; i--) {
            const prevPoint = this.pointBuffer[i];
            const distance = this.calculateDistance(point, prevPoint);
            const pointWeight = Math.exp(-distance / 20) * smoothingStrength;
            
            avgX += prevPoint.x * pointWeight;
            avgY += prevPoint.y * pointWeight;
            weight += pointWeight;
        }
        
        return {
            x: avgX / weight,
            y: avgY / weight,
            timestamp: point.timestamp
        };
    }
    
    // –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–∏–ª–∞ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
    getAdaptiveSmoothingStrength() {
        if (!this.smoothing.adaptiveSmoothing) {
            return this.smoothing.strength;
        }
        
        // –ß–µ–º –±—ã—Å—Ç—Ä–µ–µ –¥–≤–∏–∂–µ–Ω–∏–µ, —Ç–µ–º –º–µ–Ω—å—à–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ
        const velocityFactor = Math.min(this.drawingState.velocity / this.smoothing.velocityThreshold, 1);
        return this.smoothing.strength * (1 - velocityFactor * 0.5);
    }
    
    // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª throttling
    getAdaptiveInterval() {
        if (!this.throttling.adaptiveInterval) {
            return this.throttling.interval;
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ FPS –æ—Ç PerformanceManager
        const currentFPS = this.board.modules.performance ? 
            this.board.modules.performance.getCurrentFPS() : 60;
        
        if (currentFPS < this.throttling.performanceThreshold) {
            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–∏ –Ω–∏–∑–∫–æ–º FPS
            return this.throttling.interval * 2;
        }
        
        return this.throttling.interval;
    }
    
    // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è
    calculateAdaptivePressure(pressure = 1) {
        // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–∞–≤–ª–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
        const velocityFactor = Math.min(this.drawingState.velocity / 50, 1);
        const adaptedPressure = pressure * (0.7 + velocityFactor * 0.3);
        
        return Math.max(0.1, Math.min(1, adaptedPressure));
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–æ—á–µ–∫ –≤ —à—Ç—Ä–∏—Ö–µ
    optimizeStrokePoints() {
        if (!this.drawingState.currentStroke.points.length) return;
        
        const points = this.drawingState.currentStroke.points;
        const optimizedPoints = [points[0]]; // –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–≤—É—é —Ç–æ—á–∫—É
        
        // –ê–ª–≥–æ—Ä–∏—Ç–º Douglas-Peucker –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –ª–∏–Ω–∏–∏
        const tolerance = 2; // –ü–∏–∫—Å–µ–ª–∏
        
        for (let i = 1; i < points.length - 1; i++) {
            const prev = points[i - 1];
            const current = points[i];
            const next = points[i + 1];
            
            // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ç–æ—á–∫–∏ –¥–æ –ª–∏–Ω–∏–∏ –º–µ–∂–¥—É —Å–æ—Å–µ–¥–Ω–∏–º–∏ —Ç–æ—á–∫–∞–º–∏
            const distance = this.pointToLineDistance(current, prev, next);
            
            if (distance > tolerance) {
                optimizedPoints.push(current);
            }
        }
        
        // –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Ç–æ—á–∫—É
        if (points.length > 1) {
            optimizedPoints.push(points[points.length - 1]);
        }
        
        this.drawingState.currentStroke.points = optimizedPoints;
        
        console.log(`üîß –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: ${points.length} ‚Üí ${optimizedPoints.length} —Ç–æ—á–µ–∫`);
    }
    
    // –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è —à—Ç—Ä–∏—Ö–∞
    finalizeStroke() {
        if (!this.drawingState.currentStroke) return null;
        
        // –ü–æ—Å–ª–µ–¥–Ω—è—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
        this.optimizeStrokePoints();
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
        const finalStroke = {
            ...this.drawingState.currentStroke,
            optimized: true,
            originalPointCount: this.drawingState.smoothedPoints.length,
            finalPointCount: this.drawingState.currentStroke.points.length,
            averageVelocity: this.calculateAverageVelocity(),
            duration: Date.now() - this.drawingState.currentStroke.timestamp
        };
        
        console.log('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —à—Ç—Ä–∏—Ö–∞:', {
            points: finalStroke.finalPointCount,
            original: finalStroke.originalPointCount,
            velocity: finalStroke.averageVelocity.toFixed(2),
            duration: finalStroke.duration + 'ms'
        });
        
        return finalStroke;
    }
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    calculateDistance(p1, p2) {
        const dx = p2.x - p1.x;
        const dy = p2.y - p1.y;
        return Math.sqrt(dx * dx + dy * dy);
    }
    
    pointToLineDistance(point, lineStart, lineEnd) {
        const A = point.x - lineStart.x;
        const B = point.y - lineStart.y;
        const C = lineEnd.x - lineStart.x;
        const D = lineEnd.y - lineStart.y;
        
        const dot = A * C + B * D;
        const lenSq = C * C + D * D;
        let param = -1;
        
        if (lenSq !== 0) {
            param = dot / lenSq;
        }
        
        let xx, yy;
        
        if (param < 0) {
            xx = lineStart.x;
            yy = lineStart.y;
        } else if (param > 1) {
            xx = lineEnd.x;
            yy = lineEnd.y;
        } else {
            xx = lineStart.x + param * C;
            yy = lineStart.y + param * D;
        }
        
        const dx = point.x - xx;
        const dy = point.y - yy;
        return Math.sqrt(dx * dx + dy * dy);
    }
    
    calculateAverageVelocity() {
        if (!this.drawingState.currentStroke.points.length) return 0;
        
        let totalDistance = 0;
        const points = this.drawingState.currentStroke.points;
        
        for (let i = 1; i < points.length; i++) {
            totalDistance += this.calculateDistance(points[i - 1], points[i]);
        }
        
        const duration = this.drawingState.currentStroke.duration || 1;
        return totalDistance / duration;
    }
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    updateSettings(newSettings) {
        this.smoothing = { ...this.smoothing, ...newSettings.smoothing };
        this.throttling = { ...this.throttling, ...newSettings.throttling };
        
        console.log('‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ BrushOptimizer –æ–±–Ω–æ–≤–ª–µ–Ω—ã:', newSettings);
    }
    
    // –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ
    setEnabled(enabled) {
        this.isEnabled = enabled;
        console.log(`üñåÔ∏è BrushOptimizer ${enabled ? '–≤–∫–ª—é—á–µ–Ω' : '–≤—ã–∫–ª—é—á–µ–Ω'}`);
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    getStats() {
        return {
            isEnabled: this.isEnabled,
            isDrawing: this.drawingState.isDrawing,
            bufferSize: this.pointBuffer.length,
            currentVelocity: this.drawingState.velocity,
            adaptiveInterval: this.getAdaptiveInterval(),
            smoothingStrength: this.getAdaptiveSmoothingStrength()
        };
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
if (typeof module !== 'undefined' && module.exports) {
    module.exports = BrushOptimizer;
}
