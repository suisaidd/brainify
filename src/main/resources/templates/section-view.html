<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} ?: '–†–∞–∑–¥–µ–ª - Brainify'">–†–∞–∑–¥–µ–ª - Brainify</title>
    
    <link rel="stylesheet" th:href="@{/css/section-modern.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="page-container">
        <!-- –õ–µ–≤–∞—è –±–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <aside class="left-sidebar" id="leftSidebar">
            <div class="sidebar-header">
                <div class="breadcrumb">
                    <a th:href="@{'/course/' + ${subject.id}}">–ö—É—Ä—Å</a>
                    <i class="fas fa-chevron-right"></i>
                    <a th:href="@{'/course/chapter/' + ${section.chapter.id}}" th:text="${chapter.title}">–ì–ª–∞–≤–∞</a>
                </div>
                <h2 class="sidebar-title" th:text="${section.title}">–†–∞–∑–¥–µ–ª</h2>
            </div>
            
            <nav class="sections-nav">
                <div class="nav-chapter" th:each="ch : ${chapters}">
                    <a class="nav-chapter-title" 
                       th:href="@{'/course/chapter/' + ${ch.id}}"
                       th:classappend="${ch.id == chapter.id} ? 'active' : ''" 
                       th:text="${ch.title}">–ì–ª–∞–≤–∞</a>
                    <div class="nav-chapter-sections" th:if="${chapterToSections[ch.id] != null}">
                        <a class="nav-section" 
                           th:each="s : ${chapterToSections[ch.id]}"
                           th:href="@{'/course/section/' + ${s.id}}"
                           th:classappend="${s.id == section.id} ? 'active' : ''"
                           th:text="${s.title}">
                            –†–∞–∑–¥–µ–ª
                        </a>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <main class="main-content">
            <!-- –ö–†–ê–°–ò–í–´–ô HEADER –í–û –í–°–Æ –®–ò–†–ò–ù–£ -->
            <div class="top-bar">
                <div class="top-bar-container">
                    <div class="top-bar-left">
                        <button class="top-btn secondary" id="mobileSidebarToggle" style="display: none;">
                            <i class="fas fa-bars"></i>
                        </button>
                        <a href="/" class="logo">
                            <span class="logo-brain">Brain</span><span class="logo-ify">ify</span>
                        </a>
                        <div class="header-divider"></div>
                        <div class="page-breadcrumb">
                            <div class="breadcrumb-top" th:text="${chapter.title}">–ì–ª–∞–≤–∞</div>
                            <div class="breadcrumb-current" th:text="${section.title}">–†–∞–∑–¥–µ–ª</div>
                        </div>
                    </div>
                    <div class="top-bar-actions">
                    <a th:href="@{'/course/' + ${subject.id}}" class="top-btn secondary">
                        <i class="fas fa-th"></i> –ö –∫—É—Ä—Å—É
                    </a>
                    <button th:if="${isAuthenticated and currentUser != null and currentUser.role?.name() == 'ADMIN'}" 
                            class="top-btn primary" id="editModeBtn">
                        <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    </div>
                </div>
            </div>

            <div class="content-wrapper">
                <!-- –ë–µ–ª–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º -->
                <div class="content-card">
                    <h1 class="section-title" th:text="${section.title}">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞</h1>
                    
                    <!-- –ë–ª–æ–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -->
                    <div id="contentBlocks">
                    <div class="content-block" th:each="b, iterStat : ${blocks}" th:attr="data-block-id=${b.id}">
                        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è ADMIN) -->
                        <div class="block-actions" th:if="${isAuthenticated and currentUser != null and currentUser.role?.name() == 'ADMIN'}">
                            <button class="block-edit-btn" th:attr="data-block-id=${b.id}, data-block-type=${b.type.name()}">
                                <i class="fas fa-edit"></i> –ò–∑–º–µ–Ω–∏—Ç—å
                            </button>
                            <button class="block-delete-btn" th:attr="data-block-id=${b.id}">
                                <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                        
                        <!-- –¢–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫ -->
                        <div th:if="${b.type.name()} == 'TEXT'">
                            <div th:utext="${b.textContent}">–¢–µ–∫—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç</div>
                        </div>
                        
                        <!-- –ë–ª–æ–∫ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º -->
                        <div th:if="${b.type.name()} == 'IMAGE'">
                            <h3 th:if="${b.title}" th:text="${b.title}">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h3>
                            <img th:src="${b.imageUrl}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" style="max-width: 100%; border-radius: 12px; margin: 20px 0;">
                        </div>
                        
                        <!-- –ó–∞–¥–∞–Ω–∏–µ (–æ—Ç–≤–µ—Ç —Å–∫—Ä—ã—Ç –≤ –ë–î) -->
                        <div th:if="${b.type.name()} == 'SQL_TASK'">
                            <div class="task-block">
                                <div class="task-header">
                                    <div class="task-icon">
                                        <i class="fas fa-tasks"></i>
                                    </div>
                                    <h3 class="task-title" th:text="${b.title} ?: '–ó–∞–¥–∞–Ω–∏–µ'">–ó–∞–¥–∞–Ω–∏–µ</h3>
                                </div>
                                <div class="task-description" th:utext="${b.textContent} ?: '–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ'">
                                    –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ
                                </div>
                                <!-- –ö–∞—Ä—Ç–∏–Ω–∫–∞ –∏–∑ –ë–î -->
                                <img th:src="@{'/api/tasks/image/' + ${b.id} + '/SECTION'}" 
                                     class="task-image" 
                                     onerror="this.style.display='none'"
                                     style="display: block;">
                                <div class="task-input-wrapper">
                                    <textarea class="task-input" 
                                              placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç –∑–¥–µ—Å—å..." 
                                              rows="3"
                                              th:text="${b.initialSql}"></textarea>
                                </div>
                                <div class="task-actions">
                                    <button class="check-btn check-answer-btn">
                                        <i class="fas fa-check"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
                                    </button>
                                </div>
                                <div class="task-result"></div>
                    </div>
                </div>
            </div>

                    <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
                    <div th:if="${#lists.isEmpty(blocks)}" class="empty-state">
                        <i class="fas fa-file-alt"></i>
                        <h3>–†–∞–∑–¥–µ–ª –ø–æ–∫–∞ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω</h3>
                        <p th:if="${isAuthenticated and currentUser != null and currentUser.role?.name() == 'ADMIN'}">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫" –Ω–∏–∂–µ</p>
                        <p th:if="${not (isAuthenticated and currentUser != null and currentUser.role?.name() == 'ADMIN')}">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–±–∞–≤–∏—Ç –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è</p>
                    </div>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫ (—Ç–æ–ª—å–∫–æ –¥–ª—è ADMIN –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) -->
                    <button th:if="${isAuthenticated and currentUser != null and currentUser.role?.name() == 'ADMIN'}" 
                            class="add-block-btn" id="addBlockBtn" style="display: none;">
                        <i class="fas fa-plus-circle"></i>
                        –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫
                    </button>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞ -->
                    <div class="complete-section-wrapper">
                        <button class="complete-section-btn" id="completeSectionBtn" 
                                th:attr="data-section-id=${section.id}">
                            <i class="fas fa-check-circle"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–∑–¥–µ–ª
                        </button>
                    </div>
                    </div>
                    </div>
        </main>
    </div>
    
    <!-- –ü–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤) -->
    <div class="edit-overlay" id="editOverlay"></div>
    <div class="edit-panel" id="editPanel">
        <div class="edit-panel-header">
            <h3 class="edit-panel-title">
                <i class="fas fa-plus-circle"></i>
                –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç
            </h3>
            <button class="close-edit-btn" id="closeEditBtn">&times;</button>
        </div>
        <form class="edit-panel-content" th:action="@{'/admin/course/block'}" method="post">
            <input type="hidden" name="sectionId" th:value="${section.id}">
            
            <div class="edit-form-group">
                <label>
                    <i class="fas fa-layer-group"></i>
                    –¢–∏–ø –±–ª–æ–∫–∞
                </label>
                <select name="type" id="blockType">
                    <option value="TEXT">üìù –¢–µ–∫—Å—Ç</option>
                    <option value="IMAGE">üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</option>
                    <option value="SQL_TASK">‚úÖ –ó–∞–¥–∞–Ω–∏–µ</option>
                </select>
            </div>
            
            <div class="edit-form-group">
                <label>
                    <i class="fas fa-heading"></i>
                    –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                </label>
                <input type="text" name="title" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª–æ–∫–∞">
            </div>
            
            <div class="edit-form-group" id="textField">
                <label>
                    <i class="fas fa-align-left"></i>
                    –¢–µ–∫—Å—Ç (HTML)
                </label>
                <textarea name="textContent" placeholder="<h2>–ó–∞–≥–æ–ª–æ–≤–æ–∫</h2>&#10;<p>–í–∞—à —Ç–µ–∫—Å—Ç...</p>"></textarea>
                <p class="edit-form-hint">
                    <i class="fas fa-lightbulb"></i>
                    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTML: &lt;h2&gt;, &lt;p&gt;, &lt;ul&gt;, &lt;code&gt;
                </p>
            </div>
            
            <div class="edit-form-group" id="imageField" style="display: none;">
                <label>
                    <i class="fas fa-image"></i>
                    URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                </label>
                <input type="text" name="imageUrl" placeholder="https://example.com/image.jpg">
                <p class="edit-form-hint">
                    <i class="fas fa-lightbulb"></i>
                    –í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É
                </p>
            </div>
            
            <div class="edit-form-group" id="sqlField" style="display: none;">
                <label>
                    <i class="fas fa-tasks"></i>
                    –¢–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è (HTML)
                </label>
                <textarea name="textContent" placeholder="<p>–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ...</p>"></textarea>
                
                <label style="margin-top: 20px;">
                    <i class="fas fa-image"></i>
                    –ö–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞–¥–∞–Ω–∏—è (drag & drop)
                </label>
                <div id="taskImageDropZone" style="border: 2px dashed #a7f3d0; border-radius: 10px; padding: 30px; text-align: center; background: #f0fdf4; cursor: pointer; transition: all 0.3s;">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: #10b981; margin-bottom: 10px; display: block;"></i>
                    <p style="color: #059669; font-weight: 600; margin: 0;">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É —Å—é–¥–∞ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
                    <p style="color: #6b7280; font-size: 12px; margin-top: 6px;">JPG, PNG (–º–∞–∫—Å. 5MB)</p>
                    <input type="file" id="taskImageInput" accept="image/*" style="display: none;">
                </div>
                <div id="taskImagePreview" style="margin-top: 12px; display: none;">
                    <img id="previewImg" style="max-width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <button type="button" id="removeImageBtn" style="margin-top: 8px; padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-times"></i> –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
                
                <label style="margin-top: 20px;">
                    <i class="fas fa-code"></i>
                    –ù–∞—á–∞–ª—å–Ω—ã–π –∫–æ–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                </label>
                <textarea name="initialSql" placeholder="–ù–∞—á–∞–ª—å–Ω—ã–π –∫–æ–¥"></textarea>
                
                <label style="margin-top: 20px;">
                    <i class="fas fa-check-double"></i>
                    –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                </label>
                <input type="text" id="correctAnswerInput" placeholder="–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (–±—É–¥–µ—Ç —Å–∫—Ä—ã—Ç –æ—Ç —É—á–µ–Ω–∏–∫–∞)">
                <p class="edit-form-hint">
                    <i class="fas fa-lock"></i>
                    –û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î –∏ –Ω–µ –≤–∏–¥–µ–Ω –≤ –∫–æ–¥–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                </p>
            </div>
            
            <div class="edit-form-group">
                <label>
                    <i class="fas fa-sort-numeric-down"></i>
                    –ü–æ—Ä—è–¥–æ–∫
                </label>
                <input type="number" name="sortOrder" value="0" min="0">
</div>

            <div class="edit-form-actions">
                <button type="submit" class="save-edit-btn">
                    <i class="fas fa-save"></i> –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫
                </button>
                <button type="button" class="cancel-edit-btn" id="cancelEditBtn2">
                    <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </form>
    </div>
    
    <!-- JavaScript -->
<script>
        // –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é
        const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
        const leftSidebar = document.getElementById('leftSidebar');
        
        if (window.innerWidth <= 768) {
            mobileSidebarToggle.style.display = 'block';
        }
        
        mobileSidebarToggle?.addEventListener('click', () => {
            leftSidebar.classList.toggle('mobile-open');
        });
        
        // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const editModeBtn = document.getElementById('editModeBtn');
        const addBlockBtn = document.getElementById('addBlockBtn');
        const editPanel = document.getElementById('editPanel');
        const editOverlay = document.getElementById('editOverlay');
        const closeEditBtn = document.getElementById('closeEditBtn');
        const cancelEditBtn2 = document.getElementById('cancelEditBtn2');
        const blockType = document.getElementById('blockType');
        let isEditMode = false;
        
        console.log('Edit mode button found:', editModeBtn);
        console.log('Add block button found:', addBlockBtn);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–Ω–æ–ø–∫–∏
        if (editModeBtn) {
            console.log('Edit button visible:', editModeBtn.offsetParent !== null);
            console.log('Edit button display:', window.getComputedStyle(editModeBtn).display);
            console.log('Edit button classes:', editModeBtn.className);
        }
        
        function toggleEditMode() {
            console.log('Toggle edit mode clicked, current mode:', isEditMode);
            isEditMode = !isEditMode;
            document.body.classList.toggle('edit-mode', isEditMode);
            
            console.log('Edit mode now:', isEditMode);
            console.log('Body classes:', document.body.className);
            
            if (isEditMode) {
                editModeBtn.innerHTML = '<i class="fas fa-check"></i> –ì–æ—Ç–æ–≤–æ';
                editModeBtn.classList.add('success');
                if (addBlockBtn) addBlockBtn.style.display = 'block';
                console.log('Edit mode ON - showing add block button');
            } else {
                editModeBtn.innerHTML = '<i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
                editModeBtn.classList.remove('success');
                if (addBlockBtn) addBlockBtn.style.display = 'none';
                console.log('Edit mode OFF - hiding add block button');
            }
        }
        
        function openEditPanel() {
            editPanel.classList.add('active');
            editOverlay.classList.add('active');
        }
        
        function closeEditPanel() {
            editPanel.classList.remove('active');
            editOverlay.classList.remove('active');
        }
        
        if (editModeBtn) {
            editModeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Edit mode button clicked!');
                toggleEditMode();
            });
            console.log('Edit mode button event listener added');
        } else {
            console.error('Edit mode button not found!');
        }
        
        if (addBlockBtn) {
            addBlockBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Add block button clicked!');
                openEditPanel();
            });
            console.log('Add block button event listener added');
        } else {
            console.error('Add block button not found!');
        }
        closeEditBtn?.addEventListener('click', closeEditPanel);
        cancelEditBtn2?.addEventListener('click', closeEditPanel);
        editOverlay?.addEventListener('click', closeEditPanel);
        
        // –ö–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å/—É–¥–∞–ª–∏—Ç—å –±–ª–æ–∫–æ–≤
        document.querySelectorAll('.block-edit-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const blockId = this.getAttribute('data-block-id');
                const blockType = this.getAttribute('data-block-type');
                
                try {
                    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –±–ª–æ–∫–∞
                    const response = await fetch(`/api/blocks/${blockId}/data`);
                    if (response.ok) {
                        const blockData = await response.json();
                        openBlockEditModal(blockData);
                    } else {
                        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–∞');
                    }
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–∞');
                }
            });
        });
        
        document.querySelectorAll('.block-delete-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±–ª–æ–∫?')) return;
                
                const blockId = this.getAttribute('data-block-id');
                try {
                    const response = await fetch(`/admin/course/block/${blockId}/delete`, {
                        method: 'POST'
                    });
                    if (response.ok) {
                        this.closest('.content-block').style.animation = 'fadeOut 0.3s';
                        setTimeout(() => window.location.reload(), 300);
                    } else {
                        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                    }
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            });
        });
        
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–ª–æ–∫–∞
        const blockEditModal = document.getElementById('blockEditModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const saveBlockBtn = document.getElementById('saveBlockBtn');
        
        function openBlockEditModal(blockData) {
            // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –±–ª–æ–∫–∞
            document.getElementById('editBlockId').value = blockData.id;
            document.getElementById('editBlockType').value = blockData.type;
            document.getElementById('editBlockTypeSelect').value = blockData.type;
            document.getElementById('editTitle').value = blockData.title || '';
            document.getElementById('editTextContent').value = blockData.textContent || '';
            document.getElementById('editImageUrl').value = blockData.imageUrl || '';
            document.getElementById('editSortOrder').value = blockData.sortOrder || 0;
            
            // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
            toggleEditFields(blockData.type);
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            blockEditModal.style.display = 'flex';
        }
        
        function closeBlockEditModal() {
            blockEditModal.style.display = 'none';
        }
        
        function toggleEditFields(type) {
            document.getElementById('editTextField').style.display = 'none';
            document.getElementById('editImageField').style.display = 'none';
            document.getElementById('editTaskField').style.display = 'none';
            
            if (type === 'TEXT') {
                document.getElementById('editTextField').style.display = 'block';
            } else if (type === 'IMAGE') {
                document.getElementById('editImageField').style.display = 'block';
            } else if (type === 'SQL_TASK') {
                document.getElementById('editTaskField').style.display = 'block';
            }
        }
        
        closeModalBtn?.addEventListener('click', closeBlockEditModal);
        cancelEditBtn?.addEventListener('click', closeBlockEditModal);
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ overlay
        blockEditModal?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeBlockEditModal();
            }
        });
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª–µ–π –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        document.getElementById('editBlockTypeSelect')?.addEventListener('change', function() {
            toggleEditFields(this.value);
        });
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–ª–æ–∫–∞
        saveBlockBtn?.addEventListener('click', async function() {
            const formData = new FormData(document.getElementById('blockEditForm'));
            const blockId = formData.get('blockId');
            
            try {
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                this.disabled = true;
                
                const response = await fetch(`/api/blocks/${blockId}/update`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    closeBlockEditModal();
                    window.location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–ª–æ–∫–∞');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–ª–æ–∫–∞');
            } finally {
                this.innerHTML = '<i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                this.disabled = false;
            }
        });
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –±–ª–æ–∫–∞
        blockType?.addEventListener('change', () => {
            document.getElementById('textField').style.display = 'none';
            document.getElementById('imageField').style.display = 'none';
            document.getElementById('sqlField').style.display = 'none';
            
            if (blockType.value === 'TEXT') {
                document.getElementById('textField').style.display = '';
            } else if (blockType.value === 'IMAGE') {
                document.getElementById('imageField').style.display = '';
            } else if (blockType.value === 'SQL_TASK') {
                document.getElementById('sqlField').style.display = '';
            }
        });
        
        // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ SQL
        document.querySelectorAll('.run-sql-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const taskBlock = this.closest('.task-block');
                const textarea = taskBlock.querySelector('.task-input');
                const resultDiv = taskBlock.querySelector('.task-result');
                
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ...';
                
                try {
                    const response = await fetch('/course/sql/execute', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sql: textarea.value })
                    });
                    
                    const data = await response.json();
                    
                    if (!data.success) {
                        resultDiv.className = 'task-result error';
                        resultDiv.innerHTML = '<i class="fas fa-times-circle"></i> ' + (data.error || '–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è');
                        return;
                    }
                    
      const rows = data.rows || [];
                    if (rows.length === 0) {
                        resultDiv.className = 'task-result success';
                        resultDiv.innerHTML = '<i class="fas fa-info-circle"></i> –ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω, —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ—Ç';
                        return;
                    }
                    
                    resultDiv.className = 'task-result success';
                    resultDiv.innerHTML = '<i class="fas fa-check-circle"></i> –ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ! –ù–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–æ–∫: ' + rows.length;
                    
                } catch (error) {
                    resultDiv.className = 'task-result error';
                    resultDiv.innerHTML = '<i class="fas fa-times-circle"></i> –û—à–∏–±–∫–∞: ' + error.message;
                } finally {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-play"></i> –í—ã–ø–æ–ª–Ω–∏—Ç—å';
                }
            });
        });
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ –ë–î (–æ—Ç–≤–µ—Ç —Å–∫—Ä—ã—Ç –æ—Ç —É—á–µ–Ω–∏–∫–∞)
        document.querySelectorAll('.check-answer-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const taskBlock = this.closest('.task-block');
                const textarea = taskBlock.querySelector('.task-input');
                const resultDiv = taskBlock.querySelector('.task-result');
                const blockId = taskBlock.closest('[data-block-id]')?.getAttribute('data-block-id');
                const userAnswer = textarea.value.trim();
                
                if (userAnswer.length === 0) {
                    resultDiv.className = 'task-result error';
                    resultDiv.innerHTML = '<i class="fas fa-times-circle"></i> –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç';
                    return;
                }
                
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞...';
                
                try {
                    const response = await fetch('/api/tasks/check-answer', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            blockId: blockId,
                            blockType: 'SECTION',
                            answer: userAnswer
  })
});

                    const data = await response.json();
                    
                    if (data.success && data.correct) {
                        resultDiv.className = 'task-result success';
                        resultDiv.innerHTML = '<i class="fas fa-check-circle"></i> ' + (data.message || '–ü—Ä–∞–≤–∏–ª—å–Ω–æ! üéâ');
                    } else {
                        resultDiv.className = 'task-result error';
                        resultDiv.innerHTML = '<i class="fas fa-times-circle"></i> ' + (data.message || '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ');
                    }
                } catch (error) {
                    resultDiv.className = 'task-result error';
                    resultDiv.innerHTML = '<i class="fas fa-times-circle"></i> –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏';
                } finally {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-check"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å';
                }
            });
        });
        
        // Drag and Drop –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫
        const dropZone = document.getElementById('taskImageDropZone');
        const fileInput = document.getElementById('taskImageInput');
        const preview = document.getElementById('taskImagePreview');
        const previewImg = document.getElementById('previewImg');
        const removeBtn = document.getElementById('removeImageBtn');
        let uploadedImageFile = null;
        
        if (dropZone && fileInput) {
            dropZone.addEventListener('click', () => fileInput.click());
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#10b981';
                dropZone.style.background = '#dcfce7';
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.style.borderColor = '#a7f3d0';
                dropZone.style.background = '#f0fdf4';
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#a7f3d0';
                dropZone.style.background = '#f0fdf4';
                
                if (e.dataTransfer.files.length > 0) {
                    handleImageFile(e.dataTransfer.files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleImageFile(e.target.files[0]);
                }
            });
            
            function handleImageFile(file) {
                if (!file.type.startsWith('image/')) {
                    alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 5MB)');
                    return;
                }
                
                uploadedImageFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
            
            removeBtn?.addEventListener('click', () => {
                uploadedImageFile = null;
                preview.style.display = 'none';
                fileInput.value = '';
            });
        }
        
        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞
        document.getElementById('completeSectionBtn')?.addEventListener('click', async function() {
            const sectionId = this.getAttribute('data-section-id');
            
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            
            try {
                const response = await fetch(`/course/section/${sectionId}/complete`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    this.innerHTML = '<i class="fas fa-check-circle"></i> –†–∞–∑–¥–µ–ª –∑–∞–≤–µ—Ä—à—ë–Ω!';
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    this.innerHTML = '<i class="fas fa-times"></i> –û—à–∏–±–∫–∞';
                    this.disabled = false;
                }
            } catch (error) {
                this.innerHTML = '<i class="fas fa-times"></i> –û—à–∏–±–∫–∞';
                this.disabled = false;
            }
});
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–ª–æ–∫–∞ -->
<div class="modal-overlay" id="blockEditModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫</h3>
            <button class="close-btn" id="closeModalBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="blockEditForm">
                <input type="hidden" id="editBlockId" name="blockId">
                <input type="hidden" id="editBlockType" name="blockType">
                
                <div class="form-group">
                    <label>–¢–∏–ø –±–ª–æ–∫–∞</label>
                    <select id="editBlockTypeSelect" name="type" required>
                        <option value="TEXT">–¢–µ–∫—Å—Ç</option>
                        <option value="IMAGE">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</option>
                        <option value="SQL_TASK">–ó–∞–¥–∞–Ω–∏–µ</option>
                    </select>
                </div>
                
                <div class="form-group" id="editTitleField">
                    <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                    <input type="text" id="editTitle" name="title" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª–æ–∫–∞">
                </div>
                
                <div class="form-group" id="editTextField">
                    <label>–¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ</label>
                    <textarea id="editTextContent" name="textContent" rows="6" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..."></textarea>
                </div>
                
                <div class="form-group" id="editImageField" style="display: none;">
                    <label>URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
                    <input type="url" id="editImageUrl" name="imageUrl" placeholder="https://example.com/image.jpg">
                </div>
                
                <div class="form-group" id="editTaskField" style="display: none;">
                    <label>–¢–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è</label>
                    <textarea id="editTaskText" name="taskText" rows="4" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è..."></textarea>
                    
                    <label>–ù–∞—á–∞–ª—å–Ω—ã–π SQL –∫–æ–¥</label>
                    <textarea id="editInitialSql" name="initialSql" rows="3" placeholder="SELECT * FROM table;"></textarea>
                    
                    <label>–ö–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞–¥–∞–Ω–∏—è (drag & drop)</label>
                    <div id="editTaskImageDropZone" class="drop-zone">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É —Å—é–¥–∞ –∏–ª–∏ <span class="click-here">–Ω–∞–∂–º–∏—Ç–µ</span></p>
                        <input type="file" id="editTaskImageInput" accept="image/*" style="display: none;">
                    </div>
                    <div id="editTaskImagePreview" style="margin-top: 12px; display: none;">
                        <img id="editPreviewImg" style="max-width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <button type="button" id="editRemoveImageBtn" style="margin-top: 8px; padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            <i class="fas fa-times"></i> –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                    
                    <label>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç</label>
                    <input type="text" id="editCorrectAnswer" name="correctAnswer" placeholder="–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (–±—É–¥–µ—Ç —Å–∫—Ä—ã—Ç –æ—Ç —É—á–µ–Ω–∏–∫–∞)">
                    <p class="form-hint">
                        <i class="fas fa-lock"></i>
                        –û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î –∏ –Ω–µ –≤–∏–¥–µ–Ω –≤ –∫–æ–¥–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    </p>
                </div>
                
                <div class="form-group">
                    <label>–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</label>
                    <input type="number" id="editSortOrder" name="sortOrder" value="0" min="0">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" id="cancelEditBtn">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="btn-primary" id="saveBlockBtn">
                <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
        </div>
    </div>
</div>

</body>
</html>
