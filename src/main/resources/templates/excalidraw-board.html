<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brainify Board - Excalidraw</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß†</text></svg>">
    
    <!-- Excalidraw CSS -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            overflow: hidden;
            background: #f8f9fa;
        }
        
        .app-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .top-bar {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .lesson-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .lesson-title {
            font-weight: 600;
            color: #495057;
            font-size: 16px;
        }
        
        .user-info {
            font-size: 14px;
            color: #6c757d;
        }
        
        .controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .btn {
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn:hover {
            background: #f8f9fa;
            border-color: #adb5bd;
        }
        
        .btn-primary {
            background: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }
        
        .btn-primary:hover {
            background: #0b5ed7;
            border-color: #0a58ca;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
            border-color: #bd2130;
        }
        
        .excalidraw-container {
            flex: 1;
            position: relative;
        }
        
        .status-indicator {
            position: fixed;
            top: 60px;
            right: 16px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 200;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-connected {
            background: rgba(40, 167, 69, 0.9);
        }
        
        .status-disconnected {
            background: rgba(220, 53, 69, 0.9);
        }
        
        .status-connecting {
            background: rgba(255, 193, 7, 0.9);
            color: #212529;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .pulse {
            animation: pulse 1s infinite;
        }
        
        .users-online {
            position: fixed;
            top: 60px;
            left: 16px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 200;
            max-width: 300px;
        }
        
        .user-avatar {
            display: inline-block;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            text-align: center;
            line-height: 24px;
            font-size: 12px;
            margin-right: 4px;
            vertical-align: middle;
        }
        
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        .toast.error {
            background: rgba(220, 53, 69, 0.9);
        }
        
        .toast.success {
            background: rgba(40, 167, 69, 0.9);
        }
        
        .toast.warning {
            background: rgba(255, 193, 7, 0.9);
            color: #212529;
        }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π UI Excalidraw –¥–ª—è —á–∏—Å—Ç–æ–≥–æ –≤–∏–¥–∞ */
        .excalidraw .App-menu_top {
            display: none !important;
        }
        
        .excalidraw .App-toolbar {
            top: 60px !important;
        }
        
        /* –ö–∞—Å—Ç–æ–º–Ω–∞—è –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ */
        .custom-toolbar {
            position: fixed;
            left: 16px;
            top: 120px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 12px;
            z-index: 150;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: calc(100vh - 160px);
            overflow-y: auto;
        }
        
        .toolbar-section {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 6px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .toolbar-section:last-child {
            border-bottom: none;
        }
        
        .toolbar-section-title {
            font-size: 12px;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 4px;
        }
        
        .tool-btn {
            width: 40px;
            height: 40px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
            position: relative;
        }
        
        .tool-btn:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }
        
        .tool-btn.active {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }
        
        .tool-btn-group {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        
        .color-btn {
            width: 32px;
            height: 32px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .color-btn:hover {
            transform: scale(1.1);
            border-color: #495057;
        }
        
        .color-btn.active {
            border-color: #007bff;
            transform: scale(1.1);
        }
        
        .color-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
            border-radius: 4px;
            background: var(--color);
        }
        
        .size-slider {
            width: 100px;
            margin: 8px 0;
        }
        
        .size-display {
            text-align: center;
            font-size: 12px;
            color: #6c757d;
            margin-top: 4px;
        }
        
        .opacity-slider {
            width: 100px;
            margin: 8px 0;
        }
        
        .shape-btn {
            width: 36px;
            height: 36px;
            border: 2px solid #e9ecef;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .shape-btn:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }
        
        .shape-btn.active {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
        <div class="top-bar">
            <div class="lesson-info">
                <div class="lesson-title" id="lessonTitle">
                    üß† Brainify Board
                </div>
                <div class="user-info" id="userInfo">
                    –ó–∞–≥—Ä—É–∑–∫–∞...
                </div>
            </div>
            
            <div class="controls">
                <button class="btn" id="saveBtn">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button class="btn" id="exportBtn">
                    üì§ –≠–∫—Å–ø–æ—Ä—Ç
                </button>
                <button class="btn" id="shareBtn">
                    üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                </button>
                <button class="btn btn-danger" id="endLessonBtn" style="display: none;">
                    üö™ –ó–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫
                </button>
            </div>
        </div>
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è Excalidraw -->
        <div class="excalidraw-container" id="excalidraw-container">
            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div id="loading-indicator" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: #f8f9fa; color: #6c757d;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                    <div style="width: 24px; height: 24px; border: 3px solid #e9ecef; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <span id="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫...</span>
                </div>
                <div id="loading-details" style="font-size: 12px; color: #adb5bd; text-align: center; max-width: 400px;">
                    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–æ—Å–∫–∏
                </div>
            </div>
        </div>
        
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
        
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
        <div class="status-indicator status-connecting pulse" id="statusIndicator">
            üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...
        </div>
        
        <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–Ω–ª–∞–π–Ω -->
        <div class="users-online" id="usersOnline" style="display: none;">
            üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–Ω–ª–∞–π–Ω: <span id="usersList"></span>
        </div>
        
        <!-- –ö–∞—Å—Ç–æ–º–Ω–∞—è –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
        <div class="custom-toolbar" id="customToolbar">
            <!-- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∏—Å–æ–≤–∞–Ω–∏—è -->
            <div class="toolbar-section">
                <div class="toolbar-section-title">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
                <div class="tool-btn-group">
                    <button class="tool-btn active" id="tool-select" data-tool="selection" title="–í—ã–±–æ—Ä">
                        üîß
                    </button>
                    <button class="tool-btn" id="tool-pen" data-tool="freedraw" title="–ö–∞—Ä–∞–Ω–¥–∞—à">
                        ‚úèÔ∏è
                    </button>
                    <button class="tool-btn" id="tool-eraser" data-tool="eraser" title="–õ–∞—Å—Ç–∏–∫">
                        üßΩ
                    </button>
                    <button class="tool-btn" id="tool-text" data-tool="text" title="–¢–µ–∫—Å—Ç">
                        üìù
                    </button>
                </div>
            </div>
            
            <!-- –§–∏–≥—É—Ä—ã -->
            <div class="toolbar-section">
                <div class="toolbar-section-title">–§–∏–≥—É—Ä—ã</div>
                <div class="tool-btn-group">
                    <button class="shape-btn" id="shape-rectangle" data-tool="rectangle" title="–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫">
                        ‚¨ú
                    </button>
                    <button class="shape-btn" id="shape-ellipse" data-tool="ellipse" title="–≠–ª–ª–∏–ø—Å">
                        ‚≠ï
                    </button>
                    <button class="shape-btn" id="shape-arrow" data-tool="arrow" title="–°—Ç—Ä–µ–ª–∫–∞">
                        ‚û°Ô∏è
                    </button>
                    <button class="shape-btn" id="shape-line" data-tool="line" title="–õ–∏–Ω–∏—è">
                        üìè
                    </button>
                </div>
            </div>
            
            <!-- –¶–≤–µ—Ç–∞ -->
            <div class="toolbar-section">
                <div class="toolbar-section-title">–¶–≤–µ—Ç</div>
                <div class="tool-btn-group">
                    <button class="color-btn active" data-color="#000000" style="--color: #000000" title="–ß–µ—Ä–Ω—ã–π"></button>
                    <button class="color-btn" data-color="#e03131" style="--color: #e03131" title="–ö—Ä–∞—Å–Ω—ã–π"></button>
                    <button class="color-btn" data-color="#2f9e44" style="--color: #2f9e44" title="–ó–µ–ª–µ–Ω—ã–π"></button>
                    <button class="color-btn" data-color="#1971c2" style="--color: #1971c2" title="–°–∏–Ω–∏–π"></button>
                    <button class="color-btn" data-color="#f08c00" style="--color: #f08c00" title="–û—Ä–∞–Ω–∂–µ–≤—ã–π"></button>
                    <button class="color-btn" data-color="#7c3aed" style="--color: #7c3aed" title="–§–∏–æ–ª–µ—Ç–æ–≤—ã–π"></button>
                    <button class="color-btn" data-color="#ffd43b" style="--color: #ffd43b" title="–ñ–µ–ª—Ç—ã–π"></button>
                    <button class="color-btn" data-color="#e64980" style="--color: #e64980" title="–†–æ–∑–æ–≤—ã–π"></button>
                </div>
            </div>
            
            <!-- –†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏ -->
            <div class="toolbar-section">
                <div class="toolbar-section-title">–†–∞–∑–º–µ—Ä</div>
                <input type="range" class="size-slider" id="strokeWidth" min="1" max="20" value="2">
                <div class="size-display" id="sizeDisplay">2px</div>
            </div>
            
            <!-- –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å -->
            <div class="toolbar-section">
                <div class="toolbar-section-title">–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å</div>
                <input type="range" class="opacity-slider" id="opacity" min="10" max="100" value="100">
                <div class="size-display" id="opacityDisplay">100%</div>
            </div>
            
            <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã -->
            <div class="toolbar-section">
                <div class="toolbar-section-title">–î–µ–π—Å—Ç–≤–∏—è</div>
                <div class="tool-btn-group">
                    <button class="tool-btn" id="clear-canvas" title="–û—á–∏—Å—Ç–∏—Ç—å –¥–æ—Å–∫—É">
                        üóëÔ∏è
                    </button>
                    <button class="tool-btn" id="undo" title="–û—Ç–º–µ–Ω–∏—Ç—å">
                        ‚Ü∂
                    </button>
                    <button class="tool-btn" id="redo" title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å">
                        ‚Ü∑
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- React –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Excalidraw CSS - –∏—Å–ø–æ–ª—å–∑—É–µ–º jsDelivr –∫–∞–∫ –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@excalidraw/excalidraw@0.17.0/dist/excalidraw.css" onerror="console.warn('CSS loading failed, using inline styles')">
    
    <!-- Import maps –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://unpkg.com/react@18/umd/react.production.min.js",
                "react-dom": "https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
            }
        }
    </script>
    
    <!-- Excalidraw —á–µ—Ä–µ–∑ ESM —Å fallback -->
    <script type="module">
        try {
            // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é
            console.log('üì¶ Loading Excalidraw via ESM...');
            const ExcalidrawModule = await import('https://unpkg.com/@excalidraw/excalidraw@0.17.0/dist/excalidraw.production.min.js');
            window.ExcalidrawLib = ExcalidrawModule;
            console.log('‚úÖ Excalidraw loaded via ESM:', ExcalidrawModule);
        } catch (esmError) {
            console.warn('‚ö†Ô∏è ESM loading failed:', esmError);
            
            // Fallback: –ø—Ä–æ–±—É–µ–º —Å—Ç–∞—Ä—É—é UMD –≤–µ—Ä—Å–∏—é
            try {
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/@excalidraw/excalidraw@0.15.0/dist/excalidraw.production.min.js';
                script.onload = () => {
                    console.log('‚úÖ Excalidraw loaded via UMD fallback');
                };
                script.onerror = () => {
                    console.warn('‚ö†Ô∏è UMD fallback also failed');
                };
                document.head.appendChild(script);
            } catch (umdError) {
                console.error('‚ùå All Excalidraw loading methods failed');
            }
        }
    </script>
    
    <!-- Fallback –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤ –±–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ import maps -->
    <script nomodule>
        console.log('üì¶ Loading Excalidraw for legacy browsers...');
        
        function loadExcalidrawLegacy() {
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/@excalidraw/excalidraw@0.15.0/dist/excalidraw.production.min.js';
            script.onload = () => {
                console.log('‚úÖ Excalidraw loaded for legacy browser');
            };
            script.onerror = () => {
                console.warn('‚ö†Ô∏è Legacy Excalidraw loading failed');
            };
            document.head.appendChild(script);
        }
        
        loadExcalidrawLegacy();
    </script>
    
    <!-- WebSocket –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    
    <script th:inline="javascript">
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Thymeleaf
        const lessonData = /*[[${lesson}]]*/ null;
        const currentUser = /*[[${currentUser}]]*/ null;
        const isTeacher = /*[[${isTeacher}]]*/ false;
        const isAdmin = /*[[${isAdmin}]]*/ false;
        const isViewOnly = /*[[${isViewOnly}]]*/ false;
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º ID —É—Ä–æ–∫–∞
        const urlParams = new URLSearchParams(window.location.search);
        const lessonIdFromUrl = urlParams.get('lessonId');
        const lessonId = lessonData ? lessonData.id : (lessonIdFromUrl || 'demo');
        
        console.log('üé® Excalidraw Board Initialization');
        console.log('Lesson ID:', lessonId);
        console.log('Current User:', currentUser);
        console.log('Is Teacher:', isTeacher);
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let excalidrawAPI = null;
        let stompClient = null;
        let isConnected = false;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let connectedUsers = new Map();
        let collaborationState = {
            isOwner: isTeacher || isAdmin,
            roomId: lessonId,
            userId: currentUser ? currentUser.id.toString() : Math.random().toString(36).substr(2, 9),
            userName: currentUser ? currentUser.name : '–ì–æ—Å—Ç—å'
        };
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        let currentTool = 'selection';
        let currentColor = '#000000';
        let currentStrokeWidth = 2;
        let currentOpacity = 100;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI
        function initializeUI() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Ä–æ–∫–µ
            if (lessonData) {
                document.getElementById('lessonTitle').textContent = 
                    `${lessonData.subject?.name || '–ü—Ä–µ–¥–º–µ—Ç'} - ${lessonData.student?.name || '–£—á–µ–Ω–∏–∫'}`;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            const userInfo = document.getElementById('userInfo');
            if (currentUser) {
                const roleText = isTeacher ? '–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å' : isAdmin ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–£—á–µ–Ω–∏–∫';
                userInfo.textContent = `${currentUser.name} (${roleText})`;
            } else {
                userInfo.textContent = '–ì–æ—Å—Ç—å';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
            if (isTeacher || isAdmin) {
                document.getElementById('endLessonBtn').style.display = 'block';
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            if (isViewOnly) {
                document.querySelectorAll('.btn:not(#shareBtn)').forEach(btn => {
                    btn.style.display = 'none';
                });
            }
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
        function updateLoadingStatus(text, details = '') {
            const loadingText = document.getElementById('loading-text');
            const loadingDetails = document.getElementById('loading-details');
            if (loadingText) loadingText.textContent = text;
            if (loadingDetails) loadingDetails.textContent = details;
        }
        
        function hideLoadingIndicator() {
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏
        function initializeToolbar() {
            console.log('üîß Initializing custom toolbar...');
            
            // –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∏—Å–æ–≤–∞–Ω–∏—è
            document.querySelectorAll('[data-tool]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tool = btn.dataset.tool;
                    setActiveTool(tool);
                    updateExcalidrawTool(tool);
                });
            });
            
            // –¶–≤–µ—Ç–∞
            document.querySelectorAll('[data-color]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const color = btn.dataset.color;
                    setActiveColor(color);
                    updateExcalidrawColor(color);
                });
            });
            
            // –†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏
            const strokeWidthSlider = document.getElementById('strokeWidth');
            strokeWidthSlider.addEventListener('input', (e) => {
                const width = parseInt(e.target.value);
                currentStrokeWidth = width;
                document.getElementById('sizeDisplay').textContent = width + 'px';
                updateExcalidrawStrokeWidth(width);
            });
            
            // –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
            const opacitySlider = document.getElementById('opacity');
            opacitySlider.addEventListener('input', (e) => {
                const opacity = parseInt(e.target.value);
                currentOpacity = opacity;
                document.getElementById('opacityDisplay').textContent = opacity + '%';
                updateExcalidrawOpacity(opacity);
            });
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
            document.getElementById('clear-canvas').addEventListener('click', clearCanvas);
            document.getElementById('undo').addEventListener('click', undo);
            document.getElementById('redo').addEventListener('click', redo);
            
            console.log('‚úÖ Toolbar initialized');
        }
        
        function setActiveTool(tool) {
            currentTool = tool;
            
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
            document.querySelectorAll('.tool-btn, .shape-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É
            const activeBtn = document.querySelector(`[data-tool="${tool}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }
        
        function setActiveColor(color) {
            currentColor = color;
            
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —Ü–≤–µ—Ç–æ–≤
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ü–≤–µ—Ç—É
            const activeBtn = document.querySelector(`[data-color="${color}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }
        
        function updateExcalidrawTool(tool) {
            if (!excalidrawAPI) return;
            
            try {
                // Mapping –Ω–∞—à–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∫ Excalidraw –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º
                const toolMapping = {
                    'selection': 'selection',
                    'freedraw': 'freedraw',
                    'eraser': 'eraser',
                    'text': 'text',
                    'rectangle': 'rectangle',
                    'ellipse': 'ellipse',
                    'arrow': 'arrow',
                    'line': 'line'
                };
                
                const excalidrawTool = toolMapping[tool] || tool;
                
                const appState = {
                    activeTool: {
                        type: excalidrawTool
                    }
                };
                
                excalidrawAPI.updateScene({ appState });
                console.log('üîß Tool changed to:', excalidrawTool);
            } catch (error) {
                console.warn('‚ö†Ô∏è Tool update error:', error);
            }
        }
        
        function updateExcalidrawColor(color) {
            if (!excalidrawAPI) return;
            
            try {
                const appState = {
                    currentItemStrokeColor: color,
                    currentItemBackgroundColor: color === '#000000' ? 'transparent' : color
                };
                
                excalidrawAPI.updateScene({ appState });
                console.log('üé® Color changed to:', color);
            } catch (error) {
                console.warn('‚ö†Ô∏è Color update error:', error);
            }
        }
        
        function updateExcalidrawStrokeWidth(width) {
            if (!excalidrawAPI) return;
            
            try {
                const appState = {
                    currentItemStrokeWidth: width
                };
                
                excalidrawAPI.updateScene({ appState });
                console.log('üìè Stroke width changed to:', width);
            } catch (error) {
                console.warn('‚ö†Ô∏è Stroke width update error:', error);
            }
        }
        
        function updateExcalidrawOpacity(opacity) {
            if (!excalidrawAPI) return;
            
            try {
                // Excalidraw –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –æ—Ç 0 –¥–æ 100, –Ω–æ –∏–Ω–æ–≥–¥–∞ –æ—Ç 0 –¥–æ 1
                const normalizedOpacity = opacity / 100;
                
                const appState = {
                    currentItemOpacity: normalizedOpacity
                };
                
                excalidrawAPI.updateScene({ appState });
                console.log('üëª Opacity changed to:', normalizedOpacity);
            } catch (error) {
                console.warn('‚ö†Ô∏è Opacity update error:', error);
            }
        }
        
        function clearCanvas() {
            if (!excalidrawAPI) return;
            
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –¥–æ—Å–∫—É?')) {
                try {
                    excalidrawAPI.updateScene({ elements: [] });
                    console.log('üóëÔ∏è Canvas cleared');
                    showToast('–î–æ—Å–∫–∞ –æ—á–∏—â–µ–Ω–∞', 'success');
                } catch (error) {
                    console.error('‚ùå Clear canvas error:', error);
                    showToast('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –¥–æ—Å–∫–∏', 'error');
                }
            }
        }
        
        function undo() {
            if (!excalidrawAPI) return;
            
            try {
                // Excalidraw –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø—Ä—è–º–æ–π –º–µ—Ç–æ–¥ undo, —Å–∏–º—É–ª–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ keyboard event
                const event = new KeyboardEvent('keydown', {
                    key: 'z',
                    ctrlKey: true,
                    bubbles: true
                });
                document.querySelector('.excalidraw-container').dispatchEvent(event);
                console.log('‚Ü∂ Undo triggered');
            } catch (error) {
                console.warn('‚ö†Ô∏è Undo error:', error);
            }
        }
        
        function redo() {
            if (!excalidrawAPI) return;
            
            try {
                // –°–∏–º—É–ª–∏—Ä—É–µ–º Ctrl+Shift+Z –¥–ª—è redo
                const event = new KeyboardEvent('keydown', {
                    key: 'z',
                    ctrlKey: true,
                    shiftKey: true,
                    bubbles: true
                });
                document.querySelector('.excalidraw-container').dispatchEvent(event);
                console.log('‚Ü∑ Redo triggered');
            } catch (error) {
                console.warn('‚ö†Ô∏è Redo error:', error);
            }
        }
        
        function syncToolbarWithExcalidraw(appState) {
            if (!appState) return;
            
            try {
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
                if (appState.activeTool && appState.activeTool.type !== currentTool) {
                    setActiveTool(appState.activeTool.type);
                }
                
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Ü–≤–µ—Ç
                if (appState.currentItemStrokeColor && appState.currentItemStrokeColor !== currentColor) {
                    setActiveColor(appState.currentItemStrokeColor);
                }
                
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏
                if (appState.currentItemStrokeWidth && appState.currentItemStrokeWidth !== currentStrokeWidth) {
                    currentStrokeWidth = appState.currentItemStrokeWidth;
                    const slider = document.getElementById('strokeWidth');
                    if (slider) {
                        slider.value = currentStrokeWidth;
                        document.getElementById('sizeDisplay').textContent = currentStrokeWidth + 'px';
                    }
                }
                
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
                if (appState.currentItemOpacity !== undefined) {
                    const opacity = Math.round(appState.currentItemOpacity * 100);
                    if (opacity !== currentOpacity) {
                        currentOpacity = opacity;
                        const slider = document.getElementById('opacity');
                        if (slider) {
                            slider.value = currentOpacity;
                            document.getElementById('opacityDisplay').textContent = currentOpacity + '%';
                        }
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Toolbar sync error:', error);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è Java toString –≤ JSON
        function parseJavaToStringToJSON(javaString) {
            try {
                console.log('üîß Processing Java toString format...');
                
                // –ó–∞–º–µ–Ω—è–µ–º Java —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –Ω–∞ JSON
                let jsonString = javaString
                    // –ó–∞–º–µ–Ω—è–µ–º = –Ω–∞ :
                    .replace(/(\w+)=/g, '"$1":')
                    // –ó–∞–º–µ–Ω—è–µ–º [ –Ω–∞ [
                    .replace(/\[/g, '[')
                    // –ó–∞–º–µ–Ω—è–µ–º ] –Ω–∞ ]
                    .replace(/\]/g, ']')
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–≤—ã—á–∫–∏ –∫ —Å—Ç—Ä–æ–∫–æ–≤—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º
                    .replace(/:([^,\]\}]+)/g, (match, value) => {
                        value = value.trim();
                        // –ï—Å–ª–∏ —ç—Ç–æ —á–∏—Å–ª–æ, boolean –∏–ª–∏ null, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
                        if (value === 'null' || value === 'true' || value === 'false' || !isNaN(value)) {
                            return ':' + value;
                        }
                        // –ï—Å–ª–∏ —É–∂–µ –≤ –∫–∞–≤—ã—á–∫–∞—Ö, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
                        if (value.startsWith('"') && value.endsWith('"')) {
                            return ':' + value;
                        }
                        // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–≤—ã—á–∫–∏
                        return ':"' + value + '"';
                    })
                    // –ó–∞–º–µ–Ω—è–µ–º { –Ω–∞ {
                    .replace(/\{/g, '{')
                    // –ó–∞–º–µ–Ω—è–µ–º } –Ω–∞ }
                    .replace(/\}/g, '}');
                
                console.log('üîß Converted string preview:', jsonString.substring(0, 200) + '...');
                
                return JSON.parse(jsonString);
            } catch (error) {
                console.error('‚ùå Java toString conversion failed:', error);
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –µ—Å–ª–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å
                return {
                    elements: [],
                    appState: { viewBackgroundColor: "#ffffff" },
                    files: {}
                };
            }
        }
        
        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
        function saveBoardState() {
            if (!excalidrawAPI) return;
            
            try {
                const elements = excalidrawAPI.getSceneElements();
                const appState = excalidrawAPI.getAppState();
                const files = excalidrawAPI.getFiles();
                
                // –°–æ–∑–¥–∞–µ–º snapshot —Å–æ—Å—Ç–æ—è–Ω–∏—è
                const boardSnapshot = {
                    elements: elements || [],
                    appState: {
                        viewBackgroundColor: appState?.viewBackgroundColor || "#ffffff",
                        currentItemStrokeColor: appState?.currentItemStrokeColor || "#000000",
                        currentItemBackgroundColor: appState?.currentItemBackgroundColor || "transparent",
                        currentItemFillStyle: appState?.currentItemFillStyle || "hachure",
                        currentItemStrokeWidth: appState?.currentItemStrokeWidth || 1,
                        currentItemStrokeStyle: appState?.currentItemStrokeStyle || "solid",
                        currentItemRoughness: appState?.currentItemRoughness || 1,
                        currentItemOpacity: appState?.currentItemOpacity || 100,
                        currentItemFontFamily: appState?.currentItemFontFamily || 1,
                        currentItemFontSize: appState?.currentItemFontSize || 20,
                        currentItemTextAlign: appState?.currentItemTextAlign || "left",
                        currentItemStartArrowhead: appState?.currentItemStartArrowhead || null,
                        currentItemEndArrowhead: appState?.currentItemEndArrowhead || "arrow",
                        scrollX: appState?.scrollX || 0,
                        scrollY: appState?.scrollY || 0,
                        zoom: appState?.zoom || { value: 1 }
                    },
                    files: files || {}
                };
                
                console.log('üíæ Saving board state with', elements?.length || 0, 'elements');
                
                if (lessonId === 'demo') {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –¥–µ–º–æ
                    localStorage.setItem(`excalidraw_${lessonId}`, JSON.stringify(boardSnapshot));
                } else {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    saveBoardToServerImproved(boardSnapshot);
                }
                
            } catch (error) {
                console.error('‚ùå Error saving board state:', error);
            }
        }
        
        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function saveBoardToServerImproved(boardData) {
            try {
                const response = await fetch('/api/excalidraw/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        lessonId: lessonId.toString(),
                        content: JSON.stringify(boardData) // –î–≤–æ–π–Ω–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                console.log('‚úÖ Board state saved to server');
            } catch (error) {
                console.error('‚ùå Failed to save board state to server:', error);
                // Fallback: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                localStorage.setItem(`excalidraw_backup_${lessonId}`, JSON.stringify(boardData));
                console.log('üíæ Saved to localStorage as backup');
            }
        }
        
        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        function startPeriodicAutoSave() {
            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(() => {
                if (excalidrawAPI && lessonId !== 'demo') {
                    const elements = excalidrawAPI.getSceneElements();
                    if (elements && elements.length > 0) {
                        console.log('‚è∞ Periodic auto-save triggered');
                        saveBoardState();
                    }
                }
            }, 30000); // 30 —Å–µ–∫—É–Ω–¥
            
            console.log('‚è∞ Periodic auto-save started (every 30 seconds)');
        }
        
        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function setupBeforeUnloadHandlers() {
            window.addEventListener('beforeunload', async (e) => {
                if (excalidrawAPI) {
                    try {
                        console.log('üíæ Saving on page unload...');
                        
                        // –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage –∫–∞–∫ backup
                        const elements = excalidrawAPI.getSceneElements();
                        const appState = excalidrawAPI.getAppState();
                        const files = excalidrawAPI.getFiles();
                        
                        if (elements && elements.length > 0) {
                            const boardData = {
                                elements: elements,
                                appState: appState,
                                files: files,
                                timestamp: Date.now()
                            };
                            
                            localStorage.setItem(`excalidraw_emergency_${lessonId}`, JSON.stringify(boardData));
                            
                            // –ü—Ä–æ–±—É–µ–º –±—ã—Å—Ç—Ä–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                            if (lessonId !== 'demo') {
                                navigator.sendBeacon('/api/excalidraw/save', 
                                    JSON.stringify({
                                        lessonId: lessonId.toString(),
                                        content: JSON.stringify(boardData)
                                    })
                                );
                            }
                        }
                    } catch (error) {
                        console.error('‚ùå Error during page unload save:', error);
                    }
                }
                
                // –û—Ç–∫–ª—é—á–∞–µ–º—Å—è –æ—Ç WebSocket
                if (stompClient && isConnected) {
                    try {
                        stompClient.send(`/app/excalidraw/${lessonId}/leave`, {}, JSON.stringify({
                            lessonId: lessonId,
                            userId: collaborationState.userId,
                            userName: collaborationState.userName
                        }));
                    } catch (error) {
                        console.warn('‚ö†Ô∏è WebSocket disconnect error:', error);
                    }
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && excalidrawAPI) {
                    console.log('üíæ Saving on page hide...');
                    saveBoardState();
                }
            });
            
            console.log('üîß Before unload handlers setup complete');
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Excalidraw
        async function initializeExcalidraw() {
            console.log('üé® Initializing real Excalidraw...');
            
            try {
                const container = document.getElementById('excalidraw-container');
                
                // –ü—Ä–æ–±—É–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–π Excalidraw, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è - –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
                try {
                    console.log('‚è≥ Waiting for Excalidraw library...');
                    updateLoadingStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Excalidraw...', '–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏–∑ CDN');
                    await waitForExcalidrawLibrary();
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—Å—Ç–æ—è—â–∏–π Excalidraw
                    const ExcalidrawLib = window.ExcalidrawLib || window.Excalidraw;
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º ESM –∏ UMD)
                    let Excalidraw, exportToCanvas;
                    
                    // ESM –º–æ–¥—É–ª—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
                    if (ExcalidrawLib?.default?.Excalidraw) {
                        Excalidraw = ExcalidrawLib.default.Excalidraw;
                        exportToCanvas = ExcalidrawLib.default.exportToCanvas || ExcalidrawLib.exportToCanvas;
                    }
                    // ESM –ø—Ä—è–º–æ–π —ç–∫—Å–ø–æ—Ä—Ç
                    else if (ExcalidrawLib?.Excalidraw) {
                        Excalidraw = ExcalidrawLib.Excalidraw;
                        exportToCanvas = ExcalidrawLib.exportToCanvas;
                    }
                    // UMD —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
                    else if (window.Excalidraw?.Excalidraw) {
                        Excalidraw = window.Excalidraw.Excalidraw;
                        exportToCanvas = window.Excalidraw.exportToCanvas;
                    }
                    // –ï—Å–ª–∏ —Å–∞–º–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —è–≤–ª—è–µ—Ç—Å—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º (—Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏)
                    else if (typeof ExcalidrawLib === 'function') {
                        Excalidraw = ExcalidrawLib;
                        exportToCanvas = window.exportToCanvas;
                    }
                    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –∫–∞–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
                    else if (typeof window.Excalidraw === 'function') {
                        Excalidraw = window.Excalidraw;
                        exportToCanvas = window.exportToCanvas;
                    }
                    
                    console.log('‚úÖ Found Excalidraw library, initializing...', {
                        hasExcalidraw: !!Excalidraw,
                        hasExportToCanvas: !!exportToCanvas,
                        libType: typeof ExcalidrawLib,
                        libStructure: {
                            hasDefault: !!(ExcalidrawLib?.default),
                            hasExcalidrawProp: !!(ExcalidrawLib?.Excalidraw),
                            globalExcalidrawType: typeof window.Excalidraw
                        }
                    });
                    
                    if (!Excalidraw) {
                        console.error('‚ùå Excalidraw component detection failed');
                        console.log('Available structure:', {
                            ExcalidrawLib: ExcalidrawLib,
                            windowExcalidraw: window.Excalidraw,
                            allWindowProps: Object.keys(window).filter(k => k.toLowerCase().includes('excalidraw'))
                        });
                        throw new Error('–ö–æ–º–ø–æ–Ω–µ–Ω—Ç Excalidraw –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ');
                    }
                    
                    updateLoadingStatus('–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –¥–æ—Å–∫–∏...', '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ Excalidraw');
                    
                    // –°–æ–∑–¥–∞–µ–º React-—ç–ª–µ–º–µ–Ω—Ç Excalidraw
                    const excalidrawElement = React.createElement(Excalidraw, {
                        initialData: {
                            elements: [],
                            appState: { viewBackgroundColor: "#ffffff" }
                        },
                        onChange: (elements, appState, files) => {
                            handleExcalidrawChange(elements, appState, files);
                            syncToolbarWithExcalidraw(appState);
                        },
                        ref: (api) => {
                            if (api) {
                                excalidrawAPI = api;
                                console.log('‚úÖ Excalidraw API ready');
                                updateLoadingStatus('–î–æ—Å–∫–∞ –≥–æ—Ç–æ–≤–∞!', '–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è...');
                            }
                        }
                    });
                    
                    // –†–µ–Ω–¥–µ—Ä–∏–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                    ReactDOM.render(excalidrawElement, container);
                    
                } catch (libraryError) {
                    console.warn('‚ö†Ô∏è Excalidraw library failed, using fallback:', libraryError);
                    throw libraryError; // –ü–µ—Ä–µ–¥–∞–µ–º –æ—à–∏–±–∫—É –≤ –æ—Å–Ω–æ–≤–Ω–æ–π catch
                }
                
                console.log('‚úÖ Real Excalidraw initialized successfully');
                
                // –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ API
                await waitForExcalidrawAPI();
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                hideLoadingIndicator();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
                initializeToolbar();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                await loadSavedBoard();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WebSocket –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã
                if (lessonId !== 'demo') {
                    initializeWebSocket();
                }
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                startPeriodicAutoSave();
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
                setupBeforeUnloadHandlers();
                
                // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã (–¥–ª—è —Å–ª—É—á–∞–µ–≤ –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)
                setTimeout(async () => {
                    if (excalidrawAPI) {
                        const currentElements = excalidrawAPI.getSceneElements();
                        if (!currentElements || currentElements.length === 0) {
                            console.log('üîÑ Retrying board state load...');
                            await loadSavedBoard();
                        }
                    }
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Excalidraw initialization error:', error);
                showToast('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–æ—Å–∫–∏: ' + error.message, 'error');
                
                // Fallback –∫ –ø—Ä–æ—Å—Ç–æ–º—É canvas
                await initializeFallbackCanvas();
            }
        }
        
        // –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Excalidraw
        function waitForExcalidrawLibrary() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 300; // 30 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
                
                const check = () => {
                    attempts++;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Excalidraw
                    const excalidrawLibDirect = window.ExcalidrawLib;
                    const excalidrawGlobal = window.Excalidraw;
                    const reactAvailable = window.React;
                    const reactDOMAvailable = window.ReactDOM;
                    
                    // –ë–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã Excalidraw
                    let excalidrawComponentFound = false;
                    
                    if (excalidrawLibDirect) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º ESM —Å—Ç—Ä—É–∫—Ç—É—Ä—É
                        if (excalidrawLibDirect.Excalidraw || excalidrawLibDirect.default?.Excalidraw) {
                            excalidrawComponentFound = true;
                        }
                    }
                    
                    if (excalidrawGlobal) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º UMD —Å—Ç—Ä—É–∫—Ç—É—Ä—É
                        if (typeof excalidrawGlobal === 'function' || excalidrawGlobal.Excalidraw) {
                            excalidrawComponentFound = true;
                        }
                    }
                    
                    if (attempts % 10 === 0) { // –õ–æ–≥–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
                        console.log(`Attempt ${attempts}: ExcalidrawLib=${!!excalidrawLibDirect}, Excalidraw=${!!excalidrawGlobal}, Component=${excalidrawComponentFound}, React=${!!reactAvailable}, ReactDOM=${!!reactDOMAvailable}`);
                    }
                    
                    if (excalidrawComponentFound && reactAvailable && reactDOMAvailable) {
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è
                        if (!window.ExcalidrawLib && window.Excalidraw) {
                            window.ExcalidrawLib = window.Excalidraw;
                        }
                        
                        console.log('‚úÖ Excalidraw library is ready with components');
                        console.log('Library structure:', {
                            ExcalidrawLib: window.ExcalidrawLib,
                            hasDefaultExport: !!(excalidrawLibDirect?.default),
                            hasExcalidrawProp: !!(excalidrawLibDirect?.Excalidraw || excalidrawGlobal?.Excalidraw)
                        });
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        console.error('‚ùå Excalidraw library failed to load after', maxAttempts, 'attempts');
                        console.log('Available libraries:', {
                            ExcalidrawLib: !!window.ExcalidrawLib,
                            ExcalidrawLibType: typeof window.ExcalidrawLib,
                            Excalidraw: !!window.Excalidraw,
                            ExcalidrawType: typeof window.Excalidraw,
                            React: !!window.React,
                            ReactDOM: !!window.ReactDOM,
                            componentFound: excalidrawComponentFound
                        });
                        reject(new Error('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Excalidraw –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ø–æ—Å–ª–µ ' + maxAttempts + ' –ø–æ–ø—ã—Ç–æ–∫'));
                    } else {
                        setTimeout(check, 100);
                    }
                };
                
                check();
            });
        }
        
        // Fallback: –ø—Ä–æ—Å—Ç–æ–π canvas –µ—Å–ª–∏ Excalidraw –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
        async function initializeFallbackCanvas() {
            console.log('üîß Initializing fallback canvas...');
            updateLoadingStatus('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Å—Ç–æ–π –¥–æ—Å–∫–∏...', 'Excalidraw –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback');
            
            const container = document.getElementById('excalidraw-container');
            container.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            
            // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é canvas-–¥–æ—Å–∫—É
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º canvas
                canvas.width = container.offsetWidth || 800;
                canvas.height = container.offsetHeight || 600;
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                canvas.style.border = '1px solid #ddd';
                canvas.style.cursor = 'crosshair';
                canvas.style.backgroundColor = '#ffffff';
                
                container.appendChild(canvas);
                
                // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
                let isDrawing = false;
                let lastX = 0;
                let lastY = 0;
                
                canvas.addEventListener('mousedown', (e) => {
                    isDrawing = true;
                    [lastX, lastY] = [e.offsetX, e.offsetY];
                });
                
                canvas.addEventListener('mousemove', (e) => {
                    if (!isDrawing) return;
                    
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(e.offsetX, e.offsetY);
                    ctx.strokeStyle = '#000000';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    [lastX, lastY] = [e.offsetX, e.offsetY];
                });
                
                canvas.addEventListener('mouseup', () => {
                    isDrawing = false;
                });
                
                // –°–æ–∑–¥–∞–µ–º API –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                excalidrawAPI = {
                    canvas: canvas,
                    ctx: ctx,
                    getSceneElements: () => [],
                    getAppState: () => ({ viewBackgroundColor: '#ffffff' }),
                    getFiles: () => ({}),
                    updateScene: (data) => {
                        console.log('üìã Canvas updateScene called', data);
                    },
                    exportToCanvas: () => {
                        return Promise.resolve(canvas);
                    }
                };
                
                            console.log('‚úÖ Fallback canvas initialized');
                hideLoadingIndicator();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–ª—è fallback)
                initializeToolbar();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WebSocket
                await loadSavedBoard();
                if (lessonId !== 'demo') {
                    initializeWebSocket();
            }
        }
        
        // –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Excalidraw API
        function waitForExcalidrawAPI() {
            return new Promise((resolve) => {
                const checkAPI = () => {
                    if (excalidrawAPI) {
                        resolve();
                    } else {
                        setTimeout(checkAPI, 100);
                    }
                };
                checkAPI();
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Excalidraw
        function handleExcalidrawChange(elements, appState, files) {
            try {
                // –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤ —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å readonly –æ—à–∏–±–æ–∫
                const safeElements = elements ? JSON.parse(JSON.stringify(elements)) : [];
                const safeAppState = appState ? JSON.parse(JSON.stringify(appState)) : {};
                const safeFiles = files ? JSON.parse(JSON.stringify(files)) : {};
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebSocket –µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã
                if (isConnected && stompClient && lessonId !== 'demo') {
                    // Throttle –∏–∑–º–µ–Ω–µ–Ω–∏—è —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
                    clearTimeout(window.changeTimeout);
                    window.changeTimeout = setTimeout(() => {
                        sendBoardUpdate(safeElements, safeAppState, safeFiles);
                    }, 500);
                }
                
                // –£–ª—É—á—à–µ–Ω–Ω–æ–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤
                clearTimeout(window.autoSaveTimeout);
                window.autoSaveTimeout = setTimeout(() => {
                    saveBoardState();
                }, 2000); // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage –∫–∞–∫ backup
                if (lessonId !== 'demo') {
                    clearTimeout(window.backupSaveTimeout);
                    window.backupSaveTimeout = setTimeout(() => {
                        localStorage.setItem(`excalidraw_backup_${lessonId}`, JSON.stringify({
                            elements: safeElements,
                            appState: safeAppState,
                            files: safeFiles,
                            timestamp: Date.now()
                        }));
                    }, 1000);
                }
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Error in handleExcalidrawChange:', error);
                // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å —Ä–∞–±–æ—Ç–µ
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket
        function initializeWebSocket() {
            console.log('üîå Initializing WebSocket connection...');
            
            try {
                const socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);
                stompClient.debug = null; // –û—Ç–∫–ª—é—á–∞–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                
                stompClient.connect({}, 
                    (frame) => {
                        console.log('‚úÖ WebSocket connected:', frame);
                        isConnected = true;
                        reconnectAttempts = 0;
                        updateConnectionStatus('connected');
                        
                        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å–∫–∏
                        stompClient.subscribe(`/topic/excalidraw/${lessonId}`, (message) => {
                            handleBoardMessage(JSON.parse(message.body));
                        });
                        
                        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                        stompClient.subscribe(`/topic/excalidraw/${lessonId}/users`, (message) => {
                            handleUsersMessage(JSON.parse(message.body));
                        });
                        
                        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏)
                        stompClient.subscribe(`/user/queue/board/state`, (message) => {
                            console.log('üìã –ü–æ–ª—É—á–µ–Ω–æ –ª–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –¥–æ—Å–∫–∏');
                            handleBoardMessage(JSON.parse(message.body));
                        });
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏
                        sendJoinMessage();
                        
                        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏
                        requestBoardState();
                        
                    },
                    (error) => {
                        console.error('‚ùå WebSocket connection error:', error);
                        isConnected = false;
                        updateConnectionStatus('disconnected');
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                        if (reconnectAttempts < maxReconnectAttempts) {
                            reconnectAttempts++;
                            console.log(`üîÑ Reconnection attempt ${reconnectAttempts}/${maxReconnectAttempts}`);
                            setTimeout(() => {
                                initializeWebSocket();
                            }, Math.pow(2, reconnectAttempts) * 1000); // Exponential backoff
                        } else {
                            showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –†–∞–±–æ—Ç–∞–µ–º –≤ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–º —Ä–µ–∂–∏–º–µ.', 'warning');
                        }
                    }
                );
                
            } catch (error) {
                console.error('‚ùå WebSocket initialization error:', error);
                updateConnectionStatus('disconnected');
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏
        function sendJoinMessage() {
            if (stompClient && isConnected) {
                stompClient.send(`/app/excalidraw/${lessonId}/join`, {}, JSON.stringify({
                    lessonId: lessonId,
                    userId: collaborationState.userId,
                    userName: collaborationState.userName,
                    userRole: isTeacher ? 'teacher' : isAdmin ? 'admin' : 'student'
                }));
            }
        }
        
        // –ó–∞–ø—Ä–æ—Å —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ—Å–∫–∏
        function requestBoardState() {
            if (stompClient && isConnected) {
                stompClient.send(`/app/excalidraw/${lessonId}/state`, {}, JSON.stringify({
                    lessonId: lessonId,
                    userId: collaborationState.userId
                }));
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–æ—Å–∫–∏
        function sendBoardUpdate(elements, appState, files) {
            if (stompClient && isConnected) {
                const boardData = {
                    elements: elements,
                    appState: {
                        viewBackgroundColor: appState.viewBackgroundColor,
                        currentItemStrokeColor: appState.currentItemStrokeColor,
                        currentItemBackgroundColor: appState.currentItemBackgroundColor,
                        currentItemFillStyle: appState.currentItemFillStyle,
                        currentItemStrokeWidth: appState.currentItemStrokeWidth,
                        currentItemStrokeStyle: appState.currentItemStrokeStyle,
                        currentItemRoughness: appState.currentItemRoughness,
                        currentItemOpacity: appState.currentItemOpacity,
                        currentItemFontFamily: appState.currentItemFontFamily,
                        currentItemFontSize: appState.currentItemFontSize,
                        currentItemTextAlign: appState.currentItemTextAlign,
                        currentItemStartArrowhead: appState.currentItemStartArrowhead,
                        currentItemEndArrowhead: appState.currentItemEndArrowhead,
                        scrollX: appState.scrollX,
                        scrollY: appState.scrollY,
                        zoom: appState.zoom
                    },
                    files: files
                };
                
                stompClient.send(`/app/excalidraw/${lessonId}/update`, {}, JSON.stringify({
                    lessonId: lessonId,
                    userId: collaborationState.userId,
                    userName: collaborationState.userName,
                    boardData: boardData,
                    timestamp: Date.now()
                }));
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ—Å–∫–∏
        function handleBoardMessage(message) {
            console.log('üì® Board message received:', message.type);
            
            if (message.userId === collaborationState.userId) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                return;
            }
            
            switch (message.type) {
                case 'board_update':
                    if (message.boardData && excalidrawAPI) {
                        try {
                            // –†–∞–∑–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–æ—Å–∫–∏ –µ—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
                            let boardData = message.boardData;
                            if (typeof boardData === 'string') {
                                boardData = JSON.parse(boardData);
                            }
                            
                        excalidrawAPI.updateScene({
                                elements: boardData.elements || [],
                                appState: boardData.appState || {},
                                files: boardData.files || {}
                            });
                        } catch (error) {
                            console.error('‚ùå Error processing board update:', error);
                        }
                    }
                    break;
                    
                case 'board_state':
                    if (message.boardData && excalidrawAPI) {
                        try {
                            console.log('üìã Loading board state from WebSocket');
                            
                            // –†–∞–∑–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–æ—Å–∫–∏ –µ—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
                            let boardData = message.boardData;
                            if (typeof boardData === 'string') {
                                boardData = JSON.parse(boardData);
                            }
                            
                        excalidrawAPI.updateScene({
                                elements: boardData.elements || [],
                                appState: boardData.appState || {},
                                files: boardData.files || {}
                            });
                            
                            showToast('–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —Å —Å–µ—Ä–≤–µ—Ä–∞', 'success');
                        } catch (error) {
                            console.error('‚ùå Error loading board state:', error);
                            showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ—Å–∫–∏', 'error');
                        }
                    }
                    break;
                    
                case 'user_joined':
                    showToast(`${message.userName} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –¥–æ—Å–∫–µ`, 'info');
                    break;
                    
                case 'user_left':
                    showToast(`${message.userName} –ø–æ–∫–∏–Ω—É–ª –¥–æ—Å–∫—É`, 'info');
                    break;
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
        function handleUsersMessage(message) {
            if (message.type === 'users_update') {
                connectedUsers.clear();
                message.users.forEach(user => {
                    connectedUsers.set(user.userId, user);
                });
                updateUsersDisplay();
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function updateUsersDisplay() {
            const usersOnline = document.getElementById('usersOnline');
            const usersList = document.getElementById('usersList');
            
            if (connectedUsers.size > 1) {
                const users = Array.from(connectedUsers.values())
                    .filter(user => user.userId !== collaborationState.userId)
                    .map(user => {
                        const initial = user.userName.charAt(0).toUpperCase();
                        return `<span class="user-avatar" title="${user.userName}">${initial}</span>`;
                    })
                    .join('');
                
                usersList.innerHTML = users;
                usersOnline.style.display = 'block';
            } else {
                usersOnline.style.display = 'none';
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function updateConnectionStatus(status) {
            const indicator = document.getElementById('statusIndicator');
            
            indicator.className = 'status-indicator';
            
            switch (status) {
                case 'connected':
                    indicator.classList.add('status-connected');
                    indicator.innerHTML = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                    break;
                case 'disconnected':
                    indicator.classList.add('status-disconnected');
                    indicator.innerHTML = '‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ';
                    break;
                case 'connecting':
                    indicator.classList.add('status-connecting', 'pulse');
                    indicator.innerHTML = 'üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                    break;
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ—Å–∫–∏
        async function saveBoard() {
            if (!excalidrawAPI) {
                showToast('–î–æ—Å–∫–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞', 'error');
                return;
            }
            
            try {
                // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç readonly
                let elements, appState, files;
                
                try {
                    elements = excalidrawAPI.getSceneElements();
                    appState = excalidrawAPI.getAppState();
                    files = excalidrawAPI.getFiles();
                } catch (e) {
                    console.warn('‚ö†Ô∏è API access warning:', e);
                    // Fallback –∫ –ø—É—Å—Ç—ã–º –¥–∞–Ω–Ω—ã–º
                    elements = [];
                    appState = {};
                    files = {};
                }
                
                // –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                const safeElements = JSON.parse(JSON.stringify(elements || []));
                const safeAppState = JSON.parse(JSON.stringify(appState || {}));
                const safeFiles = JSON.parse(JSON.stringify(files || {}));
                
                if (lessonId === 'demo') {
                    saveBoardToLocalStorage(safeElements, safeAppState, safeFiles);
                    showToast('–î–æ—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ', 'success');
                } else {
                    await saveBoardToServer(safeElements, safeAppState, safeFiles);
                    showToast('–î–æ—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ', 'success');
                }
                
            } catch (error) {
                console.error('‚ùå Save error:', error);
                showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
        function saveBoardToLocalStorage(elements, appState, files) {
            const boardData = {
                elements: elements,
                appState: appState,
                files: files,
                timestamp: Date.now()
            };
            
            localStorage.setItem(`excalidraw_${lessonId}`, JSON.stringify(boardData));
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function saveBoardToServer(elements, appState, files) {
            const boardData = {
                elements: elements,
                appState: appState,
                files: files
            };
            
            const response = await fetch('/api/excalidraw/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    lessonId: lessonId.toString(), // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                    content: JSON.stringify(boardData)
                })
            });
            
            if (!response.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –¥–æ—Å–∫–∏
        async function loadSavedBoard() {
            if (!excalidrawAPI) {
                console.log('‚è≥ Excalidraw API not ready yet, skipping load');
                return;
            }
            
            try {
                let boardData = null;
                let loadedFromBackup = false;
                
                if (lessonId === 'demo') {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage –¥–ª—è –¥–µ–º–æ
                    const saved = localStorage.getItem(`excalidraw_${lessonId}`);
                    if (saved) {
                        boardData = JSON.parse(saved);
                        console.log('üìã Loaded demo board from localStorage');
                    }
                } else {
                    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞
                    console.log('üìã Loading board state from server for lesson:', lessonId);
                    
                    try {
                        const response = await fetch(`/api/excalidraw/load/${lessonId}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log('üìã Server response:', result);
                            
                            if (result.success && result.content) {
                                try {
                                    // –ü–∞—Ä—Å–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –µ—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
                                    if (typeof result.content === 'string') {
                                        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –æ–±—ã—á–Ω—ã–π JSON –ø–∞—Ä—Å–∏–Ω–≥
                                        try {
                                            boardData = JSON.parse(result.content);
                                        } catch (jsonError) {
                                            // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è, –ø—Ä–æ–±—É–µ–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å Java toString –≤ JSON
                                            console.log('üîß Converting Java toString format to JSON...');
                                            boardData = parseJavaToStringToJSON(result.content);
                                        }
                                    } else {
                                        boardData = result.content;
                                    }
                                    console.log('üìã Parsed board data:', boardData);
                                } catch (parseError) {
                                    console.error('‚ùå Error parsing board content:', parseError);
                                    console.log('Raw content:', result.content);
                                    // –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø—Ä–æ–±—É–µ–º backup
                                    boardData = null;
                                }
                            } else {
                                console.log('üìã No saved board state found on server for lesson:', lessonId);
                            }
                        } else {
                            console.warn('‚ö†Ô∏è Failed to load board state from server:', response.status);
                        }
                    } catch (serverError) {
                        console.error('‚ùå Server loading error:', serverError);
                    }
                    
                    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞, –ø—Ä–æ–±—É–µ–º backup –∏–∑ localStorage
                    if (!boardData || !boardData.elements) {
                        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∞–≤–∞—Ä–∏–π–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                        const emergency = localStorage.getItem(`excalidraw_emergency_${lessonId}`);
                        if (emergency) {
                            try {
                                const emergencyData = JSON.parse(emergency);
                                if (emergencyData.elements && emergencyData.elements.length > 0) {
                                    boardData = emergencyData;
                                    loadedFromBackup = true;
                                    console.log('üìã Loaded board state from emergency backup');
                                    // –£–¥–∞–ª—è–µ–º –∞–≤–∞—Ä–∏–π–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                                    localStorage.removeItem(`excalidraw_emergency_${lessonId}`);
                                }
                            } catch (emergencyError) {
                                console.error('‚ùå Emergency backup loading error:', emergencyError);
                            }
                        }
                        
                        // –ï—Å–ª–∏ –∞–≤–∞—Ä–∏–π–Ω–æ–≥–æ –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º –æ–±—ã—á–Ω—ã–π backup
                        if (!boardData || !boardData.elements) {
                            const backup = localStorage.getItem(`excalidraw_backup_${lessonId}`);
                            if (backup) {
                                try {
                                    const backupData = JSON.parse(backup);
                                    if (backupData.elements && backupData.elements.length > 0) {
                                        boardData = backupData;
                                        loadedFromBackup = true;
                                        console.log('üìã Loaded board state from localStorage backup');
                                    }
                                } catch (backupError) {
                                    console.error('‚ùå Backup loading error:', backupError);
                                }
                            }
                        }
                    }
                }
                
                if (boardData && boardData.elements) {
                    console.log('‚úÖ Applying board state with', boardData.elements.length, 'elements');
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
                    try {
                        excalidrawAPI.updateScene({
                            elements: boardData.elements || [],
                            appState: {
                                ...boardData.appState,
                                viewBackgroundColor: boardData.appState?.viewBackgroundColor || "#ffffff"
                            },
                            files: boardData.files || {}
                        });
                        
                        const message = loadedFromBackup ? 
                            '–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏' : 
                            '–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ';
                        showToast(message, loadedFromBackup ? 'warning' : 'success');
                        console.log('‚úÖ Board state loaded successfully');
                        
                        // –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∏–ª–∏ –∏–∑ backup, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                        if (loadedFromBackup) {
                            setTimeout(() => {
                                saveBoardState();
                                showToast('–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä', 'info');
                            }, 1000);
                        }
                        
                    } catch (applyError) {
                        console.error('‚ùå Error applying board state:', applyError);
                        showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ—Å–∫–∏', 'error');
                    }
                } else {
                    console.log('üìã No board data to load');
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç—É—é –¥–æ—Å–∫—É
                    excalidrawAPI.updateScene({
                        elements: [],
                        appState: { viewBackgroundColor: "#ffffff" },
                        files: {}
                    });
                }
                
            } catch (error) {
                console.error('‚ùå Load error:', error);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ—Å–∫–∏: ' + error.message, 'error');
            }
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç –¥–æ—Å–∫–∏
        async function exportBoard() {
            if (!excalidrawAPI) {
                showToast('–î–æ—Å–∫–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞', 'error');
                return;
            }
            
            try {
                // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
                let elements, appState, files;
                
                try {
                    elements = excalidrawAPI.getSceneElements();
                    appState = excalidrawAPI.getAppState();
                    files = excalidrawAPI.getFiles();
                } catch (e) {
                    console.warn('‚ö†Ô∏è API access warning:', e);
                    elements = [];
                    appState = {};
                    files = {};
                }
                
                // –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ Excalidraw
                const ExcalidrawLib = window.ExcalidrawLib || window.Excalidraw;
                let exportToCanvas = null;
                
                // –ò—â–µ–º —Ñ—É–Ω–∫—Ü–∏—é —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö (ESM –∏ UMD —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
                if (ExcalidrawLib?.default?.exportToCanvas) {
                    exportToCanvas = ExcalidrawLib.default.exportToCanvas;
                } else if (ExcalidrawLib?.exportToCanvas) {
                    exportToCanvas = ExcalidrawLib.exportToCanvas;
                } else if (window.Excalidraw?.exportToCanvas) {
                    exportToCanvas = window.Excalidraw.exportToCanvas;
                } else if (window.exportToCanvas) {
                    exportToCanvas = window.exportToCanvas;
                }
                
                if (exportToCanvas) {
                    try {
                        const canvas = await exportToCanvas({
                            elements: elements || [],
                            appState: appState || {},
                            files: files || {},
                            getDimensions: () => ({ width: 1920, height: 1080 })
                        });
                        
                        // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                        const link = document.createElement('a');
                        link.download = `brainify_board_${lessonId}_${new Date().toISOString().slice(0, 10)}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                        
                        showToast('–î–æ—Å–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞', 'success');
                    } catch (exportError) {
                        console.error('‚ùå Excalidraw export error:', exportError);
                        fallbackExport();
                    }
                } else {
                    console.warn('‚ö†Ô∏è exportToCanvas function not found, using fallback');
                    fallbackExport();
                }
                
            } catch (error) {
                console.error('‚ùå Export error:', error);
                showToast('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + error.message, 'error');
            }
        }
        
        // Fallback —ç–∫—Å–ø–æ—Ä—Ç –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ canvas
        function fallbackExport() {
            if (excalidrawAPI && excalidrawAPI.canvas) {
                // –ü—Ä–æ—Å—Ç–æ–π —ç–∫—Å–ø–æ—Ä—Ç canvas
                const link = document.createElement('a');
                link.download = `brainify_canvas_${lessonId}_${new Date().toISOString().slice(0, 10)}.png`;
                link.href = excalidrawAPI.canvas.toDataURL();
                link.click();
                showToast('–î–æ—Å–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ (–ø—Ä–æ—Å—Ç–æ–π —Ä–µ–∂–∏–º)', 'success');
            } else {
                showToast('–≠–∫—Å–ø–æ—Ä—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'warning');
            }
        }
        
        // –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –¥–æ—Å–∫–æ–π
        function shareBoard() {
            const url = window.location.href;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Brainify Board',
                    text: '–°–æ–≤–º–µ—Å—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –Ω–∞ –¥–æ—Å–∫–µ',
                    url: url
                });
            } else {
                // Fallback: –∫–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
                navigator.clipboard.writeText(url).then(() => {
                    showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
                }).catch(() => {
                    showToast('–°—Å—ã–ª–∫–∞: ' + url, 'info');
                });
            }
        }
        
        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —É—Ä–æ–∫–∞
        async function endLesson() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫?')) {
                return;
            }
            
            try {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–æ—Å–∫—É –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º
                await saveBoard();
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —É—Ä–æ–∫–∞
                const response = await fetch(`/api/lessons/${lessonId}/end`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        saveBoard: true,
                        lessonNotes: ''
                    })
                });
                
                if (response.ok) {
                    showToast('–£—Ä–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω', 'success');
                    
                    // –û—Ç–∫–ª—é—á–∞–µ–º—Å—è –æ—Ç WebSocket
                    if (stompClient && isConnected) {
                        stompClient.send(`/app/excalidraw/${lessonId}/leave`, {}, JSON.stringify({
                            lessonId: lessonId,
                            userId: collaborationState.userId,
                            userName: collaborationState.userName
                        }));
                        stompClient.disconnect();
                    }
                    
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 1500);
                } else {
                    showToast('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–∫–∞', 'error');
                }
                
            } catch (error) {
                console.error('‚ùå End lesson error:', error);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–∫–∞: ' + error.message, 'error');
            }
        }
        
        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.addEventListener('DOMContentLoaded', () => {
            // –ö–Ω–æ–ø–∫–∏
            document.getElementById('saveBtn').addEventListener('click', saveBoard);
            document.getElementById('exportBtn').addEventListener('click', exportBoard);
            document.getElementById('shareBtn').addEventListener('click', shareBoard);
            document.getElementById('endLessonBtn').addEventListener('click', endLesson);
            
            // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 's':
                            e.preventDefault();
                            saveBoard();
                            break;
                        case 'e':
                            e.preventDefault();
                            exportBoard();
                            break;
                    }
                }
            });
            
        });
        
        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫
        function checkLibrariesLoaded() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 100; // 10 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º
                
                const check = () => {
                    attempts++;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ DOM –≥–æ—Ç–æ–≤ –∏ –±–∞–∑–æ–≤—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
                    const domReady = document.getElementById('excalidraw-container');
                    const sockJSReady = typeof SockJS !== 'undefined';
                    const stompReady = typeof Stomp !== 'undefined';
                    
                    if (domReady && sockJSReady && stompReady) {
                        console.log('‚úÖ DOM and basic libraries ready');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error(`–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –Ω–µ –≥–æ—Ç–æ–≤—ã. DOM: ${!!domReady}, SockJS: ${sockJSReady}, Stomp: ${stompReady}`));
                    } else {
                        setTimeout(check, 100);
                    }
                };
                
                check();
            });
        }
        
        // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
        function checkLibraryStatus() {
            const excalidrawLib = window.ExcalidrawLib;
            const excalidrawGlobal = window.Excalidraw;
            
            return {
                react: !!window.React,
                reactDOM: !!window.ReactDOM,
                excalidraw: !!(excalidrawLib || excalidrawGlobal),
                excalidrawComponent: !!(
                    excalidrawLib?.default?.Excalidraw ||
                    excalidrawLib?.Excalidraw ||
                    excalidrawGlobal?.Excalidraw ||
                    (typeof excalidrawGlobal === 'function')
                ),
                sockJS: !!window.SockJS,
                stomp: !!window.Stomp
            };
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
        window.addEventListener('load', async () => {
            try {
                console.log('üîÑ Waiting for libraries to load...');
                updateLoadingStatus('–û–∂–∏–¥–∞–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫...', '–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤');
                
                await checkLibrariesLoaded();
                
                const status = checkLibraryStatus();
                console.log('üìö Library status:', status);
                
                if (!status.react || !status.reactDOM) {
                    throw new Error('React –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                }
                
                console.log('üìö Libraries loaded, initializing UI...');
                initializeUI();
                
                // –î–∞–µ–º –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ Excalidraw (React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)
                setTimeout(() => {
                    console.log('üé® Starting Excalidraw initialization...');
                    console.log('Available Excalidraw:', {
                        ExcalidrawLib: !!window.ExcalidrawLib,
                        Excalidraw: !!window.Excalidraw,
                        globalExcalidraw: typeof window.Excalidraw
                    });
                    initializeExcalidraw();
                }, 1000); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–æ 1 —Å–µ–∫—É–Ω–¥—ã
                
            } catch (error) {
                console.error('‚ùå Library loading error:', error);
                const status = checkLibraryStatus();
                console.log('Final library status:', status);
                
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫: ' + error.message, 'error');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                const container = document.getElementById('excalidraw-container');
                container.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: #f8f9fa; color: #6c757d;">
                        <h2>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å–∫–∏</h2>
                        <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.</p>
                        <p style="font-size: 12px; margin-top: 10px;">${error.message}</p>
                        <div style="font-size: 10px; margin-top: 10px; padding: 10px; background: #e9ecef; border-radius: 4px;">
                            React: ${status.react ? '‚úÖ' : '‚ùå'} | 
                            ReactDOM: ${status.reactDOM ? '‚úÖ' : '‚ùå'} | 
                            Excalidraw: ${status.excalidraw ? '‚úÖ' : '‚ùå'} | 
                            ExcalidrawComponent: ${status.excalidrawComponent ? '‚úÖ' : '‚ùå'} | 
                            SockJS: ${status.sockJS ? '‚úÖ' : '‚ùå'} | 
                            Stomp: ${status.stomp ? '‚úÖ' : '‚ùå'}
                        </div>
                        <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 20px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
                        <button onclick="initializeFallbackCanvas()" class="btn" style="margin-top: 10px;">üîß –ü—Ä–æ—Å—Ç–∞—è –¥–æ—Å–∫–∞</button>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
