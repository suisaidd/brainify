<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brainify Board - Excalidraw</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß†</text></svg>">
    
    <!-- Excalidraw CSS -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            overflow: hidden;
            background: #f8f9fa;
        }
        
        .app-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .top-bar {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .lesson-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .lesson-title {
            font-weight: 600;
            color: #495057;
            font-size: 16px;
        }
        
        .user-info {
            font-size: 14px;
            color: #6c757d;
        }
        
        .controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .btn {
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn:hover {
            background: #f8f9fa;
            border-color: #adb5bd;
        }
        
        .btn-primary {
            background: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }
        
        .btn-primary:hover {
            background: #0b5ed7;
            border-color: #0a58ca;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
            border-color: #bd2130;
        }
        
        .excalidraw-container {
            flex: 1;
            position: relative;
        }
        
        .status-indicator {
            position: fixed;
            top: 60px;
            right: 16px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 200;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-connected {
            background: rgba(40, 167, 69, 0.9);
        }
        
        .status-fair {
            background: rgba(255, 193, 7, 0.9);
        }
        
        .status-warning {
            background: rgba(255, 152, 0, 0.9);
        }
        
        .status-disconnected {
            background: rgba(220, 53, 69, 0.9);
        }
        
        .status-connecting {
            background: rgba(255, 193, 7, 0.9);
            color: #212529;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .pulse {
            animation: pulse 1s infinite;
        }
        
        .users-online {
            position: fixed;
            top: 60px;
            left: 16px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 200;
            max-width: 300px;
        }
        
        .user-avatar {
            display: inline-block;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            text-align: center;
            line-height: 24px;
            font-size: 12px;
            margin-right: 4px;
            vertical-align: middle;
        }
        
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        .toast.error {
            background: rgba(220, 53, 69, 0.9);
        }
        
        .toast.success {
            background: rgba(40, 167, 69, 0.9);
        }
        
        .toast.warning {
            background: rgba(255, 193, 7, 0.9);
            color: #212529;
        }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π UI Excalidraw –¥–ª—è —á–∏—Å—Ç–æ–≥–æ –≤–∏–¥–∞ */
        .excalidraw .App-menu_top {
            display: none !important;
        }
        
        .excalidraw .App-toolbar {
            top: 60px !important;
        }
        
        /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ */
        .custom-toolbar {
            position: fixed;
            left: 50%;
            top: 75px;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 6px 12px;
            z-index: 150;
            display: flex;
            align-items: center;
            gap: 2px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .toolbar-main {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .tool-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
            position: relative;
            color: #6b7280;
        }
        
        .tool-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            transform: translateY(-1px);
        }
        
        .tool-btn.active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        }
        
        .tool-divider {
            width: 1px;
            height: 24px;
            background: #e5e7eb;
            margin: 0 6px;
        }
        
        /* –í—ã–ø–∞–¥–∞—é—â–∏–µ –ø–∞–Ω–µ–ª–∏ */
        .expandable-panel {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 200;
            min-width: 240px;
        }
        
        .expandable-panel.open {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .panel-title {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }
        
        .panel-close {
            width: 20px;
            height: 20px;
            border: none;
            background: transparent;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            transition: all 0.2s ease;
        }
        
        .panel-close:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        
        /* –¶–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞ */
        .color-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            margin-bottom: 12px;
        }
        
        .color-btn {
            width: 32px;
            height: 32px;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            background: var(--color);
        }
        
        .color-btn:hover {
            transform: scale(1.05);
            border-color: #d1d5db;
        }
        
        .color-btn.active {
            border-color: #3b82f6;
            transform: scale(1.05);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        
        /* –°–ª–∞–π–¥–µ—Ä—ã */
        .slider-group {
            margin-bottom: 12px;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 11px;
            color: #6b7280;
            font-weight: 500;
        }
        
        .slider-value {
            font-weight: 600;
            color: #374151;
        }
        
        .custom-slider {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: #e5e7eb;
            outline: none;
            appearance: none;
            cursor: pointer;
        }
        
        .custom-slider::-webkit-slider-thumb {
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(59, 130, 246, 0.4);
            transition: all 0.2s ease;
        }
        
        .custom-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.6);
        }
        
        .custom-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
            box-shadow: 0 1px 4px rgba(59, 130, 246, 0.4);
        }
        
        /* –î–µ–π—Å—Ç–≤–∏—è –≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É */
        .bottom-actions {
            position: fixed;
            bottom: 16px;
            right: 16px;
            display: flex;
            flex-direction: row;
            gap: 8px;
            z-index: 150;
        }
        
        .action-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s ease;
            color: #6b7280;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .action-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }
        
        .action-btn.danger:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
        <div class="top-bar">
            <div class="lesson-info">
                <div class="lesson-title" id="lessonTitle">
                    üß† Brainify Board
                </div>
                <div class="user-info" id="userInfo">
                    –ó–∞–≥—Ä—É–∑–∫–∞...
                </div>
            </div>
            
            <div class="controls">
                <button class="btn" id="saveBtn">
                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button class="btn" id="exportBtn">
                    üì§ –≠–∫—Å–ø–æ—Ä—Ç
                </button>
                <button class="btn" id="shareBtn">
                    üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                </button>
                <button class="btn btn-danger" id="endLessonBtn" style="display: none;">
                    üö™ –ó–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫
                </button>
            </div>
        </div>
        
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è Excalidraw -->
        <div class="excalidraw-container" id="excalidraw-container">
            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div id="loading-indicator" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: #f8f9fa; color: #6c757d;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                    <div style="width: 24px; height: 24px; border: 3px solid #e9ecef; border-top: 3px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <span id="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫...</span>
                </div>
                <div id="loading-details" style="font-size: 12px; color: #adb5bd; text-align: center; max-width: 400px;">
                    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –¥–æ—Å–∫–∏
                </div>
            </div>
        </div>
        
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
        
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
        <div class="status-indicator status-connecting pulse" id="statusIndicator">
            üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...
        </div>
        
        <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–Ω–ª–∞–π–Ω -->
        <div class="users-online" id="usersOnline" style="display: none;">
            üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–Ω–ª–∞–π–Ω: <span id="usersList"></span>
        </div>
        
        <!-- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
        <div class="custom-toolbar" id="customToolbar">
            <div class="toolbar-main">
                <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã -->
                <button class="tool-btn active" id="tool-select" data-tool="selection" title="–í—ã–±–æ—Ä">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/>
                    </svg>
                </button>
                
                <button class="tool-btn" id="tool-pen" data-tool="freedraw" title="–ö–∞—Ä–∞–Ω–¥–∞—à">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                        <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                        <path d="M2 2l7.586 7.586"/>
                        <circle cx="11" cy="11" r="2"/>
                    </svg>
                </button>
                
                <button class="tool-btn" id="tool-eraser" data-tool="eraser" title="–õ–∞—Å—Ç–∏–∫">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M7 21h10"/>
                        <path d="M12 21a9 9 0 0 0 0-18c-2.52 0-4.9 1-6.65 2.75L2.5 8.6a2 2 0 0 0 0 2.8l2.85 2.85C7.1 16 9.48 17 12 17z"/>
                    </svg>
                </button>
                
                <button class="tool-btn" id="tool-text" data-tool="text" title="–¢–µ–∫—Å—Ç">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="4,7 4,4 20,4 20,7"/>
                        <line x1="9" y1="20" x2="15" y2="20"/>
                        <line x1="12" y1="4" x2="12" y2="20"/>
                    </svg>
                </button>
                
                <div class="tool-divider"></div>
                
                <!-- –§–∏–≥—É—Ä—ã -->
                <button class="tool-btn" id="shape-rectangle" data-tool="rectangle" title="–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    </svg>
                </button>
                
                <button class="tool-btn" id="shape-ellipse" data-tool="ellipse" title="–≠–ª–ª–∏–ø—Å">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                    </svg>
                </button>
                
                <button class="tool-btn" id="shape-arrow" data-tool="arrow" title="–°—Ç—Ä–µ–ª–∫–∞">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="7" y1="17" x2="17" y2="7"/>
                        <polyline points="7,7 17,7 17,17"/>
                    </svg>
                </button>
                
                <button class="tool-btn" id="shape-line" data-tool="line" title="–õ–∏–Ω–∏—è">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="6" y1="18" x2="18" y2="6"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- –í—ã–ø–∞–¥–∞—é—â–∞—è –ø–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
        <div class="expandable-panel" id="settingsPanel">
            <div class="panel-header">
                <span class="panel-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∏—Å—Ç–∏</span>
                <button class="panel-close" id="panelClose">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            
            <!-- –¶–≤–µ—Ç–∞ -->
            <div class="color-grid">
                <button class="color-btn active" data-color="#000000" style="--color: #000000" title="–ß–µ—Ä–Ω—ã–π"></button>
                <button class="color-btn" data-color="#ef4444" style="--color: #ef4444" title="–ö—Ä–∞—Å–Ω—ã–π"></button>
                <button class="color-btn" data-color="#22c55e" style="--color: #22c55e" title="–ó–µ–ª–µ–Ω—ã–π"></button>
                <button class="color-btn" data-color="#3b82f6" style="--color: #3b82f6" title="–°–∏–Ω–∏–π"></button>
                <button class="color-btn" data-color="#f97316" style="--color: #f97316" title="–û—Ä–∞–Ω–∂–µ–≤—ã–π"></button>
                <button class="color-btn" data-color="#a855f7" style="--color: #a855f7" title="–§–∏–æ–ª–µ—Ç–æ–≤—ã–π"></button>
                <button class="color-btn" data-color="#eab308" style="--color: #eab308" title="–ñ–µ–ª—Ç—ã–π"></button>
                <button class="color-btn" data-color="#ec4899" style="--color: #ec4899" title="–†–æ–∑–æ–≤—ã–π"></button>
            </div>
            
            <!-- –†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏ -->
            <div class="slider-group">
                <div class="slider-label">
                    <span>–†–∞–∑–º–µ—Ä</span>
                    <span class="slider-value" id="sizeDisplay">2px</span>
                </div>
                <input type="range" class="custom-slider" id="strokeWidth" min="1" max="20" value="2">
            </div>
            
        </div>

        <!-- –î–µ–π—Å—Ç–≤–∏—è –≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É -->
        <div class="bottom-actions">
            <button class="action-btn" id="undo" title="–û—Ç–º–µ–Ω–∏—Ç—å">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 7v6h6"/>
                    <path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/>
                </svg>
            </button>
            
            <button class="action-btn" id="redo" title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 7v6h-6"/>
                    <path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"/>
                </svg>
            </button>
            
            <button class="action-btn danger" id="clear-canvas" title="–û—á–∏—Å—Ç–∏—Ç—å –¥–æ—Å–∫—É">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3,6 5,6 21,6"/>
                    <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"/>
                    <line x1="10" y1="11" x2="10" y2="17"/>
                    <line x1="14" y1="11" x2="14" y2="17"/>
                </svg>
            </button>
            
            <button class="action-btn" id="test-sync" title="–¢–µ—Å—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9c2.35 0 4.5.9 6.1 2.4"/>
                    <path d="M21 3l-6.1 6.1"/>
                    <path d="M21 3h-6"/>
                    <path d="M21 3v6"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- CDN Loader -->
    <script src="/js/cdn-loader.js"></script>
    
    <!-- React State Manager -->
    <script src="/js/react-state-manager.js"></script>
    
    <!-- Debug Helper -->
    <script src="/js/debug-helper.js"></script>
    
    <!-- React –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π -->
    <script>
        // –ó–∞–≥—Ä—É–∂–∞–µ–º React –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Å fallback
        async function loadReactLibraries() {
            try {
                console.log('üìö Loading React libraries...');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º React
                await window.CDNLoader.loadScript(window.CDN_SOURCES.react, {
                    id: 'react',
                    timeout: 30000,  // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–æ 30 —Å–µ–∫—É–Ω–¥
                    retries: 5,      // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–æ 5
                    onProgress: (source, attempt, total) => {
                        console.log(`üîÑ Loading React from ${source} (${attempt}/${total})`);
                    },
                    onError: (error, source) => {
                        console.error(`‚ùå Failed to load React from ${source}:`, error);
                    }
                });
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º ReactDOM
                await window.CDNLoader.loadScript(window.CDN_SOURCES.reactDOM, {
                    id: 'react-dom',
                    timeout: 30000,  // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–æ 30 —Å–µ–∫—É–Ω–¥
                    retries: 5,      // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–æ 5
                    onProgress: (source, attempt, total) => {
                        console.log(`üîÑ Loading ReactDOM from ${source} (${attempt}/${total})`);
                    }
                });
                
                console.log('‚úÖ React libraries loaded successfully');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–∏—Ñ–∏–ª–ª –¥–ª—è unstable_batchedUpdates –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                if (window.React && !window.React.unstable_batchedUpdates) {
                    console.log('üîß Adding React 17 polyfill for unstable_batchedUpdates');
                    window.React.unstable_batchedUpdates = function(callback) {
                        callback();
                    };
                }
                
                // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ React
                window.dispatchEvent(new CustomEvent('reactReady', {
                    detail: { react: window.React, reactDOM: window.ReactDOM }
                }));
                
                return true;
            } catch (error) {
                console.error('‚ùå Failed to load React libraries:', error);
                return false;
            }
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É React
        loadReactLibraries();
    </script>
    
    <!-- React JSX Runtime –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –Ω–æ–≤—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏ -->
    <script>
        // –ü–æ–ª–Ω—ã–π polyfill –¥–ª—è JSX runtime —Å –æ–∂–∏–¥–∞–Ω–∏–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ React
        function setupReactJSXRuntime() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ React
            if (!window.React) {
                console.log('‚è≥ React not loaded yet, waiting...');
                // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ React —Å —Ç–∞–π–º–∞—É—Ç–æ–º
                return waitForReact().then(() => {
                    setupReactJSXRuntimeInternal();
                }).catch((error) => {
                    console.error('‚ùå Failed to load React for JSX runtime:', error);
                    // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
                });
            }
            
            setupReactJSXRuntimeInternal();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ React
        function waitForReact() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 100; // 10 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º
                
                const checkReact = () => {
                    attempts++;
                    
                    if (window.React) {
                        console.log('‚úÖ React loaded, setting up JSX runtime');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('React loading timeout'));
                    } else {
                        setTimeout(checkReact, 100);
                    }
                };
                
                checkReact();
            });
        }
        
        // –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Ñ—É–Ω–∫—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ JSX runtime
        function setupReactJSXRuntimeInternal() {
            if (!window.React) {
                console.error('‚ùå React still not available for JSX runtime');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ª–∏ —É–∂–µ JSX runtime
            if (window.React.jsxs && window.React.jsx) {
                console.log('‚úÖ React JSX runtime already configured');
                return;
            }
            
            console.log('üîß Setting up React JSX runtime...');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–∏—Ñ–∏–ª–ª –¥–ª—è unstable_batchedUpdates –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if (!window.React.unstable_batchedUpdates) {
                console.log('üîß Adding unstable_batchedUpdates polyfill...');
                window.React.unstable_batchedUpdates = function(fn) {
                    fn();
                };
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–∏—Ñ–∏–ª–ª –¥–ª—è ReactDOM –µ—Å–ª–∏ –æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω
            if (window.ReactDOM && !window.ReactDOM.unstable_batchedUpdates) {
                console.log('üîß Adding ReactDOM unstable_batchedUpdates polyfill...');
                window.ReactDOM.unstable_batchedUpdates = function(fn) {
                    fn();
                };
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–∏—Ñ–∏–ª–ª –¥–ª—è React 18 API
            if (window.React && !window.React.startTransition) {
                console.log('üîß Adding React 18 API polyfills...');
                window.React.startTransition = function(fn) {
                    fn();
                };
                window.React.useId = function() {
                    return Math.random().toString(36).substr(2, 9);
                };
            }
            
            // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–∏—Ñ–∏–ª—ã –¥–ª—è –Ω–æ–≤—ã—Ö JSX —Ñ—É–Ω–∫—Ü–∏–π
            const React = window.React;
            
            // jsxs - –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –¥–µ—Ç—å–º–∏
            if (!React.jsxs) {
                React.jsxs = function(type, props, key) {
                    if (!props) props = {};
                    if (key !== undefined) props.key = key;
                    
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º children
                    const { children, ...otherProps } = props;
                    if (children !== undefined) {
                        if (Array.isArray(children)) {
                            return React.createElement(type, otherProps, ...children);
                        } else {
                            return React.createElement(type, otherProps, children);
                        }
                    }
                    return React.createElement(type, otherProps);
                };
            }
            
            // jsx - –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å –æ–¥–Ω–∏–º —Ä–µ–±–µ–Ω–∫–æ–º
            if (!React.jsx) {
                React.jsx = function(type, props, key) {
                    if (!props) props = {};
                    if (key !== undefined) props.key = key;
                    
                    const { children, ...otherProps } = props;
                    return React.createElement(type, otherProps, children);
                };
            }
            
            // Fragment –ø–æ–¥–¥–µ—Ä–∂–∫–∞
            if (!React.Fragment) {
                React.Fragment = 'div';
            }
            
            // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è JSX
            if (!window.ReactJSXRuntime) {
                window.ReactJSXRuntime = {
                    jsx: React.jsx,
                    jsxs: React.jsxs,
                    Fragment: React.Fragment
                };
            }
            
            console.log('‚úÖ React JSX Runtime polyfill installed');
        }
        
        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è JSX runtime
        function initializeJSXRuntime() {
            console.log('üöÄ Initializing JSX runtime...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∂–µ–Ω –ª–∏ React
            if (window.React) {
                console.log('‚úÖ React already loaded, setting up JSX runtime');
                setupReactJSXRuntime();
            } else {
                console.log('‚è≥ React not loaded, waiting for it...');
                // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ React
                waitForReact().then(() => {
                    setupReactJSXRuntime();
                }).catch((error) => {
                    console.error('‚ùå Failed to wait for React:', error);
                    // –ü—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è
                    setTimeout(() => {
                        if (window.React) {
                            setupReactJSXRuntime();
                        }
                    }, 2000);
                });
            }
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
        initializeJSXRuntime();
        
        // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ React
        window.addEventListener('reactReady', () => {
            console.log('üéâ React ready event received, setting up JSX runtime');
            setupReactJSXRuntime();
        });
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (window.React && !window.React.jsxs) {
                    console.log('üîß Final JSX runtime setup after page load');
                    setupReactJSXRuntime();
                }
            }, 1000);
        });
    </script>
    
    <!-- Excalidraw CSS —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ -->
    <script>
        // –í—Ä–µ–º–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (–¥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏)
        function updateLoadingStatusTemp(text, details = '') {
            const loadingText = document.getElementById('loading-text');
            const loadingDetails = document.getElementById('loading-details');
            if (loadingText) loadingText.textContent = text;
            if (loadingDetails) loadingDetails.textContent = details;
            console.log(`üìä Loading Status: ${text}${details ? ' - ' + details : ''}`);
        }
        
        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ CSS —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
        async function loadExcalidrawCSS() {
            try {
                console.log('üé® Loading Excalidraw CSS...');
                updateLoadingStatusTemp('–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∏–ª–µ–π...', '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ CDN');
                
                // –°–ø–∏—Å–æ–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (—Ç–æ–ª—å–∫–æ —Ä–∞–±–æ—á–∏–µ URL)
                const cssSources = [
                    '/css/excalidraw/excalidraw.min.css?v=' + Date.now() // –¢–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
                ];
                
                let cssLoaded = false;
                
                for (const source of cssSources) {
                    try {
                        console.log(`üîÑ Trying CSS source: ${source}`);
                        await loadCSSFromSource(source);
                        cssLoaded = true;
                        console.log(`‚úÖ CSS loaded from: ${source}`);
                        break;
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è Failed to load CSS from ${source}:`, error.message);
                        continue;
                    }
                }
                
                if (!cssLoaded) {
                    throw new Error('All CSS sources failed');
                }
                
            } catch (error) {
                console.error('‚ùå Failed to load Excalidraw CSS:', error);
                console.warn('‚ö†Ô∏è Using fallback styles');
                addFallbackStyles();
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ CSS –∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
        function loadCSSFromSource(source) {
            return new Promise((resolve, reject) => {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = source;
                link.id = 'excalidraw-css';
                
                const timeout = setTimeout(() => {
                    reject(new Error(`Timeout loading CSS from ${source}`));
                }, 8000);
                
                link.onload = () => {
                    clearTimeout(timeout);
                    resolve();
                };
                
                link.onerror = () => {
                    clearTimeout(timeout);
                    reject(new Error(`Failed to load CSS from ${source}`));
                };
                
                document.head.appendChild(link);
            });
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –∫–∞–∫ fallback
        function addFallbackStyles() {
            const style = document.createElement('style');
            style.id = 'excalidraw-fallback-styles';
            style.textContent = `
                .excalidraw {
                    width: 100%;
                    height: 100%;
                    position: relative;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
                }
                .excalidraw .App {
                    width: 100%;
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                }
                .excalidraw .App-menu {
                    background: #fff;
                    border-bottom: 1px solid #e0e0e0;
                    padding: 8px 16px;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                }
                .excalidraw .App-toolbar {
                    background: #fff;
                    border: 1px solid #e0e0e0;
                    border-radius: 8px;
                    padding: 8px;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }
                .excalidraw .App-canvas {
                    background: #fff;
                    flex: 1;
                    position: relative;
                    overflow: hidden;
                }
                .excalidraw .ToolIcon {
                    width: 40px;
                    height: 40px;
                    border: 1px solid #e0e0e0;
                    border-radius: 6px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    background: #fff;
                    transition: all 0.2s;
                }
                .excalidraw .ToolIcon:hover {
                    background: #f5f5f5;
                    border-color: #ccc;
                }
                .excalidraw .ToolIcon.is-active {
                    background: #007bff;
                    color: white;
                    border-color: #007bff;
                }
                .excalidraw .ToolIcon svg {
                    width: 20px;
                    height: 20px;
                }
                .excalidraw .ColorPicker {
                    display: flex;
                    gap: 4px;
                    align-items: center;
                }
                .excalidraw .ColorPicker .color-swatch {
                    width: 24px;
                    height: 24px;
                    border-radius: 50%;
                    border: 2px solid #fff;
                    cursor: pointer;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                }
                .excalidraw .ColorPicker .color-swatch:hover {
                    transform: scale(1.1);
                }
                .excalidraw .ColorPicker .color-swatch.is-active {
                    border-color: #333;
                    transform: scale(1.2);
                }
            `;
            document.head.appendChild(style);
            console.log('‚úÖ Fallback styles applied');
        }
        
        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ CSS —Å—Å—ã–ª–∫–∏ –∏ —Å–∫—Ä–∏–ø—Ç—ã –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
        const oldCSSLinks = document.querySelectorAll('link[href*="excalidraw"]');
        oldCSSLinks.forEach(link => link.remove());
        
        const oldScripts = document.querySelectorAll('script[src*="excalidraw"]');
        oldScripts.forEach(script => script.remove());
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º CSS —Å—Ä–∞–∑—É
        loadExcalidrawCSS();
    </script>
    
    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π fallback –¥–ª—è CSS -->
    <script>
        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CSS
        function checkCSSLoaded() {
            const cssLinks = document.querySelectorAll('link[href*="excalidraw"]');
            let cssLoaded = false;
            
            // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CSS –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏—è CORS
            cssLinks.forEach(link => {
                try {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç link —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ –∏–º–µ–µ—Ç –æ—à–∏–±–æ–∫
                    if (link.sheet || link.readyState === 'complete' || link.readyState === 'loaded') {
                        cssLoaded = true;
                    }
                } catch (e) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º CORS –æ—à–∏–±–∫–∏ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ stylesheet
                    console.log('CSS check blocked by CORS, assuming loaded');
                    cssLoaded = true;
                }
            });
            
            return cssLoaded;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º CSS —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            if (!checkCSSLoaded()) {
                console.warn('CSS may not be loaded, trying local fallback');
                const backup = document.createElement('link');
                backup.rel = 'stylesheet';
                backup.href = '/css/excalidraw/excalidraw.min.css?v=' + Date.now();
                backup.onload = () => console.log('‚úÖ Local CSS loaded');
                backup.onerror = () => {
                    console.warn('Local CSS failed, using inline fallback styles');
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º inline —Å—Ç–∏–ª–∏ –∫–∞–∫ fallback
                    applyFallbackStyles();
                };
                document.head.appendChild(backup);
            }
        }, 3000);
    </script>
    
    <!-- Import maps –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://unpkg.com/react@17/umd/react.production.min.js",
                "react-dom": "https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"
            }
        }
    </script>
    
    <!-- Excalidraw —á–µ—Ä–µ–∑ —É–ª—É—á—à–µ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <script>
        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ Excalidraw JS
        async function loadExcalidrawJS() {
            try {
                console.log('üì¶ Loading Excalidraw JS...');
                updateLoadingStatusTemp('–ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏...', '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ CDN');
                
                // –ñ–¥–µ–º, –ø–æ–∫–∞ React –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è
                await waitForReact();
                console.log('‚úÖ React ready, loading Excalidraw...');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å React
                if (window.React && window.React.version) {
                    console.log(`üîç React version: ${window.React.version}`);
                }
                
                await window.CDNLoader.loadScript(window.CDN_SOURCES.excalidraw, {
                    id: 'excalidraw-js',
                    timeout: 60000,  // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–æ 60 —Å–µ–∫—É–Ω–¥
                    retries: 5,      // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–æ 5
                    onProgress: (source, attempt, total) => {
                        console.log(`üîÑ Loading Excalidraw from ${source} (${attempt}/${total})`);
                        updateLoadingStatusTemp('–ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏...', `–ü–æ–ø—ã—Ç–∫–∞ ${attempt}/${total}`);
                    },
                    onError: (error, source) => {
                        console.error(`‚ùå Failed to load Excalidraw from ${source}:`, error);
                        console.log('üîç Network diagnostics:', {
                            online: navigator.onLine,
                            connection: navigator.connection ? {
                                effectiveType: navigator.connection.effectiveType,
                                downlink: navigator.connection.downlink,
                                rtt: navigator.connection.rtt
                            } : 'Not available'
                        });
                    }
                });
                
                console.log('‚úÖ Excalidraw JS loaded successfully');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ React internals –¥–æ—Å—Ç—É–ø–Ω—ã
                if (window.React && !window.React.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED) {
                    console.warn('‚ö†Ô∏è React internals not available, this may cause Excalidraw issues');
                }
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                if (window.React && window.React.version) {
                    const reactVersion = window.React.version;
                    console.log(`üîç React version: ${reactVersion}`);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –Ω–∞—Å React 17.x
                    if (!reactVersion.startsWith('17.')) {
                        console.warn(`‚ö†Ô∏è Excalidraw 0.17.x works best with React 17.x, but found ${reactVersion}`);
                    }
                }
                
                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ unstable_batchedUpdates –¥–æ—Å—Ç—É–ø–µ–Ω
                if (window.React && !window.React.unstable_batchedUpdates) {
                    console.warn('‚ö†Ô∏è unstable_batchedUpdates not found, adding fallback');
                    window.React.unstable_batchedUpdates = function(callback) {
                        callback();
                    };
                }
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Excalidraw –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                await initializeExcalidrawLibrary();
                
            } catch (error) {
                console.error('‚ùå Failed to load Excalidraw JS:', error);
                // –ù–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, —á—Ç–æ–±—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–≥–ª–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å fallback
                console.warn('‚ö†Ô∏è Continuing with fallback canvas');
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Excalidraw –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
        async function initializeExcalidrawLibrary() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 100; // 10 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º
                
                const checkExcalidraw = () => {
                    attempts++;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Excalidraw
                    let excalidrawFound = false;
                    
                    if (window.ExcalidrawLib) {
                        if (window.ExcalidrawLib.Excalidraw) {
                            window.Excalidraw = window.ExcalidrawLib.Excalidraw;
                            excalidrawFound = true;
                        } else if (window.ExcalidrawLib.default?.Excalidraw) {
                            window.Excalidraw = window.ExcalidrawLib.default.Excalidraw;
                            excalidrawFound = true;
                        }
                    }
                    
                    if (window.Excalidraw && typeof window.Excalidraw === 'function') {
                        excalidrawFound = true;
                    }
                    
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ React —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                    if (excalidrawFound && window.React) {
                        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ React API –¥–æ—Å—Ç—É–ø–Ω—ã
                        if (!window.React.unstable_batchedUpdates) {
                            console.log('üîß Adding missing React API for Excalidraw compatibility');
                            window.React.unstable_batchedUpdates = function(callback) {
                                callback();
                            };
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–≥–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ API
                        if (!window.React.useState) {
                            console.warn('‚ö†Ô∏è React hooks not available, this may cause issues');
                        }
                    }
                    
                    if (attempts % 10 === 0) {
                        console.log(`Attempt ${attempts}: ExcalidrawLib=${!!window.ExcalidrawLib}, Excalidraw=${!!window.Excalidraw}, Found=${excalidrawFound}`);
                        console.log(`React status: version=${window.React?.version}, batchedUpdates=${!!window.React?.unstable_batchedUpdates}`);
                        console.log('üîç Network status:', {
                            online: navigator.onLine,
                            connection: navigator.connection ? {
                                effectiveType: navigator.connection.effectiveType,
                                downlink: navigator.connection.downlink
                            } : 'Not available'
                        });
                    }
                    
                    if (excalidrawFound) {
                        console.log('‚úÖ Excalidraw library initialized successfully');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        console.warn('‚ö†Ô∏è Excalidraw library initialization timeout');
                        resolve(); // –ù–µ reject, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É
                    } else {
                        setTimeout(checkExcalidraw, 100);
                    }
                };
                
                checkExcalidraw();
            });
        }
    </script>
    
    
    
    <!-- WebSocket –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π -->
    <script>
        // –ó–∞–≥—Ä—É–∂–∞–µ–º WebSocket –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
        async function loadWebSocketLibraries() {
            try {
                console.log('üîå Loading WebSocket libraries...');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º SockJS
                await window.CDNLoader.loadScript(window.CDN_SOURCES.sockjs, {
                    id: 'sockjs',
                    timeout: 20000,  // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–æ 20 —Å–µ–∫—É–Ω–¥
                    retries: 3       // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–æ 3
                });
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º STOMP
                await window.CDNLoader.loadScript(window.CDN_SOURCES.stomp, {
                    id: 'stomp',
                    timeout: 20000,  // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–æ 20 —Å–µ–∫—É–Ω–¥
                    retries: 3       // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–æ 3
                });
                
                console.log('‚úÖ WebSocket libraries loaded successfully');
            } catch (error) {
                console.error('‚ùå Failed to load WebSocket libraries:', error);
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É –±–µ–∑ WebSocket
            }
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É WebSocket –±–∏–±–ª–∏–æ—Ç–µ–∫
        loadWebSocketLibraries();
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        function testSynchronization() {
            console.log('üß™ Testing synchronization...');
            
            if (!excalidrawAPI) {
                console.error('‚ùå Excalidraw API not ready');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
            const testElement = {
                id: `test_${Date.now()}`,
                type: 'rectangle',
                x: Math.random() * 400,
                y: Math.random() * 300,
                width: 100,
                height: 50,
                angle: 0,
                strokeColor: '#ff0000',
                backgroundColor: '#ffff00',
                fillStyle: 'solid',
                strokeWidth: 2,
                strokeStyle: 'solid',
                roughness: 1,
                opacity: 100,
                groupIds: [],
                frameId: null,
                roundness: null,
                seed: Math.floor(Math.random() * 1000000),
                versionNonce: Math.floor(Math.random() * 1000000),
                isDeleted: false,
                boundElements: null,
                updated: Date.now(),
                link: null,
                locked: false
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –Ω–∞ –¥–æ—Å–∫—É
            const currentElements = excalidrawAPI.getSceneElements();
            const newElements = [...currentElements, testElement];
            
            excalidrawAPI.updateScene({
                elements: newElements
            });
            
            console.log('‚úÖ Test element added, synchronization should trigger automatically');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                const elements = excalidrawAPI.getSceneElements();
                const testEl = elements.find(el => el.id === testElement.id);
                if (testEl) {
                    console.log('‚úÖ Test element found, synchronization working');
                } else {
                    console.warn('‚ö†Ô∏è Test element not found, checking synchronization');
                }
            }, 2000);
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É Excalidraw –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ React
        setTimeout(() => {
            loadExcalidrawCSS();
            setTimeout(() => {
                loadExcalidrawJS();
            }, 500);
        }, 1000);
    </script>
    
    <script th:inline="javascript">
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Thymeleaf
        const lessonData = /*[[${lesson}]]*/ null;
        const currentUser = /*[[${currentUser}]]*/ null;
        const isTeacher = /*[[${isTeacher}]]*/ false;
        const isAdmin = /*[[${isAdmin}]]*/ false;
        const isViewOnly = /*[[${isViewOnly}]]*/ false;
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º ID —É—Ä–æ–∫–∞
        const urlParams = new URLSearchParams(window.location.search);
        const lessonIdFromUrl = urlParams.get('lessonId');
        const lessonId = lessonData ? lessonData.id : (lessonIdFromUrl || 'demo');
        
        console.log('üé® Excalidraw Board Initialization');
        console.log('Lesson ID:', lessonId);
        console.log('Current User:', currentUser);
        console.log('Is Teacher:', isTeacher);
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è (–∏—Å–ø—Ä–∞–≤–ª—è–µ–º –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏)
        let isApplyingRemoteUpdate = false;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let excalidrawAPI = null;
        let stompClient = null;
        let isConnected = false;
        let updateSequence = 0;
        let lastSentElementsHash = null;
        let messageQueue = [];
        let connectionQuality = 'good';
        let pendingUpdates = new Map();
        let collaborationState = {
            isOwner: isTeacher || isAdmin,
            roomId: lessonId,
            userId: currentUser ? currentUser.id.toString() : Math.random().toString(36).substr(2, 9),
            userName: currentUser ? currentUser.name : 'Anonymous',
            userRole: isTeacher ? 'teacher' : isAdmin ? 'admin' : 'student'
        };
        let connectedUsers = new Map();
        let heartbeatInterval = null;
        let processedMessageIds = new Set();
        let lastRemoteUpdate = 0;
        let lastRemoteUpdateTime = 0;
        let lastLocalUpdate = 0;
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –¥–ª—è Excalidraw
        window.addEventListener('error', function(event) {
            if (event.error && event.error.message && event.error.message.includes('forEach')) {
                console.error('üö® CRITICAL: forEach error detected:', event.error);
                console.error('üö® Stack trace:', event.error.stack);
                
                // –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
                try {
                    if (excalidrawAPI) {
                        console.log('üîÑ Attempting to recover from forEach error...');
                        const currentElements = excalidrawAPI.getSceneElements();
                        const currentAppState = excalidrawAPI.getAppState();
                        const currentFiles = excalidrawAPI.getFiles();
                        
                        // –í–∞–ª–∏–¥–∏—Ä—É–µ–º –∏ –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                        const validElements = validateAndCleanElements(currentElements || []);
                        const validAppState = validateAndCleanAppState(currentAppState || {});
                        const validFiles = validateAndCleanFiles(currentFiles || {});
                        
                        // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: validFiles —É–∂–µ Map –∏–ª–∏ undefined
                        const filesForRecovery = validFiles && validFiles.size > 0 ? validFiles : undefined;
                        
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—á–∏—â–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                        const success = safeUpdateScene(excalidrawAPI, validElements, validAppState, filesForRecovery);
                        if (success) {
                            console.log('‚úÖ Successfully recovered from forEach error');
                        } else {
                            console.error('‚ùå Failed to recover from forEach error');
                        }
                    }
                } catch (recoveryError) {
                    console.error('‚ùå Error during recovery attempt:', recoveryError);
                }
            }
        });
        let lastSendTime = 0;
        let sendTimeout = null;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
        const initialState = {
            excalidrawAPI: null,
            stompClient: null,
            isConnected: false,
            reconnectAttempts: 0,
            maxReconnectAttempts: 5,
            connectedUsers: new Map(),
            collaborationState: {
                isOwner: isTeacher || isAdmin,
                roomId: lessonId,
                userId: currentUser ? currentUser.id.toString() : Math.random().toString(36).substr(2, 9),
                userName: currentUser ? currentUser.name : '–ì–æ—Å—Ç—å'
            },
            lastLocalUpdate: 0,
            lastRemoteUpdate: 0,
            pendingUpdates: new Map(),
            updateSequence: 0,
            isApplyingRemoteUpdate: false,
            connectionQuality: 'good', // good, poor, disconnected
            messageQueue: [],
            heartbeatInterval: null,
            processedMessageIds: new Set(),
            lastSentElementsHash: null,
            isLoading: true,
            loadingStatus: '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...',
            loadingSubStatus: '–ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫...',
            error: null
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è
        window.ReactStateManager.initialize(initialState);
        
        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
        const unsubscribeFromConnection = window.ReactStateManager.subscribe('isConnected', (isConnected) => {
            updateConnectionStatus(isConnected);
        });
        
        const unsubscribeFromLoading = window.ReactStateManager.subscribe('isLoading', (isLoading) => {
            updateLoadingUI(isLoading);
        });
        
        const unsubscribeFromError = window.ReactStateManager.subscribe('error', (error) => {
            if (error) {
                showError(error);
            }
        });
        
        // –ì–µ—Ç—Ç–µ—Ä—ã –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
        const getState = (key) => window.ReactStateManager.getState(key);
        const setState = (key, value, options) => window.ReactStateManager.setState(key, value, options);
        const setMultipleState = (updates, options) => window.ReactStateManager.setMultipleState(updates, options);
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        let currentTool = 'selection';
        let currentColor = '#000000';
        let currentStrokeWidth = 2;
        let currentOpacity = 10000;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI
        function initializeUI() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Ä–æ–∫–µ
            if (lessonData) {
                document.getElementById('lessonTitle').textContent = 
                    `${lessonData.subject?.name || '–ü—Ä–µ–¥–º–µ—Ç'} - ${lessonData.student?.name || '–£—á–µ–Ω–∏–∫'}`;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            const userInfo = document.getElementById('userInfo');
            if (currentUser) {
                const roleText = isTeacher ? '–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å' : isAdmin ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–£—á–µ–Ω–∏–∫';
                userInfo.textContent = `${currentUser.name} (${roleText})`;
            } else {
                userInfo.textContent = '–ì–æ—Å—Ç—å';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
            if (isTeacher || isAdmin) {
                document.getElementById('endLessonBtn').style.display = 'block';
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            if (isViewOnly) {
                document.querySelectorAll('.btn:not(#shareBtn)').forEach(btn => {
                    btn.style.display = 'none';
                });
            }
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
        function updateLoadingStatus(text, details = '') {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ—Ä–µ–∑ State Manager
            if (window.ReactStateManager && window.ReactStateManager.isInitialized) {
                setMultipleState({
                    loadingStatus: text,
                    loadingSubStatus: details
                });
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI –Ω–∞–ø—Ä—è–º—É—é
            const loadingText = document.getElementById('loading-text');
            const loadingDetails = document.getElementById('loading-details');
            if (loadingText) loadingText.textContent = text;
            if (loadingDetails) loadingDetails.textContent = details;
            
            console.log(`üìä Loading Status: ${text}${details ? ' - ' + details : ''}`);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI –∑–∞–≥—Ä—É–∑–∫–∏
        function updateLoadingUI(isLoading) {
            setState('isLoading', isLoading);
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = isLoading ? 'flex' : 'none';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function updateConnectionStatus(isConnected) {
            setState('isConnected', isConnected);
            const connectionStatus = document.getElementById('connection-status');
            if (connectionStatus) {
                connectionStatus.textContent = isConnected ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ' : '–û—Ç–∫–ª—é—á–µ–Ω–æ';
                connectionStatus.className = isConnected ? 'status-connected' : 'status-disconnected';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–∫–∏
        function showError(error) {
            setState('error', error);
            console.error('‚ùå Application Error:', error);
            updateLoadingStatus('–û—à–∏–±–∫–∞', error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            const errorElement = document.getElementById('error-message');
            if (errorElement) {
                errorElement.textContent = error.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞';
                errorElement.style.display = 'block';
            }
        }
        
        function hideLoadingIndicator() {
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏
        function initializeToolbar() {
            console.log('üîß Initializing custom toolbar...');
            
            // –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∏—Å–æ–≤–∞–Ω–∏—è –∏ —Ñ–∏–≥—É—Ä—ã - —É–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π
            const toolButtons = document.querySelectorAll('[data-tool]');
            console.log('üîß Found', toolButtons.length, 'tool buttons');
            
            toolButtons.forEach((btn, index) => {
                const tool = btn.dataset.tool;
                console.log(`üîß Button ${index}: tool="${tool}", id="${btn.id}"`);
                
                // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                btn.removeEventListener('click', handleToolClick);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                btn.addEventListener('click', handleToolClick);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å —Ñ–æ–∫—É—Å–æ–º
                btn.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                });
            });
            
            function handleToolClick(e) {
                console.log('üîß handleToolClick called', e);
                e.preventDefault();
                e.stopPropagation();
                
                const tool = e.currentTarget.dataset.tool;
                console.log('üîß Tool from dataset:', tool, 'Target:', e.currentTarget);
                
                if (!tool) {
                    console.warn('‚ö†Ô∏è No tool found in dataset');
                    return;
                }
                
                console.log('üîß Tool selected:', tool, 'Current tool:', currentTool);
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
                setActiveTool(tool);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API
                const api = excalidrawAPI || window.excalidrawAPI || getState('excalidrawAPI');
                if (!api) {
                    console.warn('‚ö†Ô∏è Excalidraw API not available, tool change will be applied when API is ready');
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–æ–∑–∂–µ
                    setState('pendingTool', tool);
                    return;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º Excalidraw —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
                setTimeout(() => {
                    updateExcalidrawTool(tool);
                }, 50);
                
                // –£–ø—Ä–∞–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å—é –Ω–∞—Å—Ç—Ä–æ–µ–∫
                if (tool === 'freedraw') {
                    openSettingsPanel();
                } else {
                    closeSettingsPanel();
                }
            }
            
            // –¶–≤–µ—Ç–∞
            document.querySelectorAll('[data-color]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const color = btn.dataset.color;
                    setActiveColor(color);
                    updateExcalidrawColor(color);
                });
            });
            
            // –†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏
            const strokeWidthSlider = document.getElementById('strokeWidth');
            strokeWidthSlider.addEventListener('input', (e) => {
                const width = parseInt(e.target.value);
                currentStrokeWidth = width;
                document.getElementById('sizeDisplay').textContent = width + 'px';
                updateExcalidrawStrokeWidth(width);
            });
            
            // –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
            // –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ç–µ–ø–µ—Ä—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è - –≤—Å–µ–≥–¥–∞ 10000% —è—Ä–∫–æ—Å—Ç–∏ (—É–ª—å—Ç—Ä–∞-—è—Ä–∫–æ—Å—Ç—å)
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            document.getElementById('panelClose').addEventListener('click', closeSettingsPanel);
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
            document.getElementById('clear-canvas').addEventListener('click', clearCanvas);
            document.getElementById('undo').addEventListener('click', undo);
            document.getElementById('redo').addEventListener('click', redo);
            document.getElementById('test-sync').addEventListener('click', testSynchronization);
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ—ë
            document.addEventListener('click', (e) => {
                const panel = document.getElementById('settingsPanel');
                const toolbar = document.getElementById('customToolbar');
                
                if (!panel.contains(e.target) && !toolbar.contains(e.target)) {
                    closeSettingsPanel();
                }
            });
            
            console.log('‚úÖ Toolbar initialized');
        }
        
        function openSettingsPanel() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.add('open');
        }
        
        function closeSettingsPanel() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.remove('open');
        }
        
        function setActiveTool(tool) {
            console.log('üîß setActiveTool called with:', tool);
            currentTool = tool;
            
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
            const allButtons = document.querySelectorAll('.tool-btn');
            console.log('üîß Removing active from', allButtons.length, 'buttons');
            allButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É
            const activeBtn = document.querySelector(`[data-tool="${tool}"]`);
            console.log('üîß Looking for button with data-tool="' + tool + '"', activeBtn);
            if (activeBtn) {
                activeBtn.classList.add('active');
                console.log('üîß Added active class to button:', activeBtn.id);
            } else {
                console.warn('‚ö†Ô∏è Button not found for tool:', tool);
            }
        }
        
        function setActiveColor(color) {
            currentColor = color;
            
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —Ü–≤–µ—Ç–æ–≤
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ü–≤–µ—Ç—É
            const activeBtn = document.querySelector(`[data-color="${color}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }
        
        function updateExcalidrawTool(tool) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º API –±–æ–ª–µ–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ
            const api = excalidrawAPI || window.excalidrawAPI || getState('excalidrawAPI');
            if (!api) {
                console.warn('‚ö†Ô∏è Excalidraw API not available for tool change');
                return;
            }
            
            try {
                // Mapping –Ω–∞—à–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∫ Excalidraw –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º
                const toolMapping = {
                    'selection': 'selection',
                    'freedraw': 'freedraw',
                    'eraser': 'eraser',
                    'text': 'text',
                    'rectangle': 'rectangle',
                    'ellipse': 'ellipse',
                    'arrow': 'arrow',
                    'line': 'line'
                };
                
                const excalidrawTool = toolMapping[tool] || tool;
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                const currentAppState = api.getAppState();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ activeTool
                const newAppState = {
                    ...currentAppState,
                    activeTool: {
                        type: excalidrawTool
                    }
                };
                
                api.updateScene({ appState: newAppState });
                console.log('üîß Tool changed to:', excalidrawTool);
            } catch (error) {
                console.warn('‚ö†Ô∏è Tool update error:', error);
            }
        }
        
        function updateExcalidrawColor(color) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º API –±–æ–ª–µ–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ
            const api = excalidrawAPI || window.excalidrawAPI || getState('excalidrawAPI');
            if (!api) {
                console.warn('‚ö†Ô∏è Excalidraw API not available for color change');
                return;
            }
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                const currentAppState = api.getAppState();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ü–≤–µ—Ç–∞
                const newAppState = {
                    ...currentAppState,
                    currentItemStrokeColor: color,
                    currentItemBackgroundColor: color, // –§–∏–≥—É—Ä—ã –∑–∞—à—Ç—Ä–∏—Ö–æ–≤–∞–Ω—ã —Ç–µ–º –∂–µ —Ü–≤–µ—Ç–æ–º
                    currentItemFillStyle: 'solid' // –°–ø–ª–æ—à–Ω–∞—è –∑–∞–ª–∏–≤–∫–∞
                };
                
                api.updateScene({ appState: newAppState });
                console.log('üé® Color changed to:', color, '(shapes filled)');
            } catch (error) {
                console.warn('‚ö†Ô∏è Color update error:', error);
            }
        }
        
        function updateExcalidrawStrokeWidth(width) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º API –±–æ–ª–µ–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ
            const api = excalidrawAPI || window.excalidrawAPI || getState('excalidrawAPI');
            if (!api) {
                console.warn('‚ö†Ô∏è Excalidraw API not available for stroke width change');
                return;
            }
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                const currentAppState = api.getAppState();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —à–∏—Ä–∏–Ω—É –ª–∏–Ω–∏–∏
                const newAppState = {
                    ...currentAppState,
                    currentItemStrokeWidth: width
                };
                
                api.updateScene({ appState: newAppState });
                console.log('üìè Stroke width changed to:', width);
            } catch (error) {
                console.warn('‚ö†Ô∏è Stroke width update error:', error);
            }
        }
        
        function updateExcalidrawOpacity() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º API –±–æ–ª–µ–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ
            const api = excalidrawAPI || window.excalidrawAPI || getState('excalidrawAPI');
            if (!api) {
                console.warn('‚ö†Ô∏è Excalidraw API not available for opacity change');
                return;
            }
            
            try {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–ª—å—Ç—Ä–∞-—è—Ä–∫–æ—Å—Ç—å (100.0 = 10000% —è—Ä–∫–æ—Å—Ç–∏, –≤ 100 —Ä–∞–∑ —è—Ä—á–µ –æ–±—ã—á–Ω–æ–≥–æ)
                const normalizedOpacity = 100.0;
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                const currentAppState = api.getAppState();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
                const newAppState = {
                    ...currentAppState,
                    currentItemOpacity: normalizedOpacity
                };
                
                api.updateScene({ appState: newAppState });
                console.log('üëª Opacity set to ultra brightness: 10000% (normalized: ' + normalizedOpacity + ')');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                currentOpacity = 10000;
            } catch (error) {
                console.warn('‚ö†Ô∏è Opacity update error:', error);
            }
        }
        
        function clearCanvas() {
            if (!excalidrawAPI) return;
            
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –¥–æ—Å–∫—É?')) {
                try {
                    const success = safeUpdateScene(excalidrawAPI, [], {}, new Map());
                    if (success) {
                        console.log('üóëÔ∏è Canvas cleared');
                        showToast('–î–æ—Å–∫–∞ –æ—á–∏—â–µ–Ω–∞', 'success');
                    } else {
                        showToast('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –¥–æ—Å–∫–∏', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Clear canvas error:', error);
                    showToast('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –¥–æ—Å–∫–∏', 'error');
                }
            }
        }
        
        function undo() {
            if (!excalidrawAPI) return;
            
            try {
                // Excalidraw –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø—Ä—è–º–æ–π –º–µ—Ç–æ–¥ undo, —Å–∏–º—É–ª–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ keyboard event
                const event = new KeyboardEvent('keydown', {
                    key: 'z',
                    ctrlKey: true,
                    bubbles: true
                });
                document.querySelector('.excalidraw-container').dispatchEvent(event);
                console.log('‚Ü∂ Undo triggered');
            } catch (error) {
                console.warn('‚ö†Ô∏è Undo error:', error);
            }
        }
        
        function redo() {
            if (!excalidrawAPI) return;
            
            try {
                // –°–∏–º—É–ª–∏—Ä—É–µ–º Ctrl+Shift+Z –¥–ª—è redo
                const event = new KeyboardEvent('keydown', {
                    key: 'z',
                    ctrlKey: true,
                    shiftKey: true,
                    bubbles: true
                });
                document.querySelector('.excalidraw-container').dispatchEvent(event);
                console.log('‚Ü∑ Redo triggered');
            } catch (error) {
                console.warn('‚ö†Ô∏è Redo error:', error);
            }
        }
        
        function syncToolbarWithExcalidraw(appState) {
            if (!appState) return;
            
            try {
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –Ω–æ –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å –ª–∞—Å—Ç–∏–∫–∞ –Ω–∞ selection –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                if (appState.activeTool && appState.activeTool.type !== currentTool) {
                    // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç - –ª–∞—Å—Ç–∏–∫ –∏ Excalidraw –ø–µ—Ä–µ–∫–ª—é—á–∏–ª—Å—è –Ω–∞ selection, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —ç—Ç–æ
                    if (currentTool === 'eraser' && appState.activeTool.type === 'selection') {
                        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ª–∞—Å—Ç–∏–∫
                        setTimeout(() => {
                            updateExcalidrawTool('eraser');
                        }, 10);
                        return;
                    }
                    setActiveTool(appState.activeTool.type);
                }
                
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Ü–≤–µ—Ç
                if (appState.currentItemStrokeColor && appState.currentItemStrokeColor !== currentColor) {
                    setActiveColor(appState.currentItemStrokeColor);
                }
                
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏
                if (appState.currentItemStrokeWidth && appState.currentItemStrokeWidth !== currentStrokeWidth) {
                    currentStrokeWidth = appState.currentItemStrokeWidth;
                    const slider = document.getElementById('strokeWidth');
                    if (slider) {
                        slider.value = currentStrokeWidth;
                        document.getElementById('sizeDisplay').textContent = currentStrokeWidth + 'px';
                    }
                }
                
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
                // –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –≤—Å–µ–≥–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —É–ª—å—Ç—Ä–∞-—è—Ä–∫–æ—Å—Ç—å (10000%)
                if (appState.currentItemOpacity !== undefined && appState.currentItemOpacity !== 100.0) {
                    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É–ª—å—Ç—Ä–∞-—è—Ä–∫–æ—Å—Ç—å
                    updateExcalidrawOpacity();
                } else if (appState.currentItemOpacity === undefined) {
                    // –ï—Å–ª–∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10000%
                    updateExcalidrawOpacity();
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Toolbar sync error:', error);
            }
        }
        
        // –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ updateScene
        function safeUpdateScene(api, elements, appState = {}, files = undefined) {
            console.log('üîç safeUpdateScene called with:');
            console.log('  - api:', typeof api, api ? 'available' : 'null');
            console.log('  - elements:', typeof elements, Array.isArray(elements) ? `Array(${elements.length})` : 'not array');
            console.log('  - appState:', typeof appState);
            console.log('  - files:', typeof files, files instanceof Map ? `Map(${files.size})` : files);
            
            if (!api) {
                console.warn('‚ö†Ô∏è API not available for updateScene');
                return false;
            }

            try {
                // –°–¢–†–û–ì–ê–Ø –≤–∞–ª–∏–¥–∞—Ü–∏—è elements
                let validElements = elements;
                if (!Array.isArray(validElements)) {
                    console.warn('‚ö†Ô∏è Elements is not an array in safeUpdateScene, converting...');
                    if (typeof validElements === 'string') {
                        try {
                            validElements = JSON.parse(validElements);
                        } catch (e) {
                            console.error('‚ùå Failed to parse elements string in safeUpdateScene:', e);
                            validElements = [];
                        }
                    } else if (validElements && typeof validElements === 'object') {
                        if (validElements.elements && Array.isArray(validElements.elements)) {
                            validElements = validElements.elements;
                        } else {
                            validElements = Object.values(validElements);
                        }
                    } else {
                        validElements = [];
                    }
                }
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                if (!Array.isArray(validElements)) {
                    console.error('‚ùå Elements is still not an array after conversion in safeUpdateScene, using empty array');
                    validElements = [];
                }
                
                // –í–∞–ª–∏–¥–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
                validElements = validateAndCleanElements(validElements);
                
                // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                if (!Array.isArray(validElements)) {
                    console.error('‚ùå Final validation failed in safeUpdateScene: validElements is not an array');
                    return false;
                }
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º files - Excalidraw –æ–∂–∏–¥–∞–µ—Ç Map –∏–ª–∏ undefined
                let validFiles;
                if (files === undefined || files === null) {
                    validFiles = undefined;
                } else if (files instanceof Map) {
                    // –£–∂–µ Map, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –µ—Å—Ç—å
                    validFiles = files.size > 0 ? files : undefined;
                } else if (typeof files === 'object') {
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—ä–µ–∫—Ç –≤ Map –¥–ª—è Excalidraw
                    validFiles = Object.keys(files).length > 0 ? new Map(Object.entries(files)) : undefined;
                } else {
                    console.warn('‚ö†Ô∏è Invalid files type in safeUpdateScene:', typeof files);
                    validFiles = undefined;
                }
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º updateScene
                if (!Array.isArray(validElements)) {
                    console.error('‚ùå CRITICAL: validElements is not an array before updateScene call');
                    return false;
                }
                
                // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–∑–æ–≤ updateScene —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞—â–∏—Ç–æ–π
                try {
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                    const safeElements = Array.isArray(validElements) ? validElements : [];
                    const safeAppState = appState && typeof appState === 'object' ? appState : {};
                    const safeFiles = validFiles;
                    
                    console.log('üîç Final data check before updateScene:');
                    console.log('  - elements:', Array.isArray(safeElements) ? `Array(${safeElements.length})` : typeof safeElements);
                    console.log('  - appState:', typeof safeAppState);
                    console.log('  - files:', safeFiles instanceof Map ? `Map(${safeFiles.size})` : typeof safeFiles);
                    
                    // –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞: —É–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ elements —ç—Ç–æ –∏–º–µ–Ω–Ω–æ –º–∞—Å—Å–∏–≤
                    if (!Array.isArray(safeElements)) {
                        console.error('‚ùå CRITICAL: safeElements is not an array before updateScene!');
                        console.error('‚ùå Type:', typeof safeElements, 'Value:', safeElements);
                        throw new Error('Elements must be an array');
                    }
                    
                    // –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞: —É–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ files —ç—Ç–æ Map –∏–ª–∏ undefined
                    if (safeFiles !== undefined && safeFiles !== null && !(safeFiles instanceof Map)) {
                        console.error('‚ùå CRITICAL: safeFiles is not a Map or undefined before updateScene!');
                        console.error('‚ùå Type:', typeof safeFiles, 'Value:', safeFiles);
                        // –ù–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, –∞ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º —Ç–∏–ø
                        console.warn('‚ö†Ô∏è Converting safeFiles to undefined');
                        safeFiles = undefined;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ –º–∞—Å—Å–∏–≤–µ –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å
                    if (safeElements.length > 0) {
                        const firstElement = safeElements[0];
                        console.log('  - first element:', typeof firstElement, firstElement?.id, firstElement?.type);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤–∞–ª–∏–¥–Ω—ã
                        for (let i = 0; i < safeElements.length; i++) {
                            const element = safeElements[i];
                            if (!element || typeof element !== 'object') {
                                console.error(`‚ùå Invalid element at index ${i}:`, element);
                                throw new Error(`Invalid element at index ${i}`);
                            }
                            
                            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ pressures –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å points
                            if (element.points && Array.isArray(element.points)) {
                                if (!element.pressures || !Array.isArray(element.pressures)) {
                                    console.warn(`‚ö†Ô∏è Element ${i} missing pressures, adding default values`);
                                    element.pressures = element.points.map(() => 0.5);
                                } else if (element.pressures.length !== element.points.length) {
                                    console.warn(`‚ö†Ô∏è Element ${i} pressures length mismatch, fixing`);
                                    // –î–æ–ø–æ–ª–Ω—è–µ–º –∏–ª–∏ –æ–±—Ä–µ–∑–∞–µ–º pressures –¥–æ –Ω—É–∂–Ω–æ–π –¥–ª–∏–Ω—ã
                                    if (element.pressures.length < element.points.length) {
                                        const needed = element.points.length - element.pressures.length;
                                        element.pressures = element.pressures.concat(Array(needed).fill(0.5));
                                    } else {
                                        element.pressures = element.pressures.slice(0, element.points.length);
                                    }
                                }
                            }
                        }
                    }
                    
                    // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ API
                    if (!api || typeof api.updateScene !== 'function') {
                        console.error('‚ùå API or updateScene method is not available');
                        throw new Error('API updateScene method not available');
                    }
                    
                        console.log('üîç Final updateScene call:');
                        console.log('  - elements:', Array.isArray(safeElements) ? `Array(${safeElements.length})` : typeof safeElements);
                        console.log('  - appState:', typeof safeAppState);
                        console.log('  - files:', safeFiles instanceof Map ? `Map(${safeFiles.size})` : typeof safeFiles);
                        
                        // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –û–¢–õ–ê–î–ö–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–µ—Ç–∞–ª—å–Ω–æ
                        console.log('üîç DETAILED VALIDATION:');
                        console.log('  - safeElements constructor:', safeElements?.constructor?.name);
                        console.log('  - safeElements isArray:', Array.isArray(safeElements));
                        console.log('  - safeElements length:', safeElements?.length);
                        console.log('  - safeAppState constructor:', safeAppState?.constructor?.name);
                        console.log('  - safeFiles constructor:', safeFiles?.constructor?.name);
                        console.log('  - safeFiles instanceof Map:', safeFiles instanceof Map);
                        console.log('  - safeFiles size:', safeFiles?.size);
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ elements –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –º–∞—Å—Å–∏–≤
                        if (!Array.isArray(safeElements)) {
                            console.error('‚ùå CRITICAL: safeElements is not an array!');
                            console.error('‚ùå Type:', typeof safeElements);
                            console.error('‚ùå Constructor:', safeElements?.constructor?.name);
                            console.error('‚ùå Value:', safeElements);
                            throw new Error('Elements must be an array');
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ files —ç—Ç–æ Map –∏–ª–∏ undefined
                        if (safeFiles !== undefined && safeFiles !== null && !(safeFiles instanceof Map)) {
                            console.error('‚ùå CRITICAL: safeFiles is not a Map!');
                            console.error('‚ùå Type:', typeof safeFiles);
                            console.error('‚ùå Constructor:', safeFiles?.constructor?.name);
                            console.error('‚ùå Value:', safeFiles);
                            throw new Error('Files must be a Map or undefined');
                        }
                    
                    // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: Excalidraw –æ–∂–∏–¥–∞–µ—Ç files –∫–∞–∫ Map –∏–ª–∏ undefined
                    let filesForExcalidraw;
                    if (safeFiles instanceof Map) {
                        filesForExcalidraw = safeFiles.size > 0 ? safeFiles : undefined;
                    } else if (safeFiles && typeof safeFiles === 'object') {
                        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—ä–µ–∫—Ç –≤ Map
                        filesForExcalidraw = Object.keys(safeFiles).length > 0 ? new Map(Object.entries(safeFiles)) : undefined;
                    } else {
                        filesForExcalidraw = undefined;
                    }
                    
                    // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ó–ê–©–ò–¢–ê: –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
                    console.log('üîç Final data before updateScene:');
                    console.log('  - elements:', Array.isArray(safeElements) ? `Array(${safeElements.length})` : typeof safeElements);
                    console.log('  - appState:', typeof safeAppState);
                    console.log('  - files:', filesForExcalidraw instanceof Map ? `Map(${filesForExcalidraw.size})` : filesForExcalidraw);
                    
                    // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ elements —ç—Ç–æ –º–∞—Å—Å–∏–≤
                    if (!Array.isArray(safeElements)) {
                        console.error('‚ùå CRITICAL: safeElements is not an array!');
                        throw new Error('Elements must be an array');
                    }
                    
                    api.updateScene({
                        elements: safeElements,
                        appState: safeAppState,
                        files: filesForExcalidraw
                    });
                } catch (updateError) {
                    console.error('‚ùå Error in api.updateScene call:', updateError);
                    console.error('‚ùå Error details:', {
                        message: updateError.message,
                        stack: updateError.stack,
                        validElements: validElements,
                        validFiles: validFiles
                    });
                    throw updateError;
                }
                
                console.log('‚úÖ safeUpdateScene completed successfully with', validElements.length, 'elements');
                return true;
            } catch (error) {
                console.error('‚ùå Error in safeUpdateScene:', error);
                return false;
            }
        }
        
        // –£–õ–£–ß–®–ï–ù–ù–´–ï —Ñ—É–Ω–∫—Ü–∏–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Excalidraw —Å —Å—Ç—Ä–æ–≥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
        function validateAndCleanElements(elements) {
            console.log('üîç validateAndCleanElements called with:', typeof elements, Array.isArray(elements), elements?.length);
            
            // –°–¢–†–û–ì–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ null/undefined
            if (elements === null || elements === undefined) {
                console.warn('‚ö†Ô∏è Elements is null/undefined, returning empty array');
                return [];
            }
            
            // –°–¢–†–û–ì–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —ç—Ç–æ –º–∞—Å—Å–∏–≤
            if (!Array.isArray(elements)) {
                console.warn('‚ö†Ô∏è Elements is not an array, type:', typeof elements, 'value:', elements);
                
                // –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ –º–∞—Å—Å–∏–≤
                if (typeof elements === 'string') {
                    try {
                        const parsed = JSON.parse(elements);
                        if (Array.isArray(parsed)) {
                            console.log('‚úÖ Successfully parsed string to array');
                            return validateAndCleanElements(parsed); // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –≤–∞–ª–∏–¥–∏—Ä—É–µ–º
                        }
                    } catch (e) {
                        console.error('‚ùå Failed to parse elements string:', e);
                    }
                } else if (elements && typeof elements === 'object') {
                    // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç —Å –º–∞—Å—Å–∏–≤–æ–º elements
                    if (elements.elements && Array.isArray(elements.elements)) {
                        console.log('‚úÖ Found elements array in object, extracting...');
                        return validateAndCleanElements(elements.elements);
                    }
                    // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç, –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π
                    const values = Object.values(elements);
                    if (values.length > 0) {
                        console.log('‚úÖ Converting object to array of values');
                        return validateAndCleanElements(values);
                    }
                }
                
                console.error('‚ùå Cannot convert elements to array, returning empty array');
                return [];
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –º–∞—Å—Å–∏–≤ –Ω–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω
            if (elements.length === 0) {
                console.log('üîç Elements array is empty, returning as is');
                return [];
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º–∞—Å—Å–∏–≤ –Ω–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç undefined/null —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º–æ–∂–µ–º –∏—Ç–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ –º–∞—Å—Å–∏–≤—É
                for (let i = 0; i < elements.length; i++) {
                    if (elements[i] === undefined && i in elements) {
                        console.warn(`‚ö†Ô∏è Found undefined element at index ${i}, replacing with null`);
                        elements[i] = null;
                    }
                }
            } catch (error) {
                console.error('‚ùå Array is corrupted, cannot iterate:', error);
                return [];
            }
            
            // –£–õ–£–ß–®–ï–ù–ù–ê–Ø —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è - –º–µ–Ω–µ–µ —Å—Ç—Ä–æ–≥–∞—è, –Ω–æ –±–æ–ª–µ–µ –Ω–∞–¥—ë–∂–Ω–∞—è
            const filteredElements = elements.filter(element => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑–æ–≤—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
                if (!element || typeof element !== 'object') {
                    return false;
                }
                
                // –≠–ª–µ–º–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å ID (–º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞ –∏–ª–∏ —á–∏—Å–ª–æ)
                if (!element.id && element.id !== 0) {
                    return false;
                }
                
                // –≠–ª–µ–º–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å —Ç–∏–ø
                if (!element.type) {
                    return false;
                }
                
                return true;
            });
            
            console.log('üîç Filtered elements:', filteredElements.length, 'out of', elements.length);
            
                const cleanedElements = filteredElements.map(element => {
                // –°–æ–∑–¥–∞–µ–º —á–∏—Å—Ç—ã–π —ç–ª–µ–º–µ–Ω—Ç —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –¥–ª—è Excalidraw
                const cleanElement = {
                    id: element.id,
                    type: element.type,
                    x: Number(element.x) || 0,
                    y: Number(element.y) || 0,
                    width: Number(element.width) || 0,
                    height: Number(element.height) || 0,
                    angle: Number(element.angle) || 0,
                    strokeColor: element.strokeColor || '#1e1e1e',
                    backgroundColor: element.backgroundColor || 'transparent',
                    fillStyle: element.fillStyle || 'solid',
                    strokeWidth: Number(element.strokeWidth) || 2,
                    strokeStyle: element.strokeStyle || 'solid',
                    roughness: Number(element.roughness) || 1,
                    opacity: Number(element.opacity) || 100.0,
                    groupIds: Array.isArray(element.groupIds) ? element.groupIds : [],
                    frameId: element.frameId || null,
                    roundness: element.roundness || null,
                    seed: Number(element.seed) || 1,
                    versionNonce: Number(element.versionNonce) || 1,
                    isDeleted: Boolean(element.isDeleted),
                    boundElements: Array.isArray(element.boundElements) ? element.boundElements : [],
                    updated: Number(element.updated) || Date.now(),
                    link: element.link || null,
                    locked: Boolean(element.locked)
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                if (element.type === 'freedraw' && element.points) {
                    cleanElement.points = Array.isArray(element.points) ? element.points : [];
                    // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º pressures –¥–ª—è freedraw —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                    if (element.pressures && Array.isArray(element.pressures)) {
                        cleanElement.pressures = element.pressures;
                    } else if (element.points && Array.isArray(element.points)) {
                        // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ pressures —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                        cleanElement.pressures = element.points.map(() => 0.5);
                    } else {
                        cleanElement.pressures = [];
                    }
                }
                
                if (element.type === 'text' && element.text) {
                    cleanElement.text = String(element.text);
                    cleanElement.fontSize = Number(element.fontSize) || 16;
                    cleanElement.fontFamily = Number(element.fontFamily) || 1;
                    cleanElement.textAlign = element.textAlign || 'left';
                    cleanElement.verticalAlign = element.verticalAlign || 'top';
                }
                
                if (element.type === 'arrow' && element.points) {
                    cleanElement.points = Array.isArray(element.points) ? element.points : [];
                    // –î–æ–±–∞–≤–ª—è–µ–º pressures –¥–ª—è arrow –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (element.pressures && Array.isArray(element.pressures)) {
                        cleanElement.pressures = element.pressures;
                    }
                }
                
                if (element.type === 'line' && element.points) {
                    cleanElement.points = Array.isArray(element.points) ? element.points : [];
                    // –î–æ–±–∞–≤–ª—è–µ–º pressures –¥–ª—è line –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (element.pressures && Array.isArray(element.pressures)) {
                        cleanElement.pressures = element.pressures;
                    }
                }
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º pressures –¥–ª—è –ª—é–±—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å points
                if (element.points && Array.isArray(element.points) && !cleanElement.pressures) {
                    if (element.pressures && Array.isArray(element.pressures)) {
                        cleanElement.pressures = element.pressures;
                    } else {
                        // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ pressures —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
                        cleanElement.pressures = element.points.map(() => 0.5);
                    }
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞
                const validExtraProps = ['containerId', 'originalText', 'startArrowhead', 'endArrowhead'];
                validExtraProps.forEach(prop => {
                    if (element[prop] !== undefined) {
                        cleanElement[prop] = element[prop];
                    }
                });
                
                    return cleanElement;
                });
                
                // –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: —É–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç - –º–∞—Å—Å–∏–≤
                if (!Array.isArray(cleanedElements)) {
                    console.error('‚ùå CRITICAL: validateAndCleanElements did not return an array!');
                    console.error('‚ùå Returned type:', typeof cleanedElements);
                    console.error('‚ùå Returned value:', cleanedElements);
                    return [];
                }
                
                console.log('‚úÖ validateAndCleanElements returning array with', cleanedElements.length, 'elements');
                return cleanedElements;
        }
        
        function validateAndCleanAppState(appState) {
            if (!appState || typeof appState !== 'object') {
                return { viewBackgroundColor: "#ffffff" };
            }
            
            return {
                viewBackgroundColor: appState.viewBackgroundColor || "#ffffff",
                currentItemStrokeColor: appState.currentItemStrokeColor || "#1e1e1e",
                currentItemBackgroundColor: appState.currentItemBackgroundColor || "transparent",
                currentItemFillStyle: appState.currentItemFillStyle || "solid",
                currentItemStrokeWidth: Number(appState.currentItemStrokeWidth) || 2,
                currentItemStrokeStyle: appState.currentItemStrokeStyle || "solid",
                currentItemRoughness: Number(appState.currentItemRoughness) || 1,
                currentItemOpacity: Number(appState.currentItemOpacity) || 100.0,
                currentItemFontFamily: appState.currentItemFontFamily || 1,
                currentItemFontSize: Number(appState.currentItemFontSize) || 16,
                currentItemTextAlign: appState.currentItemTextAlign || "left",
                currentItemStartArrowhead: appState.currentItemStartArrowhead || null,
                currentItemEndArrowhead: appState.currentItemEndArrowhead || null,
                scrollX: Number(appState.scrollX) || 0,
                scrollY: Number(appState.scrollY) || 0,
                zoom: appState.zoom || { value: 1 },
                ...appState // –í–∫–ª—é—á–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞
            };
        }
        
        function validateAndCleanFiles(files) {
            console.log('üîç validateAndCleanFiles called with:', typeof files, files);
            
            // –°–¢–†–û–ì–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ null/undefined
            if (files === null || files === undefined) {
                console.log('üîç Files is null/undefined, returning undefined');
                return undefined;
            }
            
            // –ï—Å–ª–∏ —ç—Ç–æ —É–∂–µ Map, –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ–Ω –≤–∞–ª–∏–¥–Ω—ã–π
            if (files instanceof Map) {
                console.log('üîç Files is already a Map with', files.size, 'entries');
                // –ï—Å–ª–∏ Map –ø—É—Å—Ç–æ–π, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º undefined
                if (files.size === 0) {
                    console.log('üîç Empty Map, returning undefined');
                    return undefined;
                }
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ Map –Ω–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω
                try {
                    files.forEach((value, key) => {
                        if (typeof key !== 'string' && typeof key !== 'number') {
                            throw new Error('Invalid Map key type');
                        }
                    });
                    return files;
                } catch (error) {
                    console.warn('‚ö†Ô∏è Map is corrupted, returning undefined:', error);
                    return undefined;
                }
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π Map –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Excalidraw
            const cleanedFiles = new Map();
            
            try {
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –æ–±—ã—á–Ω—ã–π –æ–±—ä–µ–∫—Ç
                if (Array.isArray(files)) {
                    // –ï—Å–ª–∏ —ç—Ç–æ –º–∞—Å—Å–∏–≤, –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ Map
                    if (files.length === 0) {
                        console.log('üîç Empty files array, returning undefined');
                        return undefined;
                    }
                    
                    files.forEach((file, index) => {
                        if (file && typeof file === 'object') {
                            const fileId = file.id || index.toString();
                            cleanedFiles.set(fileId, {
                                id: fileId,
                                dataURL: file.dataURL || '',
                                mimeType: file.mimeType || 'image/png',
                                created: Number(file.created) || Date.now(),
                                ...file
                            });
                        }
                    });
                } else if (typeof files === 'object') {
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –æ–±—ä–µ–∫—Ç
                    const entries = Object.entries(files);
                    if (entries.length === 0) {
                        console.log('üîç Empty files object, returning empty Map');
                        return new Map();
                    }
                    
                    for (const [key, file] of entries) {
                        if (file && typeof file === 'object') {
                            cleanedFiles.set(key, {
                                id: file.id || key,
                                dataURL: file.dataURL || '',
                                mimeType: file.mimeType || 'image/png',
                                created: Number(file.created) || Date.now(),
                                ...file
                            });
                        }
                    }
                } else {
                    console.warn('‚ö†Ô∏è Files is not an object or array, type:', typeof files);
                    return undefined;
                }
                
                console.log('üîç Created Map with', cleanedFiles.size, 'files');
                
                // –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: —É–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç - Map –∏–ª–∏ undefined
                if (!(cleanedFiles instanceof Map)) {
                    console.error('‚ùå CRITICAL: validateAndCleanFiles did not return a Map!');
                    console.error('‚ùå Returned type:', typeof cleanedFiles);
                    console.error('‚ùå Returned value:', cleanedFiles);
                    return undefined;
                }
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º undefined –µ—Å–ª–∏ Map –ø—É—Å—Ç–æ–π, –∏–Ω–∞—á–µ Map
                if (cleanedFiles.size === 0) {
                    console.log('‚úÖ validateAndCleanFiles returning undefined (empty Map)');
                    return undefined;
                } else {
                    console.log('‚úÖ validateAndCleanFiles returning Map with', cleanedFiles.size, 'files');
                    return cleanedFiles;
                }
                
            } catch (error) {
                console.error('‚ùå Error in validateAndCleanFiles:', error);
                return undefined;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è Java toString –≤ JSON
        function parseJavaToStringToJSON(javaString) {
            try {
                console.log('üîß Processing Java toString format...');
                
                // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ JSON –≤–Ω—É—Ç—Ä–∏ Java toString
                let jsonString = javaString;
                
                // –ï—Å–ª–∏ —ç—Ç–æ Java toString, –∏–∑–≤–ª–µ–∫–∞–µ–º JSON —á–∞—Å—Ç—å
                if (javaString.includes('{') && javaString.includes('}')) {
                    // –ò—â–µ–º –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü JSON –æ–±—ä–µ–∫—Ç–∞
                    const startIndex = javaString.indexOf('{');
                    const lastIndex = javaString.lastIndexOf('}');
                    
                    if (startIndex !== -1 && lastIndex !== -1 && lastIndex > startIndex) {
                        jsonString = javaString.substring(startIndex, lastIndex + 1);
                    }
                }
                
                // –û—á–∏—â–∞–µ–º —Å—Ç—Ä–æ–∫—É –æ—Ç Java-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
                jsonString = jsonString
                    // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
                    .replace(/\s+/g, ' ')
                    .trim()
                    // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –≤ –∑–Ω–∞—á–µ–Ω–∏—è—Ö
                    .replace(/([^"]):([^",\]}]+)([,}\]])/g, (match, before, value, after) => {
                        value = value.trim();
                        // –ï—Å–ª–∏ —ç—Ç–æ —á–∏—Å–ª–æ, boolean –∏–ª–∏ null, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
                        if (value === 'null' || value === 'true' || value === 'false' || !isNaN(value)) {
                            return before + ':' + value + after;
                        }
                        // –ï—Å–ª–∏ —É–∂–µ –≤ –∫–∞–≤—ã—á–∫–∞—Ö, –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
                        if (value.startsWith('"') && value.endsWith('"')) {
                            return before + ':' + value + after;
                        }
                        // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–≤—ã—á–∫–∏ –∫ —Å—Ç—Ä–æ–∫–æ–≤—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º
                        return before + ':"' + value + '"' + after;
                    })
                    // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –≤ –∫–ª—é—á–∞—Ö
                    .replace(/([^"])(\w+):/g, '"$2":')
                    // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏
                    .replace(/""/g, '"')
                    // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∫–∞–≤—ã—á–∫–∏ –≤ –Ω–∞—á–∞–ª–µ –∫–ª—é—á–µ–π
                    .replace(/([^"])([a-zA-Z_][a-zA-Z0-9_]*):/g, '$1"$2":');
                
                console.log('üîß Converted string preview:', jsonString.substring(0, 200) + '...');
                
                // –ü—Ä–æ–±—É–µ–º –ø–∞—Ä—Å–∏—Ç—å JSON
                const parsed = JSON.parse(jsonString);
                
                // –í–∞–ª–∏–¥–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
                if (parsed && typeof parsed === 'object') {
                    // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ elements —ç—Ç–æ –º–∞—Å—Å–∏–≤
                    if (parsed.elements && !Array.isArray(parsed.elements)) {
                        console.warn('‚ö†Ô∏è Elements is not an array, converting...');
                        parsed.elements = [];
                    }
                    
                    // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ appState —ç—Ç–æ –æ–±—ä–µ–∫—Ç
                    if (parsed.appState && typeof parsed.appState !== 'object') {
                        console.warn('‚ö†Ô∏è AppState is not an object, creating default...');
                        parsed.appState = { viewBackgroundColor: "#ffffff" };
                    }
                    
                    // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ files —ç—Ç–æ –æ–±—ä–µ–∫—Ç –∏–ª–∏ Map
                    if (parsed.files && typeof parsed.files !== 'object') {
                        console.warn('‚ö†Ô∏è Files is not an object, creating default...');
                        parsed.files = new Map();
                    } else if (parsed.files && !(parsed.files instanceof Map)) {
                        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—ã—á–Ω—ã–π –æ–±—ä–µ–∫—Ç –≤ Map
                        const filesMap = new Map();
                        for (const [key, value] of Object.entries(parsed.files)) {
                            filesMap.set(key, value);
                        }
                        parsed.files = filesMap;
                    }
                    
                    return parsed;
                } else {
                    throw new Error('Parsed result is not an object');
                }
                
            } catch (error) {
                console.error('‚ùå Java toString conversion failed:', error);
                console.log('üîß Raw input:', javaString.substring(0, 500) + '...');
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –µ—Å–ª–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å
                return {
                    elements: [],
                    appState: { viewBackgroundColor: "#ffffff" },
                    files: new Map()
                };
            }
        }
        
        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
        function saveBoardState() {
            if (!excalidrawAPI) return;
            
            try {
                const elements = excalidrawAPI.getSceneElements();
                const appState = excalidrawAPI.getAppState();
                const files = excalidrawAPI.getFiles();
                
                // –í–∞–ª–∏–¥–∏—Ä—É–µ–º –∏ –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
                const validElements = validateAndCleanElements(elements || []);
                const validAppState = validateAndCleanAppState(appState);
                const validFiles = validateAndCleanFiles(files || {});
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Map –≤ –æ–±—ä–µ–∫—Ç –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                const filesForSerialization = validFiles instanceof Map ? Object.fromEntries(validFiles) : validFiles;
                
                // –°–æ–∑–¥–∞–µ–º snapshot —Å–æ—Å—Ç–æ—è–Ω–∏—è
                const boardSnapshot = {
                    elements: validElements,
                    appState: validAppState,
                    files: filesForSerialization,
                    timestamp: Date.now(),
                    version: 1
                };
                
                console.log('üíæ Saving board state with', elements?.length || 0, 'elements');
                
                if (lessonId === 'demo') {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –¥–µ–º–æ
                    localStorage.setItem(`excalidraw_${lessonId}`, JSON.stringify(boardSnapshot));
                } else {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                    saveBoardToServerImproved(boardSnapshot);
                    
                    // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º backup –≤ localStorage
                    localStorage.setItem(`excalidraw_backup_${lessonId}`, JSON.stringify(boardSnapshot));
                    
                    // –ò –∞–≤–∞—Ä–∏–π–Ω—É—é –∫–æ–ø–∏—é
                    localStorage.setItem(`excalidraw_emergency_${lessonId}`, JSON.stringify(boardSnapshot));
                }
                
            } catch (error) {
                console.error('‚ùå Error saving board state:', error);
            }
        }
        
        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function saveBoardToServerImproved(boardData) {
            try {
                const response = await fetch('/api/excalidraw/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    credentials: 'same-origin', // –í–∞–∂–Ω–æ –¥–ª—è CORS
                    body: JSON.stringify({
                        lessonId: lessonId.toString(),
                        content: JSON.stringify(boardData) // –î–≤–æ–π–Ω–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error: ${response.status} - ${errorText}`);
                }
                
                console.log('‚úÖ Board state saved to server');
            } catch (error) {
                console.error('‚ùå Failed to save board state to server:', error);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —ç—Ç–æ CORS –æ—à–∏–±–∫–∞ –∏–ª–∏ –¥—Ä—É–≥–∞—è
                if (error.message.includes('access control checks') || 
                    error.message.includes('CORS') ||
                    error.message.includes('fetch')) {
                    console.warn('‚ö†Ô∏è CORS or network error detected, saving to localStorage only');
                }
                
                // Fallback: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                localStorage.setItem(`excalidraw_backup_${lessonId}`, JSON.stringify(boardData));
                localStorage.setItem(`excalidraw_error_${lessonId}`, JSON.stringify({
                    error: error.message,
                    timestamp: Date.now()
                }));
                console.log('üíæ Saved to localStorage as backup');
                
                // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± —á–µ—Ä–µ–∑ WebSocket
                if (isConnected && stompClient && stompClient.connected) {
                    try {
                        const sequenceId = ++updateSequence;
                        const validElements = validateAndCleanElements(boardData.elements || []);
                        const validAppState = validateAndCleanAppState(boardData.appState || {});
                        const validFiles = validateAndCleanFiles(boardData.files || {});
                        sendBoardUpdateImproved(validElements, validAppState, validFiles, sequenceId, Date.now());
                        console.log('üîÑ Fallback: saved via WebSocket');
                    } catch (wsError) {
                        console.error('‚ùå WebSocket fallback also failed:', wsError);
                    }
                }
            }
        }
        
        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        function startPeriodicAutoSave() {
            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(() => {
                if (excalidrawAPI && lessonId !== 'demo') {
                    const elements = excalidrawAPI.getSceneElements();
                    if (elements && elements.length > 0) {
                        console.log('‚è∞ Periodic auto-save triggered');
                        saveBoardState();
                    }
                }
            }, 30000); // 30 —Å–µ–∫—É–Ω–¥
            
            console.log('‚è∞ Periodic auto-save started (every 30 seconds)');
        }
        
        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function setupBeforeUnloadHandlers() {
            window.addEventListener('beforeunload', async (e) => {
                if (excalidrawAPI) {
                    try {
                        console.log('üíæ Saving on page unload...');
                        
                        // –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage –∫–∞–∫ backup
                        const elements = excalidrawAPI.getSceneElements();
                        const appState = excalidrawAPI.getAppState();
                        const files = excalidrawAPI.getFiles();
                        
                        if (elements && elements.length > 0) {
                            const boardData = {
                                elements: elements,
                                appState: appState,
                                files: files,
                                timestamp: Date.now()
                            };
                            
                            localStorage.setItem(`excalidraw_emergency_${lessonId}`, JSON.stringify(boardData));
                            
                            // –ü—Ä–æ–±—É–µ–º –±—ã—Å—Ç—Ä–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                            if (lessonId !== 'demo') {
                                try {
                                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º sendBeacon —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
                                    const blob = new Blob([JSON.stringify({
                                        lessonId: lessonId.toString(),
                                        content: JSON.stringify(boardData)
                                    })], { type: 'application/json' });
                                    
                                    navigator.sendBeacon('/api/excalidraw/save', blob);
                                } catch (beaconError) {
                                    console.warn('‚ö†Ô∏è sendBeacon failed, using fetch fallback:', beaconError);
                                    // Fallback –∫ –æ–±—ã—á–Ω–æ–º—É fetch
                                    fetch('/api/excalidraw/save', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        credentials: 'same-origin',
                                        body: JSON.stringify({
                                            lessonId: lessonId.toString(),
                                            content: JSON.stringify(boardData)
                                        })
                                    }).catch(fetchError => {
                                        console.error('‚ùå Fallback fetch also failed:', fetchError);
                                    });
                                }
                            }
                        }
                    } catch (error) {
                        console.error('‚ùå Error during page unload save:', error);
                    }
                }
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º heartbeat
                stopHeartbeat();
                
                // –û—Ç–∫–ª—é—á–∞–µ–º—Å—è –æ—Ç WebSocket
                if (stompClient && isConnected) {
                    try {
                        stompClient.send(`/app/excalidraw/${lessonId}/leave`, {}, JSON.stringify({
                            lessonId: lessonId,
                            userId: collaborationState.userId,
                            userName: collaborationState.userName
                        }));
                        stompClient.disconnect();
                    } catch (error) {
                        console.warn('‚ö†Ô∏è WebSocket disconnect error:', error);
                    }
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && excalidrawAPI) {
                    console.log('üíæ Saving on page hide...');
                    saveBoardState();
                } else if (!document.hidden && lessonId !== 'demo') {
                    // –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞–ª–∞ –≤–∏–¥–∏–º–æ–π - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                    console.log('üëÅÔ∏è Page became visible, checking connection...');
                    
                    setTimeout(() => {
                        if (!isConnected) {
                            console.log('üîÑ Attempting to reconnect after page visibility...');
                            reconnectAttempts = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫
                            initializeWebSocket();
                        } else {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                            if (stompClient && stompClient.connected) {
                                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏
                                requestBoardState();
                                
                                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                                setTimeout(() => {
                                    checkAndSyncBoardState();
                                }, 2000);
                            } else {
                                // –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω–æ–µ, –Ω–æ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –Ω–µ—Ç
                                console.log('üîÑ Connection seems stale, reconnecting...');
                                isConnected = false;
                                reconnectAttempts = 0;
                                initializeWebSocket();
                            }
                        }
                    }, 1000);
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ—Ç–µ—Ä–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º
            window.addEventListener('online', () => {
                console.log('üåê Internet connection restored');
                if (!isConnected && lessonId !== 'demo') {
                    reconnectAttempts = 0;
                    setTimeout(() => {
                        initializeWebSocket();
                    }, 1000);
                }
            });
            
            window.addEventListener('offline', () => {
                console.log('üåê Internet connection lost');
                connectionQuality = 'disconnected';
                updateConnectionStatus('disconnected');
                showToast('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º –ø–æ—Ç–µ—Ä—è–Ω–æ. –†–∞–±–æ—Ç–∞–µ–º –≤ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–º —Ä–µ–∂–∏–º–µ.', 'warning');
            });
            
            console.log('üîß Before unload handlers setup complete');
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —Ö–µ—à–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
        function createElementsHash(elements) {
            if (!elements || elements.length === 0) return 'empty';
            
            try {
                const simplified = elements.map(el => ({
                    id: el.id,
                    type: el.type,
                    x: Math.round(el.x || 0),
                    y: Math.round(el.y || 0),
                    width: Math.round(el.width || 0),
                    height: Math.round(el.height || 0),
                    text: el.text ? el.text.replace(/[^\x00-\x7F]/g, '') : undefined, // –£–±–∏—Ä–∞–µ–º –Ω–µ-ASCII —Å–∏–º–≤–æ–ª—ã
                    points: el.points ? el.points.map(p => [Math.round(p[0]), Math.round(p[1])]) : undefined
                })).filter(el => el !== null);
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ö–µ—à–∞
                const jsonString = JSON.stringify(simplified);
                const encoder = new TextEncoder();
                const data = encoder.encode(jsonString);
                const hash = Array.from(data).reduce((hash, byte) => {
                    return ((hash << 5) - hash + byte) & 0xffffffff;
                }, 0);
                
                return Math.abs(hash).toString(36).substring(0, 16);
            } catch (error) {
                console.warn('‚ö†Ô∏è Error creating elements hash:', error);
                return Date.now().toString();
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Excalidraw
        async function initializeExcalidraw() {
            console.log('üé® Initializing real Excalidraw...');
            
            try {
                const container = document.getElementById('excalidraw-container');
                
                // –ü—Ä–æ–±—É–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–π Excalidraw, –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è - –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
                try {
                    console.log('‚è≥ Waiting for Excalidraw library...');
                    updateLoadingStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Excalidraw...', '–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏–∑ CDN');
                    await waitForExcalidrawLibrary();
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—Å—Ç–æ—è—â–∏–π Excalidraw
                    const ExcalidrawLib = window.ExcalidrawLib || window.Excalidraw;
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º ESM –∏ UMD)
                    let Excalidraw, exportToCanvas;
                    
                    // ESM –º–æ–¥—É–ª—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
                    if (ExcalidrawLib?.default?.Excalidraw) {
                        Excalidraw = ExcalidrawLib.default.Excalidraw;
                        exportToCanvas = ExcalidrawLib.default.exportToCanvas || ExcalidrawLib.exportToCanvas;
                    }
                    // ESM –ø—Ä—è–º–æ–π —ç–∫—Å–ø–æ—Ä—Ç
                    else if (ExcalidrawLib?.Excalidraw) {
                        Excalidraw = ExcalidrawLib.Excalidraw;
                        exportToCanvas = ExcalidrawLib.exportToCanvas;
                    }
                    // UMD —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
                    else if (window.Excalidraw?.Excalidraw) {
                        Excalidraw = window.Excalidraw.Excalidraw;
                        exportToCanvas = window.Excalidraw.exportToCanvas;
                    }
                    // –ï—Å–ª–∏ —Å–∞–º–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —è–≤–ª—è–µ—Ç—Å—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º (—Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏)
                    else if (typeof ExcalidrawLib === 'function') {
                        Excalidraw = ExcalidrawLib;
                        exportToCanvas = window.exportToCanvas;
                    }
                    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –∫–∞–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
                    else if (typeof window.Excalidraw === 'function') {
                        Excalidraw = window.Excalidraw;
                        exportToCanvas = window.exportToCanvas;
                    }
                    
                    console.log('‚úÖ Found Excalidraw library, initializing...', {
                        hasExcalidraw: !!Excalidraw,
                        hasExportToCanvas: !!exportToCanvas,
                        libType: typeof ExcalidrawLib,
                        libStructure: {
                            hasDefault: !!(ExcalidrawLib?.default),
                            hasExcalidrawProp: !!(ExcalidrawLib?.Excalidraw),
                            globalExcalidrawType: typeof window.Excalidraw
                        }
                    });
                    
                    if (!Excalidraw) {
                        console.error('‚ùå Excalidraw component detection failed');
                        console.log('Available structure:', {
                            ExcalidrawLib: ExcalidrawLib,
                            windowExcalidraw: window.Excalidraw,
                            allWindowProps: Object.keys(window).filter(k => k.toLowerCase().includes('excalidraw'))
                        });
                        throw new Error('–ö–æ–º–ø–æ–Ω–µ–Ω—Ç Excalidraw –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫–µ');
                    }
                    
                    updateLoadingStatus('–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –¥–æ—Å–∫–∏...', '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ Excalidraw');
                    
                    // –°–æ–∑–¥–∞–µ–º React-—ç–ª–µ–º–µ–Ω—Ç Excalidraw
                    const excalidrawElement = React.createElement(Excalidraw, {
                        initialData: {
                            elements: [],
                            appState: { 
                                viewBackgroundColor: "#ffffff",
                                currentItemBackgroundColor: "#1971c2",
                                currentItemFillStyle: "solid",
                                currentItemOpacity: 100.0  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞ 10000%
                            }
                        },
                        onChange: (elements, appState, files) => {
                            // –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π
                            handleExcalidrawChange(elements, appState, files);
                            syncToolbarWithExcalidraw(appState);
                        },
                        onPointerUp: (elements, appState, files) => {
                            // –ú–ì–ù–û–í–ï–ù–ù–ê–Ø —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
                            try {
                                if (isConnected && stompClient && stompClient.connected && lessonId !== 'demo') {
                                    // –°–¢–†–û–ì–ê–Ø –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
                                    const sequenceId = ++updateSequence;
                                    const validElements = validateAndCleanElements(elements || []);
                                    const validAppState = validateAndCleanAppState(appState || {});
                                    const validFiles = validateAndCleanFiles(files || {});
                                    
                                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–Ω—ã
                                    if (Array.isArray(validElements)) {
                                        sendBoardUpdateImproved(validElements, validAppState, validFiles, sequenceId, Date.now());
                                        console.log('üéØ INSTANT Pointer up sync sent');
                                    } else {
                                        console.warn('‚ö†Ô∏è Invalid data in onPointerUp, skipping sync');
                                    }
                                }
                            } catch (error) {
                                console.error('‚ùå Error in onPointerUp:', error);
                            }
                        },
                        onTextSubmit: (elements, appState, files) => {
                            // –ú–ì–ù–û–í–ï–ù–ù–ê–Ø —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞
                            try {
                                if (isConnected && stompClient && stompClient.connected && lessonId !== 'demo') {
                                    // –°–¢–†–û–ì–ê–Ø –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
                                    const sequenceId = ++updateSequence;
                                    const validElements = validateAndCleanElements(elements || []);
                                    const validAppState = validateAndCleanAppState(appState || {});
                                    const validFiles = validateAndCleanFiles(files || {});
                                    
                                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–Ω—ã
                                    if (Array.isArray(validElements)) {
                                        sendBoardUpdateImproved(validElements, validAppState, validFiles, sequenceId, Date.now());
                                        console.log('üìù INSTANT Text submit sync sent');
                                    } else {
                                        console.warn('‚ö†Ô∏è Invalid data in onTextSubmit, skipping sync');
                                    }
                                }
                            } catch (error) {
                                console.error('‚ùå Error in onTextSubmit:', error);
                            }
                        },
                        onResize: (elements, appState, files) => {
                            // –ú–ì–ù–û–í–ï–ù–ù–ê–Ø —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞
                            try {
                                if (isConnected && stompClient && stompClient.connected && lessonId !== 'demo') {
                                    // –°–¢–†–û–ì–ê–Ø –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
                                    const sequenceId = ++updateSequence;
                                    const validElements = validateAndCleanElements(elements || []);
                                    const validAppState = validateAndCleanAppState(appState || {});
                                    const validFiles = validateAndCleanFiles(files || {});
                                    
                                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–Ω—ã
                                    if (Array.isArray(validElements)) {
                                        sendBoardUpdateImproved(validElements, validAppState, validFiles, sequenceId, Date.now());
                                        console.log('üìè INSTANT Resize sync sent');
                                    } else {
                                        console.warn('‚ö†Ô∏è Invalid data in onResize, skipping sync');
                                    }
                                }
                            } catch (error) {
                                console.error('‚ùå Error in onResize:', error);
                            }
                        },
                        onReady: (api) => {
                            if (api) {
                                setState('excalidrawAPI', api);
                                excalidrawAPI = api; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                                console.log('‚úÖ Excalidraw API ready');
                                
                                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç—É—é –¥–æ—Å–∫—É –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                                try {
                                    const success = safeUpdateScene(
                                        api,
                                        [],
                                        { viewBackgroundColor: "#ffffff" },
                                        new Map()
                                    );
                                    if (success) {
                                        console.log('‚úÖ Initialized empty board');
                                    } else {
                                        console.warn('‚ö†Ô∏è Failed to initialize empty board safely');
                                    }
                                } catch (initError) {
                                    console.warn('‚ö†Ô∏è Failed to initialize empty board:', initError);
                                }
                                
                                // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                                setupAdvancedSyncHandlers(api);
                                updateLoadingStatus('–î–æ—Å–∫–∞ –≥–æ—Ç–æ–≤–∞!', '–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è...');
                                
                                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å–∫–∏
                                if (window.pendingBoardUpdates && window.pendingBoardUpdates.length > 0) {
                                    console.log(`üìã Processing ${window.pendingBoardUpdates.length} pending board updates...`);
                                    window.pendingBoardUpdates.forEach(update => {
                                        if (update.type === 'update') {
                                            applyBoardUpdate(update.boardData);
                                        }
                                    });
                                    window.pendingBoardUpdates = []; // –û—á–∏—â–∞–µ–º –æ—á–µ—Ä–µ–¥—å
                                }
                                
                                // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
                                const pendingTool = getState('pendingTool');
                                if (pendingTool) {
                                    console.log('üîß Applying pending tool:', pendingTool);
                                    setTimeout(() => {
                                        updateExcalidrawTool(pendingTool);
                                        setState('pendingTool', null); // –û—á–∏—â–∞–µ–º
                                    }, 100);
                                }
                                
                                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å–∫—É –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                                const needsBoardLoad = getState('needsBoardLoad');
                                if (needsBoardLoad) {
                                    console.log('üìã Loading saved board now that API is ready');
                                    setTimeout(() => {
                                        loadSavedBoard();
                                        setState('needsBoardLoad', false); // –û—á–∏—â–∞–µ–º —Ñ–ª–∞–≥
                                    }, 200);
                                }
                                
                                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
                                console.log('üîß Initializing toolbar from onReady callback');
                                initializeToolbar();
                                
                                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                                console.log('üìã Loading saved board from onReady callback');
                                setTimeout(() => {
                                    loadSavedBoard();
                                }, 300);
                            }
                        },
                        excalidrawAPI: (api) => {
                            // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è API –µ—Å–ª–∏ onReady –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
                            if (api && !getState('excalidrawAPI')) {
                                setState('excalidrawAPI', api);
                                excalidrawAPI = api; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                                console.log('‚úÖ Excalidraw API ready via callback');
                                
                                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å–∫–∏
                                if (window.pendingBoardUpdates && window.pendingBoardUpdates.length > 0) {
                                    console.log(`üìã Processing ${window.pendingBoardUpdates.length} pending board updates via callback...`);
                                    window.pendingBoardUpdates.forEach(update => {
                                        if (update.type === 'update') {
                                            applyBoardUpdate(update.boardData);
                                        }
                                    });
                                    window.pendingBoardUpdates = []; // –û—á–∏—â–∞–µ–º –æ—á–µ—Ä–µ–¥—å
                                }
                                
                                // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
                                const pendingTool = getState('pendingTool');
                                if (pendingTool) {
                                    console.log('üîß Applying pending tool via callback:', pendingTool);
                                    setTimeout(() => {
                                        updateExcalidrawTool(pendingTool);
                                        setState('pendingTool', null); // –û—á–∏—â–∞–µ–º
                                    }, 100);
                                }
                                
                                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å–∫—É –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                                const needsBoardLoad = getState('needsBoardLoad');
                                if (needsBoardLoad) {
                                    console.log('üìã Loading saved board via callback now that API is ready');
                                    setTimeout(() => {
                                        loadSavedBoard();
                                        setState('needsBoardLoad', false); // –û—á–∏—â–∞–µ–º —Ñ–ª–∞–≥
                                    }, 200);
                                }
                                
                                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
                                console.log('üîß Initializing toolbar from excalidrawAPI callback');
                                initializeToolbar();
                                
                                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                                console.log('üìã Loading saved board from excalidrawAPI callback');
                                setTimeout(() => {
                                    loadSavedBoard();
                                }, 300);
                                
                                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ—Å–∫–∏
                                setTimeout(() => {
                                    if (api && api.getSceneElementsIncludingDeleted) {
                                        const elements = api.getSceneElementsIncludingDeleted();
                                        console.log('üé® Excalidraw board ready with', elements.length, 'elements');
                                        console.log('‚úÖ Excalidraw board is fully functional!');
                                        
                                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–æ—Å–∫–∞ –≥–æ—Ç–æ–≤–∞ –∫ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—é
                                        const container = document.getElementById('excalidraw-container');
                                        if (container) {
                                            console.log('üéØ Board container found, enabling interaction...');
                                            container.style.pointerEvents = 'auto';
                                            container.style.opacity = '1';
                                            
                                            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –¥–æ—Å–∫—É
                                            container.focus();
                                            
                                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–æ—Å–∫–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∞–∫—Ç–∏–≤–Ω–∞
                                            const excalidrawElement = container.querySelector('.excalidraw');
                                            if (excalidrawElement) {
                                                console.log('‚úÖ Excalidraw element found and ready for interaction');
                                                excalidrawElement.style.pointerEvents = 'auto';
                                            }
                                        }
                                        
                                        // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                                        const loadingIndicator = document.getElementById('loading-indicator');
                                        if (loadingIndicator) {
                                            loadingIndicator.style.display = 'none';
                                        }
                                        
                                        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WebSocket, –µ—Å–ª–∏ –æ–Ω –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω
                                        if (lessonId !== 'demo' && !isConnected) {
                                            console.log('üîå Board ready, but WebSocket not connected. Initializing...');
                                            setTimeout(() => {
                                                initializeWebSocket();
                                            }, 500);
                                        }
                                    }
                                }, 1000);
                            }
                        }
                    });
                    
                    // –†–µ–Ω–¥–µ—Ä–∏–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏—Å–ø–æ–ª—å–∑—É—è React 18 API
                    if (ReactDOM.createRoot) {
                        // React 18+
                        const root = ReactDOM.createRoot(container);
                        root.render(excalidrawElement);
                    } else {
                        // Fallback –¥–ª—è React 17
                    ReactDOM.render(excalidrawElement, container);
                    }
                    
                } catch (libraryError) {
                    console.warn('‚ö†Ô∏è Excalidraw library failed, using fallback:', libraryError);
                    throw libraryError; // –ü–µ—Ä–µ–¥–∞–µ–º –æ—à–∏–±–∫—É –≤ –æ—Å–Ω–æ–≤–Ω–æ–π catch
                }
                
                console.log('‚úÖ Real Excalidraw initialized successfully');
                
                // –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ API
                await waitForExcalidrawAPI();
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                hideLoadingIndicator();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
                initializeToolbar();
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                await loadSavedBoard();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WebSocket –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã
                if (lessonId !== 'demo') {
                    console.log('üîå Starting WebSocket initialization for lesson:', lessonId);
                    initializeWebSocket();
                } else {
                    console.log('üîå Demo mode - skipping WebSocket initialization');
                }
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                startPeriodicAutoSave();
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
                setupBeforeUnloadHandlers();
                
                // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã (–¥–ª—è —Å–ª—É—á–∞–µ–≤ –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)
                setTimeout(async () => {
                    if (excalidrawAPI) {
                        const currentElements = excalidrawAPI.getSceneElements();
                        if (!currentElements || currentElements.length === 0) {
                            console.log('üîÑ Retrying board state load...');
                            await loadSavedBoard();
                        }
                    }
                }, 2000);
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ API
                window.excalidrawAPI = excalidrawAPI;
                
            } catch (error) {
                console.error('‚ùå Excalidraw initialization error:', error);
                showToast('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–æ—Å–∫–∏: ' + error.message, 'error');
                
                // Fallback –∫ –ø—Ä–æ—Å—Ç–æ–º—É canvas
                await initializeFallbackCanvas();
            }
        }
        
        // –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Excalidraw
        function waitForExcalidrawLibrary() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 600; // 60 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º –¥–ª—è –º–µ–¥–ª–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
                
                const check = () => {
                    attempts++;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Excalidraw
                    const excalidrawLibDirect = window.ExcalidrawLib;
                    const excalidrawGlobal = window.Excalidraw;
                    const reactAvailable = window.React;
                    const reactDOMAvailable = window.ReactDOM;
                    const reactJSXAvailable = !!(window.React && (window.React.jsx || window.React.jsxs));
                    
                    // –ë–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã Excalidraw
                    let excalidrawComponentFound = false;
                    
                    if (excalidrawLibDirect) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º ESM —Å—Ç—Ä—É–∫—Ç—É—Ä—É
                        if (excalidrawLibDirect.Excalidraw || excalidrawLibDirect.default?.Excalidraw) {
                            excalidrawComponentFound = true;
                        }
                    }
                    
                    if (excalidrawGlobal) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º UMD —Å—Ç—Ä—É–∫—Ç—É—Ä—É
                        if (typeof excalidrawGlobal === 'function' || excalidrawGlobal.Excalidraw) {
                            excalidrawComponentFound = true;
                        }
                    }
                    
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –∏—â–µ–º Excalidraw –≤ –ª—é–±—ã—Ö –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–∞—Ö
                    if (!excalidrawComponentFound) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã
                        const globalObjects = ['ExcalidrawLib', 'Excalidraw', 'excalidraw'];
                        for (const objName of globalObjects) {
                            const obj = window[objName];
                            if (obj) {
                                if (typeof obj === 'function') {
                                    excalidrawComponentFound = true;
                                    console.log(`‚úÖ Found Excalidraw as function in window.${objName}`);
                                    break;
                                } else if (obj.Excalidraw || obj.default?.Excalidraw) {
                                    excalidrawComponentFound = true;
                                    console.log(`‚úÖ Found Excalidraw component in window.${objName}`);
                                    break;
                                }
                            }
                        }
                    }
                    
                    if (attempts % 10 === 0) { // –õ–æ–≥–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
                        console.log(`Attempt ${attempts}: ExcalidrawLib=${!!excalidrawLibDirect}, Excalidraw=${!!excalidrawGlobal}, Component=${excalidrawComponentFound}, React=${!!reactAvailable}, ReactDOM=${!!reactDOMAvailable}, ReactJSX=${reactJSXAvailable}`);
                        
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
                        if (excalidrawLibDirect) {
                            console.log('ExcalidrawLib structure:', Object.keys(excalidrawLibDirect));
                        }
                        if (excalidrawGlobal) {
                            console.log('Excalidraw type:', typeof excalidrawGlobal);
                        }
                    }
                    
                    if (excalidrawComponentFound && reactAvailable && reactDOMAvailable && reactJSXAvailable) {
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è
                        if (!window.ExcalidrawLib && window.Excalidraw) {
                            window.ExcalidrawLib = window.Excalidraw;
                        }
                        
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ JSX runtime
                        if (window.React && (!window.React.jsx || !window.React.jsxs)) {
                            console.log('üîß Setting up JSX runtime as final safety check');
                            window.React.jsx = window.React.jsx || window.React.createElement;
                            window.React.jsxs = window.React.jsxs || window.React.createElement;
                        }
                        
                        console.log('‚úÖ Excalidraw library is ready with components');
                        console.log('Library structure:', {
                            ExcalidrawLib: window.ExcalidrawLib,
                            hasDefaultExport: !!(excalidrawLibDirect?.default),
                            hasExcalidrawProp: !!(excalidrawLibDirect?.Excalidraw || excalidrawGlobal?.Excalidraw)
                        });
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        // –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞: –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
                        console.log('üîß Last attempt: forcing Excalidraw initialization...');
                        
                        // –ü—Ä–æ–±—É–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞—Ç—å ExcalidrawLib –∏–∑ –ª—é–±–æ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
                        if (window.Excalidraw && !window.ExcalidrawLib) {
                            window.ExcalidrawLib = window.Excalidraw;
                            console.log('‚úÖ Forced ExcalidrawLib = Excalidraw');
                        }
                        
                        // –ï—Å–ª–∏ —É –Ω–∞—Å –µ—Å—Ç—å React –∏ —á—Ç–æ-—Ç–æ –ø–æ—Ö–æ–∂–µ–µ –Ω–∞ Excalidraw, –ø—Ä–æ–±—É–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                        if (window.React && (window.ExcalidrawLib || window.Excalidraw)) {
                            console.log('‚úÖ Forcing initialization with available components');
                            resolve(); // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å —Ç–µ–º, —á—Ç–æ –µ—Å—Ç—å
                        } else {
                        console.error('‚ùå Excalidraw library failed to load after', maxAttempts, 'attempts');
                        console.log('Available libraries:', {
                            ExcalidrawLib: !!window.ExcalidrawLib,
                            ExcalidrawLibType: typeof window.ExcalidrawLib,
                            Excalidraw: !!window.Excalidraw,
                            ExcalidrawType: typeof window.Excalidraw,
                            React: !!window.React,
                            ReactDOM: !!window.ReactDOM,
                            ReactJSX: reactJSXAvailable,
                            componentFound: excalidrawComponentFound
                        });
                        reject(new Error('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Excalidraw –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ø–æ—Å–ª–µ ' + maxAttempts + ' –ø–æ–ø—ã—Ç–æ–∫'));
                        }
                    } else {
                        setTimeout(check, 100);
                    }
                };
                
                check();
            });
        }
        
        // Fallback: –ø—Ä–æ—Å—Ç–æ–π canvas –µ—Å–ª–∏ Excalidraw –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
        async function initializeFallbackCanvas() {
            console.log('üîß Initializing fallback canvas...');
            updateLoadingStatus('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Å—Ç–æ–π –¥–æ—Å–∫–∏...', 'Excalidraw –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback');
            
            const container = document.getElementById('excalidraw-container');
            container.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            
            // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é canvas-–¥–æ—Å–∫—É
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º canvas
            canvas.width = container.offsetWidth || 800;
            canvas.height = container.offsetHeight || 600;
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            canvas.style.border = '1px solid #ddd';
            canvas.style.cursor = 'crosshair';
            canvas.style.backgroundColor = '#ffffff';
            
            container.appendChild(canvas);
            
            // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            
            canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                [lastX, lastY] = [e.offsetX, e.offsetY];
            });
            
            canvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                [lastX, lastY] = [e.offsetX, e.offsetY];
            });
            
            canvas.addEventListener('mouseup', () => {
                isDrawing = false;
            });
            
            // –°–æ–∑–¥–∞–µ–º API –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            excalidrawAPI = {
                canvas: canvas,
                ctx: ctx,
                getSceneElements: () => [],
                getAppState: () => ({ viewBackgroundColor: '#ffffff' }),
                getFiles: () => ({}),
                updateScene: (data) => {
                    console.log('üìã Canvas updateScene called', data);
                },
                exportToCanvas: () => {
                    return Promise.resolve(canvas);
                }
            };
            
            console.log('‚úÖ Fallback canvas initialized');
            hideLoadingIndicator();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –¥–ª—è fallback)
            initializeToolbar();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WebSocket
            await loadSavedBoard();
            if (lessonId !== 'demo') {
                initializeWebSocket();
            }
        }
        
        // –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ Excalidraw API
        function waitForExcalidrawAPI() {
            return new Promise((resolve) => {
                const checkAPI = () => {
                    if (excalidrawAPI) {
                        resolve();
                    } else {
                        setTimeout(checkAPI, 100);
                    }
                };
                checkAPI();
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
        function checkForRealChanges(elements, appState) {
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                if (!excalidrawAPI) return false;
                
                const currentElements = excalidrawAPI.getSceneElements();
                const currentAppState = excalidrawAPI.getAppState();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —ç–ª–µ–º–µ–Ω—Ç–∞—Ö
                const elementsChanged = JSON.stringify(currentElements) !== JSON.stringify(elements);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ appState (—Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã–µ –ø–æ–ª—è)
                const importantAppStateFields = ['scrollX', 'scrollY', 'zoom', 'currentItemStrokeColor', 'currentItemBackgroundColor'];
                const currentImportant = importantAppStateFields.reduce((acc, field) => {
                    acc[field] = currentAppState[field];
                    return acc;
                }, {});
                const newImportant = importantAppStateFields.reduce((acc, field) => {
                    acc[field] = appState[field];
                    return acc;
                }, {});
                
                const appStateChanged = JSON.stringify(currentImportant) !== JSON.stringify(newImportant);
                
                return elementsChanged || appStateChanged;
                
            } catch (error) {
                console.error('‚ùå Error checking for real changes:', error);
                return true; // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            }
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        function setupAdvancedSyncHandlers(api) {
            try {
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ–±—ã—Ç–∏–π —Ä–∏—Å–æ–≤–∞–Ω–∏—è
                const originalUpdateScene = api.updateScene;
                if (originalUpdateScene) {
                    api.updateScene = function(updates) {
                        // –í—ã–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
                        const result = originalUpdateScene.call(this, updates);
                        
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
                        if (isConnected && stompClient && stompClient.connected && lessonId !== 'demo') {
                            const elements = api.getSceneElements();
                            const appState = api.getAppState();
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —ç–ª–µ–º–µ–Ω—Ç–∞—Ö
                            if (updates && (updates.elements || updates.appState)) {
                                setTimeout(() => {
                                    const sequenceId = ++updateSequence;
                                    const validElements = validateAndCleanElements(elements || []);
                                    const validAppState = validateAndCleanAppState(appState || {});
                                    sendBoardUpdateImproved(validElements, validAppState, {}, sequenceId, Date.now());
                                    console.log('üé® Advanced sync sent for scene update');
                                }, 5);
                            }
                        }
                        
                        return result;
                    };
                }
                
                console.log('‚úÖ Advanced sync handlers setup complete');
                
            } catch (error) {
                console.error('‚ùå Error setting up advanced sync handlers:', error);
            }
        }
        
        // –£–ª—É—á—à–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Excalidraw —Å —É–º–Ω—ã–º –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ–º race conditions
        function handleExcalidrawChange(elements, appState, files) {
            try {
                // –°–¢–†–û–ì–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ null/undefined
                if (!elements && !appState && !files) {
                    console.warn('‚ö†Ô∏è handleExcalidrawChange called with all null parameters');
                    return;
                }
                
                const timestamp = Date.now();
                
                // –ú–Ø–ì–ö–û–ï –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ race conditions - —Ç–æ–ª—å–∫–æ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–ª—É—á–∞–µ–≤
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ–º –ª–∏ –º—ã —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                if (isApplyingRemoteUpdate) {
                    const timeSinceRemoteUpdate = timestamp - lastRemoteUpdateTime;
                    // –ë–ª–æ–∫–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è (2ms) –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç–∏
                    if (timeSinceRemoteUpdate < 2) {
                        console.log('üîÑ Skipping local update - applying remote update (race condition prevention)');
                        return;
                    }
                }
                
                // –°–¢–†–û–ì–ê–Ø –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∫–æ–ø–∏–π
                let safeElements = [];
                let safeAppState = {};
                let safeFiles = {};
                
                try {
                    // –í–∞–ª–∏–¥–∏—Ä—É–µ–º –∏ –æ—á–∏—â–∞–µ–º elements
                    if (elements) {
                        if (Array.isArray(elements)) {
                            safeElements = validateAndCleanElements(elements);
                            
                            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ pressures –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                            safeElements.forEach((element, index) => {
                                if (element && element.points && Array.isArray(element.points)) {
                                    if (!element.pressures || !Array.isArray(element.pressures)) {
                                        console.warn(`‚ö†Ô∏è handleExcalidrawChange: Element ${index} missing pressures, adding default values`);
                                        element.pressures = element.points.map(() => 0.5);
                                    } else if (element.pressures.length !== element.points.length) {
                                        console.warn(`‚ö†Ô∏è handleExcalidrawChange: Element ${index} pressures length mismatch, fixing`);
                                        if (element.pressures.length < element.points.length) {
                                            const needed = element.points.length - element.pressures.length;
                                            element.pressures = element.pressures.concat(Array(needed).fill(0.5));
                                        } else {
                                            element.pressures = element.pressures.slice(0, element.points.length);
                                        }
                                    }
                                }
                            });
                        } else {
                            console.warn('‚ö†Ô∏è Elements is not an array in handleExcalidrawChange:', typeof elements);
                            safeElements = validateAndCleanElements([]);
                        }
                    }
                    
                    // –í–∞–ª–∏–¥–∏—Ä—É–µ–º appState
                    if (appState && typeof appState === 'object') {
                        safeAppState = validateAndCleanAppState(appState);
                    }
                    
                    // –í–∞–ª–∏–¥–∏—Ä—É–µ–º files
                    if (files) {
                        safeFiles = validateAndCleanFiles(files);
                    }
                    
                } catch (validationError) {
                    console.error('‚ùå Error validating data in handleExcalidrawChange:', validationError);
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    safeElements = [];
                    safeAppState = { viewBackgroundColor: "#ffffff" };
                    safeFiles = new Map();
                }
                
                lastLocalUpdate = timestamp;
                
                // –£–ú–ù–´–ô throttling - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–æ—Ç–æ–π
                if (isConnected && stompClient && stompClient.connected && lessonId !== 'demo') {
                    const timeSinceLastSend = timestamp - lastSendTime;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    const hasRealChanges = checkForRealChanges(safeElements, safeAppState);
                    
                    // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
                    if (timeSinceLastSend >= 5 && hasRealChanges) { // –£–º–µ–Ω—å—à–∏–ª–∏ –¥–æ 5ms –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                        const sequenceId = ++updateSequence;
                        
                        // –í–∞–ª–∏–¥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
                        const validElements = validateAndCleanElements(safeElements);
                        const validAppState = validateAndCleanAppState(safeAppState);
                        const validFiles = validateAndCleanFiles(safeFiles);
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
                        sendBoardUpdateImproved(validElements, validAppState, validFiles, sequenceId, timestamp);
                        lastSendTime = timestamp;
                        console.log('‚ö° INSTANT sync sent with', validElements.length, 'elements');
                        
                    } else if (hasRealChanges) {
                        // –û—Ç–∫–ª–∞–¥—ã–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É, –Ω–æ —Å –±–æ–ª–µ–µ –∫–æ—Ä–æ—Ç–∫–∏–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º
                        clearTimeout(sendTimeout);
                        sendTimeout = setTimeout(() => {
                            const sequenceId = ++updateSequence;
                            const validElements = validateAndCleanElements(safeElements);
                            const validAppState = validateAndCleanAppState(safeAppState);
                            const validFiles = validateAndCleanFiles(safeFiles);
                            sendBoardUpdateImproved(validElements, validAppState, validFiles, sequenceId, Date.now());
                            lastSendTime = Date.now();
                            console.log('‚ö° THROTTLED sync sent with', validElements.length, 'elements');
                        }, 5 - timeSinceLastSend); // –£–º–µ–Ω—å—à–∏–ª–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ 5ms –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                    } else {
                        console.log('üîÑ No real changes detected, skipping sync');
                    }
                    
                } else if (!isConnected && lessonId !== 'demo') {
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –µ—Å–ª–∏ –Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                    messageQueue.push({
                        type: 'board_update',
                        elements: safeElements,
                        appState: safeAppState,
                        files: safeFiles,
                        timestamp: timestamp,
                        sequenceId: ++updateSequence
                    });
                    
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏
                    if (messageQueue.length > 50) {
                        messageQueue = messageQueue.slice(-25);
                    }
                }
                
                // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                clearTimeout(window.autoSaveTimeout);
                window.autoSaveTimeout = setTimeout(() => {
                    saveBoardState();
                }, 1000); // –£–º–µ–Ω—å—à–∏–ª–∏ –¥–æ 1 —Å–µ–∫—É–Ω–¥—ã
                
                // Backup –≤ localStorage
                if (lessonId !== 'demo') {
                    clearTimeout(window.backupSaveTimeout);
                    window.backupSaveTimeout = setTimeout(() => {
                        localStorage.setItem(`excalidraw_backup_${lessonId}`, JSON.stringify({
                            elements: safeElements,
                            appState: safeAppState,
                            files: safeFiles,
                            timestamp: timestamp
                        }));
                    }, 500); // –£–º–µ–Ω—å—à–∏–ª–∏ –¥–æ 500ms
                }
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Error in handleExcalidrawChange:', error);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç —á–∞—Å—Ç—ã—Ö –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
        function initializeWebSocket() {
            // –ó–∞—â–∏—Ç–∞ –æ—Ç —á–∞—Å—Ç—ã—Ö –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
            const now = Date.now();
            if (window.lastWebSocketInit && (now - window.lastWebSocketInit) < 2000) {
                console.log('‚ö†Ô∏è Too frequent WebSocket initialization attempts, skipping...');
                return;
            }
            window.lastWebSocketInit = now;
            
            console.log('üîå Initializing WebSocket connection...');
            console.log('üìä Connection diagnostics:', {
                lessonId: lessonId,
                userId: collaborationState.userId,
                userName: collaborationState.userName,
                currentUrl: window.location.href,
                userAgent: navigator.userAgent,
                timestamp: new Date().toISOString()
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ WebSocket –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            if (!window.SockJS || !window.Stomp) {
                console.error('‚ùå WebSocket libraries not loaded:', {
                    SockJS: !!window.SockJS,
                    Stomp: !!window.Stomp
                });
                updateConnectionStatus('error');
                return;
            }
            
            console.log('‚úÖ WebSocket libraries available, proceeding with connection...');
            updateConnectionStatus('connecting');
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
            if (stompClient && stompClient.connected) {
                try {
                    stompClient.disconnect();
                } catch (e) {
                    console.warn('‚ö†Ô∏è Error disconnecting previous client:', e);
                }
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            reconnectAttempts = 0;
            
            try {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –¥–ª—è WebSocket
                const protocol = window.location.protocol === 'https:' ? 'https:' : 'http:';
                const host = window.location.host;
                const wsUrl = `${protocol}//${host}/ws`;
                
                console.log('üîó Connecting to:', wsUrl);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å WebSocket endpoint –ø–µ—Ä–µ–¥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º
                const testUrl = `${protocol}//${host}/ws/info`;
                console.log('üîç Testing WebSocket endpoint:', testUrl);
                
                const socket = new SockJS(wsUrl, null, {
                    debug: false,
                    devel: false,
                    transports: ['websocket', 'xhr-polling', 'xhr-streaming'],
                    timeout: 30000, // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–æ 30 —Å–µ–∫—É–Ω–¥
                    sessionId: () => `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}` // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–µ—Å—Å–∏–∏
                });
                
                stompClient = Stomp.over(socket);
                stompClient.debug = null; // –û—Ç–∫–ª—é—á–∞–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                
                // –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ï –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ heartbeat –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                stompClient.heartbeat.outgoing = 10000; // 10 —Å–µ–∫—É–Ω–¥ - –±—ã—Å—Ç—Ä–µ–µ –¥–ª—è –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç–∏
                stompClient.heartbeat.incoming = 10000; // 10 —Å–µ–∫—É–Ω–¥ - –±—ã—Å—Ç—Ä–µ–µ –¥–ª—è –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç–∏
                stompClient.heartbeat.server = 10000; // 10 —Å–µ–∫—É–Ω–¥ - –±—ã—Å—Ç—Ä–µ–µ –¥–ª—è –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç–∏
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                const connectionTimeout = setTimeout(() => {
                    console.error('‚ùå Connection timeout after 30 seconds');
                    if (stompClient) {
                        try {
                            stompClient.disconnect();
                        } catch (e) {
                            console.warn('‚ö†Ô∏è Error during timeout disconnect:', e);
                        }
                    }
                    handleConnectionError(new Error('Connection timeout after 30 seconds'));
                }, 30000); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–æ 30 —Å–µ–∫—É–Ω–¥
                
                stompClient.connect({}, 
                    (frame) => {
                        console.log('‚úÖ WebSocket connected successfully:', {
                            command: frame.command,
                            headers: frame.headers,
                            body: frame.body
                        });
                        clearTimeout(connectionTimeout); // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                        isConnected = true;
                        reconnectAttempts = 0;
                        connectionQuality = 'good';
                        updateConnectionStatus('connected');
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                        window.stompClient = stompClient;
                        window.isConnected = isConnected;
                        
                        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Ç–æ–ø–∏–∫–∏ –¥–ª—è Excalidraw
                        subscribeToExcalidrawTopics();
                        
                        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å–∫–∏
                        stompClient.subscribe(`/topic/excalidraw/${lessonId}`, (message) => {
                            try {
                                console.log('üì® Board message received:', message.headers['message-type'] || 'unknown', 'from:', message.headers['user-id'] || 'unknown');
                                handleBoardMessage(JSON.parse(message.body));
                            } catch (error) {
                                console.error('‚ùå Error parsing board message:', error);
                            }
                        });
                        
                        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                        stompClient.subscribe(`/topic/excalidraw/${lessonId}/users`, (message) => {
                            try {
                                console.log('üë• Users message received');
                                handleUsersMessage(JSON.parse(message.body));
                            } catch (error) {
                                console.error('‚ùå Error parsing users message:', error);
                            }
                        });
                        
                        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏)
                        stompClient.subscribe(`/user/queue/board/state`, (message) => {
                            console.log('üìã –ü–æ–ª—É—á–µ–Ω–æ –ª–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –¥–æ—Å–∫–∏');
                            try {
                            handleBoardMessage(JSON.parse(message.body));
                            } catch (error) {
                                console.error('‚ùå Error parsing board state message:', error);
                            }
                        });
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏
                        sendJoinMessage();
                        
                        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
                        setTimeout(() => {
                        requestBoardState();
                        }, 1000);
                        
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                        setTimeout(() => {
                            checkAndSyncBoardState();
                        }, 3000);
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –æ—á–µ—Ä–µ–¥–∏
                        processMessageQueue();
                        
                        // –ó–∞–ø—É—Å–∫–∞–µ–º heartbeat
                        startHeartbeat();
                        
                        // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –µ—Å–ª–∏ –±—ã–ª–∞ –ø–æ–∫–∞–∑–∞–Ω–∞
                        hideReconnectButton();
                        
                    },
                    (error) => {
                        clearTimeout(connectionTimeout); // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                        console.error('‚ùå WebSocket connection failed:', {
                            error: error,
                            errorType: error?.constructor?.name,
                            message: error?.message || error?.toString() || 'Unknown error',
                            stack: error?.stack
                        });
                        handleConnectionError(error);
                    }
                );
                
            } catch (error) {
                console.error('‚ùå WebSocket initialization error:', error);
                handleConnectionError(error);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Ç–æ–ø–∏–∫–∏ Excalidraw
        function subscribeToExcalidrawTopics() {
            if (!stompClient || !isConnected) {
                console.warn('‚ö†Ô∏è Cannot subscribe to topics: WebSocket not connected');
                return;
            }
            
            try {
                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å–∫–∏
                stompClient.subscribe(`/topic/excalidraw/${lessonId}`, (message) => {
                    try {
                        const data = JSON.parse(message.body);
                        console.log('üì® Excalidraw board message received:', data.type);
                        handleExcalidrawMessage(data);
                    } catch (e) {
                        console.error('‚ùå Error parsing board message:', e);
                    }
                });
                
                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                stompClient.subscribe(`/topic/excalidraw/${lessonId}/users`, (message) => {
                    try {
                        const data = JSON.parse(message.body);
                        console.log('üë• Users update received:', data);
                        handleUsersUpdate(data);
                    } catch (e) {
                        console.error('‚ùå Error parsing users message:', e);
                    }
                });
                
                console.log('‚úÖ Subscribed to Excalidraw topics');
                
            } catch (error) {
                console.error('‚ùå Error subscribing to topics:', error);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–ª–∏—è–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ—Ç —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function mergeConcurrentChanges(localElements, remoteElements, localTimestamp, remoteTimestamp) {
            try {
                if (!Array.isArray(localElements) || !Array.isArray(remoteElements)) {
                    console.warn('‚ö†Ô∏è Invalid elements for merging, using remote');
                    return remoteElements;
                }
                
                // –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–æ–≤–µ–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
                if (localTimestamp > remoteTimestamp) {
                    console.log('üîÑ Using local changes (newer timestamp)');
                    return localElements;
                }
                
                // –ï—Å–ª–∏ —É–¥–∞–ª–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–æ–≤–µ–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
                if (remoteTimestamp > localTimestamp) {
                    console.log('üîÑ Using remote changes (newer timestamp)');
                    return remoteElements;
                }
                
                // –ï—Å–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ —Ä–∞–≤–Ω—ã, –æ–±—ä–µ–¥–∏–Ω—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
                console.log('üîÑ Merging concurrent changes');
                const mergedElements = [...localElements];
                const localIds = new Set(localElements.map(el => el.id));
                
                // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏
                remoteElements.forEach(remoteEl => {
                    if (!localIds.has(remoteEl.id)) {
                        mergedElements.push(remoteEl);
                    } else {
                        // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
                        const localEl = localElements.find(el => el.id === remoteEl.id);
                        if (localEl && remoteEl.version > localEl.version) {
                            const index = mergedElements.findIndex(el => el.id === remoteEl.id);
                            if (index !== -1) {
                                mergedElements[index] = remoteEl;
                            }
                        }
                    }
                });
                
                return mergedElements;
                
            } catch (error) {
                console.error('‚ùå Error merging concurrent changes:', error);
                return remoteElements; // Fallback to remote
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π Excalidraw
        function handleExcalidrawMessage(data) {
            console.log('üì® Excalidraw message received:', data.type, 'from:', data.userName);
            
            switch (data.type) {
                case 'board_update':
                    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –≤–∫–ª—é—á–∞—è —Å–µ–±—è
                    // –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
                    if (data.boardData) {
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ boardData
                        let boardData = data.boardData;
                        
                        // –ï—Å–ª–∏ boardData —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞, –ø—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å
                        if (typeof boardData === 'string') {
                            try {
                                boardData = JSON.parse(boardData);
                            } catch (e) {
                                console.error('‚ùå Failed to parse boardData string:', e);
                                return;
                            }
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ boardData —ç—Ç–æ –æ–±—ä–µ–∫—Ç
                        if (!boardData || typeof boardData !== 'object') {
                            console.warn('‚ö†Ô∏è Board update received with invalid boardData:', typeof boardData);
                            return;
                        }
                        
                        if (data.userId === collaborationState.userId) {
                            console.log('üìã Board update from self, sequence:', data.sequenceId);
                            // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                            if (data.sequenceId) {
                                pendingUpdates.delete(data.sequenceId);
                            }
                            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                            console.log('üîÑ Applying own board update for sync, elements:', boardData?.elements?.length || 0);
                            applyBoardUpdate(boardData);
                        } else {
                            console.log('üìã Board update from other user:', data.userName, 'elements:', boardData?.elements?.length || 0);
                            
                            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
                            if (excalidrawAPI && boardData?.elements) {
                                const currentElements = excalidrawAPI.getSceneElements();
                                const currentTimestamp = lastLocalUpdate;
                                const remoteTimestamp = data.timestamp || Date.now();
                                
                                // –°–ª–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –µ—Å–ª–∏ –æ–Ω–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
                                if (Math.abs(currentTimestamp - remoteTimestamp) < 100) { // –í –ø—Ä–µ–¥–µ–ª–∞—Ö 100ms
                                    console.log('üîÑ Detected concurrent drawing, merging changes');
                                    const mergedElements = mergeConcurrentChanges(
                                        currentElements, 
                                        boardData.elements, 
                                        currentTimestamp, 
                                        remoteTimestamp
                                    );
                                    boardData.elements = mergedElements;
                                }
                            }
                            
                            console.log('üîÑ Applying board update from', data.userName);
                            applyBoardUpdate(boardData);
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Board update received without boardData');
                    }
                    break;
                case 'user_joined':
                    console.log('üë§ User joined:', data.userName);
                    showToast(`${data.userName} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –¥–æ—Å–∫–µ`, 'info');
                    break;
                case 'user_left':
                    console.log('üë§ User left:', data.userName);
                    showToast(`${data.userName} –ø–æ–∫–∏–Ω—É–ª –¥–æ—Å–∫—É`, 'info');
                    break;
                case 'board_state':
                    console.log('üìã Board state received');
                    applyBoardState(data.boardData);
                    break;
                default:
                    console.log('üì® Unknown message type:', data.type);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function handleUsersUpdate(data) {
            if (data.users) {
                updateActiveUsers(data.users);
            }
        }
        
        // –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–æ—Å–∫–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏–∑–º–µ–Ω–µ–Ω–∏–π
        function applyBoardUpdate(boardData) {
            if (!boardData) {
                console.warn('‚ö†Ô∏è Cannot apply board update: boardData missing');
                return;
            }
            
            // –ï—Å–ª–∏ API –Ω–µ –≥–æ—Ç–æ–≤, –∂–¥–µ–º –µ–≥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
            if (!excalidrawAPI) {
                console.log('üìã API not ready, waiting for initialization...');
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ—Å–ª–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ API
                if (!window.pendingBoardUpdates) {
                    window.pendingBoardUpdates = [];
                }
                window.pendingBoardUpdates.push({
                    boardData: boardData,
                    timestamp: Date.now(),
                    type: 'update'
                });
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏
                if (window.pendingBoardUpdates.length > 10) {
                    window.pendingBoardUpdates = window.pendingBoardUpdates.slice(-5);
                }
                return;
            }
            
            try {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —á—Ç–æ –ø—Ä–∏–º–µ–Ω—è–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                isApplyingRemoteUpdate = true;
                
                console.log('üîç applyBoardUpdate input validation:');
                console.log('  - boardData type:', typeof boardData);
                console.log('  - boardData.elements type:', typeof boardData.elements);
                console.log('  - boardData.elements isArray:', Array.isArray(boardData.elements));
                
                // –°–¢–†–û–ì–ê–Ø –≤–∞–ª–∏–¥–∞—Ü–∏—è elements - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤
                let elements = boardData.elements;
                if (!Array.isArray(elements)) {
                    console.warn('‚ö†Ô∏è boardData.elements is not an array in applyBoardUpdate, converting...');
                    if (typeof elements === 'string') {
                        try {
                            elements = JSON.parse(elements);
                        } catch (e) {
                            console.error('‚ùå Failed to parse elements string in applyBoardUpdate:', e);
                            elements = [];
                        }
                    } else if (elements && typeof elements === 'object') {
                        // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç, –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –º–∞—Å—Å–∏–≤
                        if (elements.elements && Array.isArray(elements.elements)) {
                            elements = elements.elements;
                        } else {
                            console.warn('‚ö†Ô∏è Converting object to array in applyBoardUpdate');
                            elements = Object.values(elements);
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Invalid elements data in applyBoardUpdate, using empty array');
                        elements = [];
                    }
                }
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ elements —ç—Ç–æ –º–∞—Å—Å–∏–≤
                if (!Array.isArray(elements)) {
                    console.error('‚ùå Elements is still not an array after conversion in applyBoardUpdate, using empty array');
                    elements = [];
                }
                
                // –í–∞–ª–∏–¥–∏—Ä—É–µ–º –∏ –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                console.log('üîç applyBoardUpdate: Starting validation...');
                const validElements = validateAndCleanElements(elements);
                const validAppState = validateAndCleanAppState(boardData.appState || {});
                const validFiles = validateAndCleanFiles(boardData.files || {});
                
                // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ø–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
                console.log('üîç applyBoardUpdate: After validation:');
                console.log('  - validElements type:', typeof validElements, Array.isArray(validElements) ? `Array(${validElements.length})` : 'not array');
                console.log('  - validAppState type:', typeof validAppState);
                console.log('  - validFiles type:', typeof validFiles, validFiles instanceof Map ? `Map(${validFiles.size})` : 'not Map');
                
                if (!Array.isArray(validElements)) {
                    console.error('‚ùå CRITICAL: validElements is not an array after validation!');
                    return;
                }
                
                if (validFiles !== undefined && validFiles !== null && !(validFiles instanceof Map)) {
                    console.error('‚ùå CRITICAL: validFiles is not a Map after validation!');
                    return;
                }
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ pressures –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                if (Array.isArray(validElements)) {
                    validElements.forEach((element, index) => {
                        if (element && element.points && Array.isArray(element.points)) {
                            if (!element.pressures || !Array.isArray(element.pressures)) {
                                console.warn(`‚ö†Ô∏è applyBoardUpdate: Element ${index} missing pressures, adding default values`);
                                element.pressures = element.points.map(() => 0.5);
                            } else if (element.pressures.length !== element.points.length) {
                                console.warn(`‚ö†Ô∏è applyBoardUpdate: Element ${index} pressures length mismatch, fixing`);
                                if (element.pressures.length < element.points.length) {
                                    const needed = element.points.length - element.pressures.length;
                                    element.pressures = element.pressures.concat(Array(needed).fill(0.5));
                                } else {
                                    element.pressures = element.pressures.slice(0, element.points.length);
                                }
                            }
                        }
                    });
                }
                
                // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: Excalidraw –æ–∂–∏–¥–∞–µ—Ç Map –∏–ª–∏ undefined
                let filesForUpdate;
                if (validFiles instanceof Map) {
                    filesForUpdate = validFiles.size > 0 ? validFiles : undefined;
                } else if (typeof validFiles === 'object' && validFiles !== null) {
                    filesForUpdate = Object.keys(validFiles).length > 0 ? new Map(Object.entries(validFiles)) : undefined;
                } else {
                    filesForUpdate = undefined;
                }
                
                console.log('üîç applyBoardUpdate validation:');
                console.log('  - elements:', Array.isArray(validElements) ? `Array(${validElements.length})` : typeof validElements);
                console.log('  - appState:', typeof validAppState);
                console.log('  - files:', filesForUpdate instanceof Map ? `Map(${filesForUpdate.size})` : 'undefined');
                
                // –ü–†–û–í–ï–†–ö–ê –ò–ó–ú–ï–ù–ï–ù–ò–ô: –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å —Ç–µ–∫—É—â–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
                const currentElements = excalidrawAPI.getSceneElements();
                const currentAppState = excalidrawAPI.getAppState();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                const elementsChanged = JSON.stringify(currentElements) !== JSON.stringify(validElements);
                const appStateChanged = JSON.stringify(currentAppState) !== JSON.stringify(validAppState);
                
                if (!elementsChanged && !appStateChanged) {
                    console.log('üîÑ No changes detected, skipping update');
                    return;
                }
                
                // –§–ò–ù–ê–õ–¨–ù–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º
                if (!Array.isArray(validElements)) {
                    console.error('‚ùå Final validation failed in applyBoardUpdate: validElements is not an array');
                    return;
                }
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                if (Array.isArray(validElements)) {
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ files –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º
                    if (filesForUpdate !== undefined && filesForUpdate !== null && !(filesForUpdate instanceof Map)) {
                        console.error('‚ùå filesForUpdate is not a Map or undefined in applyBoardUpdate:', filesForUpdate);
                        return;
                    }
                    
                    const success = safeUpdateScene(
                        excalidrawAPI,
                        validElements,
                        validAppState,
                        filesForUpdate
                    );
                    
                    if (!success) {
                        console.error('‚ùå Failed to apply board update');
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                    lastRemoteUpdate = Date.now();
                    lastRemoteUpdateTime = Date.now();
                    
                    console.log('‚úÖ Board update applied successfully with', validElements.length, 'elements');
                    console.log('üîÑ Updated lastRemoteUpdateTime to:', lastRemoteUpdateTime);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
                    try {
                        const backupData = {
                            elements: validElements,
                            appState: validAppState,
                            files: filesForUpdate ? Object.fromEntries(filesForUpdate) : {},
                            timestamp: Date.now()
                        };
                        localStorage.setItem(`excalidraw_backup_${lessonId}`, JSON.stringify(backupData));
                    } catch (backupError) {
                        console.warn('‚ö†Ô∏è Failed to save backup:', backupError);
                    }
                } else {
                    console.error('‚ùå Invalid elements data:', validElements);
                }
                
            } catch (error) {
                console.error('‚ùå Error applying board update:', error);
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å–∫–∏', 'error');
            } finally {
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                setTimeout(() => {
                    isApplyingRemoteUpdate = false;
                }, 10); // –£–º–µ–Ω—å—à–∏–ª–∏ –¥–æ 10ms —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏—é
            }
        }
        
        // –£–õ–£–ß–®–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ—Å–∫–∏ —Å —Å—Ç—Ä–æ–≥–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
        function applyBoardState(boardData) {
            if (!excalidrawAPI || !boardData) {
                console.warn('‚ö†Ô∏è Cannot apply board state: API not ready or boardData missing');
                return;
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ API
            if (!excalidrawAPI.updateScene || typeof excalidrawAPI.updateScene !== 'function') {
                console.warn('‚ö†Ô∏è API updateScene method not ready, retrying in 100ms');
                setTimeout(() => applyBoardState(boardData), 100);
                return;
            }
            
            try {
                console.log('üîç applyBoardState input validation:');
                console.log('  - boardData type:', typeof boardData);
                console.log('  - boardData.elements type:', typeof boardData.elements);
                console.log('  - boardData.elements isArray:', Array.isArray(boardData.elements));
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ boardData –Ω–µ –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç
                if (!boardData || Object.keys(boardData).length === 0) {
                    console.warn('‚ö†Ô∏è boardData is empty, skipping application');
                    return;
                }
                
                // –°–¢–†–û–ì–ê–Ø –≤–∞–ª–∏–¥–∞—Ü–∏—è elements - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤
                let elements = boardData.elements;
                
                // –ï—Å–ª–∏ elements –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
                if (elements === null || elements === undefined) {
                    console.log('üîç elements is null/undefined, using empty array');
                    elements = [];
                } else if (!Array.isArray(elements)) {
                    console.warn('‚ö†Ô∏è boardData.elements is not an array, converting...');
                    if (typeof elements === 'string') {
                        try {
                            elements = JSON.parse(elements);
                        } catch (e) {
                            console.error('‚ùå Failed to parse elements string:', e);
                            elements = [];
                        }
                    } else if (elements && typeof elements === 'object') {
                        // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç, –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –º–∞—Å—Å–∏–≤
                        if (elements.elements && Array.isArray(elements.elements)) {
                            elements = elements.elements;
                        } else {
                            console.warn('‚ö†Ô∏è Converting object to array');
                            elements = Object.values(elements);
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Invalid elements data, using empty array');
                        elements = [];
                    }
                }
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ elements —ç—Ç–æ –º–∞—Å—Å–∏–≤
                if (!Array.isArray(elements)) {
                    console.error('‚ùå Elements is still not an array after conversion, using empty array');
                    elements = [];
                }
                
                // –í–∞–ª–∏–¥–∏—Ä—É–µ–º –∏ –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                const validElements = validateAndCleanElements(elements);
                const validAppState = validateAndCleanAppState(boardData.appState || {});
                const validFiles = validateAndCleanFiles(boardData.files || {});
                
                // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: Excalidraw –æ–∂–∏–¥–∞–µ—Ç Map
                let filesForUpdate;
                if (validFiles instanceof Map) {
                    filesForUpdate = validFiles.size > 0 ? validFiles : undefined;
                } else if (typeof validFiles === 'object' && validFiles !== null) {
                    filesForUpdate = Object.keys(validFiles).length > 0 ? new Map(Object.entries(validFiles)) : undefined;
                } else {
                    filesForUpdate = undefined;
                }
                
                console.log('üîç applyBoardState final validation:');
                console.log('  - elements:', Array.isArray(validElements) ? `Array(${validElements.length})` : typeof validElements);
                console.log('  - appState:', typeof validAppState);
                console.log('  - files:', filesForUpdate instanceof Map ? `Map(${filesForUpdate.size})` : 'undefined');
                
                // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º
                if (!Array.isArray(validElements)) {
                    console.error('‚ùå Final validation failed: validElements is not an array');
                    return;
                }
                
                const success = safeUpdateScene(
                    excalidrawAPI,
                    validElements,
                    validAppState,
                    filesForUpdate
                );
                
                if (success) {
                    console.log('‚úÖ Board state applied successfully with', validElements.length, 'elements');
                } else {
                    console.error('‚ùå Failed to apply board state');
                }
            } catch (error) {
                console.error('‚ùå Error applying board state:', error);
                console.error('‚ùå Error details:', {
                    message: error.message,
                    stack: error.stack,
                    boardData: boardData
                });
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function updateActiveUsers(users) {
            const usersList = document.getElementById('active-users');
            if (usersList) {
                usersList.innerHTML = '';
                users.forEach(user => {
                    const userElement = document.createElement('div');
                    userElement.className = 'user-item';
                    userElement.textContent = user.userName;
                    usersList.appendChild(userElement);
                });
            }
        }
        
        // –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        function handleConnectionError(error) {
            // –£–ª—É—á—à–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ—à–∏–±–∫–∏
            let errorMessage = 'Unknown error';
            if (error && error.message) {
                errorMessage = error.message;
            } else if (typeof error === 'string') {
                errorMessage = error;
            } else if (error && error.toString) {
                errorMessage = error.toString();
            }
            
            const errorInfo = {
                message: errorMessage,
                timestamp: new Date().toISOString(),
                url: window.location.href,
                userAgent: navigator.userAgent,
                reconnectAttempt: reconnectAttempts,
                lessonId: lessonId,
                userId: collaborationState.userId,
                errorType: error?.constructor?.name || 'Unknown',
                stack: error?.stack || 'No stack trace available'
            };
            
            console.error('‚ùå WebSocket connection error:', errorInfo);
            
            // –õ–æ–≥–∏—Ä—É–µ–º –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ª–æ–∫–∞–ª—å–Ω–æ
            try {
                console.log('üìä WebSocket Error Diagnostics:', errorInfo);
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                const diagnostics = JSON.parse(localStorage.getItem('websocket-diagnostics') || '[]');
                diagnostics.push(errorInfo);
                // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞–ø–∏—Å–µ–π
                if (diagnostics.length > 10) {
                    diagnostics.splice(0, diagnostics.length - 10);
                }
                localStorage.setItem('websocket-diagnostics', JSON.stringify(diagnostics));
            } catch (e) {
                console.warn('‚ö†Ô∏è Could not save diagnostic info:', e);
            }
            
                        isConnected = false;
            connectionQuality = 'disconnected';
                        updateConnectionStatus('disconnected');
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º heartbeat
            stopHeartbeat();
            
            // –û—á–∏—â–∞–µ–º stompClient
            if (stompClient) {
                try {
                    stompClient.disconnect();
                } catch (e) {
                    console.warn('‚ö†Ô∏è Error during cleanup disconnect:', e);
                }
                stompClient = null;
            }
                        
                        // –£–ú–ù–û–ï –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç —Å–ø–∞–º–∞
                        if (reconnectAttempts < maxReconnectAttempts) {
                            reconnectAttempts++;
                            console.log(`üîÑ Reconnection attempt ${reconnectAttempts}/${maxReconnectAttempts}`);
                            updateConnectionStatus('connecting');
                            
                            // –≠–ö–°–ü–û–ù–ï–ù–¶–ò–ê–õ–¨–ù–ê–Ø –∑–∞–¥–µ—Ä–∂–∫–∞ —Å jitter –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è thundering herd
                            const baseDelay = Math.min(1000 * Math.pow(2, reconnectAttempts - 1), 30000); // 1s, 2s, 4s, 8s, 16s, 30s max
                            const jitter = Math.random() * 2000; // –î–æ 2 —Å–µ–∫—É–Ω–¥ —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏
                            const delay = baseDelay + jitter;
                            
                            console.log(`‚è±Ô∏è Waiting ${Math.round(delay/1000)}s before reconnection (exponential backoff)...`);
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –Ω–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ
                            const now = Date.now();
                            if (window.lastReconnectTime && (now - window.lastReconnectTime) < 1000) {
                                console.log('‚ö†Ô∏è Too frequent reconnection attempts, skipping...');
                                return;
                            }
                            window.lastReconnectTime = now;
                            
                            setTimeout(() => {
                                if (!isConnected) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –≤—Å—ë –µ—â—ë –æ—Ç–∫–ª—é—á–µ–Ω—ã
                                    console.log('üîÑ Attempting reconnection...');
                                    initializeWebSocket();
                                }
                }, delay);
                        } else {
                console.error('‚ùå Max reconnection attempts reached');
                showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –†–∞–±–æ—Ç–∞–µ–º –≤ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–º —Ä–µ–∂–∏–º–µ.', 'error');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                showReconnectButton();
            }
        }
        
        // –£–õ–£–ß–®–ï–ù–ù–´–ô heartbeat –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        function startHeartbeat() {
            stopHeartbeat(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –µ—Å–ª–∏ –µ—Å—Ç—å
            
            let missedHeartbeats = 0;
            const maxMissedHeartbeats = 5; // –£–º–µ–Ω—å—à–∞–µ–º –ª–∏–º–∏—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º
            let lastSuccessfulPing = Date.now();
            
            heartbeatInterval = setInterval(() => {
                if (stompClient && isConnected) {
                    try {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ
                        if (!stompClient.connected) {
                            console.warn('‚ö†Ô∏è STOMP client not connected, triggering reconnection');
                            isConnected = false;
                            handleConnectionError(new Error('STOMP connection lost'));
                            return;
                        }
                        
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º ping —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ null
                        const pingTime = Date.now();
                        const pingData = {
                            userId: collaborationState.userId,
                            timestamp: pingTime
                        };
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥–∞–Ω–Ω—ã–µ ping –Ω–µ null
                        if (pingData.userId && pingData.timestamp) {
                            stompClient.send(`/app/excalidraw/${lessonId}/ping`, {}, JSON.stringify(pingData));
                            lastSuccessfulPing = Date.now();
                            missedHeartbeats = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ
                        } else {
                            console.warn('‚ö†Ô∏è Ping data is invalid:', pingData);
                            missedHeartbeats++;
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ ping
                        const timeSinceLastPing = Date.now() - lastSuccessfulPing;
                        if (timeSinceLastPing > 60000) { // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ –º–∏–Ω—É—Ç—ã –±–µ–∑ —É—Å–ø–µ—à–Ω–æ–≥–æ ping
                            console.warn('‚ö†Ô∏è No successful ping for over 1 minute, triggering reconnection');
                            isConnected = false;
                            handleConnectionError(new Error('Heartbeat timeout - no successful ping for 1 minute'));
                            return;
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ pending updates (–±–æ–ª–µ–µ –º—è–≥–∫–æ)
                        const previousQuality = connectionQuality;
                        if (pendingUpdates.size > 20) { // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø–æ—Ä–æ–≥
                            connectionQuality = 'poor';
                            missedHeartbeats++;
                        } else if (pendingUpdates.size > 10) { // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø–æ—Ä–æ–≥
                            connectionQuality = 'fair';
                            missedHeartbeats = Math.max(0, missedHeartbeats - 1);
                        } else {
                            connectionQuality = 'good';
                            missedHeartbeats = Math.max(0, missedHeartbeats - 2); // –ë—ã—Å—Ç—Ä–µ–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
                        }
                        
                        // –ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø—Ä–æ–±–ª–µ–º —Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è
                        if (missedHeartbeats >= maxMissedHeartbeats) {
                            console.warn(`‚ö†Ô∏è Too many missed heartbeats (${missedHeartbeats}), reconnecting...`);
                            isConnected = false;
                            reconnectAttempts = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                            handleConnectionError(new Error('Poor connection quality'));
                            return;
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –µ—Å–ª–∏ –∫–∞—á–µ—Å—Ç–≤–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
                        if (previousQuality !== connectionQuality) {
                            updateConnectionStatus('connected');
                        }
                        
                    } catch (error) {
                        console.warn('‚ùå Heartbeat error:', error);
                        connectionQuality = 'poor';
                        missedHeartbeats++;
                        
                        // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è
                        if (missedHeartbeats >= maxMissedHeartbeats) {
                            isConnected = false;
                            handleConnectionError(error);
                        }
                    }
                }
            }, 20000); // –ö–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥ (–º–µ–Ω–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ)
        }
        
        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
        }
        
        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π retry
        function processMessageQueue() {
            if (messageQueue.length === 0) return;
            
            console.log(`üì§ Processing ${messageQueue.length} queued messages`);
            
            const messagesToSend = [...messageQueue];
            messageQueue = []; // –û—á–∏—â–∞–µ–º –æ—á–µ—Ä–µ–¥—å
            
            messagesToSend.forEach((queuedMessage, index) => {
                setTimeout(() => {
                    if (queuedMessage.type === 'board_update') {
                        // –ü–µ—Ä–µ–¥–∞–µ–º retryCount –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                        const retryCount = queuedMessage.retryCount || 0;
                        sendBoardUpdateImproved(
                            queuedMessage.elements,
                            queuedMessage.appState,
                            queuedMessage.files,
                            queuedMessage.sequenceId,
                            queuedMessage.timestamp,
                            retryCount
                        );
                    }
                }, index * 50); // –£–º–µ–Ω—å—à–∏–ª–∏ –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        function getSyncDiagnostics() {
            return {
                isConnected: isConnected,
                stompClientConnected: stompClient && stompClient.connected,
                messageQueueLength: messageQueue.length,
                pendingUpdatesCount: pendingUpdates.size,
                lastSendTime: lastSendTime,
                lastRemoteUpdateTime: lastRemoteUpdateTime,
                isApplyingRemoteUpdate: isApplyingRemoteUpdate,
                updateSequence: updateSequence,
                connectionQuality: connectionQuality,
                reconnectAttempts: reconnectAttempts,
                timestamp: new Date().toISOString()
            };
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        function forceSync() {
            if (!excalidrawAPI || !isConnected) {
                console.warn('‚ö†Ô∏è Cannot force sync: API not ready or not connected');
                return;
            }
            
            console.log('üîÑ Forcing board synchronization...');
            
            try {
                const elements = excalidrawAPI.getSceneElements();
                const appState = excalidrawAPI.getAppState();
                const files = excalidrawAPI.getFiles();
                
                const sequenceId = ++updateSequence;
                const timestamp = Date.now();
                
                sendBoardUpdateImproved(elements, appState, files, sequenceId, timestamp);
                console.log('‚úÖ Force sync completed');
                
            } catch (error) {
                console.error('‚ùå Error during force sync:', error);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        function logSyncState() {
            console.log('üîç === SYNC STATE DIAGNOSTICS ===');
            console.log('üìä Connection State:', {
                isConnected: isConnected,
                stompClientConnected: stompClient && stompClient.connected,
                lessonId: lessonId,
                userId: collaborationState.userId,
                userName: collaborationState.userName
            });
            console.log('üìä API State:', {
                excalidrawAPI: !!excalidrawAPI,
                globalExcalidrawAPI: !!window.excalidrawAPI,
                stateManagerAPI: !!getState('excalidrawAPI')
            });
            console.log('üìä Timing State:', {
                lastSendTime: lastSendTime,
                lastRemoteUpdateTime: lastRemoteUpdateTime,
                lastLocalUpdate: lastLocalUpdate,
                isApplyingRemoteUpdate: isApplyingRemoteUpdate
            });
            console.log('üìä Queue State:', {
                messageQueueLength: messageQueue.length,
                pendingUpdatesCount: pendingUpdates.size,
                pendingBoardUpdatesLength: window.pendingBoardUpdates ? window.pendingBoardUpdates.length : 0
            });
            console.log('üìä Sequence State:', {
                updateSequence: updateSequence,
                connectionQuality: connectionQuality,
                reconnectAttempts: reconnectAttempts
            });
            console.log('üîç === END SYNC STATE ===');
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∫–∞—á–µ—Å—Ç–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        function getConnectionHealth() {
            const now = Date.now();
            return {
                isConnected: isConnected,
                stompClientConnected: stompClient && stompClient.connected,
                connectionQuality: connectionQuality,
                reconnectAttempts: reconnectAttempts,
                maxReconnectAttempts: maxReconnectAttempts,
                timeSinceLastSend: now - lastSendTime,
                timeSinceLastRemoteUpdate: now - lastRemoteUpdateTime,
                pendingUpdatesCount: pendingUpdates.size,
                messageQueueLength: messageQueue.length,
                lastSuccessfulPing: window.lastSuccessfulPing ? now - window.lastSuccessfulPing : null,
                uptime: now - (window.connectionStartTime || now)
            };
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function forceReconnect() {
            console.log('üîÑ Forcing WebSocket reconnection...');
            if (stompClient) {
                try {
                    stompClient.disconnect();
                } catch (e) {
                    console.warn('‚ö†Ô∏è Error during forced disconnect:', e);
                }
            }
            isConnected = false;
            reconnectAttempts = 0;
            window.connectionStartTime = Date.now();
            setTimeout(() => {
                initializeWebSocket();
            }, 1000);
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        window.getSyncDiagnostics = getSyncDiagnostics;
        window.forceSync = forceSync;
        window.logSyncState = logSyncState;
        window.getConnectionHealth = getConnectionHealth;
        window.forceReconnect = forceReconnect;
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É —Ä—É—á–Ω–æ–≥–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function showReconnectButton() {
            let reconnectBtn = document.getElementById('reconnectButton');
            if (!reconnectBtn) {
                reconnectBtn = document.createElement('button');
                reconnectBtn.id = 'reconnectButton';
                reconnectBtn.innerHTML = 'üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è';
                reconnectBtn.className = 'btn btn-warning btn-sm';
                reconnectBtn.style.cssText = `
                    position: fixed;
                    top: 100px;
                    right: 16px;
                    z-index: 1000;
                    border-radius: 6px;
                    padding: 8px 12px;
                    border: none;
                    font-size: 12px;
                    cursor: pointer;
                `;
                reconnectBtn.onclick = () => {
                    reconnectAttempts = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                    hideReconnectButton();
                    initializeWebSocket();
                };
                document.body.appendChild(reconnectBtn);
            }
            reconnectBtn.style.display = 'block';
        }
        
        // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function hideReconnectButton() {
            const reconnectBtn = document.getElementById('reconnectButton');
            if (reconnectBtn) {
                reconnectBtn.style.display = 'none';
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ—Å–∫–∏
        function checkAndSyncBoardState() {
            if (!excalidrawAPI || !isConnected) return;
            
            const currentElements = excalidrawAPI.getSceneElements();
            const hasElements = currentElements && currentElements.length > 0;
            
            // –ï—Å–ª–∏ —É –Ω–∞—Å –Ω–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –Ω–æ —É—Ä–æ–∫ –Ω–µ –Ω–æ–≤—ã–π, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            if (!hasElements && lessonId !== 'demo') {
                console.log('üîÑ Board appears empty, requesting state...');
                requestBoardState();
                
                // –¢–∞–∫–∂–µ –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ backup
                setTimeout(() => {
                    const currentElementsAfter = excalidrawAPI.getSceneElements();
                    if (!currentElementsAfter || currentElementsAfter.length === 0) {
                        loadFromBackup();
                    }
                }, 2000);
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ backup –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
        function loadFromBackup() {
            try {
                const backupKey = `excalidraw_backup_${lessonId}`;
                const backup = localStorage.getItem(backupKey);
                
                if (backup) {
                    const backupData = JSON.parse(backup);
                    if (backupData.elements && backupData.elements.length > 0) {
                        console.log('üìã Loading from backup:', backupData.elements.length, 'elements');
                        
                        // –°–¢–†–û–ì–ê–Ø –≤–∞–ª–∏–¥–∞—Ü–∏—è backup —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                        let elements = backupData.elements;
                        if (!Array.isArray(elements)) {
                            console.warn('‚ö†Ô∏è backupData.elements is not an array, converting...');
                            if (typeof elements === 'string') {
                                try {
                                    elements = JSON.parse(elements);
                                } catch (e) {
                                    console.error('‚ùå Failed to parse backup elements string:', e);
                                    elements = [];
                                }
                            } else if (elements && typeof elements === 'object') {
                                if (elements.elements && Array.isArray(elements.elements)) {
                                    elements = elements.elements;
                                } else {
                                    elements = Object.values(elements);
                                }
                            } else {
                                elements = [];
                            }
                        }
                        
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                        if (!Array.isArray(elements)) {
                            console.error('‚ùå Backup elements is still not an array after conversion, using empty array');
                            elements = [];
                        }
                        
                        // –í–∞–ª–∏–¥–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
                        const validElements = validateAndCleanElements(elements);
                        
                        // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                        if (!Array.isArray(validElements)) {
                            console.error('‚ùå Final validation failed for backup elements: validElements is not an array');
                            return;
                        }
                        
                        isApplyingRemoteUpdate = true;
                        // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: Excalidraw –æ–∂–∏–¥–∞–µ—Ç Map
                        let filesForUpdate;
                        if (backupData.files instanceof Map) {
                            filesForUpdate = backupData.files.size > 0 ? backupData.files : undefined;
                        } else if (typeof backupData.files === 'object' && backupData.files !== null) {
                            filesForUpdate = Object.keys(backupData.files).length > 0 ? new Map(Object.entries(backupData.files)) : undefined;
                        } else {
                            filesForUpdate = undefined;
                        }
                        
                        const success = safeUpdateScene(
                            excalidrawAPI,
                            validElements,
                            backupData.appState || {},
                            filesForUpdate
                        );
                        
                        if (!success) {
                            console.error('‚ùå Failed to apply backup data');
                        }
                        
                        setTimeout(() => {
                            isApplyingRemoteUpdate = false;
                        }, 100);
                        
                        showToast('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'info');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error loading from backup:', error);
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏
        function sendJoinMessage() {
            if (stompClient && isConnected) {
                stompClient.send(`/app/excalidraw/${lessonId}/join`, {}, JSON.stringify({
                    lessonId: lessonId,
                    userId: collaborationState.userId,
                    userName: collaborationState.userName,
                    userRole: isTeacher ? 'teacher' : isAdmin ? 'admin' : 'student'
                }));
            }
        }
        
        // –ó–∞–ø—Ä–æ—Å —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ—Å–∫–∏
        function requestBoardState() {
            if (stompClient && isConnected) {
                stompClient.send(`/app/excalidraw/${lessonId}/state`, {}, JSON.stringify({
                    lessonId: lessonId,
                    userId: collaborationState.userId
                }));
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Å–∂–∞—Ç–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø–µ—Ä–µ–¥–∞—á–∏
        function compressBoardData(elements, appState, files) {
            try {
                // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø–æ–ª—è –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
                const compressedElements = elements.map(el => ({
                    id: el.id,
                    type: el.type,
                    x: el.x,
                    y: el.y,
                    width: el.width,
                    height: el.height,
                    angle: el.angle,
                    strokeColor: el.strokeColor,
                    backgroundColor: el.backgroundColor,
                    fillStyle: el.fillStyle,
                    strokeWidth: el.strokeWidth,
                    strokeStyle: el.strokeStyle,
                    roughness: el.roughness,
                    opacity: el.opacity,
                    groupIds: el.groupIds,
                    frameId: el.frameId,
                    roundness: el.roundness,
                    seed: el.seed,
                    versionNonce: el.versionNonce,
                    isDeleted: el.isDeleted,
                    boundElements: el.boundElements,
                    updated: el.updated,
                    link: el.link,
                    locked: el.locked,
                    // –¢–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–ª—è –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
                    points: el.points,
                    text: el.text,
                    fontSize: el.fontSize,
                    fontFamily: el.fontFamily,
                    textAlign: el.textAlign,
                    verticalAlign: el.verticalAlign,
                    containerId: el.containerId,
                    originalText: el.originalText
                }));
                
                // –°–∂–∏–º–∞–µ–º appState - —Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã–µ –ø–æ–ª—è
                const compressedAppState = {
                    viewBackgroundColor: appState.viewBackgroundColor,
                    currentItemStrokeColor: appState.currentItemStrokeColor,
                    currentItemBackgroundColor: appState.currentItemBackgroundColor,
                    currentItemFillStyle: appState.currentItemFillStyle,
                    currentItemStrokeWidth: appState.currentItemStrokeWidth,
                    currentItemStrokeStyle: appState.currentItemStrokeStyle,
                    currentItemRoughness: appState.currentItemRoughness,
                    currentItemOpacity: appState.currentItemOpacity,
                    currentItemFontFamily: appState.currentItemFontFamily,
                    currentItemFontSize: appState.currentItemFontSize,
                    currentItemTextAlign: appState.currentItemTextAlign,
                    scrollX: appState.scrollX,
                    scrollY: appState.scrollY,
                    zoom: appState.zoom
                };
                
                return {
                    elements: compressedElements,
                    appState: compressedAppState,
                    files: files instanceof Map ? Object.fromEntries(files) : files
                };
                
            } catch (error) {
                console.error('‚ùå Error compressing board data:', error);
                return { elements, appState, files };
            }
        }
        
        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–æ—Å–∫–∏ —Å retry –º–µ—Ö–∞–Ω–∏–∑–º–æ–º –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π
        function sendBoardUpdateImproved(elements, appState, files, sequenceId, timestamp, retryCount = 0) {
            const maxRetries = 3;
            
            // –°–¢–†–û–ì–ê–Ø –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            try {
                if (!Array.isArray(elements)) {
                    console.error('‚ùå sendBoardUpdateImproved: elements is not an array:', typeof elements);
                    return;
                }
                
                if (files !== undefined && (typeof files !== 'object' || files === null)) {
                    console.error('‚ùå sendBoardUpdateImproved: files has invalid type:', typeof files);
                    return;
                }
                
                if (typeof appState !== 'object' || appState === null) {
                    console.error('‚ùå sendBoardUpdateImproved: appState is not an object:', typeof appState);
                    return;
                }
                
                if (typeof sequenceId !== 'number' || sequenceId <= 0) {
                    console.error('‚ùå sendBoardUpdateImproved: invalid sequenceId:', sequenceId);
                    return;
                }
                
            } catch (validationError) {
                console.error('‚ùå Error validating data in sendBoardUpdateImproved:', validationError);
                return;
            }
            
            // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            if (!stompClient || !isConnected || !stompClient.connected) {
                console.warn('‚ö†Ô∏è WebSocket not connected, adding to queue');
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
                messageQueue.push({
                    type: 'board_update',
                    elements: elements,
                    appState: appState,
                    files: files,
                    timestamp: timestamp,
                    sequenceId: sequenceId,
                    retryCount: retryCount
                });
                return;
            }
            
            // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –°–∂–∏–º–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø–µ—Ä–µ–¥–∞—á–∏
            const compressedData = compressBoardData(elements, appState, files);
            
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∂–∞—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø–µ—Ä–µ–¥–∞—á–∏
                const boardData = compressedData;
                
                const message = {
                    lessonId: lessonId,
                    userId: collaborationState.userId,
                    userName: collaborationState.userName,
                    boardData: boardData,
                    timestamp: timestamp,
                    sequenceId: sequenceId,
                    clientVersion: Date.now() // –í–µ—Ä—Å–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
                };
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
                pendingUpdates.set(sequenceId, {
                    timestamp: timestamp,
                    message: message
                });
                
                // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ pending updates
                if (pendingUpdates.size > 10) {
                    const oldestKey = Math.min(...pendingUpdates.keys());
                    pendingUpdates.delete(oldestKey);
                }
                
                console.log('üì§ Sending WebSocket message:', {
                    lessonId: lessonId,
                    userId: collaborationState.userId,
                    elementsCount: elements.length,
                    timestamp: timestamp,
                    sequenceId: sequenceId
                });
                
                stompClient.send(`/app/excalidraw/${lessonId}/update`, {}, JSON.stringify(message));
                
                // –£—Å–ø–µ—à–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ - —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ retry
                if (retryCount > 0) {
                    console.log('‚úÖ Message sent successfully after', retryCount, 'retries');
                }
                
            } catch (error) {
                console.error('‚ùå Error sending board update:', error);
                
                // RETRY –ú–ï–•–ê–ù–ò–ó–ú: –ü–æ–≤—Ç–æ—Ä—è–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –¥–æ maxRetries —Ä–∞–∑
                if (retryCount < maxRetries) {
                    console.log(`üîÑ Retrying send (attempt ${retryCount + 1}/${maxRetries})`);
                    setTimeout(() => {
                        sendBoardUpdateImproved(elements, appState, files, sequenceId, timestamp, retryCount + 1);
                    }, 100 * (retryCount + 1)); // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
                } else {
                    console.error('‚ùå Max retries reached, adding to queue');
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                    messageQueue.push({
                        type: 'board_update',
                        elements: elements,
                        appState: appState,
                        files: files,
                        timestamp: timestamp,
                        sequenceId: sequenceId,
                        retryCount: 0 // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–ª—è –æ—á–µ—Ä–µ–¥–∏
                    });
                }
            }
        }
        
        // –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        function sendBoardUpdate(elements, appState, files) {
            const sequenceId = ++updateSequence;
            const timestamp = Date.now();
            sendBoardUpdateImproved(elements, appState, files, sequenceId, timestamp);
        }
        
        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–æ—Å–∫–∏
        function handleBoardMessage(message) {
            console.log('üì® Board message received:', message.type, 'from:', message.userId, 'timestamp:', message.timestamp);
            
            // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
            const messageId = `${message.userId}_${message.timestamp}_${message.sequenceId || 'no-seq'}`;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏ –ª–∏ –º—ã —É–∂–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (processedMessageIds.has(messageId)) {
                console.log('üîÑ Skipping duplicate message:', messageId);
                return;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ (–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä Set)
            processedMessageIds.add(messageId);
            if (processedMessageIds.size > 100) {
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ ID (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50)
                const idsArray = Array.from(processedMessageIds);
                processedMessageIds.clear();
                idsArray.slice(-50).forEach(id => processedMessageIds.add(id));
            }
            
            // –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            if (message.userId === collaborationState.userId && message.sequenceId) {
                // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                if (pendingUpdates.has(message.sequenceId)) {
                    pendingUpdates.delete(message.sequenceId);
                    console.log('üì® Confirmed own message:', message.sequenceId);
                }
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
            if (message.timestamp && message.timestamp < lastRemoteUpdate) {
                console.log('‚è∞ Ignoring outdated message');
                return;
            }
            
            switch (message.type) {
                case 'board_update':
                    if (message.boardData && excalidrawAPI) {
                        try {
                            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —á—Ç–æ –ø—Ä–∏–º–µ–Ω—è–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                            isApplyingRemoteUpdate = true;
                            
                            // –†–∞–∑–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–æ—Å–∫–∏ –µ—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
                            let boardData = message.boardData;
                            if (typeof boardData === 'string') {
                                boardData = JSON.parse(boardData);
                            }
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                            if (boardData.elements) {
                                lastRemoteUpdate = message.timestamp || Date.now();
                                lastRemoteUpdateTime = Date.now();
                                
                                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
                                console.log('üîç Real-time sync data check:');
                                console.log('  - boardData.elements type:', typeof boardData.elements, 'isArray:', Array.isArray(boardData.elements), 'length:', boardData.elements?.length);
                                
                                // –ï—Å–ª–∏ elements –Ω–µ –º–∞—Å—Å–∏–≤, –∏—Å–ø—Ä–∞–≤–ª—è–µ–º —ç—Ç–æ
                                if (!Array.isArray(boardData.elements)) {
                                    console.warn('‚ö†Ô∏è Real-time elements is not an array, converting...');
                                    if (typeof boardData.elements === 'string') {
                                        try {
                                            boardData.elements = JSON.parse(boardData.elements);
                                        } catch (e) {
                                            console.error('‚ùå Failed to parse real-time elements string:', e);
                                            boardData.elements = [];
                                        }
                                    } else {
                                        boardData.elements = [];
                                    }
                                }
                                
                                // –í–∞–ª–∏–¥–∏—Ä—É–µ–º –∏ –æ—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º
                                console.log('üîç loadBoardState: Starting validation...');
                                const validElements = validateAndCleanElements(boardData.elements);
                                const validAppState = validateAndCleanAppState(boardData.appState);
                                const validFiles = validateAndCleanFiles(boardData.files);
                                
                                // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ø–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
                                console.log('üîç loadBoardState: After validation:');
                                console.log('  - validElements type:', typeof validElements, Array.isArray(validElements) ? `Array(${validElements.length})` : 'not array');
                                console.log('  - validAppState type:', typeof validAppState);
                                console.log('  - validFiles type:', typeof validFiles, validFiles instanceof Map ? `Map(${validFiles.size})` : 'not Map');
                                
                                if (!Array.isArray(validElements)) {
                                    console.error('‚ùå CRITICAL: validElements is not an array after validation in loadBoardState!');
                                    return;
                                }
                                
                                if (validFiles !== undefined && validFiles !== null && !(validFiles instanceof Map)) {
                                    console.error('‚ùå CRITICAL: validFiles is not a Map after validation in loadBoardState!');
                                    return;
                                }
                                
                                // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç race conditions
                                // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: Excalidraw –æ–∂–∏–¥–∞–µ—Ç Map
                                let filesForExcalidraw;
                                if (validFiles instanceof Map) {
                                    filesForExcalidraw = validFiles.size > 0 ? validFiles : undefined;
                                } else if (typeof validFiles === 'object' && validFiles !== null) {
                                    filesForExcalidraw = Object.keys(validFiles).length > 0 ? new Map(Object.entries(validFiles)) : undefined;
                                } else {
                                    filesForExcalidraw = undefined;
                                }
                                
                                excalidrawAPI.updateScene({
                                    elements: validElements,
                                    appState: validAppState,
                                    files: filesForExcalidraw
                                });
                                
                                console.log('‚úÖ Applied remote board update with', validElements.length, 'elements from user', message.userId);
                                
                                // –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                                setTimeout(() => {
                                    if (excalidrawAPI) {
                                        const currentScene = excalidrawAPI.getSceneElements();
                                        if (currentScene.length !== validElements.length) {
                                            console.log('üîÑ Re-syncing board state...');
                                            // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º files –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
                                            let filesForExcalidraw;
                                            if (validFiles instanceof Map) {
                                                filesForExcalidraw = validFiles.size > 0 ? Object.fromEntries(validFiles) : undefined;
                                            } else if (typeof validFiles === 'object' && validFiles !== null) {
                                                filesForExcalidraw = Object.keys(validFiles).length > 0 ? validFiles : undefined;
                                            } else {
                                                filesForExcalidraw = undefined;
                                            }
                                            
                                            excalidrawAPI.updateScene({
                                                elements: validElements,
                                                appState: validAppState,
                                                files: filesForExcalidraw
                                            });
                                        }
                                    }
                                }, 10);
                            }
                            
                        } catch (error) {
                            console.error('‚ùå Error processing board update:', error);
                        } finally {
                            // –°–Ω–∏–º–∞–µ–º —Ñ–ª–∞–≥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
                            setTimeout(() => {
                                isApplyingRemoteUpdate = false;
                            }, 10);
                        }
                    }
                    break;
                    
                case 'board_state':
                    if (message.boardData && excalidrawAPI) {
                        try {
                            console.log('üìã Loading board state from WebSocket');
                            isApplyingRemoteUpdate = true;
                            
                            // –†–∞–∑–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–æ—Å–∫–∏ –µ—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
                            let boardData = message.boardData;
                            if (typeof boardData === 'string') {
                                boardData = JSON.parse(boardData);
                            }
                            
                            lastRemoteUpdate = message.timestamp || Date.now();
                            
                        // –°–¢–†–û–ì–ê–Ø –≤–∞–ª–∏–¥–∞—Ü–∏—è elements –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º
                        let elements = boardData.elements;
                        if (!Array.isArray(elements)) {
                            console.warn('‚ö†Ô∏è boardData.elements is not an array in loadBoardState, converting...');
                            if (typeof elements === 'string') {
                                try {
                                    elements = JSON.parse(elements);
                                } catch (e) {
                                    console.error('‚ùå Failed to parse elements string in loadBoardState:', e);
                                    elements = [];
                                }
                            } else if (elements && typeof elements === 'object') {
                                if (elements.elements && Array.isArray(elements.elements)) {
                                    elements = elements.elements;
                                } else {
                                    elements = Object.values(elements);
                                }
                            } else {
                                elements = [];
                            }
                        }
                        
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                        if (!Array.isArray(elements)) {
                            console.error('‚ùå Elements is still not an array after conversion in loadBoardState, using empty array');
                            elements = [];
                        }
                        
                        // –í–∞–ª–∏–¥–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
                        const validElements = validateAndCleanElements(elements);
                        
                        // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º files –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
                        let filesForUpdate;
                        if (boardData.files instanceof Map) {
                            filesForUpdate = boardData.files.size > 0 ? Object.fromEntries(boardData.files) : undefined;
                        } else if (typeof boardData.files === 'object' && boardData.files !== null) {
                            filesForUpdate = Object.keys(boardData.files).length > 0 ? boardData.files : undefined;
                        } else {
                            filesForUpdate = undefined;
                        }
                        
                        // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
                        if (!Array.isArray(validElements)) {
                            console.error('‚ùå Final validation failed in loadBoardState: validElements is not an array');
                            return;
                        }
                        
                        const success = safeUpdateScene(
                            excalidrawAPI,
                            validElements,
                            boardData.appState || {},
                            filesForUpdate
                        );
                        
                        if (!success) {
                            console.error('‚ùå Failed to load board state');
                        } else {
                            showToast('–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —Å —Å–µ—Ä–≤–µ—Ä–∞', 'success');
                        }
                    } catch (error) {
                        console.error('‚ùå Error loading board state:', error);
                        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ—Å–∫–∏', 'error');
                    } finally {
                        setTimeout(() => {
                            isApplyingRemoteUpdate = false;
                        }, 50);
                    }
                    }
                    break;
                    
                case 'user_joined':
                    showToast(`${message.userName} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –¥–æ—Å–∫–µ`, 'info');
                    break;
                    
                case 'user_left':
                    showToast(`${message.userName} –ø–æ–∫–∏–Ω—É–ª –¥–æ—Å–∫—É`, 'info');
                    break;
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
        function handleUsersMessage(message) {
            if (message.type === 'users_update') {
                connectedUsers.clear();
                message.users.forEach(user => {
                    connectedUsers.set(user.userId, user);
                });
                updateUsersDisplay();
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function updateUsersDisplay() {
            const usersOnline = document.getElementById('usersOnline');
            const usersList = document.getElementById('usersList');
            
            if (connectedUsers.size > 1) {
                const users = Array.from(connectedUsers.values())
                    .filter(user => user.userId !== collaborationState.userId)
                    .map(user => {
                        const initial = user.userName.charAt(0).toUpperCase();
                        return `<span class="user-avatar" title="${user.userName}">${initial}</span>`;
                    })
                    .join('');
                
                usersList.innerHTML = users;
                usersOnline.style.display = 'block';
            } else {
                usersOnline.style.display = 'none';
            }
        }
        
        // –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function updateConnectionStatus(status) {
            const indicator = document.getElementById('statusIndicator');
            if (!indicator) return;
            
            indicator.className = 'status-indicator';
            
            switch (status) {
                case 'connected':
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                    let qualityIcon = '‚úÖ';
                    let qualityText = '–û—Ç–ª–∏—á–Ω–æ';
                    
                    if (connectionQuality === 'poor') {
                        qualityIcon = '‚ö†Ô∏è';
                        qualityText = '–ü–ª–æ—Ö–æ–µ';
                        indicator.classList.add('status-warning');
                    } else if (connectionQuality === 'fair') {
                        qualityIcon = 'üü°';
                        qualityText = '–°—Ä–µ–¥–Ω–µ–µ';
                        indicator.classList.add('status-fair');
                    } else {
                    indicator.classList.add('status-connected');
                    }
                    
                    indicator.innerHTML = `${qualityIcon} ${qualityText}`;
                    indicator.title = `–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ: ${qualityText}. Pending: ${pendingUpdates.size}`;
                    break;
                    
                case 'disconnected':
                    indicator.classList.add('status-disconnected');
                    indicator.innerHTML = '‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ';
                    indicator.title = '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
                    break;
                    
                case 'connecting':
                    indicator.classList.add('status-connecting', 'pulse');
                    indicator.innerHTML = 'üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                    indicator.title = `–ü–æ–ø—ã—Ç–∫–∞ ${reconnectAttempts}/${maxReconnectAttempts}`;
                    break;
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ—Å–∫–∏
        async function saveBoard() {
            console.log('üíæ saveBoard called');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º API –±–æ–ª–µ–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ
            const api = excalidrawAPI || window.excalidrawAPI || getState('excalidrawAPI');
            console.log('üíæ API check:', { excalidrawAPI: !!excalidrawAPI, windowAPI: !!window.excalidrawAPI, stateAPI: !!getState('excalidrawAPI') });
            
            if (!api) {
                console.warn('‚ö†Ô∏è Excalidraw API not available');
                showToast('–î–æ—Å–∫–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'error');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ API –∏–º–µ–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–µ—Ç–æ–¥—ã
            const hasMethods = {
                getSceneElements: !!api.getSceneElements,
                getAppState: !!api.getAppState,
                getFiles: !!api.getFiles
            };
            console.log('üíæ API methods check:', hasMethods);
            
            if (!api.getSceneElements || !api.getAppState || !api.getFiles) {
                console.warn('‚ö†Ô∏è Excalidraw API methods not available');
                showToast('API –¥–æ—Å–∫–∏ –Ω–µ –≥–æ—Ç–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'error');
                return;
            }
            
            try {
                // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç readonly
                let elements, appState, files;
                
                try {
                    elements = api.getSceneElements();
                    appState = api.getAppState();
                    files = api.getFiles();
                    console.log('üíæ Retrieved data:', { 
                        elementsCount: elements ? elements.length : 0, 
                        hasAppState: !!appState, 
                        hasFiles: !!files 
                    });
                } catch (e) {
                    console.warn('‚ö†Ô∏è API access warning:', e);
                    // Fallback –∫ –ø—É—Å—Ç—ã–º –¥–∞–Ω–Ω—ã–º
                    elements = [];
                    appState = {};
                    files = {};
                }
                
                // –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                const safeElements = JSON.parse(JSON.stringify(elements || []));
                const safeAppState = JSON.parse(JSON.stringify(appState || {}));
                const safeFiles = JSON.parse(JSON.stringify(files || {}));
                
                if (lessonId === 'demo') {
                    saveBoardToLocalStorage(safeElements, safeAppState, safeFiles);
                    showToast('–î–æ—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ', 'success');
                } else {
                    await saveBoardToServer(safeElements, safeAppState, safeFiles);
                    showToast('–î–æ—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ', 'success');
                }
                
            } catch (error) {
                console.error('‚ùå Save error:', error);
                showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
        function saveBoardToLocalStorage(elements, appState, files) {
            const boardData = {
                elements: elements,
                appState: appState,
                files: files,
                timestamp: Date.now()
            };
            
            localStorage.setItem(`excalidraw_${lessonId}`, JSON.stringify(boardData));
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function saveBoardToServer(elements, appState, files) {
            const boardData = {
                elements: elements,
                appState: appState,
                files: files
            };
            
            const response = await fetch('/api/excalidraw/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json',
                    'Cache-Control': 'no-cache'
                },
                credentials: 'same-origin', // –í–∞–∂–Ω–æ –¥–ª—è CORS
                body: JSON.stringify({
                    lessonId: lessonId.toString(), // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                    content: JSON.stringify(boardData)
                })
            });
            
            if (!response.ok) {
                throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –¥–æ—Å–∫–∏
        async function loadSavedBoard() {
            console.log('üìã loadSavedBoard called');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º API –±–æ–ª–µ–µ —Ç—â–∞—Ç–µ–ª—å–Ω–æ
            const api = excalidrawAPI || window.excalidrawAPI || getState('excalidrawAPI');
            console.log('üìã API check in loadSavedBoard:', { excalidrawAPI: !!excalidrawAPI, windowAPI: !!window.excalidrawAPI, stateAPI: !!getState('excalidrawAPI') });
            
            if (!api) {
                console.log('‚è≥ Excalidraw API not ready yet, will retry later');
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–ª–∞–≥ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
                setState('needsBoardLoad', true);
                return;
            }
            
            try {
                let boardData = null;
                let loadedFromBackup = false;
                
                if (lessonId === 'demo') {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage –¥–ª—è –¥–µ–º–æ
                    const saved = localStorage.getItem(`excalidraw_${lessonId}`);
                    if (saved) {
                        boardData = JSON.parse(saved);
                        console.log('üìã Loaded demo board from localStorage');
                    }
                } else {
                    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞
                    console.log('üìã Loading board state from server for lesson:', lessonId);
                    
                    try {
                        const response = await fetch(`/api/excalidraw/load/${lessonId}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log('üìã Server response:', result);
                            
                            if (result.success && result.content) {
                                try {
                                    // –ü–∞—Ä—Å–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –µ—Å–ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
                                    if (typeof result.content === 'string') {
                                        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –æ–±—ã—á–Ω—ã–π JSON –ø–∞—Ä—Å–∏–Ω–≥
                                        try {
                                            boardData = JSON.parse(result.content);
                                        } catch (jsonError) {
                                            // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è, –ø—Ä–æ–±—É–µ–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å Java toString –≤ JSON
                                            console.log('üîß Converting Java toString format to JSON...');
                                            boardData = parseJavaToStringToJSON(result.content);
                                        }
                                    } else {
                                        boardData = result.content;
                                    }
                                    console.log('üìã Parsed board data:', boardData);
                                    
                                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
                                    if (boardData && typeof boardData === 'object') {
                                        console.log('üîç Board data structure check:');
                                        console.log('  - elements type:', typeof boardData.elements, 'isArray:', Array.isArray(boardData.elements), 'length:', boardData.elements?.length);
                                        console.log('  - appState type:', typeof boardData.appState);
                                        console.log('  - files type:', typeof boardData.files);
                                        
                                        // –ï—Å–ª–∏ elements –Ω–µ –º–∞—Å—Å–∏–≤, –∏—Å–ø—Ä–∞–≤–ª—è–µ–º —ç—Ç–æ
                                        if (boardData.elements && !Array.isArray(boardData.elements)) {
                                            console.warn('‚ö†Ô∏è Elements is not an array, converting...');
                                            if (typeof boardData.elements === 'string') {
                                                try {
                                                    boardData.elements = JSON.parse(boardData.elements);
                                                } catch (e) {
                                                    console.error('‚ùå Failed to parse elements string:', e);
                                                    boardData.elements = [];
                                                }
                                            } else {
                                                boardData.elements = [];
                                            }
                                        }
                                    }
                                } catch (parseError) {
                                    console.error('‚ùå Error parsing board content:', parseError);
                                    console.log('Raw content:', result.content);
                                    // –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø—Ä–æ–±—É–µ–º backup
                                    boardData = null;
                                }
                            } else {
                                console.log('üìã No saved board state found on server for lesson:', lessonId);
                            }
                        } else {
                            console.warn('‚ö†Ô∏è Failed to load board state from server:', response.status);
                        }
                    } catch (serverError) {
                        console.error('‚ùå Server loading error:', serverError);
                    }
                    
                    // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞, –ø—Ä–æ–±—É–µ–º backup –∏–∑ localStorage
                    if (!boardData || !boardData.elements) {
                        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∞–≤–∞—Ä–∏–π–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                        const emergency = localStorage.getItem(`excalidraw_emergency_${lessonId}`);
                        if (emergency) {
                            try {
                                const emergencyData = JSON.parse(emergency);
                                if (emergencyData.elements && emergencyData.elements.length > 0) {
                                    boardData = emergencyData;
                                    loadedFromBackup = true;
                                    console.log('üìã Loaded board state from emergency backup');
                                    // –£–¥–∞–ª—è–µ–º –∞–≤–∞—Ä–∏–π–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                                    localStorage.removeItem(`excalidraw_emergency_${lessonId}`);
                                }
                            } catch (emergencyError) {
                                console.error('‚ùå Emergency backup loading error:', emergencyError);
                            }
                        }
                        
                        // –ï—Å–ª–∏ –∞–≤–∞—Ä–∏–π–Ω–æ–≥–æ –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º –æ–±—ã—á–Ω—ã–π backup
                        if (!boardData || !boardData.elements) {
                            const backup = localStorage.getItem(`excalidraw_backup_${lessonId}`);
                            if (backup) {
                                try {
                                    const backupData = JSON.parse(backup);
                                    if (backupData.elements && backupData.elements.length > 0) {
                                        // –í–∞–ª–∏–¥–∏—Ä—É–µ–º backup –¥–∞–Ω–Ω—ã–µ
                                        const validElements = validateAndCleanElements(backupData.elements);
                                        if (validElements.length > 0) {
                                            boardData = {
                                                elements: validElements,
                                                appState: validateAndCleanAppState(backupData.appState),
                                                files: validateAndCleanFiles(backupData.files)
                                            };
                                            loadedFromBackup = true;
                                            console.log('üìã Loaded board state from localStorage backup');
                                        }
                                    }
                                } catch (backupError) {
                                    console.error('‚ùå Backup loading error:', backupError);
                                }
                            }
                        }
                    }
                }
                
                if (boardData && boardData.elements) {
                    console.log('‚úÖ Applying board state with', boardData.elements.length, 'elements');
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
                    try {
                        // –í–∞–ª–∏–¥–∏—Ä—É–µ–º –∏ –æ—á–∏—â–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
                        const validElements = validateAndCleanElements(boardData.elements);
                        const validAppState = validateAndCleanAppState(boardData.appState);
                        const validFiles = validateAndCleanFiles(boardData.files);
                        
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
                        console.log('üîç Validating data before updateScene:');
                        console.log('  - validElements type:', typeof validElements, 'isArray:', Array.isArray(validElements), 'length:', validElements?.length);
                        console.log('  - validAppState type:', typeof validAppState);
                        console.log('  - validFiles type:', typeof validFiles);
                        
                        // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ elements —ç—Ç–æ –º–∞—Å—Å–∏–≤
                        if (!Array.isArray(validElements)) {
                            console.error('‚ùå validElements is not an array:', validElements);
                            throw new Error('Elements must be an array');
                        }
                        
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π API
                        const currentAPI = excalidrawAPI || window.excalidrawAPI || getState('excalidrawAPI');
                        if (!currentAPI) {
                            console.warn('‚ö†Ô∏è API not available for applying board state');
                            return;
                        }
                        
                        // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: Excalidraw –æ–∂–∏–¥–∞–µ—Ç Map
                        let filesForUpdate;
                        if (validFiles instanceof Map) {
                            filesForUpdate = validFiles.size > 0 ? validFiles : undefined;
                        } else if (typeof validFiles === 'object' && validFiles !== null) {
                            filesForUpdate = Object.keys(validFiles).length > 0 ? new Map(Object.entries(validFiles)) : undefined;
                        } else {
                            filesForUpdate = undefined;
                        }
                        
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
                        console.log('üîç Final data validation before updateScene:');
                        console.log('  - elements:', Array.isArray(validElements) ? `Array(${validElements.length})` : typeof validElements);
                        console.log('  - appState:', typeof validAppState);
                        console.log('  - files:', filesForUpdate instanceof Map ? `Map(${filesForUpdate.size})` : 'undefined');
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ files –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø
                        if (filesForUpdate !== undefined && filesForUpdate !== null && !(filesForUpdate instanceof Map)) {
                            console.error('‚ùå filesForUpdate has invalid type:', typeof filesForUpdate);
                            throw new Error('Files must be undefined or Map');
                        }
                        
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º safeUpdateScene –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞—â–∏—Ç—ã
                        // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º files –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è safeUpdateScene
                        let filesForSafeUpdate;
                        if (filesForUpdate instanceof Map) {
                            filesForSafeUpdate = filesForUpdate;
                        } else if (filesForUpdate && typeof filesForUpdate === 'object') {
                            filesForSafeUpdate = new Map(Object.entries(filesForUpdate));
                        } else {
                            filesForSafeUpdate = undefined;
                        }
                        
                        const success = safeUpdateScene(
                            currentAPI,
                            validElements,
                            validAppState,
                            filesForSafeUpdate
                        );
                        
                        if (!success) {
                            throw new Error('Failed to update scene safely');
                        }
                        
                        const message = loadedFromBackup ? 
                            '–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏' : 
                            '–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ';
                        showToast(message, loadedFromBackup ? 'warning' : 'success');
                        console.log('‚úÖ Board state loaded successfully');
                        
                        // –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∏–ª–∏ –∏–∑ backup, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                        if (loadedFromBackup) {
                            setTimeout(() => {
                                saveBoardState();
                                showToast('–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä', 'info');
                            }, 1000);
                        }
                        
                    } catch (applyError) {
                        console.error('‚ùå Error applying board state:', applyError);
                        showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ—Å–∫–∏', 'error');
                    }
                } else {
                    console.log('üìã No board data to load, initializing empty board');
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç—É—é –¥–æ—Å–∫—É
                    const currentAPI = excalidrawAPI || window.excalidrawAPI || getState('excalidrawAPI');
                    if (currentAPI) {
                        const success = safeUpdateScene(
                            currentAPI, 
                            [], 
                            { viewBackgroundColor: "#ffffff" }, 
                            new Map()
                        );
                        if (!success) {
                            console.error('‚ùå Failed to initialize empty board');
                        }
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ backup –¥–∞–Ω–Ω—ã–µ
                    const backup = localStorage.getItem(`excalidraw_backup_${lessonId}`);
                    if (backup) {
                        try {
                            const backupData = JSON.parse(backup);
                            if (backupData.elements && backupData.elements.length > 0) {
                                console.log('üìã Found backup data, loading...');
                                const validElements = validateAndCleanElements(backupData.elements);
                                const validAppState = validateAndCleanAppState(backupData.appState);
                                const validFiles = validateAndCleanFiles(backupData.files);
                                
                                // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º files –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
                                let filesForUpdate;
                                if (validFiles instanceof Map) {
                                    filesForUpdate = validFiles.size > 0 ? Object.fromEntries(validFiles) : undefined;
                                } else if (typeof validFiles === 'object' && validFiles !== null) {
                                    filesForUpdate = Object.keys(validFiles).length > 0 ? validFiles : undefined;
                                } else {
                                    filesForUpdate = undefined;
                                }
                                
                                excalidrawAPI.updateScene({
                                    elements: validElements,
                                    appState: validAppState,
                                    files: filesForUpdate
                                });
                                
                                showToast('–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏', 'info');
                            }
                        } catch (backupError) {
                            console.error('‚ùå Backup loading error:', backupError);
                        }
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Load error:', error);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ—Å–∫–∏: ' + error.message, 'error');
            }
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç –¥–æ—Å–∫–∏
        async function exportBoard() {
            if (!excalidrawAPI) {
                showToast('–î–æ—Å–∫–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞', 'error');
                return;
            }
            
            try {
                // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
                let elements, appState, files;
                
                try {
                    elements = excalidrawAPI.getSceneElements();
                    appState = excalidrawAPI.getAppState();
                    files = excalidrawAPI.getFiles();
                } catch (e) {
                    console.warn('‚ö†Ô∏è API access warning:', e);
                    elements = [];
                    appState = {};
                    files = {};
                }
                
                // –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ Excalidraw
                const ExcalidrawLib = window.ExcalidrawLib || window.Excalidraw;
                let exportToCanvas = null;
                
                // –ò—â–µ–º —Ñ—É–Ω–∫—Ü–∏—é —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö (ESM –∏ UMD —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
                if (ExcalidrawLib?.default?.exportToCanvas) {
                    exportToCanvas = ExcalidrawLib.default.exportToCanvas;
                } else if (ExcalidrawLib?.exportToCanvas) {
                    exportToCanvas = ExcalidrawLib.exportToCanvas;
                } else if (window.Excalidraw?.exportToCanvas) {
                    exportToCanvas = window.Excalidraw.exportToCanvas;
                } else if (window.exportToCanvas) {
                    exportToCanvas = window.exportToCanvas;
                }
                
                if (exportToCanvas) {
                    try {
                        const canvas = await exportToCanvas({
                            elements: elements || [],
                            appState: appState || {},
                            files: files || {},
                            getDimensions: () => ({ width: 1920, height: 1080 })
                        });
                        
                        // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                        const link = document.createElement('a');
                        link.download = `brainify_board_${lessonId}_${new Date().toISOString().slice(0, 10)}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                        
                        showToast('–î–æ—Å–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞', 'success');
                    } catch (exportError) {
                        console.error('‚ùå Excalidraw export error:', exportError);
                        fallbackExport();
                    }
                } else {
                    console.warn('‚ö†Ô∏è exportToCanvas function not found, using fallback');
                    fallbackExport();
                }
                
            } catch (error) {
                console.error('‚ùå Export error:', error);
                showToast('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + error.message, 'error');
            }
        }
        
        // Fallback —ç–∫—Å–ø–æ—Ä—Ç –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ canvas
        function fallbackExport() {
            if (excalidrawAPI && excalidrawAPI.canvas) {
                // –ü—Ä–æ—Å—Ç–æ–π —ç–∫—Å–ø–æ—Ä—Ç canvas
                const link = document.createElement('a');
                link.download = `brainify_canvas_${lessonId}_${new Date().toISOString().slice(0, 10)}.png`;
                link.href = excalidrawAPI.canvas.toDataURL();
                link.click();
                showToast('–î–æ—Å–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ (–ø—Ä–æ—Å—Ç–æ–π —Ä–µ–∂–∏–º)', 'success');
            } else {
                showToast('–≠–∫—Å–ø–æ—Ä—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'warning');
            }
        }
        
        // –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –¥–æ—Å–∫–æ–π
        function shareBoard() {
            const url = window.location.href;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Brainify Board',
                    text: '–°–æ–≤–º–µ—Å—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –Ω–∞ –¥–æ—Å–∫–µ',
                    url: url
                });
            } else {
                // Fallback: –∫–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
                navigator.clipboard.writeText(url).then(() => {
                    showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
                }).catch(() => {
                    showToast('–°—Å—ã–ª–∫–∞: ' + url, 'info');
                });
            }
        }
        
        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —É—Ä–æ–∫–∞
        async function endLesson() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫?')) {
                return;
            }
            
            try {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–æ—Å–∫—É –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º
                await saveBoard();
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —É—Ä–æ–∫–∞
                const response = await fetch(`/api/lessons/${lessonId}/end`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        saveBoard: true,
                        lessonNotes: ''
                    })
                });
                
                if (response.ok) {
                    showToast('–£—Ä–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω', 'success');
                    
                    // –û—Ç–∫–ª—é—á–∞–µ–º—Å—è –æ—Ç WebSocket
                    if (stompClient && isConnected) {
                        stompClient.send(`/app/excalidraw/${lessonId}/leave`, {}, JSON.stringify({
                            lessonId: lessonId,
                            userId: collaborationState.userId,
                            userName: collaborationState.userName
                        }));
                        stompClient.disconnect();
                    }
                    
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 1500);
                } else {
                    showToast('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–∫–∞', 'error');
                }
                
            } catch (error) {
                console.error('‚ùå End lesson error:', error);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–∫–∞: ' + error.message, 'error');
            }
        }
        
        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.addEventListener('DOMContentLoaded', () => {
            // –ö–Ω–æ–ø–∫–∏
            document.getElementById('saveBtn').addEventListener('click', (e) => {
                console.log('üíæ Save button clicked');
                e.preventDefault();
                saveBoard();
            });
            document.getElementById('exportBtn').addEventListener('click', exportBoard);
            document.getElementById('shareBtn').addEventListener('click', shareBoard);
            document.getElementById('endLessonBtn').addEventListener('click', endLesson);
            
            // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 's':
                            e.preventDefault();
                            saveBoard();
                            break;
                        case 'e':
                            e.preventDefault();
                            exportBoard();
                            break;
                    }
                }
            });
            
        });
        
        // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫
        function checkLibrariesLoaded() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 100; // 10 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º
                
                const check = () => {
                    attempts++;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ DOM –≥–æ—Ç–æ–≤ –∏ –±–∞–∑–æ–≤—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
                    const domReady = document.getElementById('excalidraw-container');
                    const sockJSReady = typeof SockJS !== 'undefined';
                    const stompReady = typeof Stomp !== 'undefined';
                    
                    if (domReady && sockJSReady && stompReady) {
                        console.log('‚úÖ DOM and basic libraries ready');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error(`–ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –Ω–µ –≥–æ—Ç–æ–≤—ã. DOM: ${!!domReady}, SockJS: ${sockJSReady}, Stomp: ${stompReady}`));
                    } else {
                        setTimeout(check, 100);
                    }
                };
                
                check();
            });
        }
        
        // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
        function checkLibraryStatus() {
            const excalidrawLib = window.ExcalidrawLib;
            const excalidrawGlobal = window.Excalidraw;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º JSX runtime
            const reactHasJSX = !!(window.React && (window.React.jsx || window.React.jsxs));
            
            return {
                react: !!window.React,
                reactDOM: !!window.ReactDOM,
                reactJSX: reactHasJSX,
                excalidraw: !!(excalidrawLib || excalidrawGlobal),
                excalidrawComponent: !!(
                    excalidrawLib?.default?.Excalidraw ||
                    excalidrawLib?.Excalidraw ||
                    excalidrawGlobal?.Excalidraw ||
                    (typeof excalidrawGlobal === 'function') ||
                    excalidrawGlobal // –í –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–ø—Ä—è–º—É—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
                ),
                sockJS: !!window.SockJS,
                stomp: !!window.Stomp
            };
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
        window.addEventListener('load', async () => {
            try {
                console.log('üîÑ Waiting for libraries to load...');
                updateLoadingStatus('–û–∂–∏–¥–∞–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫...', '–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤');
                
                await checkLibrariesLoaded();
                
                const status = checkLibraryStatus();
                console.log('üìö Library status:', status);
                
                if (!status.react || !status.reactDOM) {
                    throw new Error('React –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                }
                
                console.log('üìö Libraries loaded, initializing UI...');
                initializeUI();
                
                // –î–∞–µ–º –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ Excalidraw (React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)
                setTimeout(() => {
                    console.log('üé® Starting Excalidraw initialization...');
                    console.log('Available Excalidraw:', {
                        ExcalidrawLib: !!window.ExcalidrawLib,
                        Excalidraw: !!window.Excalidraw,
                        globalExcalidraw: typeof window.Excalidraw
                    });
                    initializeExcalidraw();
                }, 1000); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–æ 1 —Å–µ–∫—É–Ω–¥—ã
                
            } catch (error) {
                console.error('‚ùå Library loading error:', error);
                const status = checkLibraryStatus();
                console.log('Final library status:', status);
                
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫: ' + error.message, 'error');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                const container = document.getElementById('excalidraw-container');
                container.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; background: #f8f9fa; color: #6c757d;">
                        <h2>‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å–∫–∏</h2>
                        <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏.</p>
                        <p style="font-size: 12px; margin-top: 10px;">${error.message}</p>
                        <div style="font-size: 10px; margin-top: 10px; padding: 10px; background: #e9ecef; border-radius: 4px;">
                            React: ${status.react ? '‚úÖ' : '‚ùå'} | 
                            ReactDOM: ${status.reactDOM ? '‚úÖ' : '‚ùå'} | 
                            ReactJSX: ${status.reactJSX ? '‚úÖ' : '‚ùå'} | 
                            Excalidraw: ${status.excalidraw ? '‚úÖ' : '‚ùå'} | 
                            ExcalidrawComponent: ${status.excalidrawComponent ? '‚úÖ' : '‚ùå'} | 
                            SockJS: ${status.sockJS ? '‚úÖ' : '‚ùå'} | 
                            Stomp: ${status.stomp ? '‚úÖ' : '‚ùå'}
                        </div>
                        <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 20px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
                        <button onclick="initializeFallbackCanvas()" class="btn" style="margin-top: 10px;">üîß –ü—Ä–æ—Å—Ç–∞—è –¥–æ—Å–∫–∞</button>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
