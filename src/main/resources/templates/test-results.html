<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Результаты теста - Brainify</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/test-results.css}">
    <link rel="stylesheet" th:href="@{/css/animations.css}">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-container">
                <div class="nav-logo">
                    <span class="nav-logo-green">Brain</span>ify
                </div>
                <div class="nav-menu">
                    <a href="/" class="nav-link">Главная</a>
                    <a href="/trainers" class="nav-link">Тренажёры</a>
                    <a href="/test" class="nav-link">Тесты</a>
                </div>
                
                <!-- Верхние кнопки -->
                <div class="nav-buttons">
                    <!-- Кнопки для неавторизованных пользователей -->
                    <div th:if="${!isAuthenticated}">
                        <button class="nav-btn nav-btn-login">ВОЙТИ</button>
                        <button class="nav-btn nav-btn-register">РЕГИСТРАЦИЯ</button>
                        <button class="nav-btn nav-btn-free free-lesson-btn">БЕСПЛАТНЫЙ УРОК</button>
                    </div>
                    
                    <!-- Кнопки для авторизованных пользователей -->
                    <div th:if="${isAuthenticated}">
                        <span class="user-welcome" th:text="'Привет, ' + ${currentUser.name} + '!'">Привет, Пользователь!</span>
                        <button class="nav-btn nav-btn-dashboard" th:data-role="${currentUser.role.name()}">КАБИНЕТ</button>
                        <button class="nav-btn nav-btn-logout">ВЫЙТИ</button>
                    </div>
                </div>
                
                <button class="mobile-menu-btn">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
            <div class="mobile-menu hidden">
                <ul>
                    <li><a href="/">Главная</a></li>
                    <li><a href="/trainers">Тренажёры</a></li>
                    <li><a href="/test">Тесты</a></li>
                </ul>
                <!-- Кнопки в мобильном меню -->
                <div class="mobile-nav-buttons">
                    <!-- Кнопки для неавторизованных пользователей -->
                    <div th:if="${!isAuthenticated}">
                        <button class="nav-btn nav-btn-login">ВОЙТИ</button>
                        <button class="nav-btn nav-btn-register">РЕГИСТРАЦИЯ</button>
                        <button class="nav-btn nav-btn-free free-lesson-btn">БЕСПЛАТНЫЙ УРОК</button>
                    </div>
                    
                    <!-- Кнопки для авторизованных пользователей -->
                    <div th:if="${isAuthenticated}">
                        <span class="user-welcome mobile-welcome" th:text="'Привет, ' + ${currentUser.name} + '!'">Привет, Пользователь!</span>
                        <button class="nav-btn nav-btn-dashboard" th:data-role="${currentUser.role.name()}">КАБИНЕТ</button>
                        <button class="nav-btn nav-btn-logout">ВЫЙТИ</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Results Header -->
    <section class="results-header">
        <div class="container">
            <div class="results-info">
                <h1 class="results-title">Результаты теста</h1>
                <p class="results-subtitle" th:text="${testSession.subject.name} + ' (' + ${testSession.examType.toUpperCase()} + ')'">Предмет (ОГЭ)</p>
            </div>
        </div>
    </section>

    <!-- Results Summary -->
    <section class="results-summary">
        <div class="container">
            <div class="summary-cards">
                <div class="summary-card correct">
                    <div class="card-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-value" th:text="${testSession.correctAnswers}">0</div>
                        <div class="card-label">Правильных ответов</div>
                    </div>
                </div>
                
                <div class="summary-card total">
                    <div class="card-icon">
                        <i class="fas fa-list-ol"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-value" th:text="${testSession.totalQuestions}">0</div>
                        <div class="card-label">Всего вопросов</div>
                    </div>
                </div>
                
                <div class="summary-card percentage">
                    <div class="card-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-value" th:text="${#numbers.formatDecimal(testSession.scorePercentage, 1, 1)} + '%'">0%</div>
                        <div class="card-label">Процент правильных</div>
                    </div>
                </div>
            </div>

            
        </div>
    </section>

    <!-- Filter & Answers Section -->
    <section class="answers-section">
        <div class="container">
            <h2 class="section-title">Разбор заданий</h2>
            
            <!-- Фильтры -->
            <div class="filter-tabs">
                <button class="filter-tab active" data-filter="all">
                    <i class="fas fa-list"></i>
                    Все <span class="filter-count" th:text="${#lists.size(answers)}">0</span>
                </button>
                <button class="filter-tab" data-filter="correct">
                    <i class="fas fa-check-circle"></i>
                    Правильные <span class="filter-count" th:text="${testSession.correctAnswers}">0</span>
                </button>
                <button class="filter-tab" data-filter="incorrect">
                    <i class="fas fa-times-circle"></i>
                    Неправильные <span class="filter-count" th:text="${testSession.totalQuestions - testSession.correctAnswers}">0</span>
                </button>
            </div>
            
            <!-- Список заданий -->
            <div class="answers-list" id="answersList">
                <div th:each="answer, iterStat : ${answers}" 
                     class="answer-card"
                     th:classappend="${answer.isCorrect} ? ' answer-correct' : ' answer-incorrect'"
                     th:data-status="${answer.isCorrect} ? 'correct' : 'incorrect'">
                    
                    <!-- Шапка карточки (всегда видна) -->
                    <div class="answer-card-header" onclick="toggleSolution(this)">
                        <div class="answer-card-left">
                            <div class="answer-number" th:text="${iterStat.index + 1}">1</div>
                            <div class="answer-status-icon" th:classappend="${answer.isCorrect} ? ' status-ok' : ' status-fail'">
                                <i th:if="${answer.isCorrect}" class="fas fa-check"></i>
                                <i th:unless="${answer.isCorrect}" class="fas fa-times"></i>
                            </div>
                            <div class="answer-summary">
                                <div class="answer-question-preview" th:text="${#strings.abbreviate(answer.task.question, 120)}">Текст задания...</div>
                                <div class="answer-meta">
                                    <span class="meta-item">
                                        <i class="fas fa-pen"></i>
                                        Ваш ответ: <strong th:text="${answer.userAnswer != null and answer.userAnswer != '' ? answer.userAnswer : 'Не отвечено'}">—</strong>
                                    </span>
                                    <span class="meta-separator">|</span>
                                    <span class="meta-item correct-answer-hint">
                                        <i class="fas fa-check-double"></i>
                                        Ответ: <strong th:text="${answer.task.answer}">—</strong>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="answer-card-right">
                            <span class="toggle-solution-label">Подробнее</span>
                            <i class="fas fa-chevron-down toggle-icon"></i>
                        </div>
                    </div>
                    
                    <!-- Развёрнутый контент (скрыт по умолчанию) -->
                    <div class="answer-card-body" style="display:none;">
                        <!-- Задание -->
                        <div class="solution-block solution-question">
                            <h4><i class="fas fa-file-alt"></i> Задание</h4>
                            <p th:text="${answer.task.question}">Текст задания</p>
                            <!-- Изображение задания -->
                            <div th:if="${answer.task.imageData != null}" class="solution-image">
                                <img th:src="@{'/api/tasks/' + ${answer.task.id} + '/image'}" alt="Изображение к заданию" loading="lazy">
                            </div>
                        </div>
                        
                        <!-- Ваш ответ -->
                        <div class="solution-block solution-user-answer" th:classappend="${answer.isCorrect} ? ' user-answer-correct' : ' user-answer-incorrect'">
                            <h4><i class="fas fa-user"></i> Ваш ответ</h4>
                            <p th:if="${answer.userAnswer != null and answer.userAnswer != ''}" th:text="${answer.userAnswer}">Ваш ответ</p>
                            <p th:if="${answer.userAnswer == null or answer.userAnswer == ''}" class="no-answer">Не отвечено</p>
                        </div>
                        
                        <!-- Правильный ответ -->
                        <div class="solution-block solution-correct-answer">
                            <h4><i class="fas fa-check-circle"></i> Правильный ответ</h4>
                            <p th:text="${answer.task.answer}">Правильный ответ</p>
                        </div>
                        
                        <!-- Решение (если есть) -->
                        <div th:if="${answer.task.solution != null and answer.task.solution != ''}" class="solution-block solution-explanation">
                            <h4><i class="fas fa-lightbulb"></i> Решение</h4>
                            <div class="solution-text" th:text="${answer.task.solution}">Подробное решение</div>
                        </div>
                        
                        <!-- Если решения нет -->
                        <div th:if="${answer.task.solution == null or answer.task.solution == ''}" class="solution-block solution-no-explanation">
                            <h4><i class="fas fa-info-circle"></i> Решение</h4>
                            <p class="no-solution-text">Решение для данного задания пока не добавлено.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Пустое состояние для фильтров -->
            <div class="empty-filter-state" id="emptyFilterState" style="display:none;">
                <i class="fas fa-search"></i>
                <p>Нет заданий, соответствующих выбранному фильтру</p>
            </div>
        </div>
    </section>

    <!-- Actions -->
    <section class="results-actions">
        <div class="container">
            <div class="actions-content">
                <a href="/test/random" class="btn btn-primary">
                    <i class="fas fa-random"></i>
                    Новый случайный тест
                </a>
                <a href="/test/specific" class="btn btn-secondary">
                    <i class="fas fa-list-ol"></i>
                    Тест по номеру
                </a>
                <a href="/test/marathon" class="btn btn-success">
                    <i class="fas fa-trophy"></i>
                    Марафон
                </a>
                <a th:if="${incorrectNumbers} and ${not #lists.isEmpty(incorrectNumbers)}" th:href="@{'/test/specific'(retry=${incorrectNumbers[0]})}" class="btn btn-warning">
                    Повторить номер №<span th:text="${incorrectNumbers[0]}">1</span>
                </a>
                <a href="/trainers" class="btn btn-outline">
                    <i class="fas fa-arrow-left"></i>
                    К тренажёрам
                </a>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <span class="footer-logo-green">Brain</span>ify
                </div>
                <p>© 2024 Brainify. Все права защищены.</p>
            </div>
        </div>
    </footer>

    <script th:src="@{/js/csrf.js}"></script>
    <script th:src="@{/js/main.js(v=2)}"></script>
    <script th:src="@{/js/test-results.js}"></script>
</body>
</html>

