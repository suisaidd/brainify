<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Управление тренажёрами - Админ панель</title>
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/admin-trainers.css">
</head>
<body>
    <div class="admin-container">
        <!-- Хедер -->
        <header class="admin-header">
            <div class="header-left">
                <a href="/admin" class="back-btn">
                    <i class="fas fa-arrow-left"></i>
                    Назад к панели
                </a>
                <h1>
                    <i class="fas fa-dumbbell"></i>
                    Управление тренажёрами
                </h1>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <span class="user-name" th:text="${currentUser?.name}">Администратор</span>
                    <span class="user-role" th:text="${currentUser?.role?.displayName}">Админ</span>
                </div>
                <a href="/" class="btn btn-outline">
                    <i class="fas fa-home"></i>
                    На главную
                </a>
                <button class="btn btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Выйти
                </button>
            </div>
        </header>

        <!-- Основной контент -->
        <main class="admin-main">
            <!-- Статистика -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon subject">
                        <i class="fas fa-book"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" th:text="${subjectsCount}">0</span>
                        <span class="stat-label">Предметов</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon task-number">
                        <i class="fas fa-list-ol"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" th:text="${taskNumbersCount}">0</span>
                        <span class="stat-label">Номеров заданий</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon subtopic">
                        <i class="fas fa-tags"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" th:text="${subtopicsCount}">0</span>
                        <span class="stat-label">Подтем</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon task">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <div class="stat-info">
                        <span class="stat-value" th:text="${tasksCount}">0</span>
                        <span class="stat-label">Заданий</span>
                    </div>
                </div>
            </div>

            <!-- Управление номерами заданий -->
            <div class="management-section">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-list-ol"></i>
                        Создать номер задания
                    </h2>
                </div>
                
                <div class="form-container">
                    <form id="taskNumberForm" class="admin-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="subjectSelect">Предмет:</label>
                                <select id="subjectSelect" name="subjectId" required>
                                    <option value="">Выберите предмет</option>
                                    <option th:each="subject : ${subjects}" 
                                            th:value="${subject.id}" 
                                            th:text="${subject.name}">Предмет</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="examTypeSelect">Тип экзамена:</label>
                                <select id="examTypeSelect" name="examType" required>
                                    <option value="">Выберите тип</option>
                                    <option value="OGE">ОГЭ</option>
                                    <option value="EGE">ЕГЭ</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="taskNumberName">Название:</label>
                                <input type="text" id="taskNumberName" name="name" placeholder="Например: Задание 1" required>
                            </div>
                            <div class="form-group">
                                <label for="taskNumberNumber">Номер:</label>
                                <input type="number" id="taskNumberNumber" name="number" min="1" max="99" placeholder="1" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            Создать номер задания
                        </button>
                    </form>
                </div>
            </div>

            <!-- Управление подтемами -->
            <div class="management-section">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-tags"></i>
                        Создать подтему
                    </h2>
                </div>
                
                <div class="form-container">
                    <form id="subtopicForm" class="admin-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="subtopicSubjectSelect">Предмет:</label>
                                <select id="subtopicSubjectSelect" name="subjectId" required>
                                    <option value="">Выберите предмет</option>
                                    <option th:each="subject : ${subjects}" 
                                            th:value="${subject.id}" 
                                            th:text="${subject.name}">Предмет</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="subtopicExamTypeSelect">Тип экзамена:</label>
                                <select id="subtopicExamTypeSelect" name="examType" required>
                                    <option value="">Выберите тип</option>
                                    <option value="OGE">ОГЭ</option>
                                    <option value="EGE">ЕГЭ</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="taskNumberSelect">Номер задания:</label>
                                <select id="taskNumberSelect" name="taskNumberId" required disabled>
                                    <option value="">Сначала выберите предмет и тип экзамена</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="sortOrder">Порядок сортировки:</label>
                                <input type="number" id="sortOrder" name="sortOrder" min="0" value="0">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="subtopicName">Название подтемы:</label>
                                <input type="text" id="subtopicName" name="name" placeholder="Например: Линейные уравнения" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="subtopicDescription">Описание:</label>
                                <textarea id="subtopicDescription" name="description" rows="3" placeholder="Описание подтемы (необязательно)"></textarea>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            Создать подтему
                        </button>
                    </form>
                </div>
            </div>

            <!-- Управление заданиями -->
            <div class="management-section">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-tasks"></i>
                        Создать задание
                    </h2>
                </div>
                
                <div class="form-container">
                    <form id="taskForm" class="admin-form" enctype="multipart/form-data">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="taskSubjectSelect">Предмет:</label>
                                <select id="taskSubjectSelect" name="subjectId" required>
                                    <option value="">Выберите предмет</option>
                                    <option th:each="subject : ${subjects}" 
                                            th:value="${subject.id}" 
                                            th:text="${subject.name}">Предмет</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="taskExamTypeSelect">Тип экзамена:</label>
                                <select id="taskExamTypeSelect" name="examType" required>
                                    <option value="">Выберите тип</option>
                                    <option value="OGE">ОГЭ</option>
                                    <option value="EGE">ЕГЭ</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="taskTaskNumberSelect">Номер задания:</label>
                                <select id="taskTaskNumberSelect" name="taskNumberId" required disabled>
                                    <option value="">Сначала выберите предмет и тип экзамена</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="subtopicSelect">Подтема:</label>
                                <select id="subtopicSelect" name="subtopicId" required disabled>
                                    <option value="">Сначала выберите номер задания</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="question">Текст задания:</label>
                                <textarea id="question" name="question" rows="4" placeholder="Введите текст задания" required></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="answer">Ответ:</label>
                                <input type="text" id="answer" name="answer" placeholder="Правильный ответ" required>
                            </div>
                            <div class="form-group">
                                <label for="difficultyLevel">Уровень сложности (1-5):</label>
                                <input type="number" id="difficultyLevel" name="difficultyLevel" min="1" max="5" value="1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="points">Баллы:</label>
                                <input type="number" id="points" name="points" min="1" value="1">
                            </div>
                            <div class="form-group">
                                <label for="image">Изображение (необязательно):</label>
                                <input type="file" id="image" name="image" accept="image/*">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="solution">Решение (необязательно):</label>
                                <textarea id="solution" name="solution" rows="3" placeholder="Подробное решение задания"></textarea>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            Создать задание
                        </button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initializeForms();
        });
        
        function initializeForms() {
            // Обработчики для формы номера задания
            document.getElementById('taskNumberForm').addEventListener('submit', handleTaskNumberSubmit);
            
            // Обработчики для формы подтемы
            document.getElementById('subtopicSubjectSelect').addEventListener('change', loadTaskNumbersForSubtopic);
            document.getElementById('subtopicExamTypeSelect').addEventListener('change', loadTaskNumbersForSubtopic);
            document.getElementById('subtopicForm').addEventListener('submit', handleSubtopicSubmit);
            
            // Обработчики для формы задания
            document.getElementById('taskSubjectSelect').addEventListener('change', loadTaskNumbersForTask);
            document.getElementById('taskExamTypeSelect').addEventListener('change', loadTaskNumbersForTask);
            document.getElementById('taskTaskNumberSelect').addEventListener('change', loadSubtopicsForTask);
            document.getElementById('taskForm').addEventListener('submit', handleTaskSubmit);
        }
        
        function handleTaskNumberSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            fetch('/admin/trainers/api/task-numbers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Номер задания успешно создан!', 'success');
                    e.target.reset();
                } else {
                    showNotification(data.error || 'Ошибка при создании номера задания', 'error');
                }
            })
            .catch(error => {
                showNotification('Ошибка при создании номера задания', 'error');
            });
        }
        
        function loadTaskNumbersForSubtopic() {
            const subjectId = document.getElementById('subtopicSubjectSelect').value;
            const examType = document.getElementById('subtopicExamTypeSelect').value;
            const taskNumberSelect = document.getElementById('taskNumberSelect');
            
            if (!subjectId || !examType) {
                taskNumberSelect.disabled = true;
                taskNumberSelect.innerHTML = '<option value="">Сначала выберите предмет и тип экзамена</option>';
                return;
            }
            
            fetch(`/admin/trainers/api/task-numbers?subjectId=${subjectId}&examType=${examType}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showNotification(data.error, 'error');
                        return;
                    }
                    
                    taskNumberSelect.innerHTML = '<option value="">Выберите номер задания</option>';
                    data.taskNumbers.forEach(tn => {
                        const option = document.createElement('option');
                        option.value = tn.id;
                        option.textContent = tn.name;
                        taskNumberSelect.appendChild(option);
                    });
                    taskNumberSelect.disabled = false;
                })
                .catch(error => {
                    showNotification('Ошибка при загрузке номеров заданий', 'error');
                });
        }
        
        function loadTaskNumbersForTask() {
            const subjectId = document.getElementById('taskSubjectSelect').value;
            const examType = document.getElementById('taskExamTypeSelect').value;
            const taskNumberSelect = document.getElementById('taskTaskNumberSelect');
            const subtopicSelect = document.getElementById('subtopicSelect');
            
            if (!subjectId || !examType) {
                taskNumberSelect.disabled = true;
                subtopicSelect.disabled = true;
                taskNumberSelect.innerHTML = '<option value="">Сначала выберите предмет и тип экзамена</option>';
                subtopicSelect.innerHTML = '<option value="">Сначала выберите номер задания</option>';
                return;
            }
            
            fetch(`/admin/trainers/api/task-numbers?subjectId=${subjectId}&examType=${examType}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showNotification(data.error, 'error');
                        return;
                    }
                    
                    taskNumberSelect.innerHTML = '<option value="">Выберите номер задания</option>';
                    data.taskNumbers.forEach(tn => {
                        const option = document.createElement('option');
                        option.value = tn.id;
                        option.textContent = tn.name;
                        taskNumberSelect.appendChild(option);
                    });
                    taskNumberSelect.disabled = false;
                })
                .catch(error => {
                    showNotification('Ошибка при загрузке номеров заданий', 'error');
                });
        }
        
        function loadSubtopicsForTask() {
            const taskNumberId = document.getElementById('taskTaskNumberSelect').value;
            const subtopicSelect = document.getElementById('subtopicSelect');
            
            if (!taskNumberId) {
                subtopicSelect.disabled = true;
                subtopicSelect.innerHTML = '<option value="">Сначала выберите номер задания</option>';
                return;
            }
            
            fetch(`/admin/trainers/api/subtopics?taskNumberId=${taskNumberId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showNotification(data.error, 'error');
                        return;
                    }
                    
                    subtopicSelect.innerHTML = '<option value="">Выберите подтему</option>';
                    data.subtopics.forEach(st => {
                        const option = document.createElement('option');
                        option.value = st.id;
                        option.textContent = st.name;
                        subtopicSelect.appendChild(option);
                    });
                    subtopicSelect.disabled = false;
                })
                .catch(error => {
                    showNotification('Ошибка при загрузке подтем', 'error');
                });
        }
        
        function handleSubtopicSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            fetch('/admin/trainers/api/subtopics', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Подтема успешно создана!', 'success');
                    e.target.reset();
                } else {
                    showNotification(data.error || 'Ошибка при создании подтемы', 'error');
                }
            })
            .catch(error => {
                showNotification('Ошибка при создании подтемы', 'error');
            });
        }
        
        function handleTaskSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            fetch('/admin/trainers/api/tasks', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Задание успешно создано!', 'success');
                    e.target.reset();
                } else {
                    showNotification(data.error || 'Ошибка при создании задания', 'error');
                }
            })
            .catch(error => {
                showNotification('Ошибка при создании задания', 'error');
            });
        }
        
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            Object.assign(notification.style, {
                position: 'fixed',
                top: '20px',
                right: '20px',
                padding: '1rem 1.5rem',
                borderRadius: '8px',
                color: 'white',
                fontWeight: '600',
                zIndex: '10000',
                transform: 'translateX(100%)',
                transition: 'transform 0.3s ease',
                maxWidth: '400px'
            });
            
            const colors = {
                success: 'linear-gradient(135deg, #10b981, #059669)',
                error: 'linear-gradient(135deg, #ef4444, #dc2626)',
                info: 'linear-gradient(135deg, #3b82f6, #1d4ed8)'
            };
            
            notification.style.background = colors[type] || colors.info;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
    </script>

    <script src="/js/admin.js"></script>
</body>
</html>

