<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} ?: '–ì–ª–∞–≤–∞ - Brainify'">–ì–ª–∞–≤–∞ - Brainify</title>
    
    <link rel="stylesheet" th:href="@{/css/section-modern.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="page-container">
        <!-- –õ–µ–≤–∞—è –±–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <aside class="left-sidebar" id="leftSidebar">
            <div class="sidebar-header">
                <div class="breadcrumb">
                    <a th:href="@{'/course/' + ${subject.id}}">–ö—É—Ä—Å</a>
                    <i class="fas fa-chevron-right"></i>
                    <span th:text="${module.title}">–ú–æ–¥—É–ª—å</span>
                </div>
                <h2 class="sidebar-title" th:text="${chapter.title}">–ì–ª–∞–≤–∞</h2>
            </div>
            
            <nav class="sections-nav">
                <div class="nav-chapter" th:each="ch : ${chapters}">
                    <a class="nav-chapter-title" 
                       th:href="@{'/course/chapter/' + ${ch.id}}"
                       th:classappend="${ch.id == chapter.id} ? 'active' : ''" 
                       th:text="${ch.title}">–ì–ª–∞–≤–∞</a>
                    <div class="nav-chapter-sections" th:if="${chapterToSections[ch.id] != null}">
                        <a class="nav-section" 
                           th:each="s : ${chapterToSections[ch.id]}"
                           th:href="@{'/course/section/' + ${s.id}}"
                           th:text="${s.title}">
                            –†–∞–∑–¥–µ–ª
                        </a>
                    </div>
                </div>
            </nav>
        </aside>
        
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <main class="main-content">
            <!-- –ö–†–ê–°–ò–í–´–ô HEADER –í–û –í–°–Æ –®–ò–†–ò–ù–£ -->
            <div class="top-bar">
                <div class="top-bar-container">
                    <div class="top-bar-left">
                        <button class="top-btn secondary" id="mobileSidebarToggle" style="display: none;">
                            <i class="fas fa-bars"></i>
                        </button>
                        <a href="/" class="logo">
                            <span class="logo-brain">Brain</span><span class="logo-ify">ify</span>
                        </a>
                        <div class="header-divider"></div>
                        <div class="page-breadcrumb">
                            <div class="breadcrumb-top" th:text="${module.title}">–ú–æ–¥—É–ª—å</div>
                            <div class="breadcrumb-current" th:text="${chapter.title}">–ì–ª–∞–≤–∞</div>
                        </div>
                    </div>
                    <div class="top-bar-actions">
                    <a th:href="@{'/course/' + ${subject.id}}" class="top-btn secondary">
                        <i class="fas fa-th"></i> –ö –∫—É—Ä—Å—É
                    </a>
                    <button th:if="${isAuthenticated and currentUser != null and currentUser.role?.name() == 'ADMIN'}" 
                            class="top-btn primary" id="editModeBtn">
                        <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    </div>
                </div>
            </div>
            
            <div class="content-wrapper">
                <!-- –ë–µ–ª–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º -->
                <div class="content-card">
                    <h1 class="section-title" th:text="${chapter.title}">–ù–∞–∑–≤–∞–Ω–∏–µ –≥–ª–∞–≤—ã</h1>
                    
                    <!-- –ë–ª–æ–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≥–ª–∞–≤—ã -->
                    <div id="contentBlocks">
                    <div class="content-block" th:each="b : ${blocks}" th:attr="data-block-id=${b.id}">
                        <!-- –¢–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫ -->
                        <div th:if="${b.type.name()} == 'TEXT'">
                            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è ADMIN –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) -->
                            <div class="block-actions" th:if="${isAuthenticated and currentUser != null and currentUser.role?.name() == 'ADMIN'}" style="display: none;">
                                <button class="block-edit-btn" th:attr="data-block-id=${b.id}, data-block-type=${b.type.name()}">
                                    <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                                <button class="block-delete-btn" th:attr="data-block-id=${b.id}">
                                    <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                            <h3 th:if="${b.title != null and b.title != ''}" th:text="${b.title}">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h3>
                            <div th:utext="${b.textContent}">–¢–µ–∫—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç</div>
                        </div>
                        
                        <!-- –ë–ª–æ–∫ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º -->
                        <div th:if="${b.type.name()} == 'IMAGE'">
                            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è ADMIN –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) -->
                            <div class="block-actions" th:if="${isAuthenticated and currentUser != null and currentUser.role?.name() == 'ADMIN'}" style="display: none;">
                                <button class="block-edit-btn" th:attr="data-block-id=${b.id}, data-block-type=${b.type.name()}">
                                    <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                                <button class="block-delete-btn" th:attr="data-block-id=${b.id}">
                                    <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                            <h3 th:if="${b.title != null and b.title != ''}" th:text="${b.title}">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h3>
                            <img th:src="${b.imageUrl}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" style="max-width: 100%; border-radius: 12px; margin: 20px 0; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                        </div>
                        
                        <!-- –ó–∞–¥–∞–Ω–∏–µ -->
                        <div th:if="${b.type.name()} == 'SQL_TASK'">
                            <div class="task-block">
                                <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è ADMIN –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) -->
                                <div class="block-actions" th:if="${isAuthenticated and currentUser != null and currentUser.role?.name() == 'ADMIN'}" style="display: none;">
                                    <button class="block-edit-btn" th:attr="data-block-id=${b.id}, data-block-type=${b.type.name()}">
                                        <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                    </button>
                                    <button class="block-delete-btn" th:attr="data-block-id=${b.id}">
                                        <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                    </button>
                                </div>
                                <div class="task-header">
                                    <div class="task-icon">
                                        <i class="fas fa-tasks"></i>
                                    </div>
                                    <h3 class="task-title" th:text="${b.title} ?: '–ó–∞–¥–∞–Ω–∏–µ'">–ó–∞–¥–∞–Ω–∏–µ</h3>
                                </div>
                                <div class="task-description" th:utext="${b.textContent} ?: '<p>–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ</p>'">
                                    –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è
                                </div>
                                <!-- –ö–∞—Ä—Ç–∏–Ω–∫–∞ –∏–∑ –ë–î -->
                                <img th:src="@{'/api/tasks/image/' + ${b.id} + '/CHAPTER'}" 
                                     class="task-image" 
                                     onerror="this.style.display='none'"
                                     style="display: block;">
                                <div class="task-compact">
                                    <input class="task-answer-input" type="text" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç..." th:value="${b.initialSql}">
                                    <button class="check-btn check-answer-btn">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </div>
                                <div class="task-result"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
                    <div th:if="${#lists.isEmpty(blocks)}" class="empty-state">
                        <i class="fas fa-book-open"></i>
                        <h3>–ì–ª–∞–≤–∞ –ø–æ–∫–∞ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞</h3>
                        <p th:if="${isAuthenticated and currentUser != null and currentUser.role?.name() == 'ADMIN'}">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫" –Ω–∏–∂–µ</p>
                        <p th:if="${not (isAuthenticated and currentUser != null and currentUser.role?.name() == 'ADMIN')}">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–±–∞–≤–∏—Ç –º–∞—Ç–µ—Ä–∏–∞–ª—ã –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è</p>
                    </div>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫ (—Ç–æ–ª—å–∫–æ –¥–ª—è ADMIN –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) -->
                    <button th:if="${isAuthenticated and currentUser != null and currentUser.role?.name() == 'ADMIN'}" 
                            class="add-block-btn" id="addBlockBtn" style="display: none;">
                        <i class="fas fa-plus-circle"></i>
                        –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫
                    </button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- –ü–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div class="edit-overlay" id="editOverlay"></div>
    <div class="edit-panel" id="editPanel">
        <div class="edit-panel-header">
            <h3 class="edit-panel-title" id="editPanelTitle">
                <i class="fas fa-plus-circle"></i>
                –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç
            </h3>
            <button class="close-edit-btn" id="closeEditBtn">&times;</button>
        </div>
        <form class="edit-panel-content" th:action="@{'/admin/course/chapter/block'}" method="post" id="blockForm">
            <input type="hidden" name="chapterId" th:value="${chapter.id}">
            <input type="hidden" id="editBlockId" name="blockId">
            <input type="hidden" id="editBlockType" name="blockType">
            
            <div class="edit-form-group">
                <label>
                    <i class="fas fa-layer-group"></i>
                    –¢–∏–ø –±–ª–æ–∫–∞
                </label>
                <select name="type" id="blockType">
                    <option value="TEXT">üìù –¢–µ–∫—Å—Ç</option>
                    <option value="IMAGE">üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</option>
                    <option value="SQL_TASK">‚úÖ –ó–∞–¥–∞–Ω–∏–µ</option>
                </select>
            </div>
            
            <div class="edit-form-group">
                <label>
                    <i class="fas fa-heading"></i>
                    –ó–∞–≥–æ–ª–æ–≤–æ–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                </label>
                <input type="text" name="title" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª–æ–∫–∞">
            </div>
            
            <div class="edit-form-group" id="textField">
                <label>
                    <i class="fas fa-align-left"></i>
                    –¢–µ–∫—Å—Ç (HTML)
                </label>
                <textarea name="textContent" placeholder="<h2>–ó–∞–≥–æ–ª–æ–≤–æ–∫</h2>&#10;<p>–í–∞—à —Ç–µ–∫—Å—Ç...</p>"></textarea>
                <p class="edit-form-hint">
                    <i class="fas fa-lightbulb"></i>
                    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTML: &lt;h2&gt;, &lt;p&gt;, &lt;ul&gt;, &lt;code&gt;
                </p>
            </div>
            
            <div class="edit-form-group" id="imageField" style="display: none;">
                <label>
                    <i class="fas fa-image"></i>
                    URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                </label>
                <input type="text" name="imageUrl" placeholder="https://example.com/image.jpg">
                <p class="edit-form-hint">
                    <i class="fas fa-lightbulb"></i>
                    –í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É
                </p>
            </div>
            
            <div class="edit-form-group" id="sqlField" style="display: none;">
                <label>
                    <i class="fas fa-tasks"></i>
                    –¢–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è (HTML)
                </label>
                <textarea name="textContent" placeholder="<p>–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ...</p>"></textarea>
                
                <label style="margin-top: 20px;">
                    <i class="fas fa-image"></i>
                    –ö–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞–¥–∞–Ω–∏—è (drag & drop)
                </label>
                <div id="taskImageDropZone" style="border: 2px dashed #a7f3d0; border-radius: 10px; padding: 30px; text-align: center; background: #f0fdf4; cursor: pointer; transition: all 0.3s;">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: #10b981; margin-bottom: 10px; display: block;"></i>
                    <p style="color: #059669; font-weight: 600; margin: 0;">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É —Å—é–¥–∞ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
                    <p style="color: #6b7280; font-size: 12px; margin-top: 6px;">JPG, PNG (–º–∞–∫—Å. 5MB)</p>
                    <input type="file" id="taskImageInput" accept="image/*" style="display: none;">
                </div>
                <div id="taskImagePreview" style="margin-top: 12px; display: none;">
                    <img id="previewImg" style="max-width: 100%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <button type="button" id="removeImageBtn" style="margin-top: 8px; padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-times"></i> –£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
                
                <label style="margin-top: 20px;">
                    <i class="fas fa-code"></i>
                    –ù–∞—á–∞–ª—å–Ω—ã–π –∫–æ–¥ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                </label>
                <textarea name="initialSql" placeholder="–ù–∞—á–∞–ª—å–Ω—ã–π –∫–æ–¥"></textarea>
                
                <label style="margin-top: 20px;">
                    <i class="fas fa-check-double"></i>
                    –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                </label>
                <input type="text" id="correctAnswerInput" placeholder="–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (–±—É–¥–µ—Ç —Å–∫—Ä—ã—Ç –æ—Ç —É—á–µ–Ω–∏–∫–∞)">
                <p class="edit-form-hint">
                    <i class="fas fa-lock"></i>
                    –û—Ç–≤–µ—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î –∏ –Ω–µ –≤–∏–¥–µ–Ω –≤ –∫–æ–¥–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                </p>
            </div>
            
            <div class="edit-form-group">
                <label>
                    <i class="fas fa-sort-numeric-down"></i>
                    –ü–æ—Ä—è–¥–æ–∫
                </label>
                <input type="number" name="sortOrder" value="0" min="0">
            </div>
            
            <div class="edit-form-actions">
                <button type="submit" class="save-edit-btn">
                    <i class="fas fa-save"></i> –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫
                </button>
                <button type="button" class="cancel-edit-btn" id="cancelEditBtn">
                    <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </form>
    </div>
    
    <!-- JavaScript -->
    <script th:src="@{/js/csrf.js}"></script>
    <script>
        // –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é
        const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
        const leftSidebar = document.getElementById('leftSidebar');
        
        if (window.innerWidth <= 768) {
            mobileSidebarToggle.style.display = 'block';
        }
        
        mobileSidebarToggle?.addEventListener('click', () => {
            leftSidebar.classList.toggle('mobile-open');
        });
        
        // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const editModeBtn = document.getElementById('editModeBtn');
        const addBlockBtn = document.getElementById('addBlockBtn');
        const editPanel = document.getElementById('editPanel');
        const editOverlay = document.getElementById('editOverlay');
        const closeEditBtn = document.getElementById('closeEditBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const blockType = document.getElementById('blockType');
        let isEditMode = false;
        
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const blockActions = document.querySelectorAll('.block-actions');
            const addBlockBtn = document.getElementById('addBlockBtn');
            
            if (isEditMode) {
                // –í–∫–ª—é—á–∞–µ–º CSS-—Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                document.body.classList.add('edit-mode');
                // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–ª–æ–∫–æ–≤
                blockActions.forEach(action => action.style.display = 'flex');
                blockActions.forEach(action => action.style.opacity = '1');
                // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–∞
                if (addBlockBtn) addBlockBtn.style.display = 'block';
                // –ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
                if (editModeBtn) editModeBtn.innerHTML = '<i class="fas fa-eye"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä';
                // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫
                setTimeout(() => addBlockEventListeners(), 100);
            } else {
                // –í—ã–∫–ª—é—á–∞–µ–º CSS-—Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                document.body.classList.remove('edit-mode');
                // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–ª–æ–∫–æ–≤
                blockActions.forEach(action => action.style.display = 'none');
                blockActions.forEach(action => action.style.opacity = '0');
                // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–∞
                if (addBlockBtn) addBlockBtn.style.display = 'none';
                // –ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
                if (editModeBtn) editModeBtn.innerHTML = '<i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
            }
        }
        
        function openEditPanel() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞
            document.getElementById('editBlockId').value = '';
            document.getElementById('editBlockType').value = '';
            document.getElementById('editPanelTitle').innerHTML = '<i class="fas fa-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç';
            document.querySelector('.save-edit-btn').innerHTML = '<i class="fas fa-save"></i> –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫';
            
            // –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ–ª—è
            document.querySelector('input[name="title"]').value = '';
            document.querySelector('textarea[name="textContent"]').value = '';
            document.querySelector('input[name="imageUrl"]').value = '';
            document.querySelector('textarea[name="initialSql"]').value = '';
            document.querySelector('input[name="sortOrder"]').value = '0';
            document.getElementById('correctAnswerInput').value = '';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–ª—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            document.getElementById('textField').style.display = 'none';
            document.getElementById('imageField').style.display = 'none';
            document.getElementById('sqlField').style.display = 'none';
            // –û—Ç–∫–ª—é—á–∞–µ–º –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è –ø–æ–ª—è, —á—Ç–æ–±—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏—Å—å
            document.querySelectorAll('#textField [name="textContent"]').forEach(el => el.disabled = true);
            document.querySelectorAll('#sqlField [name="textContent"]').forEach(el => el.disabled = true);
            
            editPanel.classList.add('active');
            editOverlay.classList.add('active');
        }
        
        function closeEditPanel() {
            editPanel.classList.remove('active');
            editOverlay.classList.remove('active');
        }
        
        editModeBtn?.addEventListener('click', toggleEditMode);
        addBlockBtn?.addEventListener('click', openEditPanel);
        closeEditBtn?.addEventListener('click', closeEditPanel);
        cancelEditBtn?.addEventListener('click', closeEditPanel);
        editOverlay?.addEventListener('click', closeEditPanel);
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –∫ –∫–Ω–æ–ø–∫–∞–º –±–ª–æ–∫–æ–≤
        function addBlockEventListeners() {
            // –ö–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫–æ–≤
            document.querySelectorAll('.block-edit-btn').forEach(btn => {
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
                btn.removeEventListener('click', handleEditBlock);
                btn.addEventListener('click', handleEditBlock);
            });
            
            // –ö–Ω–æ–ø–∫–∏ —É–¥–∞–ª–∏—Ç—å –±–ª–æ–∫–æ–≤
            document.querySelectorAll('.block-delete-btn').forEach(btn => {
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
                btn.removeEventListener('click', handleDeleteBlock);
                btn.addEventListener('click', handleDeleteBlock);
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–ª–æ–∫–∞
        async function handleEditBlock() {
            const blockId = this.getAttribute('data-block-id');
            const blockType = this.getAttribute('data-block-type');
            
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –±–ª–æ–∫–∞
                const response = await fetch(`/api/blocks/${blockId}/data?scope=CHAPTER`);
                if (!response.ok) {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–∞');
                    return;
                }
                
                const blockData = await response.json();
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –±–ª–æ–∫–∞
                document.getElementById('editBlockId').value = blockData.id;
                document.getElementById('editBlockType').value = blockData.type;
                document.getElementById('blockType').value = blockData.type;
                document.querySelector('input[name="title"]').value = blockData.title || '';
                document.querySelector('textarea[name="textContent"]').value = blockData.textContent || '';
                document.querySelector('input[name="imageUrl"]').value = blockData.imageUrl || '';
                document.querySelector('textarea[name="initialSql"]').value = blockData.initialSql || '';
                document.querySelector('input[name="sortOrder"]').value = blockData.sortOrder || 0;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è –∏ —É–ø—Ä–∞–≤–ª—è–µ–º disabled
                document.getElementById('textField').style.display = 'none';
                document.getElementById('imageField').style.display = 'none';
                document.getElementById('sqlField').style.display = 'none';
                document.querySelectorAll('#textField [name="textContent"]').forEach(el => el.disabled = true);
                document.querySelectorAll('#sqlField [name="textContent"]').forEach(el => el.disabled = true);
                
                if (blockData.type === 'TEXT') {
                    document.getElementById('textField').style.display = '';
                    document.querySelectorAll('#textField [name="textContent"]').forEach(el => el.disabled = false);
                } else if (blockData.type === 'IMAGE') {
                    document.getElementById('imageField').style.display = '';
                } else if (blockData.type === 'SQL_TASK') {
                    document.getElementById('sqlField').style.display = '';
                    document.querySelectorAll('#sqlField [name="textContent"]').forEach(el => el.disabled = false);
                }
                
                // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–Ω–æ–ø–∫—É –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                document.getElementById('editPanelTitle').innerHTML = '<i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫';
                document.querySelector('.save-edit-btn').innerHTML = '<i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ —Å–±—Ä–æ—Å–∞ —Ñ–æ—Ä–º—ã
                editPanel.classList.add('active');
                editOverlay.classList.add('active');
                
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±–ª–æ–∫–∞');
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –±–ª–æ–∫–∞
        async function handleDeleteBlock() {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±–ª–æ–∫?')) return;
            
            const blockId = this.getAttribute('data-block-id');
            try {
                const response = await fetch(`/admin/course/chapter/block/${blockId}/delete`, {
                    method: 'POST'
                });
                if (response.ok) {
                    this.closest('.content-block').style.animation = 'fadeOut 0.3s';
                    setTimeout(() => window.location.reload(), 300);
                } else {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        addBlockEventListeners();
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª–µ–π
        blockType?.addEventListener('change', () => {
            document.getElementById('textField').style.display = 'none';
            document.getElementById('imageField').style.display = 'none';
            document.getElementById('sqlField').style.display = 'none';
            document.querySelectorAll('#textField [name="textContent"]').forEach(el => el.disabled = true);
            document.querySelectorAll('#sqlField [name="textContent"]').forEach(el => el.disabled = true);
            
            if (blockType.value === 'TEXT') {
                document.getElementById('textField').style.display = '';
                document.querySelectorAll('#textField [name="textContent"]').forEach(el => el.disabled = false);
            } else if (blockType.value === 'IMAGE') {
                document.getElementById('imageField').style.display = '';
            } else if (blockType.value === 'SQL_TASK') {
                document.getElementById('sqlField').style.display = '';
                document.querySelectorAll('#sqlField [name="textContent"]').forEach(el => el.disabled = false);
            }
        });
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ –ë–î API
        document.querySelectorAll('.check-answer-btn').forEach(btn => {
            btn.addEventListener('click', async function() {
                const taskBlock = this.closest('.task-block');
                const textarea = taskBlock.querySelector('.task-answer-input') || taskBlock.querySelector('.task-input');
                const resultDiv = taskBlock.querySelector('.task-result');
                const blockId = taskBlock.closest('[data-block-id]')?.getAttribute('data-block-id');
                const userAnswer = textarea.value.trim();
                
                if (!userAnswer) {
                    resultDiv.className = 'task-result error';
                    resultDiv.innerHTML = '<i class="fas fa-times-circle"></i> –í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç';
                    return;
                }
                
                this.disabled = true;
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                
                try {
                    const response = await fetch('/api/tasks/check-answer', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            blockId: blockId,
                            blockType: 'CHAPTER',
                            answer: userAnswer
                        })
                    });
                    
                    const data = await response.json();
                    
                    // –°–±—Ä–æ—Å –∫–ª–∞—Å—Å–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–∞ –±–ª–æ–∫–µ
                    taskBlock.classList.remove('is-success', 'is-error');

                    const isSuccess = data && (data.success === true || data.success === 'true');
                    const isCorrect = data && (data.correct === true || data.correct === 'true');

                    if (isSuccess && isCorrect) {
                        resultDiv.className = 'task-result success';
                        resultDiv.innerHTML = '<i class="fas fa-check-circle"></i> ' + (data.message || '–ü—Ä–∞–≤–∏–ª—å–Ω–æ!');
                        taskBlock.classList.add('is-success');
                        // –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ
                        if (textarea) textarea.disabled = true;
                        this.disabled = true;
                        this.innerHTML = '<i class="fas fa-check"></i>';
                    } else {
                        resultDiv.className = 'task-result error';
                        resultDiv.innerHTML = '<i class="fas fa-times-circle"></i> ' + (data.message || '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑');
                        taskBlock.classList.add('is-error');
                        // –†–∞–∑—Ä–µ—à–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø–æ–ø—ã—Ç–∫—É
                        this.disabled = false;
                        this.innerHTML = '<i class="fas fa-check"></i>';
                    }
                } catch (error) {
                    resultDiv.className = 'task-result error';
                    resultDiv.innerHTML = '<i class="fas fa-times-circle"></i> –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏';
                    taskBlock.classList.remove('is-success');
                    taskBlock.classList.add('is-error');
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-check"></i>';
                }
            });
        });
        
        // Drag and Drop –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫
        const dropZone = document.getElementById('taskImageDropZone');
        const fileInput = document.getElementById('taskImageInput');
        const preview = document.getElementById('taskImagePreview');
        const previewImg = document.getElementById('previewImg');
        const removeBtn = document.getElementById('removeImageBtn');
        let uploadedImageFile = null;
        
        if (dropZone && fileInput) {
            dropZone.addEventListener('click', () => fileInput.click());
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#10b981';
                dropZone.style.background = '#dcfce7';
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.style.borderColor = '#a7f3d0';
                dropZone.style.background = '#f0fdf4';
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = '#a7f3d0';
                dropZone.style.background = '#f0fdf4';
                
                if (e.dataTransfer.files.length > 0) {
                    handleImageFile(e.dataTransfer.files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleImageFile(e.target.files[0]);
                }
            });
            
            function handleImageFile(file) {
                if (!file.type.startsWith('image/')) {
                    alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                    return;
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 5MB)');
                    return;
                }
                
                uploadedImageFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
            
            removeBtn?.addEventListener('click', () => {
                uploadedImageFile = null;
                preview.style.display = 'none';
                fileInput.value = '';
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        document.querySelector('#editPanel form')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const blockType = document.getElementById('blockType').value;
            const correctAnswer = document.getElementById('correctAnswerInput')?.value;
            const editBlockId = document.getElementById('editBlockId').value;
            const isEdit = editBlockId && editBlockId !== '';
            
            const saveBtn = this.querySelector('.save-edit-btn');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            
            try {
                let response;
                
                if (isEdit) {
                    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –±–ª–æ–∫–∞
                    response = await fetch(`/api/blocks/${editBlockId}/update?scope=CHAPTER`, {
                        method: 'POST',
                        body: formData
                    });
                } else {
                    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞ —á–µ—Ä–µ–∑ JSON API, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å ID
                    response = await fetch('/api/admin/course/chapter/block', {
                        method: 'POST',
                        body: formData
                    });
                }
                
                if (response.ok) {
                    let newId = editBlockId;
                    try {
                        const resJson = await response.json();
                        if (resJson && resJson.id) newId = resJson.id;
                    } catch (e) { /* ignore parse error for edit case */ }
                    
                    // –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ –∏ –µ—Å—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∏–ª–∏ –æ—Ç–≤–µ—Ç
                    if (blockType === 'SQL_TASK') {
                        const blockId = newId; 
                        
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –µ—Å–ª–∏ –µ—Å—Ç—å
                        if (uploadedImageFile) {
                            const imgFormData = new FormData();
                            imgFormData.append('file', uploadedImageFile);
                            imgFormData.append('blockId', blockId);
                            imgFormData.append('blockType', 'CHAPTER');
                            
                            await fetch('/api/tasks/upload-image', {
                                method: 'POST',
                                body: imgFormData
                            });
                        }
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
                        if (correctAnswer) {
                            await fetch('/api/tasks/save-answer', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    blockId: blockId,
                                    blockType: 'CHAPTER',
                                    correctAnswer: correctAnswer
                                })
                            });
                        }
                    }
                    
                    window.location.reload();
                } else {
                    saveBtn.innerHTML = '<i class="fas fa-times"></i> –û—à–∏–±–∫–∞';
                    saveBtn.disabled = false;
                }
            } catch (error) {
                saveBtn.innerHTML = '<i class="fas fa-times"></i> –û—à–∏–±–∫–∞';
                saveBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
