<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brainify Board - –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –¥–æ—Å–∫–∞</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß†</text></svg>">
    
    <!-- –°—Ç–∏–ª–∏ -->
    <link rel="stylesheet" th:href="@{/css/professional-board-new.css}">
    <link rel="stylesheet" th:href="@{/css/professional-board-modern.css}">
    
    <!-- –ò–∫–æ–Ω–∫–∏ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    
    <!-- –®—Ä–∏—Ñ—Ç—ã -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- KaTeX –¥–ª—è —Ñ–æ—Ä–º—É–ª -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css">
</head>
<body>
    <!-- –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="board-app">
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
        <header class="top-bar">
            <div class="top-bar-left">
                <button class="menu-btn" id="menuBtn">
                    <i class="material-icons-outlined">menu</i>
                </button>
                <div class="board-title">
                    <input type="text" id="boardTitle" value="–ù–æ–≤–∞—è –¥–æ—Å–∫–∞" class="title-input">
                    <span class="save-indicator" id="saveIndicator">
                        <i class="material-icons-outlined">cloud_done</i>
                        –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ
                    </span>
                </div>
            </div>
            
            <div class="top-bar-center">
                <div class="toolbar-group">
                    <button class="tool-btn" data-tool="select" title="–í—ã–±–æ—Ä (V)">
                        <i class="material-icons-outlined">arrow_selector_tool</i>
                    </button>
                    <button class="tool-btn active" data-tool="pen" title="–†—É—á–∫–∞ (P)">
                        <i class="material-icons-outlined">edit</i>
                    </button>
                    <button class="tool-btn" data-tool="highlighter" title="–ú–∞—Ä–∫–µ—Ä (H)">
                        <i class="material-icons-outlined">highlight</i>
                    </button>
                    <button class="tool-btn" data-tool="eraser" title="–õ–∞—Å—Ç–∏–∫ (E)">
                        <i class="material-icons-outlined">auto_fix_normal</i>
                    </button>
                </div>
                
                <div class="toolbar-separator"></div>
                
                <div class="toolbar-group">
                    <button class="tool-btn" data-tool="shape" data-shape="rectangle" title="–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ (R)">
                        <i class="material-icons-outlined">crop_square</i>
                    </button>
                    <button class="tool-btn" data-tool="shape" data-shape="circle" title="–ö—Ä—É–≥ (O)">
                        <i class="material-icons-outlined">circle</i>
                    </button>
                    <button class="tool-btn" data-tool="arrow" title="–°—Ç—Ä–µ–ª–∫–∞ (A)">
                        <i class="material-icons-outlined">trending_flat</i>
                    </button>
                    <button class="tool-btn" data-tool="text" title="–¢–µ–∫—Å—Ç (T)">
                        <i class="material-icons-outlined">text_fields</i>
                    </button>
                </div>
                
                <div class="toolbar-separator"></div>
                
                <div class="toolbar-group">
                    <button class="tool-btn" data-tool="image" title="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
                        <i class="material-icons-outlined">image</i>
                    </button>
                    <button class="tool-btn" data-tool="formula" title="–§–æ—Ä–º—É–ª–∞">
                        <i class="material-icons-outlined">functions</i>
                    </button>
                    <button class="tool-btn" data-tool="laser" title="–õ–∞–∑–µ—Ä–Ω–∞—è —É–∫–∞–∑–∫–∞ (L)">
                        <i class="material-icons-outlined">my_location</i>
                    </button>
                </div>
            </div>
            
            <div class="top-bar-right">
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomOutBtn" title="–£–º–µ–Ω—å—à–∏—Ç—å (Ctrl -)">
                        <i class="material-icons-outlined">remove</i>
                    </button>
                    <div class="zoom-level" id="zoomLevel">100%</div>
                    <button class="zoom-btn" id="zoomInBtn" title="–£–≤–µ–ª–∏—á–∏—Ç—å (Ctrl +)">
                        <i class="material-icons-outlined">add</i>
                    </button>
                    <button class="zoom-btn" id="zoomFitBtn" title="–ü–æ —Ä–∞–∑–º–µ—Ä—É">
                        <i class="material-icons-outlined">fit_screen</i>
                    </button>
                </div>
                
                <div class="toolbar-separator"></div>
                
                <div class="user-avatars" id="userAvatars">
                    <!-- –ê–≤–∞—Ç–∞—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
                </div>
                
                <button class="share-btn" id="shareBtn">
                    <i class="material-icons-outlined">share</i>
                    –ü–æ–¥–µ–ª–∏—Ç—å—Å—è
                </button>
                
                <button class="video-btn" id="videoBtn" title="–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫">
                    <i class="material-icons-outlined">videocam</i>
                </button>
                
                <div class="toolbar-separator"></div>
                
                <!-- –ö–Ω–æ–ø–∫–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ (–ø–æ–∫–∞–∑–∞–Ω—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏) -->
                <div class="toolbar-group" style="display: flex;">
                    <button class="tool-btn" id="diagnoseBtn" title="–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è" style="background-color: #ff6b6b;">
                        <i class="fas fa-bug"></i>
                    </button>
                    <button class="tool-btn" id="fullDiagnoseBtn" title="–ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã" style="background-color: #4ecdc4;">
                        <i class="fas fa-stethoscope"></i>
                    </button>
                    <button class="tool-btn" id="recreateSessionBtn" title="–ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Å–µ—Å—Å–∏—é" style="background-color: #ffa726;">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="tool-btn" id="forceRestoreBtn" title="–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ" style="background-color: #4caf50;">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="tool-btn" id="testConnectionBtn" title="–¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è" style="background-color: #2196f3;">
                        <i class="fas fa-wifi"></i>
                    </button>
                    <button class="tool-btn" id="testBoardBtn" title="–¢–µ—Å—Ç –¥–æ—Å–∫–∏" style="background-color: #9c27b0;">
                        <i class="fas fa-paint-brush"></i>
                    </button>
                </div>
                
                <div class="toolbar-separator"></div>
                
                <button class="share-btn danger" id="endLessonBtn" title="–ó–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫">
                    <i class="material-icons-outlined">logout</i>
                    –ó–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫
                </button>
            </div>
        </header>
        
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å -->
        <div class="board-container">
            <!-- –ö–Ω–æ–ø–∫–∏ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–µ–π -->
            <button class="panel-toggle-btn left" id="propertiesToggleBtn" title="–°–≤–æ–π—Å—Ç–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞">
                <i class="material-icons-outlined">tune</i>
            </button>
            
            <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
            <aside class="left-panel" id="leftPanel">
                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ -->
                <div class="tool-properties">
                    <div class="section-header">
                        <h3>–°–≤–æ–π—Å—Ç–≤–∞</h3>
                        <button class="panel-close-btn" id="closePropertiesBtn">
                            <i class="material-icons-outlined">close</i>
                        </button>
                    </div>
                    
                    <!-- –¶–≤–µ—Ç -->
                    <div class="property-group">
                        <label>–¶–≤–µ—Ç</label>
                        <div class="color-palette">
                            <button class="color-btn active" data-color="#000000" style="background: #000000"></button>
                            <button class="color-btn" data-color="#FF0000" style="background: #FF0000"></button>
                            <button class="color-btn" data-color="#00FF00" style="background: #00FF00"></button>
                            <button class="color-btn" data-color="#0000FF" style="background: #0000FF"></button>
                            <button class="color-btn" data-color="#FFFF00" style="background: #FFFF00"></button>
                            <button class="color-btn" data-color="#FF00FF" style="background: #FF00FF"></button>
                            <button class="color-btn" data-color="#00FFFF" style="background: #00FFFF"></button>
                            <button class="color-btn" data-color="#FFFFFF" style="background: #FFFFFF; border: 1px solid #ddd"></button>
                            <button class="color-picker-btn" title="–í—ã–±—Ä–∞—Ç—å —Ü–≤–µ—Ç">
                                <i class="material-icons-outlined">palette</i>
                                <input type="color" id="colorPicker" style="display: none">
                            </button>
                        </div>
                    </div>
                    
                    <!-- –†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏ -->
                    <div class="property-group">
                        <label>–†–∞–∑–º–µ—Ä <span id="brushSizeValue">3</span></label>
                        <input type="range" id="brushSize" min="1" max="50" value="3" class="slider">
                    </div>
                    
                    <!-- –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å -->
                    <div class="property-group">
                        <label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å <span id="opacityValue">100%</span></label>
                        <input type="range" id="opacity" min="0" max="100" value="100" class="slider">
                    </div>
                </div>
                
                <!-- –°–ª–æ–∏ -->
                <div class="layers-section">
                    <div class="section-header">
                        <h3>–°–ª–æ–∏</h3>
                        <button class="icon-btn" id="addLayerBtn" title="–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–π">
                            <i class="material-icons-outlined">add</i>
                        </button>
                    </div>
                    <div class="layers-list" id="layersList">
                        <!-- –°–ø–∏—Å–æ–∫ —Å–ª–æ—ë–≤ -->
                    </div>
                </div>
                
                <!-- –ò—Å—Ç–æ—Ä–∏—è -->
                <div class="history-section">
                    <div class="section-header">
                        <h3>–ò—Å—Ç–æ—Ä–∏—è</h3>
                        <button class="icon-btn" id="clearHistoryBtn" title="–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é">
                            <i class="material-icons-outlined">clear_all</i>
                        </button>
                    </div>
                    <div class="history-list" id="historyList">
                        <!-- –°–ø–∏—Å–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π -->
                    </div>
                </div>
            </aside>
            
            <!-- –û–±–ª–∞—Å—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏—è -->
            <main class="canvas-area">
                <!-- Canvas viewport -->
                <div class="canvas-viewport" id="canvasViewport">
                    <canvas id="boardCanvas"></canvas>
                    
                    <!-- –ú–∏–Ω–∏-–∫–∞—Ä—Ç–∞ -->
                    <div class="minimap" id="minimap">
                        <canvas id="minimapCanvas"></canvas>
                        <div class="minimap-viewport"></div>
                    </div>
                    
                    <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é -->
                    <div class="context-menu" id="contextMenu" style="display: none">
                        <button class="context-menu-item" data-action="copy">
                            <i class="material-icons-outlined">content_copy</i>
                            –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <button class="context-menu-item" data-action="cut">
                            <i class="material-icons-outlined">content_cut</i>
                            –í—ã—Ä–µ–∑–∞—Ç—å
                        </button>
                        <button class="context-menu-item" data-action="paste">
                            <i class="material-icons-outlined">content_paste</i>
                            –í—Å—Ç–∞–≤–∏—Ç—å
                        </button>
                        <div class="context-menu-separator"></div>
                        <button class="context-menu-item" data-action="delete">
                            <i class="material-icons-outlined">delete</i>
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                        <button class="context-menu-item" data-action="duplicate">
                            <i class="material-icons-outlined">control_point_duplicate</i>
                            –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <div class="context-menu-separator"></div>
                        <button class="context-menu-item" data-action="bring-front">
                            <i class="material-icons-outlined">flip_to_front</i>
                            –ù–∞ –ø–µ—Ä–µ–¥–Ω–∏–π –ø–ª–∞–Ω
                        </button>
                        <button class="context-menu-item" data-action="send-back">
                            <i class="material-icons-outlined">flip_to_back</i>
                            –ù–∞ –∑–∞–¥–Ω–∏–π –ø–ª–∞–Ω
                        </button>
                    </div>
                </div>
                
                <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å -->
                <div class="bottom-bar">
                    <div class="bottom-bar-left">
                        <button class="icon-btn" id="undoBtn" title="–û—Ç–º–µ–Ω–∏—Ç—å (Ctrl+Z)">
                            <i class="material-icons-outlined">undo</i>
                        </button>
                        <button class="icon-btn" id="redoBtn" title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å (Ctrl+Y)">
                            <i class="material-icons-outlined">redo</i>
                        </button>
                    </div>
                    
                    <div class="bottom-bar-center">
                        <button class="icon-btn" id="gridBtn" title="–°–µ—Ç–∫–∞">
                            <i class="material-icons-outlined">grid_on</i>
                        </button>
                        <button class="icon-btn" id="snapBtn" title="–ü—Ä–∏–≤—è–∑–∫–∞">
                            <i class="material-icons-outlined">grid_goldenratio</i>
                        </button>
                        <button class="icon-btn" id="rulerBtn" title="–õ–∏–Ω–µ–π–∫–∏">
                            <i class="material-icons-outlined">straighten</i>
                        </button>
                    </div>
                    
                    <div class="bottom-bar-right">
                        <span class="cursor-position" id="cursorPosition">0, 0</span>
                        <button class="icon-btn" id="fullscreenBtn" title="–ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω">
                            <i class="material-icons-outlined">fullscreen</i>
                        </button>
                    </div>
                </div>
            </main>
            
            
        </div>
        
        <!-- –í–∏–¥–µ–æ –æ–∫–Ω–æ (—Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div class="video-window" id="videoWindow" style="display: none">
            <div class="video-header">
                <span>–í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</span>
                <div class="video-controls">
                    <button class="video-control-btn" id="toggleMicBtn">
                        <i class="material-icons-outlined">mic</i>
                    </button>
                    <button class="video-control-btn" id="toggleCamBtn">
                        <i class="material-icons-outlined">videocam</i>
                    </button>
                    <button class="video-control-btn" id="minimizeVideoBtn">
                        <i class="material-icons-outlined">minimize</i>
                    </button>
                </div>
            </div>
            <div class="video-content" id="videoGrid">
                <!-- –í–∏–¥–µ–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
            </div>
        </div>
        
        <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
        <!-- –û–∫–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
        <div class="modal" id="exportModal" style="display: none">
            <div class="modal-backdrop"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h2>–≠–∫—Å–ø–æ—Ä—Ç –¥–æ—Å–∫–∏</h2>
                    <button class="modal-close" data-modal="exportModal">
                        <i class="material-icons-outlined">close</i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="export-options">
                        <button class="export-option" data-format="png">
                            <i class="material-icons-outlined">image</i>
                            <span>PNG</span>
                            <small>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã—Å–æ–∫–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞</small>
                        </button>
                        <button class="export-option" data-format="jpg">
                            <i class="material-icons-outlined">photo</i>
                            <span>JPEG</span>
                            <small>–°–∂–∞—Ç–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</small>
                        </button>
                        <button class="export-option" data-format="svg">
                            <i class="material-icons-outlined">vector_square</i>
                            <span>SVG</span>
                            <small>–í–µ–∫—Ç–æ—Ä–Ω–∞—è –≥—Ä–∞—Ñ–∏–∫–∞</small>
                        </button>
                        <button class="export-option" data-format="pdf">
                            <i class="material-icons-outlined">picture_as_pdf</i>
                            <span>PDF</span>
                            <small>–î–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –ø–µ—á–∞—Ç–∏</small>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –û–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
        <div class="modal" id="settingsModal" style="display: none">
            <div class="modal-backdrop"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                    <button class="modal-close" data-modal="settingsModal">
                        <i class="material-icons-outlined">close</i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
                </div>
            </div>
        </div>
        
        <!-- –û–∫–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–∫–∞ -->
        <div class="modal" id="endLessonModal" style="display: none">
            <div class="modal-backdrop"></div>
            <div class="modal-content" style="max-width: 400px">
                <div class="modal-header">
                    <h2>–ó–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫?</h2>
                    <button class="modal-close" data-modal="endLessonModal">
                        <i class="material-icons-outlined">close</i>
                    </button>
                </div>
                <div class="modal-body">
                    <p style="margin-bottom: 20px; color: var(--text-secondary)">
                        –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.
                    </p>
                    
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="saveBoardOnEnd" checked>
                            <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–æ—Å–∫–∏</span>
                        </label>
                        
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="exportBoardOnEnd">
                            <span>–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å–∫—É –≤ PDF</span>
                        </label>
                    </div>
                </div>
                <div class="modal-footer" style="padding: 20px; border-top: 1px solid var(--border-color); display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="modal-btn" onclick="document.getElementById('endLessonModal').style.display='none'" style="padding: 10px 20px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button class="modal-btn danger" onclick="confirmEndLesson()" style="padding: 10px 20px; background: var(--error); color: white; border: none; border-radius: 8px; cursor: pointer;">
                        –ó–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ü–∞–Ω–µ–ª—å –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div class="active-users-panel" id="activeUsersPanel">
        <h4>üë• –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h4>
        <div id="activeUsersList">
            <div class="no-users">–ù–µ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
        </div>
    </div>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ -->
    <div class="sync-indicator" id="syncIndicator">
        <span class="sync-icon">üîÑ</span>
        <span class="sync-text">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
    </div>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ -->
    <div class="performance-indicator" id="performanceIndicator" style="position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 6px; font-family: monospace; font-size: 12px; z-index: 9999; display: none;">
        <div>FPS: <span id="fpsValue">60</span></div>
        <div>Objects: <span id="objectsValue">0</span></div>
        <div>Points: <span id="pointsValue">0</span></div>
        <div>Render: <span id="renderTimeValue">0</span>ms</div>
    </div>
    
    <!-- –¢–æ—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- –°–∫—Ä–∏–ø—Ç—ã -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js"></script>
    
    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥—É–ª–∏ –¥–æ—Å–∫–∏ -->
    <script th:src="@{/js/professional-board-performance.js}"></script>
    <script th:src="@{/js/professional-board-brush-optimizer.js}"></script>
    <script th:src="@{/js/professional-board-sync.js}"></script>
    <script th:src="@{/js/professional-board-core.js}"></script>
    <script th:src="@{/js/professional-board-renderer.js}"></script>
    <script th:src="@{/js/professional-board-tools.js}"></script>
    <script th:src="@{/js/professional-board-modules.js}"></script>
    <!-- <script th:src="@{/js/professional-board.js}"></script> -->
    
    <!-- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–∞–±–æ—á–∞—è –≤–µ—Ä—Å–∏—è -->
    <script th:src="@{/js/professional-board-minimal.js}"></script>
    
    <!-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è -->
    <script th:inline="javascript">
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —É—Ä–æ–∫–∞ –∏–∑ –º–æ–¥–µ–ª–∏
        const lessonData = /*[[${lesson}]]*/ null;
        const currentUser = /*[[${currentUser}]]*/ null;
        const isTeacher = /*[[${isTeacher}]]*/ false;
        const isAdmin = /*[[${isAdmin}]]*/ false;
        const isViewOnly = /*[[${isViewOnly}]]*/ false;
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ URL (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
        const urlParams = new URLSearchParams(window.location.search);
        const lessonIdFromUrl = urlParams.get('lessonId');
        const lessonId = lessonData ? lessonData.id : (lessonIdFromUrl || 'demo');
        
        console.log('üìã –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ID —É—Ä–æ–∫–∞:');
        console.log('  - lessonData:', lessonData);
        console.log('  - lessonIdFromUrl:', lessonIdFromUrl);
        console.log('  - –∏—Ç–æ–≥–æ–≤—ã–π lessonId:', lessonId);
        
                        // –°–æ–∑–¥–∞–Ω–∏–µ mock –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
                if (!lessonData && lessonId && lessonId !== 'demo') {
                    console.log('‚ö†Ô∏è –°–æ–∑–¥–∞–µ–º mock –¥–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–∞ –¥–ª—è lessonId:', lessonId);
                    const mockLessonData = {
                        id: parseInt(lessonId) || lessonId,
                        subject: { name: '–ü—Ä–µ–¥–º–µ—Ç' },
                        teacher: { id: 1, name: '–£—á–∏—Ç–µ–ª—å' },
                        student: { id: 2, name: '–£—á–µ–Ω–∏–∫' },
                        session: null,
                        currentUserId: 1
                    };
                    window.lessonData = mockLessonData;
                    lessonData = mockLessonData; // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                    console.log('‚úÖ Mock –¥–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–∞ —Å–æ–∑–¥–∞–Ω—ã:', mockLessonData);
                } else {
                    window.lessonData = lessonData;
                    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:', lessonData);
                }
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å professional-board.js
        window.currentUser = currentUser;
        window.isTeacher = isTeacher;
        window.isAdmin = isAdmin;
        window.isViewOnly = isViewOnly;
        window.lessonId = lessonId;
        
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        const currentUserId = currentUser ? currentUser.id : (lessonData ? lessonData.currentUserId : 1);
        const currentUserName = currentUser ? currentUser.name : (currentUser ? currentUser.firstName + ' ' + currentUser.lastName : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
        
        window.currentUserId = currentUserId;
        window.currentUserName = currentUserName;
        
        console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω:', { currentUserId, currentUserName });
        
        // üé® –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è –æ–±–ª–∞—Å—Ç–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
        function showDrawingAreaImmediately() {
            console.log('üé® === –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –ü–û–Ø–í–õ–ï–ù–ò–ï –û–ë–õ–ê–°–¢–ò –†–ò–°–û–í–ê–ù–ò–Ø ===');
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –æ–±–ª–∞—Å—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏—è –≤–∏–¥–Ω–∞
            const canvasArea = document.querySelector('.canvas-area');
            const canvasViewport = document.querySelector('.canvas-viewport');
            const boardCanvas = document.getElementById('boardCanvas');
            
            if (canvasArea) {
                canvasArea.style.display = 'flex';
                canvasArea.style.visibility = 'visible';
                canvasArea.style.opacity = '1';
                canvasArea.style.minHeight = '500px';
                console.log('‚úÖ –û–±–ª–∞—Å—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏—è (.canvas-area) —Å–¥–µ–ª–∞–Ω–∞ –≤–∏–¥–∏–º–æ–π');
            }
            
            if (canvasViewport) {
                canvasViewport.style.display = 'block';
                canvasViewport.style.visibility = 'visible';
                canvasViewport.style.opacity = '1';
                canvasViewport.style.minHeight = '400px';
                canvasViewport.style.minWidth = '400px';
                console.log('‚úÖ Viewport canvas (.canvas-viewport) —Å–¥–µ–ª–∞–Ω –≤–∏–¥–∏–º—ã–º');
            }
            
            if (boardCanvas) {
                boardCanvas.style.display = 'block';
                boardCanvas.style.visibility = 'visible';
                boardCanvas.style.opacity = '1';
                boardCanvas.style.background = '#ffffff';
                boardCanvas.style.border = '1px solid #e0e0e0';
                boardCanvas.style.minWidth = '400px';
                boardCanvas.style.minHeight = '400px';
                console.log('‚úÖ Canvas (#boardCanvas) —Å–¥–µ–ª–∞–Ω –≤–∏–¥–∏–º—ã–º');
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã canvas
                setTimeout(() => {
                    const rect = canvasViewport?.getBoundingClientRect();
                    if (rect && rect.width > 0 && rect.height > 0) {
                        boardCanvas.width = rect.width;
                        boardCanvas.height = rect.height;
                        console.log('üìè –†–∞–∑–º–µ—Ä—ã canvas —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:', rect.width, 'x', rect.height);
                    } else {
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –µ—Å–ª–∏ viewport –Ω–µ –≥–æ—Ç–æ–≤
                        boardCanvas.width = 800;
                        boardCanvas.height = 600;
                        console.log('üìè –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã canvas: 800x600');
                    }
                }, 100);
            }
            
            // –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–∫—Ä—ã—Ç—ã–µ –∫–ª–∞—Å—Å—ã –∏–ª–∏ —Å—Ç–∏–ª–∏
            const hiddenElements = document.querySelectorAll('.canvas-area[style*="display: none"], .canvas-viewport[style*="display: none"], #boardCanvas[style*="display: none"]');
            hiddenElements.forEach(el => {
                el.style.display = '';
                console.log('‚úÖ –£–±—Ä–∞–Ω display:none —Å —ç–ª–µ–º–µ–Ω—Ç–∞:', el.className || el.id);
            });
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–µ–≤—É—é –ø–∞–Ω–µ–ª—å —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏
            const leftPanel = document.getElementById('leftPanel');
            const propertiesToggleBtn = document.getElementById('propertiesToggleBtn');
            
            if (leftPanel && propertiesToggleBtn) {
                setTimeout(() => {
                    leftPanel.classList.add('show');
                    propertiesToggleBtn.classList.add('active');
                    console.log('‚úÖ –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã—Ç–∞');
                }, 500);
            }
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç "–†—É—á–∫–∞" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const penTool = document.querySelector('[data-tool="pen"]');
            if (penTool) {
                setTimeout(() => {
                    penTool.classList.add('active');
                    console.log('‚úÖ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç "–†—É—á–∫–∞" –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é');
                }, 300);
            }
            
            console.log('üé® === –û–ë–õ–ê–°–¢–¨ –†–ò–°–û–í–ê–ù–ò–Ø –ì–û–¢–û–í–ê –ö –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ ===');
        }
        
        // üé® –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –æ–±–ª–∞—Å—Ç–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ—Å–∫–∏
        function makeDrawingAreaActive() {
            console.log('üé® === –ê–ö–¢–ò–í–ê–¶–ò–Ø –û–ë–õ–ê–°–¢–ò –†–ò–°–û–í–ê–ù–ò–Ø ===');
            
            const boardCanvas = document.getElementById('boardCanvas');
            if (!boardCanvas) {
                console.error('‚ùå Canvas –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏!');
                return;
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
            boardCanvas.style.cursor = 'crosshair';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            setTimeout(() => {
                showToast('üé® –û–±–ª–∞—Å—Ç—å –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –≥–æ—Ç–æ–≤–∞! –ù–∞—á–Ω–∏—Ç–µ —Ä–∏—Å–æ–≤–∞—Ç—å.', 'success');
            }, 1000);
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ canvas –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π
            setTimeout(() => {
                boardCanvas.focus();
                console.log('‚úÖ Canvas —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π');
            }, 500);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
            const canvasArea = document.querySelector('.canvas-area');
            if (canvasArea) {
                canvasArea.style.boxShadow = '0 0 10px rgba(94, 92, 230, 0.3)';
                setTimeout(() => {
                    canvasArea.style.boxShadow = '';
                }, 2000);
            }
            
            console.log('‚úÖ –û–±–ª–∞—Å—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞');
        }

        // –§—É–Ω–∫—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        function setupPerformanceMonitoring() {
            console.log('üìä –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏...');
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
            const isDebugMode = window.location.hostname === 'localhost' || window.location.search.includes('debug=true');
            
            if (isDebugMode) {
                const performanceIndicator = document.getElementById('performanceIndicator');
                if (performanceIndicator) {
                    performanceIndicator.style.display = 'block';
                }
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
                setInterval(() => {
                    updatePerformanceUI();
                }, 1000);
            }
            
            // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.shiftKey) {
                    switch (e.key) {
                        case 'P': // Ctrl+Shift+P - –ø–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                            e.preventDefault();
                            togglePerformanceIndicator();
                            break;
                        case 'M': // Ctrl+Shift+M - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏
                            e.preventDefault();
                            forceMemoryCleanup();
                            break;
                    }
                }
            });
        }
        
        function updatePerformanceUI() {
            const boardInstance = getBoard();
            if (!boardInstance || !boardInstance.modules.performance) return;
            
            const metrics = boardInstance.modules.performance.getMetrics();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –≤ UI
            const fpsValue = document.getElementById('fpsValue');
            const objectsValue = document.getElementById('objectsValue');
            const pointsValue = document.getElementById('pointsValue');
            const renderTimeValue = document.getElementById('renderTimeValue');
            
            if (fpsValue) fpsValue.textContent = metrics.fps || '60';
            if (objectsValue) objectsValue.textContent = metrics.objectCount || '0';
            if (pointsValue) pointsValue.textContent = metrics.pointCount || '0';
            if (renderTimeValue) renderTimeValue.textContent = (metrics.renderTime || 0).toFixed(1);
            
            // –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            const performanceIndicator = document.getElementById('performanceIndicator');
            if (performanceIndicator && metrics.fps) {
                if (metrics.fps >= 50) {
                    performanceIndicator.style.borderLeft = '4px solid #10b981'; // –ó–µ–ª–µ–Ω—ã–π
                } else if (metrics.fps >= 30) {
                    performanceIndicator.style.borderLeft = '4px solid #f59e0b'; // –ñ–µ–ª—Ç—ã–π
                } else {
                    performanceIndicator.style.borderLeft = '4px solid #ef4444'; // –ö—Ä–∞—Å–Ω—ã–π
                }
            }
        }
        
        function togglePerformanceIndicator() {
            const performanceIndicator = document.getElementById('performanceIndicator');
            if (performanceIndicator) {
                const isVisible = performanceIndicator.style.display !== 'none';
                performanceIndicator.style.display = isVisible ? 'none' : 'block';
                showToast(isVisible ? '–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–∫—Ä—ã—Ç' : '–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–∫–∞–∑–∞–Ω', 'info');
            }
        }
        
        function forceMemoryCleanup() {
            const boardInstance = getBoard();
            if (boardInstance && boardInstance.modules.memory) {
                boardInstance.modules.memory.forceCleanup();
                showToast('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞', 'success');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω–∞ —Å—Ä–∞–∑—É)
        function showToast(message, type = 'info') {
            console.log(`Toast [${type}]: ${message}`);
            
            // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è —Ç–æ—Å—Ç–æ–≤ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            let toastContainer = document.querySelector('.toast-container') || document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container';
                toastContainer.id = 'toastContainer';
                toastContainer.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    pointer-events: none;
                `;
                document.body.appendChild(toastContainer);
            }
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.style.cssText = `
                background: ${type === 'error' ? '#ff4757' : type === 'success' ? '#2ed573' : type === 'warning' ? '#ffa502' : '#3742fa'};
                color: white;
                padding: 12px 20px;
                margin-bottom: 10px;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transform: translateX(100%);
                transition: transform 0.3s ease;
                pointer-events: auto;
                max-width: 300px;
                word-wrap: break-word;
            `;
            
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            toast.innerHTML = `${icon} ${message}`;
            
            toastContainer.appendChild(toast);
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 10);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –¥–æ—Å–∫–∏
        window.board = null; // –î–µ–ª–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≥–ª–æ–±–∞–ª—å–Ω–æ–π
        window.professionalBoardInstance = null; // –†–µ–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –¥–æ—Å–∫–∏
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –¥–æ—Å–∫–∏...');
            console.log('–î–∞–Ω–Ω—ã–µ —É—Ä–æ–∫–∞:', lessonData);
            console.log('ID —É—Ä–æ–∫–∞:', lessonId);
            
            // –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∞—Å—Å–æ–≤
            console.log('üîç === –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ó–ê–ì–†–£–ó–ö–ò –ö–õ–ê–°–°–û–í ===');
            console.log('ProfessionalBoard –¥–æ—Å—Ç—É–ø–µ–Ω:', typeof ProfessionalBoard !== 'undefined');
            console.log('getBoard —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞:', typeof getBoard !== 'undefined');
            console.log('setRealBoardInstance —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞:', typeof setRealBoardInstance !== 'undefined');
            console.log('window.professionalBoardInstance:', !!window.professionalBoardInstance);
            console.log('üîç === –ö–û–ù–ï–¶ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò –ö–õ–ê–°–°–û–í ===');
            
            // üé® –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –ü–û–Ø–í–õ–ï–ù–ò–ï –û–ë–õ–ê–°–¢–ò –†–ò–°–û–í–ê–ù–ò–Ø
            showDrawingAreaImmediately();
            
            try {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± —É—Ä–æ–∫–µ
                if (lessonData) {
                    const titleInput = document.getElementById('boardTitle');
                    if (titleInput) {
                        titleInput.value = `${lessonData.subject?.name || '–ü—Ä–µ–¥–º–µ—Ç'} - ${lessonData.student?.name || '–£—á–µ–Ω–∏–∫'}`;
                        titleInput.setAttribute('readonly', 'readonly');
                    }
                }
                
                // –°–∫—Ä—ã—Ç–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                if (isViewOnly) {
                    document.querySelectorAll('.tool-btn, #saveBtn, #exportModal, #endLessonBtn').forEach(el => {
                        if (el) el.style.display = 'none';
                    });
                }
                
                // –ü–æ–∫–∞–∑ –∫–Ω–æ–ø–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è —É—á–∏—Ç–µ–ª—è
                const endLessonBtn = document.getElementById('endLessonBtn');
                if (endLessonBtn && !isTeacher && !isAdmin) {
                    endLessonBtn.style.display = 'none';
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ canvas
                const canvas = document.getElementById('boardCanvas');
                if (!canvas) {
                    console.error('‚ùå Canvas —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                    showToast('–û—à–∏–±–∫–∞: Canvas –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                    return;
                }
                
                console.log('‚úÖ Canvas –Ω–∞–π–¥–µ–Ω:', canvas);
                console.log('üìè Canvas —Ä–∞–∑–º–µ—Ä—ã:', canvas.offsetWidth, 'x', canvas.offsetHeight);
                console.log('üìè Canvas parent —Ä–∞–∑–º–µ—Ä—ã:', canvas.parentElement.offsetWidth, 'x', canvas.parentElement.offsetHeight);
                console.log('üìè Canvas –≤ DOM:', canvas.isConnected);
                console.log('üìè Canvas display:', getComputedStyle(canvas).display);
                console.log('üìè Canvas visibility:', getComputedStyle(canvas).visibility);
                
                // –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ—Å–∫–∏
                console.log('üé® –°–æ–∑–¥–∞–µ–º –¥–æ—Å–∫—É...');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∞—Å—Å ProfessionalBoard –¥–æ—Å—Ç—É–ø–µ–Ω
                console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∞—Å—Å–∞ ProfessionalBoard...');
                console.log('  - typeof ProfessionalBoard:', typeof ProfessionalBoard);
                console.log('  - window.ProfessionalBoard:', !!window.ProfessionalBoard);
                
                if (typeof ProfessionalBoard === 'undefined') {
                    console.error('‚ùå –ö–ª–∞—Å—Å ProfessionalBoard –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!');
                    console.log('üîç –î–æ—Å—Ç—É–ø–Ω—ã–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã:');
                    console.log('  - Canvas2DRenderer:', typeof Canvas2DRenderer);
                    console.log('  - ToolsManager:', typeof ToolsManager);
                    console.log('  - BaseTool:', typeof BaseTool);
                    showToast('–û—à–∏–±–∫–∞: –∫–ª–∞—Å—Å –¥–æ—Å–∫–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ JS —Ñ–∞–π–ª–æ–≤.', 'error');
                    return;
                }
                
                console.log('üîß –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ ProfessionalBoard...');
                console.log('  - Canvas ID: boardCanvas');
                console.log('  - Canvas element:', !!document.getElementById('boardCanvas'));
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º MinimalBoard –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã
                let realBoard;
                if (typeof MinimalBoard !== 'undefined') {
                    console.log('‚úÖ –°–æ–∑–¥–∞–µ–º MinimalBoard');
                    realBoard = new MinimalBoard('boardCanvas');
                } else if (typeof ProfessionalBoard !== 'undefined') {
                    console.log('‚úÖ –°–æ–∑–¥–∞–µ–º ProfessionalBoard');
                    realBoard = new ProfessionalBoard('boardCanvas', {
                        renderer: 'canvas2d',
                        antialiasing: true,
                        gridEnabled: true,
                        gridSize: 20,
                        snapToGrid: false,
                        virtualScrolling: true,
                        maxHistorySize: 50
                    });
                } else {
                    throw new Error('–ù–∏ –æ–¥–∏–Ω –∫–ª–∞—Å—Å –¥–æ—Å–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
                
                console.log('‚úÖ –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä ProfessionalBoard –∑–∞–≤–µ—Ä—à–µ–Ω');
                
                if (!realBoard) {
                    console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –¥–æ—Å–∫—É!');
                    showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ—Å–∫–∏', 'error');
                    return;
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –¥–æ—Å–∫–∏
                window.professionalBoardInstance = realBoard;
                setRealBoardInstance(realBoard);
                
                console.log('‚úÖ –î–æ—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞:', realBoard);
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ—Å–∫–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å
                window.testBoardDrawing = function() {
                    console.log('üß™ === –¢–ï–°–¢ –†–ò–°–û–í–ê–ù–ò–Ø –î–û–°–ö–ò ===');
                    const boardInstance = getBoard();
                    if (!boardInstance) {
                        console.error('‚ùå –î–æ—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
                        return false;
                    }
                    console.log('‚úÖ –î–æ—Å–∫–∞ –Ω–∞–π–¥–µ–Ω–∞:', boardInstance);
                    console.log('‚úÖ Canvas:', boardInstance.canvas);
                    console.log('‚úÖ –ú–æ–¥—É–ª–∏:', Object.keys(boardInstance.modules || {}));
                    
                    // –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ª–∏–Ω–∏—é
                    try {
                        if (boardInstance.canvas) {
                            const ctx = boardInstance.canvas.getContext('2d');
                            ctx.strokeStyle = '#ff0000';
                            ctx.lineWidth = 5;
                            ctx.beginPath();
                            ctx.moveTo(50, 50);
                            ctx.lineTo(150, 150);
                            ctx.stroke();
                            console.log('‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –ª–∏–Ω–∏—è –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–∞!');
                            return true;
                        }
                    } catch (error) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è:', error);
                        return false;
                    }
                };
                
                // üé® –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û –î–ï–õ–ê–ï–ú –û–ë–õ–ê–°–¢–¨ –†–ò–°–û–í–ê–ù–ò–Ø –ê–ö–¢–ò–í–ù–û–ô
                makeDrawingAreaActive();
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                setupPerformanceMonitoring();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–æ—Å–∫—É (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª)
                console.log('üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–æ—Å–∫—É...');
                try {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–ª–æ–∂–µ–Ω–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å canvas
                    setTimeout(() => {
                        console.log('‚è∞ –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ—Å–∫–∏...');
                        const initResult = realBoard.init();
                        console.log('‚úÖ –î–æ—Å–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞:', initResult);
                        
                        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ä–∏—Å—É–µ–º —Å–µ—Ç–∫—É –µ—Å–ª–∏ –¥–æ—Å–∫–∞ –≥–æ—Ç–æ–≤–∞
                        setTimeout(() => {
                            if (realBoard.modules && realBoard.modules.renderer) {
                                console.log('üî≤ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–Ω–¥–µ—Ä–∏–º –¥–æ—Å–∫—É —Å —Å–µ—Ç–∫–æ–π...');
                                realBoard.render();
                            }
                        }, 200);
                        
                        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                        setTimeout(async () => {
                            if (lessonData && lessonData.id && currentUserId && currentUserName) {
                                console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏...');
                                try {
                                    await realBoard.initSync(lessonData.id, currentUserId, currentUserName);
                                    console.log('‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
                                } catch (error) {
                                    console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
                                }
                            } else {
                                console.warn('‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã:', { lessonData, currentUserId, currentUserName });
                            }
                        }, 400);
                    }, 200);
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–æ—Å–∫–∏:', error);
                    showToast('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–æ—Å–∫–∏: ' + error.message, 'error');
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ (—Ç–µ–ø–µ—Ä—å —ç—Ç–æ Proxy)
                const board = window.board;
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UI
                console.log('üîß –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º UI...');
                setupUI();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
                if (typeof initBoard === 'function') {
                    initBoard();
                }
                
                // WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                window.stompClient = null;
                
                if (lessonId && lessonId !== 'demo') {
                    console.log('üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket –¥–ª—è —É—Ä–æ–∫–∞:', lessonId);
                    if (typeof connectWebSocket === 'function') {
                        connectWebSocket();
                    } else {
                        console.warn('‚ö†Ô∏è –§—É–Ω–∫—Ü–∏—è connectWebSocket –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Å–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ');
                        // –ë–∞–∑–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WebSocket –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
                        setTimeout(() => {
                            try {
                                const socket = new SockJS('/ws');
                                window.stompClient = Stomp.over(socket);
                                window.stompClient.debug = null;
                                
                                window.stompClient.connect({}, function(frame) {
                                    console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                                    webSocketConnected = true;
                                    showToast('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω', 'success');
                                    
                                    // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å–∫–∏
                                    window.stompClient.subscribe('/topic/board/' + lessonId, function(message) {
                                        handleBoardMessage(JSON.parse(message.body));
                                    });
                                    
                                    // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏
                                    window.stompClient.subscribe('/user/queue/board/state', function(message) {
                                        handleBoardStateMessage(JSON.parse(message.body));
                                    });
                                    
                                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏
                                    const userId = getUserId();
                                    const userName = getUserName();
                                    
                                    window.stompClient.send("/app/board/" + lessonId + "/join", {}, JSON.stringify({
                                        lessonId: lessonId,
                                        userId: userId,
                                        userName: userName
                                    }));
                                    
                                }, function(error) {
                                    console.error('‚ùå –û—à–∏–±–∫–∞ WebSocket:', error);
                                    webSocketConnected = false;
                                    showToast('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WebSocket', 'error');
                                });
                            } catch (error) {
                                console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ WebSocket:', error);
                                showToast('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ WebSocket', 'error');
                            }
                        }, 1000);
                    }
                } else {
                    console.log('üìù –î–µ–º–æ —Ä–µ–∂–∏–º - WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è');
                    showToast('–î–µ–º–æ —Ä–µ–∂–∏–º - —Ä–∞–±–æ—Ç–∞ –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞', 'info');
                }
                
                console.log('üéâ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                showToast('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + error.message, 'error');
                
                // Fallback: –ø–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                console.log('üîÑ –ó–∞–ø—É—Å–∫–∞–µ–º fallback –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã...');
                setTimeout(() => {
                    console.log('üöÄ –ü–æ–ø—ã—Ç–∫–∞ fallback –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏...');
                    if (typeof window.forceInitializeBoard === 'function') {
                        const success = window.forceInitializeBoard();
                        if (success) {
                            console.log('‚úÖ Fallback –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
                            showToast('–î–æ—Å–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ fallback', 'success');
                            
                            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UI –ø–æ—Å–ª–µ fallback –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                            if (typeof setupUI === 'function') {
                                setupUI();
                            }
                        } else {
                            console.error('‚ùå Fallback –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å');
                            showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å–∫—É', 'error');
                        }
                    } else {
                        console.error('‚ùå –§—É–Ω–∫—Ü–∏—è forceInitializeBoard –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞');
                        showToast('–§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
                    }
                }, 2000);
            }
            
            // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é connectWebSocket, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ –µ—Å—Ç—å –≤ professional-board.js
            
            function handleBoardMessage(message) {
                console.log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ—Å–∫–∏:', message);
                
                if (message.type === 'board_update' && message.content && board) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å–∫—É —Å –Ω–æ–≤—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º
                    board.import(message.content, 'json').then(() => {
                        board.render();
                        console.log('–î–æ—Å–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑ WebSocket');
                    }).catch(error => {
                        console.error('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –¥–æ—Å–∫–∏:', error);
                    });
                } else if (message.type === 'user_joined') {
                    showToast(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${message.userName} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –¥–æ—Å–∫–µ`, 'info');
                } else if (message.type === 'user_left') {
                    showToast(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${message.userName} –ø–æ–∫–∏–Ω—É–ª –¥–æ—Å–∫—É`, 'info');
                } else if (message.type === 'draw_operation' && board) {
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∏—Å–æ–≤–∞–Ω–∏—è –æ—Ç –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ —Ä–∏—Å–æ–≤–∞–Ω–∏—è:', message);
                    handleDrawOperation(message);
                }
            }
            
            function handleDrawOperation(data) {
                if (!board || !data.operationType) return;
                
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
                if (data.userId.toString() === (currentUser ? currentUser.id.toString() : '1')) {
                    return;
                }
                
                console.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏—è:', data.operationType);
                
                switch (data.operationType) {
                    case 'start':
                        // –ù–∞—á–∞–ª–æ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
                        if (data.x !== null && data.y !== null) {
                            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —à—Ç—Ä–∏—Ö
                            const stroke = {
                                type: 'stroke',
                                points: [{ x: data.x, y: data.y }],
                                color: data.color || '#000000',
                                brushSize: data.brushSize || 3,
                                opacity: 1,
                                tool: 'pen',
                                timestamp: Date.now()
                            };
                            board.addObject(stroke);
                            board.render();
                        }
                        break;
                        
                    case 'draw':
                        // –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
                        if (data.x !== null && data.y !== null) {
                            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —à—Ç—Ä–∏—Ö—É
                            const lastStroke = board.objects.get(Array.from(board.objects.keys()).pop());
                            if (lastStroke && lastStroke.type === 'stroke') {
                                lastStroke.points.push({ x: data.x, y: data.y });
                                board.render();
                            }
                        }
                        break;
                        
                    case 'end':
                        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∏—Å–æ–≤–∞–Ω–∏—è
                        console.log('–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∏—Å–æ–≤–∞–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', data.userName);
                        break;
                }
            }
            
            function handleCursorMessage(message) {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∑–∏—Ü–∏–π –∫—É—Ä—Å–æ—Ä–æ–≤ –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                if (message.type === 'cursor_position' && message.userId !== getUserId()) {
                    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –∫—É—Ä—Å–æ—Ä –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    console.log('–ö—É—Ä—Å–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', message.userName, '–≤ –ø–æ–∑–∏—Ü–∏–∏', message.x, message.y);
                }
            }
            
            function handleBoardStateMessage(message) {
                if (message.type === 'board_state' && message.content && board) {
                    console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏ –∏–∑ WebSocket');
                    board.import(message.content, 'json').then(() => {
                        board.render();
                        showToast('–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
                    }).catch(error => {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ—Å–∫–∏:', error);
                    });
                }
            }
            
            function getUserId() {
                return currentUser ? currentUser.id : 'user_' + Math.random().toString(36).substr(2, 9);
            }
            
            function getUserName() {
                return currentUser ? currentUser.name : '–ì–æ—Å—Ç—å';
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –¥–æ—Å–∫–∏
            board.on('toolChanged', (tool) => {
                updateToolButtons(tool);
            });
            
            board.on('historyChanged', (state) => {
                const undoBtn = document.getElementById('undoBtn');
                const redoBtn = document.getElementById('redoBtn');
                if (undoBtn) undoBtn.disabled = !state.canUndo;
                if (redoBtn) redoBtn.disabled = !state.canRedo;
            });
            
            board.on('zoomChanged', (zoom) => {
                const zoomLevel = document.getElementById('zoomLevel');
                if (zoomLevel) zoomLevel.textContent = Math.round(zoom * 100) + '%';
            });
            
            board.on('cursorMove', (pos) => {
                const cursorPosition = document.getElementById('cursorPosition');
                if (cursorPosition) {
                    cursorPosition.textContent = `${Math.round(pos.x)}, ${Math.round(pos.y)}`;
                }
            });
            
            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(() => {
                if (board && lessonId !== 'demo') {
                    saveBoard();
                }
            }, 30000);
            
            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
            board.on('drawEnd', () => {
                if (lessonId !== 'demo') {
                    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
                    clearTimeout(board.saveTimeout);
                    board.saveTimeout = setTimeout(() => {
                        saveBoard();
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ WebSocket
                        if (stompClient && stompClient.connected) {
                            board.exportAs('json').then(content => {
                                stompClient.send("/app/board/" + lessonId + "/update", {}, JSON.stringify({
                                    lessonId: lessonId,
                                    userId: getUserId(),
                                    userName: getUserName(),
                                    content: content,
                                    action: 'draw_end'
                                }));
                            });
                        }
                    }, 1000);
                }
            });
            
            board.on('objectAdded', () => {
                if (lessonId !== 'demo') {
                    clearTimeout(board.saveTimeout);
                    board.saveTimeout = setTimeout(() => {
                        saveBoard();
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ WebSocket
                        if (stompClient && stompClient.connected) {
                            board.exportAs('json').then(content => {
                                stompClient.send("/app/board/" + lessonId + "/update", {}, JSON.stringify({
                                    lessonId: lessonId,
                                    userId: getUserId(),
                                    userName: getUserName(),
                                    content: content,
                                    action: 'object_added'
                                }));
                            });
                        }
                    }, 1000);
                }
            });
            
            board.on('objectModified', () => {
                if (lessonId !== 'demo') {
                    clearTimeout(board.saveTimeout);
                    board.saveTimeout = setTimeout(() => {
                        saveBoard();
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ WebSocket
                        if (stompClient && stompClient.connected) {
                            board.exportAs('json').then(content => {
                                stompClient.send("/app/board/" + lessonId + "/update", {}, JSON.stringify({
                                    lessonId: lessonId,
                                    userId: getUserId(),
                                    userName: getUserName(),
                                    content: content,
                                    action: 'object_modified'
                                }));
                            });
                        }
                    }, 1000);
                }
            });
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–∑–∏—Ü–∏–∏ –∫—É—Ä—Å–æ—Ä–∞
            board.on('cursorMove', (pos) => {
                if (lessonId !== 'demo' && stompClient && stompClient.connected) {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º —á–∞—Å—Ç–æ—Ç—ã
                    clearTimeout(board.cursorTimeout);
                    board.cursorTimeout = setTimeout(() => {
                        stompClient.send("/app/board/" + lessonId + "/cursor", {}, JSON.stringify({
                            lessonId: lessonId,
                            userId: getUserId(),
                            userName: getUserName(),
                            x: pos.x,
                            y: pos.y
                        }));
                    }, 100); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 10 —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É
                }
            });
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ—Å–∫–∏
            loadSavedBoard();
        });
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UI
        function setupUI() {
            console.log('üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UI...');
            console.log('–î–æ—Å–∫–∞:', board);
            
            if (!board) {
                console.error('‚ùå –î–æ—Å–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ UI!');
                return;
            }
            
            // –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
            const toolButtons = document.querySelectorAll('.tool-btn');
            console.log('üîß –ù–∞–π–¥–µ–Ω–æ –∫–Ω–æ–ø–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤:', toolButtons.length);
            
            toolButtons.forEach((btn, index) => {
                console.log(`üîß –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É ${index + 1}:`, btn.dataset.tool);
                
                btn.addEventListener('click', function() {
                    console.log('üñ±Ô∏è –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞:', this.dataset.tool);
                    
                    if (!board) {
                        console.error('‚ùå –î–æ—Å–∫–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞!');
                        showToast('–î–æ—Å–∫–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞', 'error');
                        return;
                    }
                    
                    const tool = this.dataset.tool;
                    const shape = this.dataset.shape;
                    
                    try {
                        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
                        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
                        if (board.modules && board.modules.tools) {
                            board.modules.tools.setActiveTool(tool);
                            console.log('‚úÖ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', tool);
                            
                            if (tool === 'shape' && shape && board.modules.tools.activeTool && board.modules.tools.activeTool.setShapeType) {
                                board.modules.tools.activeTool.setShapeType(shape);
                            }
                        } else {
                            console.warn('‚ö†Ô∏è –ú–æ–¥—É–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç—É—é —Å–º–µ–Ω—É');
                            if (board.state) {
                                board.state.selectedTool = tool;
                            }
                            if (board.emit) {
                                board.emit('toolChanged', tool);
                            }
                        }
                        
                        showToast(`–í—ã–±—Ä–∞–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: ${tool}`, 'info');
                        
                    } catch (error) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞:', error);
                        showToast('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞', 'error');
                    }
                });
            });
            
            // –¶–≤–µ—Ç–∞
            const colorButtons = document.querySelectorAll('.color-btn');
            console.log('–ù–∞–π–¥–µ–Ω–æ –∫–Ω–æ–ø–æ–∫ —Ü–≤–µ—Ç–æ–≤:', colorButtons.length);
            
            colorButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    console.log('–í—ã–±—Ä–∞–Ω —Ü–≤–µ—Ç:', this.dataset.color);
                    if (!board) return;
                    
                    document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    board.state.selectedColor = this.dataset.color;
                });
            });
            
            // –í—ã–±–æ—Ä —Ü–≤–µ—Ç–∞
            const colorPicker = document.getElementById('colorPicker');
            if (colorPicker) {
                colorPicker.addEventListener('change', function() {
                    console.log('–í—ã–±—Ä–∞–Ω —Ü–≤–µ—Ç –∏–∑ –ø–∏–∫–µ—Ä–∞:', this.value);
                    if (board) {
                        board.state.selectedColor = this.value;
                        document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                    }
                });
            }
            
            // –†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏
            const brushSize = document.getElementById('brushSize');
            const brushSizeValue = document.getElementById('brushSizeValue');
            
            if (brushSize && brushSizeValue) {
                brushSize.addEventListener('input', function() {
                    console.log('–†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω:', this.value);
                    if (board) {
                        board.state.brushSize = parseInt(this.value);
                        brushSizeValue.textContent = this.value;
                        console.log('–ù–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', board.state.brushSize);
                    }
                });
            }
            
            // –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å
            const opacitySlider = document.getElementById('opacity');
            const opacityValue = document.getElementById('opacityValue');
            
            if (opacitySlider && opacityValue) {
                opacitySlider.addEventListener('input', function() {
                    console.log('–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∞:', this.value);
                    if (board) {
                        board.state.opacity = parseInt(this.value) / 100;
                        opacityValue.textContent = this.value + '%';
                        console.log('–ù–æ–≤–∞—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞:', board.state.opacity);
                    }
                });
            }
            
            // –ó—É–º
            const zoomInBtn = document.getElementById('zoomInBtn');
            const zoomOutBtn = document.getElementById('zoomOutBtn');
            const zoomFitBtn = document.getElementById('zoomFitBtn');
            
            if (zoomInBtn && board) {
                zoomInBtn.addEventListener('click', () => {
                    console.log('–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∑—É–º–∞');
                    const centerX = board.canvas.width / (2 * board.dpr);
                    const centerY = board.canvas.height / (2 * board.dpr);
                    board.zoomAt(centerX, centerY, board.state.zoom * 1.2);
                });
            }
            
            if (zoomOutBtn && board) {
                zoomOutBtn.addEventListener('click', () => {
                    console.log('–£–º–µ–Ω—å—à–µ–Ω–∏–µ –∑—É–º–∞');
                    const centerX = board.canvas.width / (2 * board.dpr);
                    const centerY = board.canvas.height / (2 * board.dpr);
                    board.zoomAt(centerX, centerY, board.state.zoom / 1.2);
                });
            }
            
            if (zoomFitBtn && board) {
                zoomFitBtn.addEventListener('click', () => {
                    console.log('–ó—É–º –ø–æ —Ä–∞–∑–º–µ—Ä—É');
                    const centerX = board.canvas.width / (2 * board.dpr);
                    const centerY = board.canvas.height / (2 * board.dpr);
                    board.zoomAt(centerX, centerY, 1);
                });
            }
            
            // –ò—Å—Ç–æ—Ä–∏—è
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            
            if (undoBtn && board) {
                undoBtn.addEventListener('click', () => {
                    console.log('–û—Ç–º–µ–Ω–∞');
                    board.undo();
                });
            }
            
            if (redoBtn && board) {
                redoBtn.addEventListener('click', () => {
                    console.log('–ü–æ–≤—Ç–æ—Ä');
                    board.redo();
                });
            }
            
            // –û—á–∏—Å—Ç–∫–∞ –¥–æ—Å–∫–∏
            const clearBoardBtn = document.getElementById('clearBoardBtn');
            if (clearBoardBtn && board) {
                clearBoardBtn.addEventListener('click', () => {
                    console.log('–û—á–∏—Å—Ç–∫–∞ –¥–æ—Å–∫–∏');
                    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –¥–æ—Å–∫—É?')) {
                        board.clear();
                    }
                });
            }
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ—Å–∫–∏
            const saveBoardBtn = document.getElementById('saveBoardBtn');
            if (saveBoardBtn && board) {
                saveBoardBtn.addEventListener('click', () => {
                    console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ—Å–∫–∏');
                    saveBoard();
                });
            }
            
            // –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            if (fullscreenBtn) {
                fullscreenBtn.addEventListener('click', toggleFullscreen);
            }
            
            // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —É—Ä–æ–∫–∞
            const endLessonBtn = document.getElementById('endLessonBtn');
            if (endLessonBtn) {
                endLessonBtn.addEventListener('click', showEndLessonModal);
            }
            
            // –í–∏–¥–µ–æ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è
            const videoBtn = document.getElementById('videoBtn');
            if (videoBtn) {
                videoBtn.addEventListener('click', toggleVideo);
            }
            
            // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–Ω–µ–ª—è–º–∏
            const propertiesToggleBtn = document.getElementById('propertiesToggleBtn');
            const closePropertiesBtn = document.getElementById('closePropertiesBtn');
            
            if (propertiesToggleBtn) {
                propertiesToggleBtn.addEventListener('click', toggleLeftPanel);
            }
            
            if (closePropertiesBtn) {
                closePropertiesBtn.addEventListener('click', closeLeftPanel);
            }
            
            // –°–ª–æ–∏
            const addLayerBtn = document.getElementById('addLayerBtn');
            if (addLayerBtn) {
                addLayerBtn.addEventListener('click', addNewLayer);
            }
            
            // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
            document.addEventListener('keydown', function(event) {
                if (!event.ctrlKey && !event.altKey && !event.metaKey) {
                    switch(event.key.toLowerCase()) {
                        case 'p':
                            selectTool('pen');
                            break;
                        case 'h':
                            selectTool('highlighter');
                            break;
                        case 'e':
                            selectTool('eraser');
                            break;
                        case 't':
                            selectTool('text');
                            break;
                        case 's':
                            selectTool('shape');
                            break;
                        case 'l':
                            selectTool('laser');
                            break;
                        case ' ':
                            event.preventDefault();
                            selectTool('hand');
                            break;
                        case 'v':
                            selectTool('select');
                            break;
                    }
                }
            });
            
            console.log('UI –Ω–∞—Å—Ç—Ä–æ–µ–Ω!');
        }
        
        // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
        function selectTool(toolName) {
            console.log('–í—ã–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞:', toolName);
            
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É
            const selectedBtn = document.querySelector(`[data-tool="${toolName}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
                console.log('–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω:', toolName);
            } else {
                console.warn('–ö–Ω–æ–ø–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', toolName);
            }
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–Ω–µ–ª—è–º–∏
        function toggleLeftPanel() {
            console.log('toggleLeftPanel –≤—ã–∑–≤–∞–Ω–∞');
            const leftPanel = document.getElementById('leftPanel');
            const toggleBtn = document.getElementById('propertiesToggleBtn');
            
            if (!leftPanel || !toggleBtn) {
                console.error('–≠–ª–µ–º–µ–Ω—Ç—ã –ø–∞–Ω–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                return;
            }
            
            if (leftPanel.classList.contains('show')) {
                leftPanel.classList.remove('show');
                toggleBtn.classList.remove('active');
                console.log('–ü–∞–Ω–µ–ª—å —Å–≤–æ–π—Å—Ç–≤ –∑–∞–∫—Ä—ã—Ç–∞');
            } else {
                leftPanel.classList.add('show');
                toggleBtn.classList.add('active');
                console.log('–ü–∞–Ω–µ–ª—å —Å–≤–æ–π—Å—Ç–≤ –æ—Ç–∫—Ä—ã—Ç–∞');
            }
        }
        
        function closeLeftPanel() {
            const leftPanel = document.getElementById('leftPanel');
            const toggleBtn = document.getElementById('propertiesToggleBtn');
            if (leftPanel && toggleBtn) {
                leftPanel.classList.remove('show');
                toggleBtn.classList.remove('active');
                console.log('–ü–∞–Ω–µ–ª—å —Å–≤–æ–π—Å—Ç–≤ –∑–∞–∫—Ä—ã—Ç–∞');
            }
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        function updateToolButtons(tool) {
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tool === tool) {
                    btn.classList.add('active');
                }
            });
        }
        
        function addNewLayer() {
            try {
                const layerId = 'layer_' + Date.now();
                const layerName = `–°–ª–æ–π ${board.layers.size + 1}`;
                
                // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–≥–æ —Å–ª–æ—è
                const layer = {
                    id: layerId,
                    name: layerName,
                    visible: true,
                    locked: false,
                    opacity: 1,
                    objects: new Map()
                };
                
                board.layers.set(layerId, layer);
                board.activeLayerId = layerId;
                
                updateLayersList();
                showToast(`–°–ª–æ–π "${layerName}" —Å–æ–∑–¥–∞–Ω`, 'success');
            } catch (error) {
                showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–æ—è: ' + error.message, 'error');
            }
        }
        
        function updateLayersList() {
            const container = document.getElementById('layersList');
            container.innerHTML = '';
            
            const layers = Array.from(board.layers.values()).reverse();
            
            layers.forEach(layer => {
                const item = document.createElement('div');
                item.className = 'layer-item' + (layer.id === board.activeLayerId ? ' active' : '');
                item.innerHTML = `
                    <button class="layer-visibility" data-layer="${layer.id}">
                        <i class="material-icons-outlined">${layer.visible ? 'visibility' : 'visibility_off'}</i>
                    </button>
                    <span class="layer-name">${layer.name}</span>
                    <button class="layer-menu" data-layer="${layer.id}">
                        <i class="material-icons-outlined">more_vert</i>
                    </button>
                `;
                
                item.addEventListener('click', () => {
                    board.activeLayerId = layer.id;
                    updateLayersList();
                });
                
                container.appendChild(item);
            });
        }
        
        function toggleVideo() {
            const videoWindow = document.getElementById('videoWindow');
            videoWindow.style.display = videoWindow.style.display === 'none' ? 'flex' : 'none';
        }
        
        function exportBoard(format) {
            try {
                // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞
                const canvas = board.canvas;
                const dataURL = canvas.toDataURL(`image/${format}`);
                
                // –°–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                const link = document.createElement('a');
                link.download = `board_${new Date().getTime()}.${format}`;
                link.href = dataURL;
                link.click();
                
                showToast(`–î–æ—Å–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –∫–∞–∫ ${format.toUpperCase()}`, 'success');
            } catch (error) {
                showToast('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + error.message, 'error');
            }
        }
        
        async function saveBoard() {
            if (!board) {
                console.error('–î–æ—Å–∫–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
                showToast('–î–æ—Å–∫–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞', 'error');
                return;
            }
            
            try {
                console.log('–ù–∞—á–∏–Ω–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ—Å–∫–∏...');
                
                // –ü–æ–ª—É—á–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–æ—Å–∫–∏
                const content = await board.exportAs('json');
                console.log('–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–æ—Å–∫–∏ –ø–æ–ª—É—á–µ–Ω–æ:', content);
                
                // –î–ª—è –¥–µ–º–æ —Ä–µ–∂–∏–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                if (lessonId === 'demo') {
                    localStorage.setItem('demo_board_content', content);
                    console.log('–î–µ–º–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ localStorage');
                    
                    // –ü–æ–∫–∞–∑ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                    const saveIndicator = document.getElementById('saveIndicator');
                    if (saveIndicator) {
                        saveIndicator.style.opacity = '1';
                        setTimeout(() => {
                            saveIndicator.style.opacity = '0.5';
                        }, 2000);
                    }
                    
                    showToast('–î–µ–º–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
                    return;
                }
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                if (stompClient && stompClient.connected) {
                    stompClient.send("/app/board/" + lessonId + "/update", {}, JSON.stringify({
                        lessonId: lessonId,
                        userId: getUserId(),
                        userName: getUserName(),
                        content: content,
                        action: 'manual_save'
                    }));
                }
                
                // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ REST API
                const response = await fetch(`/api/board/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        lessonId: lessonId || 'demo',
                        content: content
                    })
                });
                
                console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', result);
                    if (result.success) {
                        showToast(result.message || '–î–æ—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
                    } else {
                        showToast(result.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', errorText);
                    showToast(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${response.status}`, 'error');
                }
                
                // –ü–æ–∫–∞–∑ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                const saveIndicator = document.getElementById('saveIndicator');
                if (saveIndicator) {
                    saveIndicator.style.opacity = '1';
                    setTimeout(() => {
                        saveIndicator.style.opacity = '0.5';
                    }, 2000);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'error');
            }
        }
        
        async function loadSavedBoard() {
            if (!board) return;
            
            // –î–ª—è –¥–µ–º–æ —Ä–µ–∂–∏–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º localStorage
            if (lessonId === 'demo') {
                try {
                    const savedContent = localStorage.getItem('demo_board_content');
                    if (savedContent) {
                        console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ–º–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ localStorage:', savedContent);
                        await board.import(savedContent, 'json');
                        board.render();
                        showToast('–î–µ–º–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ–º–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è:', error);
                }
                return;
            }
            
            try {
                console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏...');
                
                const response = await fetch(`/api/board/load/${lessonId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.content) {
                        console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏:', result.content);
                        
                        // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –¥–æ—Å–∫—É
                        await board.import(result.content, 'json');
                        board.render();
                        
                        showToast('–°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
                    }
                } else {
                    console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ—Å–∫–∏:', error);
            }
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <i class="material-icons-outlined">${getToastIcon(type)}</i>
                <span>${message}</span>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function getToastIcon(type) {
            switch (type) {
                case 'success': return 'check_circle';
                case 'error': return 'error';
                case 'warning': return 'warning';
                default: return 'info';
            }
        }
        
        function getUserId() {
            // –ü–æ–ª—É—á–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö
            return currentUser ? currentUser.id : ('user_' + Math.random().toString(36).substr(2, 9));
        }
        
        function getUserName() {
            // –ü–æ–ª—É—á–∏—Ç—å –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö
            return currentUser ? currentUser.name : '–ì–æ—Å—Ç—å';
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–∫–∞
        function showEndLessonModal() {
            document.getElementById('endLessonModal').style.display = 'flex';
        }
        
        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–∫–∞
        async function confirmEndLesson() {
            const saveBoard = document.getElementById('saveBoardOnEnd').checked;
            const exportPDF = document.getElementById('exportBoardOnEnd').checked;
            
            try {
                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ—Å–∫–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                if (saveBoard) {
                    await saveBoard();
                }
                
                // –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                if (exportPDF) {
                    await exportBoard('png'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º PNG –≤–º–µ—Å—Ç–æ PDF
                }
                
                // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç —Å–æ–≤–º–µ—Å—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã
                if (board.modules.collaboration && board.modules.collaboration.disconnect) {
                    board.modules.collaboration.disconnect();
                }
                
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —É—Ä–æ–∫–∞
                if (lessonData && lessonId !== 'demo') {
                    const response = await fetch(`/api/lessons/${lessonId}/end`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            saveBoard: saveBoard,
                            boardContent: saveBoard ? 'board_data' : null
                        })
                    });
                    
                    if (response.ok) {
                        showToast('–£—Ä–æ–∫ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω', 'success');
                        setTimeout(() => {
                            window.location.href = '/dashboard';
                        }, 1500);
                    } else {
                        showToast('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–∫–∞', 'error');
                    }
                } else {
                    // –î–ª—è –¥–µ–º–æ —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                    window.location.href = '/dashboard';
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —É—Ä–æ–∫–∞:', error);
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —É—Ä–æ–∫–∞', 'error');
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', function(e) {
            if (board) {
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
                if (lessonId === 'demo') {
                    // –î–ª—è –¥–µ–º–æ —Ä–µ–∂–∏–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                    try {
                        const content = board.exportAs('json');
                        localStorage.setItem('demo_board_content', content);
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏:', error);
                    }
                } else {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≤—ã—Ö–æ–¥–µ —á–µ—Ä–µ–∑ WebSocket
                    if (stompClient && stompClient.connected) {
                        stompClient.send("/app/board/" + lessonId + "/leave", {}, JSON.stringify({
                            lessonId: lessonId,
                            userId: getUserId(),
                            userName: getUserName()
                        }));
                        
                        // –û—Ç–∫–ª—é—á–∞–µ–º WebSocket
                        stompClient.disconnect();
                    }
                    
                    // –î–ª—è –æ–±—ã—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                    e.preventDefault();
                    e.returnValue = '';
                }
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤)
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden' && board && lessonId === 'demo') {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                try {
                    const content = board.exportAs('json');
                    localStorage.setItem('demo_board_content', content);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏:', error);
                }
            }
        });
    </script>
    
</body>
</html>
