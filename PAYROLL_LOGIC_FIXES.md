# Исправления логики вознаграждений

## Проблемы, которые были исправлены

### 1. Ошибка "Invalid Date"

**Проблема:** В интерфейсе отображалась ошибка "Invalid Date" вместо дат уроков.

**Решение:**
- Добавлена аннотация `@JsonFormat(pattern = "yyyy-MM-dd")` в `PayrollDTO.java`
- Улучшена функция форматирования дат в `payroll.js` с проверкой валидности
- Добавлено логирование ошибок форматирования дат

```java
@JsonFormat(pattern = "yyyy-MM-dd")
private LocalDate date;
```

```javascript
formatDate(dateString) {
    if (!dateString) return '-';
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) {
            console.warn('Invalid date:', dateString);
            return dateString;
        }
        return date.toLocaleDateString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    } catch (error) {
        console.error('Error formatting date:', dateString, error);
        return dateString;
    }
}
```

### 2. Одновременная активность месяца и сметы

**Проблема:** При выборе месяца и сметы одновременно горели обе кнопки.

**Решение:**
- Исправлена логика переключения в `payroll.js`
- При выборе сметы сбрасывается выбор месяца
- При выборе месяца сбрасывается выбор сметы

```javascript
// Сбрасываем выбор месяца при переключении на смету
document.querySelectorAll('.month-item').forEach(item => {
    item.classList.remove('active');
});
```

### 3. Фильтрация уроков в сметах

**Проблема:** В сметах отображались все уроки, включая будущие.

**Решение:**
- Добавлена фильтрация по времени для всех типов смет
- **Текущая смета:** показывает прошедшие уроки и ВСЕ отменённые уроки за месяц
- **Прошлая смета:** показывает только прошедшие уроки
- Будущие уроки со статусом SCHEDULED не отображаются

```java
// Фильтруем уроки: показываем прошедшие уроки и отменённые уроки (независимо от даты)
List<Lesson> lessons = periodLessons.stream()
        .filter(lesson -> lesson.getLessonDate().isBefore(now) || lesson.getStatus() == Lesson.LessonStatus.CANCELLED)
        .collect(Collectors.toList());

// Если это текущая смета, добавляем отменённые уроки из других периодов
if ("current-payroll".equals(type)) {
    // Получаем все отменённые уроки за текущий месяц
    List<Lesson> cancelledLessons = lessonRepository.findByTeacherIdAndLessonDateBetween(teacherId, monthStartDateTime, monthEndDateTime)
            .stream()
            .filter(lesson -> lesson.getStatus() == Lesson.LessonStatus.CANCELLED)
            .collect(Collectors.toList());
    
    // Добавляем отменённые уроки, которых нет в текущем списке
    lessons.addAll(cancelledLessons.stream()
            .filter(cancelled -> lessons.stream()
                    .noneMatch(existing -> existing.getId().equals(cancelled.getId())))
            .collect(Collectors.toList()));
}
```

### 4. Исправленная логика отображения

**Проблема:** Неправильное отображение данных в соответствующих разделах.

**Решение:**
- **Текущая смета (17-31 число):** отображается в разделе "Текущая смета", только прошедшие уроки
- **Прошлая смета (1-16 число):** отображается в разделе "Прошлая смета", все уроки за период
- **Месячный просмотр:** отображается в разделе "Текущая смета", все уроки за месяц

```javascript
updateSummary(summary, isCurrentSection, isMonthlyView) {
    // Определяем, какой раздел использовать
    let expectedElement, paidElement;
    
    if (isMonthlyView || isCurrentSection) {
        // Месячный просмотр или текущая смета - используем текущий раздел
        expectedElement = document.getElementById('expectedAmount');
        paidElement = document.getElementById('paidAmount');
    } else {
        // Прошлая смета - используем прошлый раздел
        expectedElement = document.getElementById('pastExpectedAmount');
        paidElement = document.getElementById('pastPaidAmount');
    }
    // ...
}
```

## Логика работы системы

### Три режима отображения:

1. **Текущая смета** - уроки с 17 по 31 число + ВСЕ отменённые уроки за месяц
2. **Прошлая смета** - уроки с 1 по 16 число (только прошедшие)
3. **Месячный просмотр** - все уроки за выбранный месяц (прошедшие и отменённые)

### Фильтрация уроков:

- **Текущая смета:** показывает прошедшие уроки и ВСЕ отменённые уроки за месяц
- **Прошлая смета:** показывает только прошедшие уроки
- **Месячный просмотр:** показывает прошедшие и отменённые уроки за месяц
- Отменённые уроки из всех периодов попадают в текущую смету
- Будущие уроки со статусом `SCHEDULED` не отображаются в сметах
- Уроки со статусом `COMPLETED`, `MISSED`, `CANCELLED` отображаются согласно правилам фильтрации

### Правила переключения:

- При выборе "Текущая смета" или "Прошлая смета" сбрасывается выбор месяца
- При выборе месяца сбрасывается выбор сметы
- Данные отображаются в соответствующих разделах

## Изменения в файлах

### 1. PayrollDTO.java

```java
import com.fasterxml.jackson.annotation.JsonFormat;

@JsonFormat(pattern = "yyyy-MM-dd")
private LocalDate date;
```

### 2. PayrollService.java

```java
// Добавлена фильтрация по времени для текущей сметы
LocalDateTime now = LocalDateTime.now();

if ("current-payroll".equals(type)) {
    lessons = lessons.stream()
            .filter(lesson -> lesson.getLessonDate().isBefore(now))
            .collect(Collectors.toList());
}
```

### 3. payroll.js

```javascript
// Исправлена логика отображения
updateSummary(summary, isCurrentSection, isMonthlyView) {
    // Определяем, какой раздел использовать
    if (isMonthlyView || isCurrentSection) {
        // Месячный просмотр или текущая смета - используем текущий раздел
        expectedElement = document.getElementById('expectedAmount');
        paidElement = document.getElementById('paidAmount');
    } else {
        // Прошлая смета - используем прошлый раздел
        expectedElement = document.getElementById('pastExpectedAmount');
        paidElement = document.getElementById('pastPaidAmount');
    }
}

// Исправлена логика переключения
switchSection(section) {
    // Сбрасываем выбор месяца при переключении на смету
    document.querySelectorAll('.month-item').forEach(item => {
        item.classList.remove('active');
    });
}
```

### 4. data.sql

```sql
-- Исправлены комментарии для правильного понимания периодов
-- 1-16 января (прошлая смета)
-- 17-31 января (текущая смета)
-- 1-16 февраля (прошлая смета)
-- 17-28 февраля (текущая смета)
```

## Структура данных

### Январь 2025
- **Прошлая смета (1-16):** 15 уроков
- **Текущая смета (17-31):** 15 уроков (только прошедшие)

### Февраль 2025
- **Прошлая смета (1-16):** 5 уроков
- **Текущая смета (17-28):** 5 уроков (только прошедшие)

## Результат исправлений

✅ **Исправлена ошибка "Invalid Date"**
✅ **Убрана одновременная активность месяца и сметы**
✅ **Текущая смета показывает прошедшие и ВСЕ отменённые уроки месяца**
✅ **Прошлая смета показывает только прошедшие уроки**
✅ **Отменённые уроки из всех периодов попадают в текущую смету**
✅ **Будущие SCHEDULED уроки не отображаются в сметах**
✅ **Правильное отображение в соответствующих разделах**
✅ **Корректная логика переключения между сметами и месяцами**
✅ **Добавлено логирование для отладки**
✅ **Добавлена фильтрация будущих уроков**

## Как проверить исправления

1. Запустите приложение
2. Откройте файл `test-payroll-api.html`
3. Выполните все тесты:
   - Тест текущей сметы
   - Тест прошлой сметы
   - Тест месячного просмотра
   - Сравнение периодов
   - Проверка фильтрации уроков
   - Проверка логики отменённых уроков
   - Тест форматирования дат
4. Перейдите на страницу `/dashboard` → "Вознаграждения"
5. Проверьте переключение между разделами:
   - Текущая смета (17-31 число)
   - Прошлая смета (1-16 число)
   - Выбор месяца
6. Убедитесь, что данные отображаются в правильных разделах
7. Проверьте, что:
   - Будущие SCHEDULED уроки не отображаются в сметах
   - Отменённые уроки из всех периодов попадают в текущую смету
   - Прошлая смета показывает только прошедшие уроки
   - Прошедшие уроки отображаются корректно

## Дополнительные улучшения

- Добавлена обработка ошибок с подробным логированием
- Улучшена читаемость кода с комментариями
- Создана документация для будущих разработчиков
- Добавлены тесты для проверки форматирования дат
- Добавлено сравнение периодов для проверки корректности данных
- Добавлена проверка фильтрации уроков (будущие vs отменённые)
- Добавлена проверка логики отменённых уроков в текущей смете
